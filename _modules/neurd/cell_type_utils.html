<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neurd.cell_type_utils &mdash; neurd  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            neurd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">neurd</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">neurd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../neurd.html">neurd</a></li>
      <li class="breadcrumb-item active">neurd.cell_type_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neurd.cell_type_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>



<span class="sd">Interesting website for cell types: </span>
<span class="sd">http://celltypes.brain-map.org/experiment/morphology/474626527</span>




<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">pathlib_utils</span> <span class="k">as</span> <span class="n">plu</span>

<span class="n">e_i_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">e_i_model_features_default</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;syn_density_shaft&quot;</span><span class="p">,</span><span class="s2">&quot;spine_density&quot;</span><span class="p">]</span>
<span class="c1">#e_i_model_features_default = [&quot;syn_density_post&quot;,&quot;spine_density&quot;]</span>
<span class="n">module_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plu</span><span class="o">.</span><span class="n">parent_directory</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

<span class="c1"># use the </span>
<span class="n">manual_df_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;man_proof_stats_df_for_e_i.csv&quot;</span><span class="p">))</span><span class="c1">#/meshAfterParty/meshAfterParty/man_proof_stats_df_for_e_i.pbz2&quot;</span>
<span class="n">manual_df_path_backup</span> <span class="o">=</span> <span class="s2">&quot;/neurd_packages/meshAfterParty/meshAfterParty/man_proof_stats_df_for_e_i.pbz2&quot;</span>
<span class="n">manual_exc_df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">manual_inh_df</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#border_df_path  = &quot;/meshAfterParty/meshAfterParty/border_df_for_e_i_improved.pbz2&quot;</span>
<span class="n">border_df_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;border_df_for_e_i_improved.csv&quot;</span><span class="p">))</span>
<span class="n">border_df_path_backup</span> <span class="o">=</span> <span class="s2">&quot;/neurd_packages/meshAfterParty/meshAfterParty/border_df_for_e_i_improved.pbz2&quot;</span>
<span class="n">border_exc_df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">border_inh_df</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">e_i_model_logistic_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="mf">3.22451485</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.7</span><span class="p">]])</span>
<span class="n">e_i_model_logistic_intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.2</span><span class="p">])</span>

<span class="n">nomenclature</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="n">IT</span> <span class="o">=</span> <span class="s2">&quot;intratelencephalic&quot;</span><span class="p">,</span>
<span class="n">PT</span> <span class="o">=</span> <span class="s2">&quot;pyramidal_tract&quot;</span><span class="p">,</span>
<span class="n">CT</span> <span class="o">=</span> <span class="s2">&quot;corticothalamic&quot;</span><span class="p">,</span>
<span class="n">VISp</span><span class="o">=</span> <span class="s2">&quot;primary_visual_cortex&quot;</span><span class="p">,</span>
<span class="n">CF</span> <span class="o">=</span> <span class="s2">&quot;corticofugal&quot;</span><span class="p">,</span>
<span class="n">NP</span> <span class="o">=</span> <span class="s2">&quot;near_projecting&quot;</span>
    
<span class="p">)</span>
<span class="n">cell_type_fine_names_excitatory</span> <span class="o">=</span> <span class="p">{</span>

 <span class="s1">&#39;23P&#39;</span><span class="p">:</span><span class="s2">&quot;layer_2/3_pyramidal&quot;</span><span class="p">,</span> 
 <span class="s1">&#39;4P&#39;</span><span class="p">:</span> <span class="s2">&quot;layer 4_pyramidal&quot;</span><span class="p">,</span>
 <span class="s1">&#39;5P_IT&#39;</span><span class="p">:</span> <span class="s2">&quot;layer_5_intratelencephalic&quot;</span><span class="p">,</span>
 <span class="s1">&#39;5P_NP&#39;</span><span class="p">:</span> <span class="s2">&quot;layer_5_near_projecting&quot;</span><span class="p">,</span> 
 <span class="s1">&#39;5P_PT&#39;</span><span class="p">:</span> <span class="s2">&quot;layer_5_pyramidal_track&quot;</span><span class="p">,</span>
 <span class="s1">&#39;6CT&#39;</span><span class="p">:</span> <span class="s2">&quot;layer_6_corticothalamic&quot;</span><span class="p">,</span>
 <span class="s1">&#39;6IT&#39;</span><span class="p">:</span> <span class="s2">&quot;layer_6_intratelencephalic&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">cell_type_fine_name_inhibitory</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;BC&#39;</span><span class="p">:</span><span class="s2">&quot;basket&quot;</span><span class="p">,</span>
 <span class="s1">&#39;BPC&#39;</span><span class="p">:</span><span class="s2">&quot;bipolar&quot;</span><span class="p">,</span>
 <span class="s1">&#39;MC&#39;</span><span class="p">:</span><span class="s2">&quot;martinotti&quot;</span><span class="p">,</span>
 <span class="s1">&#39;NGC&#39;</span><span class="p">:</span><span class="s2">&quot;neurogliaform&quot;</span>
<span class="p">}</span>

<span class="n">e_i_from_type_dict</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([{</span>
<span class="s1">&#39;IT_short&#39;</span><span class="p">:</span> <span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;Martinotti&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;IT_small_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;5P_NP&#39;</span><span class="p">:</span> <span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;VIP&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="c1">#basket cell</span>
<span class="s1">&#39;ndnf+npy-&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;Pvalb&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="c1">#baske cell</span>
<span class="s1">&#39;bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;IT_big_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;prox targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;l1vip&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;I targeting non-bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
<span class="s1">&#39;ngfc&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;alfa7&#39;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
<span class="s1">&#39;cb1 basket&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;np-targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;small basket&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;CCK&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span> <span class="c1">#basket cell</span>
<span class="s1">&#39;chandelier&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;PT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;IT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;basket&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;npy&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;alfa7&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;chandelier&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;MC&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;6P&#39;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P_IT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;23P&#39;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span> 
<span class="s1">&#39;4P&#39;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;1P&#39;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;INH&#39;</span><span class="p">:</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;Unsure E&#39;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s1">&#39;Unsure I&#39;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="p">},</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cell_type_fine_names_excitatory</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cell_type_fine_names_excitatory</span><span class="o">.</span><span class="n">values</span><span class="p">()},</span>
    
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cell_type_fine_name_inhibitory</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cell_type_fine_name_inhibitory</span><span class="o">.</span><span class="n">values</span><span class="p">()},])</span>


<span class="n">allen_cell_type_fine_classifier_labels</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;23P&quot;</span><span class="p">,</span>
<span class="s2">&quot;4P&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-NP&quot;</span><span class="p">,</span>
<span class="c1">#&quot;5P-PT&quot;,</span>
<span class="s2">&quot;5P-ET&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-CT&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-IT&quot;</span><span class="p">,</span>
<span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s2">&quot;BPC&quot;</span><span class="p">,</span>
<span class="s1">&#39;MC&#39;</span><span class="p">,</span>
<span class="s1">&#39;NGC&#39;</span>
<span class="p">]</span>

<span class="n">cell_type_fine_allen_classifier_labels</span> <span class="o">=</span> <span class="n">allen_cell_type_fine_classifier_labels</span>

<span class="n">allen_cell_type_fine_classifier_labels_exc</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;23P&quot;</span><span class="p">,</span>
<span class="s2">&quot;4P&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-NP&quot;</span><span class="p">,</span>
<span class="c1">#&quot;5P-PT&quot;,</span>
<span class="s2">&quot;5P-ET&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-CT&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-IT&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">allen_cell_type_fine_classifier_labels_inh</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s2">&quot;BPC&quot;</span><span class="p">,</span>
<span class="s1">&#39;MC&#39;</span><span class="p">,</span>
<span class="s1">&#39;NGC&#39;</span>
<span class="p">]</span>

<span class="n">allen_cell_type_fine_classifier_to_e_i_map</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;23P&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;4P&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-IT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P-NP&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="c1">#&quot;5P-PT&quot;:&quot;excitatory&quot;,</span>
<span class="s2">&quot;5P-ET&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-CT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;6P-IT&quot;</span><span class="p">:</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span>
<span class="s2">&quot;BC&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s2">&quot;BPC&quot;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;MC&#39;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="s1">&#39;NGC&#39;</span><span class="p">:</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">cell_type_fine_to_cell_type_coarse_map</span> <span class="o">=</span> <span class="n">allen_cell_type_fine_classifier_to_e_i_map</span>

<span class="n">allen_cell_type_coarse_classifier_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">]</span>

<span class="n">publishable_names_map</span> <span class="o">=</span> <span class="n">dict_map</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;5P-PT&quot;</span><span class="p">:</span><span class="s2">&quot;5P-ET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5P_PT&quot;</span><span class="p">:</span><span class="s2">&quot;5P_ET&quot;</span>
<span class="p">}</span>

<div class="viewcode-block" id="cell_type_fine_mapping_publishable"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.cell_type_fine_mapping_publishable">[docs]</a><span class="k">def</span> <span class="nf">cell_type_fine_mapping_publishable</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s2">&quot;gnn_cell_type_fine&quot;</span><span class="p">,</span>
    <span class="n">dict_map</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dict_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dict_map</span> <span class="o">=</span> <span class="n">publishable_names_map</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">map_column_with_dict</span><span class="p">(</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
        <span class="n">dict_map</span><span class="o">=</span><span class="n">dict_map</span><span class="p">,</span>
        <span class="n">use_default_value</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span></div>

<span class="n">map_cell_type_fine_publishable</span> <span class="o">=</span> <span class="n">cell_type_fine_mapping_publishable</span>

<div class="viewcode-block" id="classes_from_cell_type_name"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.classes_from_cell_type_name">[docs]</a><span class="k">def</span> <span class="nf">classes_from_cell_type_name</span><span class="p">(</span><span class="n">cell_type_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Returns a list to iterate over depending on </span>
<span class="sd">    the name of the cell type</span>
<span class="sd">    </span>
<span class="sd">    cell_type_predicted ==&gt; </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cell_type_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cell_type_predicted&quot;</span><span class="p">,</span><span class="s2">&quot;cell_type_fine&quot;</span><span class="p">]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">allen_cell_type_fine_classifier_labels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">allen_cell_type_coarse_classifier_labels</span>
    <span class="k">return</span> <span class="n">classes</span></div>

<span class="n">cell_type_fine_classifier_map</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;IT_short&#39;</span><span class="p">:</span> <span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s1">&#39;Martinotti&#39;</span><span class="p">:</span> <span class="s2">&quot;MC&quot;</span><span class="p">,</span>
<span class="s1">&#39;IT_small_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s1">&#39;5P_NP&#39;</span><span class="p">:</span> <span class="s2">&quot;5P-NP&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P_PT&quot;</span><span class="p">:</span><span class="s2">&quot;5P-PT&quot;</span><span class="p">,</span>
<span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s2">&quot;SST&quot;</span><span class="p">,</span>
<span class="s1">&#39;VIP&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="c1">#basket cell</span>
<span class="s1">&#39;ndnf+npy-&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;Pvalb&#39;</span><span class="p">:</span> <span class="s2">&quot;Pvalb&quot;</span><span class="p">,</span> <span class="c1">#baske cell</span>
<span class="s1">&#39;bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;BPC&quot;</span><span class="p">,</span>
<span class="s1">&#39;IT_big_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s1">&#39;prox targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;l1vip&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;I targeting non-bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;ngfc&#39;</span><span class="p">:</span> <span class="s2">&quot;NGC&quot;</span><span class="p">,</span>
<span class="s1">&#39;alfa7&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;cb1 basket&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;np-targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;small basket&#39;</span><span class="p">:</span> <span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s1">&#39;CCK&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="c1">#basket cell</span>
<span class="s1">&#39;chandelier&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;PT&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;IT&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;basket&quot;</span><span class="p">:</span><span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s2">&quot;npy&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;alfa7&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;chandelier&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;MC&quot;</span><span class="p">:</span><span class="s2">&quot;MC&quot;</span><span class="p">,</span>
<span class="s1">&#39;6P&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P_IT&quot;</span><span class="p">:</span><span class="s2">&quot;5P-IT&quot;</span><span class="p">,</span>
<span class="s2">&quot;5P&quot;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;23P&#39;</span><span class="p">:</span><span class="s2">&quot;23P&quot;</span><span class="p">,</span> 
<span class="s1">&#39;4P&#39;</span><span class="p">:</span><span class="s2">&quot;4P&quot;</span><span class="p">,</span>
<span class="s1">&#39;1P&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;INH&#39;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;Unsure E&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;Unsure I&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;ndnf+npy_&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;I targeting non_bpc&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;BPC&#39;</span><span class="p">:</span><span class="s2">&quot;BPC&quot;</span><span class="p">,</span>
<span class="s1">&#39;SST&#39;</span><span class="p">:</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span>
<span class="s1">&#39;BC&#39;</span><span class="p">:</span><span class="s2">&quot;BC&quot;</span><span class="p">,</span>
<span class="s1">&#39;np_targeting&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;Unsure&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;NGC&#39;</span><span class="p">:</span><span class="s2">&quot;NGC&quot;</span><span class="p">,</span>
<span class="s1">&#39;6P_IT&#39;</span><span class="p">:</span><span class="s2">&quot;6P-IT&quot;</span><span class="p">,</span>
<span class="s1">&#39;6P_U&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;6P_CT&#39;</span><span class="p">:</span><span class="s2">&quot;6P-CT&quot;</span><span class="p">,</span>
<span class="s1">&#39;WM_P&#39;</span><span class="p">:</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s1">&#39;6CT&#39;</span><span class="p">:</span><span class="s2">&quot;6P-CT&quot;</span><span class="p">,</span>
<span class="p">}</span>            

<div class="viewcode-block" id="cell_type_fine_classifier_map_derived"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.cell_type_fine_classifier_map_derived">[docs]</a><span class="k">def</span> <span class="nf">cell_type_fine_classifier_map_derived</span><span class="p">(</span>
    <span class="n">cell_type_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">e_i_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">e_i_labels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cell_type_dict_extended</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">cell_type_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cell_type_dict</span> <span class="o">=</span> <span class="n">cell_type_fine_classifier_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">cell_type_dict_extended</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cell_type_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cell_type_dict_extended</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span>
    
    <span class="k">if</span> <span class="n">e_i_labels</span><span class="p">:</span>
        <span class="n">map_func</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_label_from_cell_type_fine</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">map_func</span> <span class="o">=</span> <span class="n">dummy</span>
    
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cell_type_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#print(f&quot;inside cell types&quot;)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Unsure E&quot;</span><span class="p">,</span><span class="s2">&quot;Unsure I&quot;</span><span class="p">]:</span>
            <span class="c1">#print(f&quot;inside&quot;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">e_i_labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">,</span><span class="s2">&quot;unknown&quot;</span><span class="p">]:</span>
                    <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;Unsure I&quot;</span><span class="p">:</span>
                    <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inhibitory&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excitatory&quot;</span>
            <span class="k">continue</span>
            
            
        
        
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">,</span><span class="s2">&quot;unknown&quot;</span><span class="p">]:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
            <span class="k">continue</span>
            
        <span class="n">e_i_label</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_label_from_cell_type_fine</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e_i_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e_i_label</span> <span class="o">!=</span> <span class="n">e_i_type</span><span class="p">:</span>
                <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">e_i_labels</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_i_label</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            
    <span class="k">return</span> <span class="n">return_dict</span></div>
            
    
        

    
<span class="n">cell_type_fine_classifier_map_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cell_type_fine_classifier_map</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
<span class="n">cell_type_fine_classifier_map_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;other&quot;</span><span class="p">)</span>

<span class="n">cell_type_fine_classifier_weights</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;23P&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span><span class="c1">#1294</span>
<span class="s1">&#39;4P&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span><span class="c1">#890</span>
<span class="s1">&#39;5P_IT&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span><span class="c1">#465</span>
<span class="s1">&#39;6P&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span><span class="c1">#342</span>
<span class="s1">&#39;6P_IT&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span><span class="c1">#263</span>
<span class="s1">&#39;5P_PT&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span><span class="c1">#224</span>
<span class="p">}</span>
<span class="n">cell_type_fine_color_map_old</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;23P&#39;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span><span class="c1">#1294</span>
<span class="s1">&#39;4P&#39;</span><span class="p">:</span> <span class="s2">&quot;slategrey&quot;</span><span class="p">,</span><span class="c1">#890</span>
<span class="s1">&#39;5P_IT&#39;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span><span class="c1">#465</span>
<span class="s1">&#39;6P&#39;</span><span class="p">:</span> <span class="s2">&quot;lightsteelblue&quot;</span><span class="p">,</span><span class="c1">#342</span>
<span class="s1">&#39;6P_IT&#39;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span><span class="c1">#263</span>
<span class="s1">&#39;5P_PT&#39;</span><span class="p">:</span> <span class="s2">&quot;Turquoise&quot;</span><span class="p">,</span><span class="c1">#224</span>
<span class="s1">&#39;BC&#39;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="c1">#218</span>
<span class="s1">&#39;Martinotti&#39;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span><span class="c1">#151</span>
<span class="s1">&#39;6P_CT&#39;</span><span class="p">:</span> <span class="s2">&quot;tan&quot;</span><span class="p">,</span><span class="c1">#132</span>
<span class="s1">&#39;SST&#39;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span><span class="c1">#93</span>
<span class="s1">&#39;5P_NP&#39;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="c1">#91</span>
<span class="s1">&#39;BPC&#39;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="c1">#88</span>
<span class="s1">&#39;Unsure&#39;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="c1">#41</span>
<span class="s1">&#39;IT_short&#39;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span><span class="c1">#39</span>
<span class="s1">&#39;IT_small_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;plum&quot;</span><span class="p">,</span><span class="c1">#37</span>
<span class="s1">&#39;Pvalb&#39;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span><span class="c1">#35</span>
<span class="s1">&#39;IT_big_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;indigo&quot;</span><span class="p">,</span><span class="c1">#34</span>
<span class="s1">&#39;6CT&#39;</span><span class="p">:</span> <span class="s2">&quot;tan&quot;</span><span class="p">,</span><span class="c1">#33</span>
<span class="s1">&#39;6P_U&#39;</span><span class="p">:</span> <span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span><span class="c1">#27</span>
<span class="s1">&#39;WM_P&#39;</span><span class="p">:</span> <span class="s2">&quot;teal&quot;</span><span class="p">,</span><span class="c1">#20</span>
<span class="s1">&#39;ngfc&#39;</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span><span class="c1">#20</span>
<span class="s1">&#39;I targeting non_bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;olivedrab&quot;</span><span class="p">,</span><span class="c1">#19</span>
<span class="s1">&#39;NGC&#39;</span><span class="p">:</span> <span class="s2">&quot;lightcoral&quot;</span><span class="p">,</span><span class="c1">#17</span>
<span class="s1">&#39;1P&#39;</span><span class="p">:</span> <span class="s2">&quot;springgreen&quot;</span><span class="p">,</span><span class="c1">#15</span>
<span class="s1">&#39;VIP&#39;</span><span class="p">:</span> <span class="s2">&quot;chocolate&quot;</span><span class="p">,</span><span class="c1">#14</span>
<span class="s1">&#39;ndnf+npy_&#39;</span><span class="p">:</span> <span class="s2">&quot;tomato&quot;</span><span class="p">,</span><span class="c1">#13</span>
<span class="s2">&quot;Unsure E&quot;</span><span class="p">:</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span>
<span class="s2">&quot;Unsure I&quot;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span>
<span class="c1"># &#39;prox targeting&#39;: 4</span>
<span class="c1"># &#39;cb1 basket&#39;: 4</span>
<span class="c1"># &#39;l1vip&#39;: 3</span>
<span class="c1"># &#39;CCK&#39;: 1</span>
<span class="c1"># &#39;alfa7&#39;: 1</span>
<span class="c1"># &#39;chandelier&#39;: 1</span>
<span class="c1"># &#39;np_targeting&#39;: 1</span>
<span class="c1"># &#39;small basket&#39;: 1</span>
<span class="p">}</span>

<span class="n">cell_type_fine_color_map_bcm</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;23P&#39;</span><span class="p">:</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">,</span><span class="c1">#1294</span>
<span class="s1">&#39;4P&#39;</span><span class="p">:</span> <span class="s2">&quot;greenyellow&quot;</span><span class="p">,</span><span class="c1">#890</span>
<span class="c1"># &#39;5P_IT&#39;: &quot;silver&quot;,#465</span>
<span class="c1"># &#39;5P-IT&#39;: &quot;silver&quot;,#465</span>
<span class="s1">&#39;5P_IT&#39;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span><span class="c1">#465</span>
<span class="s1">&#39;5P-IT&#39;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span><span class="c1">#465</span>
<span class="s1">&#39;6P&#39;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span><span class="c1">#342</span>
<span class="s1">&#39;6P_IT&#39;</span><span class="p">:</span> <span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span><span class="c1">#263</span>
<span class="s1">&#39;6P-IT&#39;</span><span class="p">:</span> <span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span><span class="c1">#263</span>
<span class="s1">&#39;5P_PT&#39;</span><span class="p">:</span> <span class="s2">&quot;Turquoise&quot;</span><span class="p">,</span><span class="c1">#224</span>
<span class="s1">&#39;5P-PT&#39;</span><span class="p">:</span> <span class="s2">&quot;Turquoise&quot;</span><span class="p">,</span><span class="c1">#224</span>
<span class="s1">&#39;5P_ET&#39;</span><span class="p">:</span> <span class="s2">&quot;Turquoise&quot;</span><span class="p">,</span><span class="c1">#224</span>
<span class="s1">&#39;5P-ET&#39;</span><span class="p">:</span> <span class="s2">&quot;Turquoise&quot;</span><span class="p">,</span><span class="c1">#224</span>
<span class="s1">&#39;BC&#39;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span><span class="c1">#218</span>
<span class="s1">&#39;Martinotti&#39;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span><span class="c1">#151</span>
<span class="s1">&#39;MC&#39;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span><span class="c1">#151</span>
<span class="s1">&#39;6P_CT&#39;</span><span class="p">:</span> <span class="s2">&quot;olivedrab&quot;</span><span class="p">,</span><span class="c1">#132</span>
<span class="s1">&#39;6P-CT&#39;</span><span class="p">:</span> <span class="s2">&quot;olivedrab&quot;</span><span class="p">,</span><span class="c1">#132</span>
<span class="s1">&#39;SST&#39;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span><span class="c1">#93</span>
<span class="s1">&#39;5P_NP&#39;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span><span class="c1">#91</span>
<span class="s1">&#39;5P-NP&#39;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span><span class="c1">#91</span>
<span class="s1">&#39;BPC&#39;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="c1">#88</span>
<span class="s1">&#39;Unsure&#39;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="c1">#41</span>
<span class="s1">&#39;IT_short&#39;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span><span class="c1">#39</span>
<span class="s1">&#39;IT_small_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;plum&quot;</span><span class="p">,</span><span class="c1">#37</span>
<span class="s1">&#39;Pvalb&#39;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span><span class="c1">#35</span>
<span class="s1">&#39;IT_big_tuft&#39;</span><span class="p">:</span> <span class="s2">&quot;indigo&quot;</span><span class="p">,</span><span class="c1">#34</span>
<span class="s1">&#39;6CT&#39;</span><span class="p">:</span> <span class="s2">&quot;lightsteelblue&quot;</span><span class="p">,</span><span class="c1">#33</span>
<span class="s1">&#39;6P_U&#39;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="c1">#27</span>
<span class="s1">&#39;WM_P&#39;</span><span class="p">:</span> <span class="s2">&quot;teal&quot;</span><span class="p">,</span><span class="c1">#20</span>
<span class="s1">&#39;ngfc&#39;</span><span class="p">:</span> <span class="s2">&quot;coral&quot;</span><span class="p">,</span><span class="c1">#20</span>
<span class="s1">&#39;I targeting non_bpc&#39;</span><span class="p">:</span> <span class="s2">&quot;rosybrown&quot;</span><span class="p">,</span><span class="c1">#19</span>
<span class="s1">&#39;NGC&#39;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="c1">#17</span>
<span class="s1">&#39;1P&#39;</span><span class="p">:</span> <span class="s2">&quot;springgreen&quot;</span><span class="p">,</span><span class="c1">#15</span>
<span class="s1">&#39;VIP&#39;</span><span class="p">:</span> <span class="s2">&quot;chocolate&quot;</span><span class="p">,</span><span class="c1">#14</span>
<span class="s1">&#39;ndnf+npy_&#39;</span><span class="p">:</span> <span class="s2">&quot;tomato&quot;</span><span class="p">,</span><span class="c1">#13</span>
<span class="s1">&#39;prox targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;cornsilk&quot;</span><span class="p">,</span><span class="c1">#3</span>
<span class="s1">&#39;cb1 basket&#39;</span><span class="p">:</span> <span class="s2">&quot;seashell&quot;</span><span class="p">,</span><span class="c1">#3</span>
<span class="s1">&#39;l1vip&#39;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="c1">#3</span>
<span class="s1">&#39;CCK&#39;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="c1">#1</span>
<span class="s1">&#39;alfa7&#39;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="c1">#1</span>
<span class="s2">&quot;Unsure E&quot;</span><span class="p">:</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span>
<span class="s2">&quot;Unsure I&quot;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span>
<span class="s2">&quot;Other Exc&quot;</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span>
<span class="s2">&quot;Other Inh&quot;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span>
<span class="s1">&#39;chandelier&#39;</span><span class="p">:</span> <span class="s2">&quot;lightcyan&quot;</span><span class="p">,</span><span class="c1">#1</span>
<span class="s1">&#39;np_targeting&#39;</span><span class="p">:</span> <span class="s2">&quot;ghostwhite&quot;</span><span class="p">,</span><span class="c1">#1</span>
<span class="s1">&#39;No Label&#39;</span><span class="p">:</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
<span class="s1">&#39;small basket&#39;</span><span class="p">:</span> <span class="s2">&quot;ghostwhite&quot;</span><span class="p">,</span><span class="c1">#1</span>
<span class="p">}</span>

<span class="n">cell_type_fine_allen_color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;23P&#39;</span><span class="p">:</span><span class="s1">&#39;#8268DC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;4P&#39;</span><span class="p">:</span><span class="s1">&#39;#647FDC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;5P-IT&#39;</span><span class="p">:</span><span class="s1">&#39;#77BCDE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;5P-PT&#39;</span><span class="p">:</span><span class="s1">&#39;#87DD90&#39;</span><span class="p">,</span>
    <span class="s1">&#39;5P-ET&#39;</span><span class="p">:</span><span class="s1">&#39;#87DD90&#39;</span><span class="p">,</span>
    <span class="s1">&#39;5P-NP&#39;</span><span class="p">:</span><span class="s1">&#39;#85DEC9&#39;</span><span class="p">,</span>
    <span class="s1">&#39;6P-CT&#39;</span><span class="p">:</span><span class="s1">&#39;#96DD70&#39;</span><span class="p">,</span>
    <span class="s1">&#39;6P-IT&#39;</span><span class="p">:</span><span class="s1">&#39;#DCC86E&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BC&#39;</span><span class="p">:</span><span class="s1">&#39;#D68C66&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BPC&#39;</span><span class="p">:</span><span class="s1">&#39;#D3697C&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MC&#39;</span><span class="p">:</span><span class="s1">&#39;#D36BBA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NGC&#39;</span><span class="p">:</span><span class="s1">&#39;#BC6BDB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;astrocyte&#39;</span><span class="p">:</span><span class="s1">&#39;#009245&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pericyte&#39;</span><span class="p">:</span><span class="s1">&#39;#754C24&#39;</span><span class="p">,</span>
    <span class="s1">&#39;microglia&#39;</span><span class="p">:</span><span class="s1">&#39;#006837&#39;</span><span class="p">,</span>
    <span class="s1">&#39;oligo&#39;</span><span class="p">:</span><span class="s1">&#39;#998675&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OPC&#39;</span><span class="p">:</span><span class="s1">&#39;#8CC63F&#39;</span><span class="p">,</span>
    <span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="s1">&#39;#899499&#39;</span>
             
<span class="p">}</span>

<span class="n">cell_type_fine_color_map</span> <span class="o">=</span> <span class="n">cell_type_fine_color_map_bcm</span>

<div class="viewcode-block" id="e_i_label_from_cell_type_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_label_from_cell_type_fine">[docs]</a><span class="k">def</span> <span class="nf">e_i_label_from_cell_type_fine</span><span class="p">(</span>
    <span class="n">cell_type</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">cell_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_value</span>
    <span class="c1">#print(f&quot;cell_type = {cell_type}&quot;)</span>
    <span class="k">if</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;unsure&#39;</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span> <span class="ow">in</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">default_value</span>
    
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">e_i_from_type_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">cell_type</span> <span class="o">=</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">most_match_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">stru</span><span class="o">.</span><span class="n">str_overlap</span><span class="p">(</span><span class="n">cell_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">])</span>
    <span class="n">most_match_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">most_match_length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;most_match_length = </span><span class="si">{</span><span class="n">most_match_length</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">candidates</span><span class="p">[</span><span class="n">most_match_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">most_match_length</span><span class="p">[</span><span class="n">most_match_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">winning_candid</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">most_match_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">most_match_length</span><span class="p">[</span><span class="n">most_match_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_value</span>
    <span class="k">return</span> <span class="n">e_i_from_type_dict</span><span class="p">[</span><span class="n">winning_candid</span><span class="p">]</span></div>

<div class="viewcode-block" id="e_i_color_dict"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_color_dict">[docs]</a><span class="k">def</span> <span class="nf">e_i_color_dict</span><span class="p">(</span>
    <span class="n">excitatory_color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">inhibitory_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">other_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="n">e_i_color_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">excitatory</span><span class="o">=</span><span class="n">excitatory_color</span><span class="p">,</span>
        <span class="n">inhibitory</span><span class="o">=</span><span class="n">inhibitory_color</span><span class="p">,</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">other_color</span><span class="p">,</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="n">other_color</span><span class="p">,</span>
        
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">e_i_color_mapping</span><span class="p">[</span><span class="n">ctu</span><span class="o">.</span><span class="n">e_i_label_from_cell_type_fine</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cell_type_fine_color_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>
    
<span class="n">e_i_raw_color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">excitatory</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">inhibitory</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
<span class="p">)</span>

<span class="n">cell_type_coarse_color_map</span> <span class="o">=</span> <span class="n">e_i_raw_color_dict</span>

<div class="viewcode-block" id="coarse_cell_type_from_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.coarse_cell_type_from_fine">[docs]</a><span class="k">def</span> <span class="nf">coarse_cell_type_from_fine</span><span class="p">(</span><span class="n">cell_type</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">e_i_from_type_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cell_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="coarse_cell_type_from_coarse"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.coarse_cell_type_from_coarse">[docs]</a><span class="k">def</span> <span class="nf">coarse_cell_type_from_coarse</span><span class="p">(</span><span class="n">cell_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;exc&quot;</span> <span class="ow">in</span> <span class="n">cell_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;excitatory&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;inh&quot;</span> <span class="ow">in</span> <span class="n">cell_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;inhibitory&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="filter_cell_type_df_for_most_complete_duplicates"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.filter_cell_type_df_for_most_complete_duplicates">[docs]</a><span class="k">def</span> <span class="nf">filter_cell_type_df_for_most_complete_duplicates</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">segment_id_name</span> <span class="o">=</span> <span class="s2">&quot;pt_root_id&quot;</span><span class="p">):</span>
    <span class="c1">#filter to keep most complete</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To filter so that only one of segment id</span>
<span class="sd">    and takes the most filled out one</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    For each unique pt_root_id</span>
<span class="sd">    1) Find all of the rows</span>
<span class="sd">    2) If more than 1 filter for those not None in cell_type</span>
<span class="sd">    3a) if empty then add first of initial</span>
<span class="sd">    3b) if not empty then add first of final</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filt_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root_id</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">segment_id_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">with_nan_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">segment_id_name</span><span class="si">}</span><span class="s1"> == </span><span class="si">{</span><span class="n">root_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">non_nan_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">filter_away_nan_rows</span><span class="p">(</span><span class="n">with_nan_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filt_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">with_nan_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filt_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">non_nan_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

    <span class="n">filt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">filt_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filt_df</span></div>
    

<span class="n">cell_type_fine_for_clustering_exc</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;IT_short&#39;</span><span class="p">,</span> <span class="s1">&#39;IT_small_tuft&#39;</span><span class="p">,</span> <span class="s1">&#39;5P_NP&#39;</span><span class="p">,</span> <span class="s1">&#39;IT_big_tuft&#39;</span>
<span class="p">]</span>

<span class="n">cell_type_fine_for_clustering_inh</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Martinotti&#39;</span><span class="p">,</span>
 <span class="s1">&#39;sst&#39;</span><span class="p">,</span>
 <span class="s1">&#39;VIP&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ndnf+npy-&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Pvalb&#39;</span><span class="p">,</span>
 <span class="s1">&#39;bpc&#39;</span><span class="p">,</span>
<span class="c1">#  &#39;l1vip&#39;,</span>
 <span class="s1">&#39;ngfc&#39;</span><span class="p">,</span>
<span class="c1">#  &#39;cb1 basket&#39;,</span>
<span class="c1">#  &#39;small basket&#39;,</span>
<span class="c1">#  &#39;chandelier&#39;</span>
                                    <span class="p">]</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Location where the allen labels are</span>
<span class="sd">ManualCellTypesAllen() &amp; &quot;table_name != &#39;allen_v1_column_types_slanted&#39;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="c1">#--------parameters ----------</span>


<span class="n">cell_type_fine_names</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([</span><span class="n">cell_type_fine_names_excitatory</span><span class="p">,</span>
               <span class="n">cell_type_fine_name_inhibitory</span><span class="p">])</span>
    
<div class="viewcode-block" id="plot_e_i_model_classifier_map"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.plot_e_i_model_classifier_map">[docs]</a><span class="k">def</span> <span class="nf">plot_e_i_model_classifier_map</span><span class="p">(</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">mlu</span><span class="o">.</span><span class="n">plot_classifier_map</span><span class="p">(</span><span class="n">e_i_model</span><span class="p">,</span>
                            <span class="n">feature_1_name</span><span class="o">=</span><span class="n">e_i_model_features_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">feature_2_name</span><span class="o">=</span><span class="n">e_i_model_features_default</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="postsyn_branches_near_soma"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.postsyn_branches_near_soma">[docs]</a><span class="k">def</span> <span class="nf">postsyn_branches_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">perform_axon_classification</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1">#for the synapses filter</span>
    <span class="n">n_synapses_post_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">synapse_post_perc_min</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">plot_syn_post_filt</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1">#for the skeletal length and spine filter</span>
    <span class="n">lower_width_bound</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
    <span class="n">upper_width_bound</span> <span class="o">=</span> <span class="mi">520</span><span class="p">,</span><span class="c1">#380,</span>
    <span class="n">spine_threshold</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">skeletal_distance_threshold</span> <span class="o">=</span> <span class="mi">110000</span><span class="p">,</span><span class="c1">#30000,</span>
    <span class="n">skeletal_length_threshold</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">,</span><span class="c1">#10000</span>

    <span class="n">plot_spines_and_sk_filter</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Do axon classification without best candidate to eliminate possible axons (filters away)</span>
<span class="sd">    2) filter away only branches with a majority postsyns</span>
<span class="sd">    3) apply spine and width restrictions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">perform_axon_classification</span><span class="p">:</span>
        <span class="n">au</span><span class="o">.</span><span class="n">axon_classification_using_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                              <span class="n">return_best_candidate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="n">plot_final_axon</span><span class="o">=</span><span class="kc">False</span>
                                             <span class="p">)</span>


    <span class="n">non_axon_candidates</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">not_matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;non_axon_candidates = </span><span class="si">{</span><span class="n">non_axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="n">syn_post_filt_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">synapse_post_perc</span><span class="p">],</span>
                   <span class="n">query</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(n_synapses_post&gt;</span><span class="si">{</span><span class="n">n_synapses_post_min</span><span class="si">}</span><span class="s2">) and &quot;</span> 
                         <span class="sa">f</span><span class="s2">&quot;synapse_post_perc &gt; </span><span class="si">{</span><span class="n">synapse_post_perc_min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">non_axon_candidates</span><span class="p">,</span>
                    <span class="n">plot_limb_branch_dict</span><span class="o">=</span><span class="n">plot_syn_post_filt</span>
                   <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_post_filt_limb_branch = </span><span class="si">{</span><span class="n">syn_post_filt_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">query_postsyn_filter</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(distance_from_soma&lt;</span><span class="si">{</span><span class="n">skeletal_distance_threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
                                                       <span class="sa">f</span><span class="s2">&quot; and (no_spine_median_mesh_center &gt; </span><span class="si">{</span><span class="n">lower_width_bound</span><span class="si">}</span><span class="s2">)&quot;</span>
                                                       <span class="sa">f</span><span class="s2">&quot; and (no_spine_median_mesh_center &lt; </span><span class="si">{</span><span class="n">upper_width_bound</span><span class="si">}</span><span class="s2">)&quot;</span>
                                                      <span class="sa">f</span><span class="s2">&quot; and (n_spines &gt; </span><span class="si">{</span><span class="n">spine_threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
                                                       <span class="sa">f</span><span class="s2">&quot; and skeletal_length &gt; </span><span class="si">{</span><span class="n">skeletal_length_threshold</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query_postsyn_filter = </span><span class="si">{</span><span class="n">query_postsyn_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">spines_and_sk_filt_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance_from_soma&quot;</span><span class="p">,</span><span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;n_spines&quot;</span><span class="p">,</span><span class="s2">&quot;spine_density&quot;</span><span class="p">,</span><span class="s2">&quot;skeletal_length&quot;</span><span class="p">],</span>
                                                <span class="n">query</span><span class="o">=</span><span class="p">(</span><span class="n">query_postsyn_filter</span>
                                                      <span class="p">),</span>
                                                <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">syn_post_filt_limb_branch</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spines_and_sk_filt_limb_branch = </span><span class="si">{</span><span class="n">spines_and_sk_filt_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_spines_and_sk_filter</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting plot_spines_and_sk_filter&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">spines_and_sk_filt_limb_branch</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">spines_and_sk_filt_limb_branch</span></div>

<div class="viewcode-block" id="postsyn_branches_near_soma_for_syn_post_density"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.postsyn_branches_near_soma_for_syn_post_density">[docs]</a><span class="k">def</span> <span class="nf">postsyn_branches_near_soma_for_syn_post_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                    <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    
                                                    <span class="n">spine_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">skeletal_length_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                    <span class="n">upper_width_bound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To restrict the branches close to the soma that will be used </span>
<span class="sd">    for postsynaptic density</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from neurd import cell_type_utils as ctu</span>

<span class="sd">    output_limb_branch = ctu.postsyn_branches_near_soma_for_syn_post_density(</span>
<span class="sd">                            neuron_obj = neuron_obj_exc_syn_sp,</span>
<span class="sd">                           verbose = True)</span>
<span class="sd">                           </span>
<span class="sd">    from neurd import neuron_visualizations as nviz</span>
<span class="sd">    nviz.plot_limb_branch_dict(neuron_obj_exc_syn_sp,</span>
<span class="sd">                              output_limb_branch)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spine_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spine_threshold</span> <span class="o">=</span> <span class="n">spine_threshold_syn_density_global</span>
    <span class="k">if</span> <span class="n">skeletal_length_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_threshold</span> <span class="o">=</span> <span class="n">skeletal_length_threshold_syn_density_global</span>
    <span class="k">if</span> <span class="n">upper_width_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">upper_width_bound</span><span class="o">=</span> <span class="n">upper_width_bound_syn_density_global</span>
    
    <span class="k">return</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">spine_threshold</span> <span class="o">=</span> <span class="n">spine_threshold</span><span class="p">,</span>
            <span class="n">skeletal_length_threshold</span> <span class="o">=</span> <span class="n">skeletal_length_threshold</span><span class="p">,</span>
            <span class="n">upper_width_bound</span> <span class="o">=</span> <span class="n">upper_width_bound</span><span class="p">,</span>
            <span class="n">plot_spines_and_sk_filter</span> <span class="o">=</span> <span class="n">plot_spines_and_sk_filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
    
<span class="c1">#     if special_syn_parameters:</span>
<span class="c1">#         return ctu.postsyn_branches_near_soma(</span>
<span class="c1">#             neuron_obj,</span>
<span class="c1">#             spine_threshold = -1,</span>
<span class="c1">#             skeletal_length_threshold = 5000,</span>
<span class="c1">#             upper_width_bound = 10000,</span>
<span class="c1">#             plot_spines_and_sk_filter = plot_spines_and_sk_filter,</span>
<span class="c1">#             **kwargs)</span>
<span class="c1">#     else:</span>
<span class="c1">#         return ctu.postsyn_branches_near_soma(</span>
<span class="c1">#             neuron_obj,</span>
<span class="c1">#             spine_threshold = -1,</span>
<span class="c1">#             skeletal_length_threshold = 5000,</span>
<span class="c1">#             plot_spines_and_sk_filter = plot_spines_and_sk_filter,</span>
<span class="c1">#             **kwargs)</span>
    


<div class="viewcode-block" id="synapse_density_near_soma"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.synapse_density_near_soma">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                              <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                              <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                              <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">plot_spines_and_sk_filter</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Application: To be used for cell type (E/I)</span>
<span class="sd">    classification</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma_for_syn_post_density</span><span class="p">(</span>
                                <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="n">plot_spines_and_sk_filter</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_density_over_limb_branch</span><span class="p">(</span>
        <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span>
        <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="n">return_skeletal_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">density</span></div>

<div class="viewcode-block" id="synapse_density_stats"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.synapse_density_stats">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_stats</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">return_skeletal_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">                          </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose To compute synapse densities that </span>
<span class="sd">    could be used for E/I classification</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">syn_density_post</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">synapse_type</span><span class="o">=</span><span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">syn_density_head</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">synapse_type</span><span class="o">=</span><span class="s2">&quot;synapses_head&quot;</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">syn_density_neck</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">synapse_type</span><span class="o">=</span><span class="s2">&quot;synapses_neck&quot;</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">syn_density_shaft</span><span class="p">,</span><span class="n">sk_length</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">synapse_type</span><span class="o">=</span><span class="s2">&quot;synapses_shaft&quot;</span><span class="p">,</span>
                                <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_density_post = </span><span class="si">{</span><span class="n">syn_density_post</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_density_head = </span><span class="si">{</span><span class="n">syn_density_head</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_density_neck = </span><span class="si">{</span><span class="n">syn_density_neck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_density_shaft = </span><span class="si">{</span><span class="n">syn_density_shaft</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sk_length_synapse_density = </span><span class="si">{</span><span class="n">sk_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    
    
    <span class="n">return_value</span> <span class="o">=</span>  <span class="p">[</span><span class="n">syn_density_post</span><span class="p">,</span><span class="n">syn_density_head</span><span class="p">,</span><span class="n">syn_density_neck</span><span class="p">,</span><span class="n">syn_density_shaft</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">return_skeletal_length</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sk_length</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">return_value</span></div>



<div class="viewcode-block" id="spine_density_near_soma"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.spine_density_near_soma">[docs]</a><span class="k">def</span> <span class="nf">spine_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">limb_branch_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                            <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">lower_width_bound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">upper_width_bound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To compute the spine </span>
<span class="sd">    density over branches near the soma</span>

<span class="sd">    Application: To be used for </span>
<span class="sd">    cell classification</span>

<span class="sd">    Ex: </span>
<span class="sd">    ctu.spine_density_near_soma(neuron_obj = neuron_obj_exc_syn_sp,</span>
<span class="sd">        verbose = True,</span>
<span class="sd">        multiplier = 1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lower_width_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower_width_bound</span> <span class="o">=</span> <span class="n">lower_width_bound_spine_global</span>
    <span class="k">if</span> <span class="n">upper_width_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">upper_width_bound</span> <span class="o">=</span> <span class="n">upper_width_bound_spine_global</span>
    
    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">postsyn_limb_branch</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                             <span class="n">lower_width_bound</span><span class="o">=</span><span class="n">lower_width_bound</span><span class="p">,</span>
                                                             <span class="n">upper_width_bound</span><span class="o">=</span><span class="n">upper_width_bound</span><span class="p">,</span>
                                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">postsyn_limb_branch</span> <span class="o">=</span> <span class="n">limb_branch_dict</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;postsyn_limb_branch = </span><span class="si">{</span><span class="n">postsyn_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">spine_density</span><span class="p">,</span><span class="n">sk_length</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_density_over_limb_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                       <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">postsyn_limb_branch</span><span class="p">,</span>
                                      <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                      <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span>
                                                      <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spine_density = </span><span class="si">{</span><span class="n">spine_density</span><span class="si">}</span><span class="s2"> (multiplier = </span><span class="si">{</span><span class="n">multiplier</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sk_length spine density = </span><span class="si">{</span><span class="n">sk_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_skeletal_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spine_density</span><span class="p">,</span><span class="n">sk_length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spine_density</span></div>

<span class="c1"># ------------ 8/28 E/I Classifier ---------------</span>

<div class="viewcode-block" id="load_manual_exc_inh_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.load_manual_exc_inh_df">[docs]</a><span class="k">def</span> <span class="nf">load_manual_exc_inh_df</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">manual_df_path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">manual_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span><span class="n">manual_df_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="n">manual_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span><span class="n">manual_df_path_backup</span><span class="p">)</span>
    
    <span class="k">global</span> <span class="n">manual_exc_df</span>
    <span class="k">global</span> <span class="n">manual_inh_df</span>
    
    <span class="n">manual_exc_df</span> <span class="o">=</span> <span class="n">manual_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type==&#39;excitatory&#39;&quot;</span><span class="p">)</span>
    <span class="n">manual_inh_df</span> <span class="o">=</span> <span class="n">manual_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type==&#39;inhibitory&#39;&quot;</span><span class="p">)</span>
    <span class="n">manual_inh_df</span><span class="p">[</span><span class="s2">&quot;cell_type_manual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inhibitory&quot;</span>
    <span class="n">manual_exc_df</span><span class="p">[</span><span class="s2">&quot;cell_type_manual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excitatory&quot;</span></div>


<div class="viewcode-block" id="set_e_i_model_as_kNN"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.set_e_i_model_as_kNN">[docs]</a><span class="k">def</span> <span class="nf">set_e_i_model_as_kNN</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                         <span class="n">y</span><span class="p">,</span>
                         <span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">plot_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To create the kNN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">mlu</span><span class="o">.</span><span class="n">kNN_classifier</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
                   <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span>
                   <span class="n">plot_map</span> <span class="o">=</span> <span class="n">plot_map</span><span class="p">,</span>
                   <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">map_fill_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,],</span>
                    <span class="n">scatter_colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">],</span>
                             <span class="o">**</span><span class="n">kwargs</span>
                  <span class="p">)</span>
    <span class="k">return</span> <span class="n">clf</span></div>

<div class="viewcode-block" id="set_e_i_model"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.set_e_i_model">[docs]</a><span class="k">def</span> <span class="nf">set_e_i_model</span><span class="p">(</span><span class="n">features</span><span class="o">=</span> <span class="n">e_i_model_features_default</span><span class="p">,</span>
                  <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
                  <span class="n">add_features_to_model_obj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;logistic_reg&quot;</span><span class="p">,</span><span class="c1">#&quot;kNN&quot;,</span>
                  <span class="n">plot_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">return_new_model</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span>
                 <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To set the module e/i classifier</span>
<span class="sd">    </span>
<span class="sd">    Ex: How to specify different features for the classification</span>
<span class="sd">    ctu.set_e_i_model(plot_map = True,</span>
<span class="sd">                 features= [&quot;spine_density&quot;,&quot;syn_density_shaft&quot;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">e_i_model</span>
    
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;kNN&quot;</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">manual_exc_df</span>
        <span class="k">global</span> <span class="n">manual_inh_df</span>

        <span class="k">if</span> <span class="n">manual_exc_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">manual_inh_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctu</span><span class="o">.</span><span class="n">load_manual_exc_inh_df</span><span class="p">()</span>

        <span class="n">class_exc</span> <span class="o">=</span> <span class="n">manual_exc_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">class_inh</span> <span class="o">=</span> <span class="n">manual_inh_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">exc_features</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">columns_values_from_df</span><span class="p">(</span><span class="n">manual_exc_df</span><span class="p">,</span><span class="n">features</span><span class="p">)</span>
        <span class="n">inh_features</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">columns_values_from_df</span><span class="p">(</span><span class="n">manual_inh_df</span><span class="p">,</span><span class="n">features</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">class_inh</span><span class="p">,</span><span class="n">class_exc</span><span class="p">])</span>

        <span class="n">total_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> 
                                      <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inh_features</span><span class="p">,</span><span class="n">exc_features</span><span class="p">)]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">total_features</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;kNN&quot;</span><span class="p">:</span>
            <span class="n">clf</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">set_e_i_model_as_kNN</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                             <span class="n">y</span><span class="p">,</span>
                            <span class="n">plot_map</span> <span class="o">=</span> <span class="n">plot_map</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented model type: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                

    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;logistic_reg&quot;</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_model_as_logistic_reg_on_border_df</span><span class="p">(</span><span class="n">plot_decision_map</span> <span class="o">=</span> <span class="n">plot_map</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_features_to_model_obj</span><span class="p">:</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_new_model</span><span class="p">:</span>
        <span class="n">e_i_model</span> <span class="o">=</span> <span class="n">clf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">clf</span></div>
        
    
<div class="viewcode-block" id="predict_class_single_datapoint"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.predict_class_single_datapoint">[docs]</a><span class="k">def</span> <span class="nf">predict_class_single_datapoint</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span>
                                  <span class="n">data</span><span class="p">,</span>
                                  <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">return_probability</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To predict the class of a single datapoint</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    data = [1,1]</span>
<span class="sd">    mlu.predict_class_single_datapoint(clf,data,verbose = True)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pred_class</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class = </span><span class="si">{</span><span class="n">pred_class</span><span class="si">}</span><span class="s2"> for data = </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2"> with prediction probability </span><span class="si">{</span><span class="n">pred_prob</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_probability</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pred_class</span><span class="p">,</span><span class="n">pred_prob</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pred_class</span></div>
    
<div class="viewcode-block" id="e_i_classification_single"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_classification_single">[docs]</a><span class="k">def</span> <span class="nf">e_i_classification_single</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                              <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">return_label_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">plot_on_model_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">return_probability</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Right now usually done with </span>
<span class="sd">    &#39;syn_density_shaft&#39;, &#39;spine_density&#39; but can specify other features</span>
<span class="sd">    </span>
<span class="sd">    ctu.e_i_classification_single([0.5,0.6],</span>
<span class="sd">                              features = [&quot;spine_density&quot;,&quot;syn_density_shaft&quot;],</span>
<span class="sd">                              verbose = True)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">model</span> <span class="o">=</span> <span class="n">e_i_model</span>
        
    <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">features</span> <span class="o">!=</span> <span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting features from previously </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="s2"> to now </span><span class="si">{</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">set_e_i_model</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span><span class="n">return_new_model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;with features: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">pred_class</span><span class="p">,</span><span class="n">pred_prob</span> <span class="o">=</span> <span class="n">predict_class_single_datapoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">return_probability</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pred_class_label</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">pred_class</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pred_class_label</span> <span class="o">=</span> <span class="n">pred_class</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pred_class = </span><span class="si">{</span><span class="n">pred_class</span><span class="si">}</span><span class="s2">, pred_class_label = </span><span class="si">{</span><span class="n">pred_class_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="c1">#print(f&quot;plot_on_model_map = {plot_on_model_map}&quot;)</span>
    <span class="k">if</span> <span class="n">plot_on_model_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;******* ATTEMPTING TO PLT ON MODEL MAP****&quot;</span><span class="p">)</span>
        <span class="c1">#mlu.plot_classifier_map(model,data_to_plot = data,)</span>
        <span class="n">ctu</span><span class="o">.</span><span class="n">plot_classifier_map</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_class_label</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">return_label_name</span><span class="p">:</span>
        <span class="n">return_class</span> <span class="o">=</span> <span class="n">pred_class_label</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_class</span> <span class="o">=</span> <span class="n">pred_class</span>
        
    <span class="k">if</span> <span class="n">return_probability</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pred_class</span><span class="p">,</span><span class="n">pred_prob</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pred_class</span></div>

<div class="viewcode-block" id="e_i_classification_from_neuron_obj_old"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_classification_from_neuron_obj_old">[docs]</a><span class="k">def</span> <span class="nf">e_i_classification_from_neuron_obj_old</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                      <span class="n">features</span> <span class="o">=</span> <span class="n">e_i_model_features_default</span><span class="p">,</span>
                                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_cell_type_info</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">return_dendrite_branch_stats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">plot_on_model_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       
                                       <span class="c1">#parameters for hand-made rules</span>
                                      <span class="n">apply_hand_made_low_rules</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="n">skeletal_length_processed_syn_min</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
                                      <span class="n">skeletal_length_processed_spine_min</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
                                       
                                       <span class="n">excitatory_spine_density_min</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                       
                                       <span class="c1">#visualization arguments</span>
                                       <span class="n">plot_spines_and_sk_filter_for_syn</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">plot_spines_and_sk_filter_for_spine</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       
                                       <span class="n">special_syn_parameters</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                       
                                      <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To take a neuron object and classify it as </span>
<span class="sd">    excitatory or inhibitory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma_for_syn_post_density</span><span class="p">(</span>
                                <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="n">plot_spines_and_sk_filter_for_syn</span><span class="p">,</span>
        <span class="n">special_syn_parameters</span><span class="o">=</span><span class="n">special_syn_parameters</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,)</span>
    
    <span class="p">(</span><span class="n">syn_density_post</span><span class="p">,</span>
             <span class="n">syn_density_head</span><span class="p">,</span>
             <span class="n">syn_density_neck</span><span class="p">,</span>
             <span class="n">syn_density_shaft</span><span class="p">,</span>
             <span class="n">skeletal_length_processed_syn</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_stats</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    
    <span class="p">(</span><span class="n">spine_density</span><span class="p">,</span>
     <span class="n">skeletal_length_processed_spine</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">spine_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                                <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="n">plot_spines_and_sk_filter_for_spine</span><span class="p">,</span>
                                                <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
    
    <span class="n">baylor_cell_type_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">syn_density_post</span> <span class="o">=</span> <span class="n">syn_density_post</span><span class="p">,</span>
                        <span class="n">syn_density_head</span> <span class="o">=</span> <span class="n">syn_density_head</span><span class="p">,</span>
                        <span class="n">syn_density_neck</span> <span class="o">=</span> <span class="n">syn_density_neck</span><span class="p">,</span>
                        <span class="n">syn_density_shaft</span> <span class="o">=</span> <span class="n">syn_density_shaft</span><span class="p">,</span>
                        <span class="n">skeletal_length_processed_syn</span><span class="o">=</span><span class="n">skeletal_length_processed_syn</span><span class="p">,</span>
                        <span class="n">spine_density</span><span class="o">=</span><span class="n">spine_density</span><span class="p">,</span>
                        <span class="n">skeletal_length_processed_spine</span> <span class="o">=</span> <span class="n">skeletal_length_processed_spine</span>
            <span class="p">)</span>
    
    <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">apply_hand_made_low_rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">skeletal_length_processed_syn</span> <span class="o">&lt;</span> <span class="n">skeletal_length_processed_syn_min</span> <span class="p">)</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">skeletal_length_processed_spine</span> <span class="o">&lt;</span> <span class="n">skeletal_length_processed_spine_min</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classified as Inhibitory because skeletal_length_processed_syn or skeletal_length_processed_spine below min&quot;</span><span class="p">)</span>
            <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="s2">&quot;inhibitory&quot;</span>
        <span class="k">elif</span> <span class="n">spine_density</span> <span class="o">&lt;</span> <span class="n">excitatory_spine_density_min</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classified as Inhibitory because spine_density below min (</span><span class="si">{</span><span class="n">excitatory_spine_density_min</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="s2">&quot;inhibitory&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No manual rules applied&quot;</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">baylor_e_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_classification_single</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">globs</span><span class="p">,</span><span class="n">locs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">features</span><span class="p">],</span>
                                  <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                  <span class="n">return_label_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">plot_on_model_map</span><span class="o">=</span><span class="n">plot_on_model_map</span><span class="p">,</span>
                                 <span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_dendrite_branch_stats</span> <span class="ow">and</span> <span class="n">return_cell_type_info</span><span class="p">:</span>
        <span class="n">dendr_stats</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">dendrite_branch_stats_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dendr_stats:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dendr_stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">baylor_cell_type_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dendr_stats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for e/i calculations = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;baylor_e_i = </span><span class="si">{</span><span class="n">baylor_e_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_cell_type_info</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">baylor_e_i</span><span class="p">,</span><span class="n">baylor_cell_type_info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">baylor_e_i</span></div>
    
<div class="viewcode-block" id="e_i_classification_from_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_classification_from_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">e_i_classification_from_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                      <span class="n">features</span> <span class="o">=</span> <span class="n">e_i_model_features_default</span><span class="p">,</span>
                                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_cell_type_info</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">return_dendrite_branch_stats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">plot_on_model_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       
                                       <span class="c1">#parameters for hand-made rules</span>
                                      <span class="n">apply_hand_made_low_rules</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">skeletal_length_processed_syn_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">skeletal_length_processed_spine_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       
                                       <span class="n">inhibitory_syn_density_shaft_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       
                                       <span class="c1">#visualization arguments</span>
                                       <span class="n">plot_spines_and_sk_filter_for_syn</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">plot_spines_and_sk_filter_for_spine</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       
                                       <span class="n">e_i_classification_single</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">return_probability</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                       
                                       <span class="o">**</span><span class="n">kwargs</span>
                                       
                                      <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To take a neuron object and classify it as </span>
<span class="sd">    excitatory or inhibitory</span>
<span class="sd">    </span>
<span class="sd">    The hand written rules moves the y intercept of the classifier from </span>
<span class="sd">    0.372 to 0.4 </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma_for_syn_post_density</span><span class="p">(</span>
                                <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="n">plot_spines_and_sk_filter_for_syn</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to do syn_density stats&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">syn_density_post</span><span class="p">,</span>
             <span class="n">syn_density_head</span><span class="p">,</span>
             <span class="n">syn_density_neck</span><span class="p">,</span>
             <span class="n">syn_density_shaft</span><span class="p">,</span>
             <span class="n">skeletal_length_processed_syn</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">synapse_density_stats</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to do spine_density stats&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">spine_density</span><span class="p">,</span>
     <span class="n">skeletal_length_processed_spine</span><span class="p">)</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">spine_density_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                                <span class="n">plot_spines_and_sk_filter</span><span class="o">=</span><span class="n">plot_spines_and_sk_filter_for_spine</span><span class="p">,</span>
                                                <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done stats&quot;</span><span class="p">)</span>
    <span class="n">baylor_cell_type_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">syn_density_post</span> <span class="o">=</span> <span class="n">syn_density_post</span><span class="p">,</span>
                        <span class="n">syn_density_head</span> <span class="o">=</span> <span class="n">syn_density_head</span><span class="p">,</span>
                        <span class="n">syn_density_neck</span> <span class="o">=</span> <span class="n">syn_density_neck</span><span class="p">,</span>
                        <span class="n">syn_density_shaft</span> <span class="o">=</span> <span class="n">syn_density_shaft</span><span class="p">,</span>
                        <span class="n">skeletal_length_processed_syn</span><span class="o">=</span><span class="n">skeletal_length_processed_syn</span><span class="p">,</span>
                        <span class="n">spine_density</span><span class="o">=</span><span class="n">spine_density</span><span class="p">,</span>
                        <span class="n">skeletal_length_processed_spine</span> <span class="o">=</span> <span class="n">skeletal_length_processed_spine</span>
            <span class="p">)</span>
    
    <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">apply_hand_made_low_rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">skeletal_length_processed_syn</span> <span class="o">&lt;</span> <span class="n">skeletal_length_processed_syn_min</span> <span class="p">)</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">skeletal_length_processed_spine</span> <span class="o">&lt;</span> <span class="n">skeletal_length_processed_spine_min</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classified as Inhibitory because skeletal_length_processed_syn or skeletal_length_processed_spine below min&quot;</span><span class="p">)</span>
            <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="s2">&quot;inhibitory&quot;</span>
        <span class="k">elif</span> <span class="n">syn_density_shaft</span> <span class="o">&lt;</span> <span class="n">inhibitory_syn_density_shaft_min</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classified as excitatory because syn_density_shaft below min (</span><span class="si">{</span><span class="n">inhibitory_syn_density_shaft_min</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">baylor_e_i</span> <span class="o">=</span> <span class="s2">&quot;excitatory&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No manual rules applied&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not apply_hand_made_low_rules&quot;</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">baylor_e_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">baylor_e_i</span><span class="p">,</span><span class="n">baylor_e_i_prob</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_classification_single</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">globs</span><span class="p">,</span><span class="n">locs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">features</span><span class="p">],</span>
                                  <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                  <span class="n">return_label_name</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">plot_on_model_map</span><span class="o">=</span><span class="n">plot_on_model_map</span><span class="p">,</span>
                                    <span class="n">return_probability</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_cell_type_info</span> <span class="ow">and</span> <span class="n">return_probability</span><span class="p">:</span>
            <span class="n">baylor_cell_type_info</span><span class="p">[</span><span class="s2">&quot;baylor_cell_type_exc_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baylor_e_i_prob</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plot_on_model_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;******* ATTEMPTING TO PLT ON MODEL MAP****&quot;</span><span class="p">)</span>
            <span class="c1">#mlu.plot_classifier_map(model,data_to_plot = data,)</span>
            <span class="n">ctu</span><span class="o">.</span><span class="n">plot_classifier_map</span><span class="p">(</span> <span class="n">e_i_model</span><span class="p">,</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">globs</span><span class="p">,</span><span class="n">locs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">features</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                                    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">baylor_e_i</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="n">return_dendrite_branch_stats</span> <span class="ow">and</span> <span class="n">return_cell_type_info</span><span class="p">:</span>
        <span class="n">dendr_stats</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">dendrite_branch_stats_near_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dendr_stats:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dendr_stats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">baylor_cell_type_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dendr_stats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for e/i calculations = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;baylor_e_i = </span><span class="si">{</span><span class="n">baylor_e_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_cell_type_info</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">baylor_e_i</span><span class="p">,</span><span class="n">baylor_cell_type_info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_probability</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">baylor_e_i</span><span class="p">,</span><span class="n">baylor_e_i_prob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">baylor_e_i</span></div>
    
    
    
<div class="viewcode-block" id="dendrite_branch_stats_near_soma"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.dendrite_branch_stats_near_soma">[docs]</a><span class="k">def</span> <span class="nf">dendrite_branch_stats_near_soma</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_spines_and_sk_filter</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get features of the dendrite branches</span>
<span class="sd">    from an unclassified neuron</span>

<span class="sd">    Applicaiton: Can be used to help with E/I cell typing</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the branches near the soma up to certain distance</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    ctu.dendrite_branch_stats_near_soma(neuron_obj,)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># near_branches = ctu.postsyn_branches_near_soma(</span>
    <span class="c1"># neuron_obj,</span>
    <span class="c1"># plot_syn_post_filt = False,</span>
    <span class="c1"># upper_width_bound = 100000,</span>
    <span class="c1"># skeletal_distance_threshold = 150_000,</span>
    <span class="c1"># skeletal_length_threshold = 2_000,</span>

    <span class="c1"># plot_spines_and_sk_filter = True,</span>
    <span class="c1">#     verbose = True</span>
    <span class="c1"># )</span>

    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">near_branches</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">postsyn_branches_near_soma_for_syn_post_density</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">plot_spines_and_sk_filter</span> <span class="o">=</span> <span class="n">plot_spines_and_sk_filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">near_branches</span> <span class="o">=</span> <span class="n">limb_branch_dict</span>


    <span class="n">dendr_branches_dict</span> <span class="o">=</span> <span class="n">nst</span><span class="o">.</span><span class="n">branch_stats_over_limb_branch</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">near_branches</span><span class="p">)</span>

    <span class="n">dendr_branches_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;dendrite_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dendr_branches_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">return</span> <span class="n">dendr_branches_dict</span></div>


<div class="viewcode-block" id="soma_stats_for_cell_type"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.soma_stats_for_cell_type">[docs]</a><span class="k">def</span> <span class="nf">soma_stats_for_cell_type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stats we want to include about the soma</span>
<span class="sd">    to maybe help cell type</span>

<span class="sd">    surface_area</span>
<span class="sd">    volume</span>
<span class="sd">    sa_to_volume</span>
<span class="sd">    ray_trace_percentile_70</span>
<span class="sd">    n_syn_soma</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">soma_mesh</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span>
    <span class="n">soma_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">n_syn_soma</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_synapses</span><span class="p">,</span>
        <span class="n">soma_surface_area</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">surface_area</span><span class="p">(</span><span class="n">soma_mesh</span><span class="p">)</span><span class="o">/</span><span class="mi">1_000_000</span><span class="p">,</span>
        <span class="n">soma_volume</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_volume</span><span class="p">(</span><span class="n">soma_mesh</span><span class="p">)</span><span class="o">/</span><span class="mi">1_000_000_000</span><span class="p">,</span>
        <span class="n">soma_ray_trace_percentile_70</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_size</span><span class="p">(</span><span class="n">soma_mesh</span><span class="p">,</span>
                                               <span class="n">size_type</span> <span class="o">=</span> <span class="s2">&quot;ray_trace_percentile&quot;</span><span class="p">,</span>
                                               <span class="n">percentile</span><span class="o">=</span><span class="mi">70</span><span class="p">),</span>
        <span class="n">soma_sa_to_volume</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">surface_area_to_volume</span><span class="p">(</span><span class="n">soma_mesh</span><span class="p">)</span>
        
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">soma_dict</span></div>

<span class="c1"># ===================== 10/11: improved E/I Classification ================</span>




<div class="viewcode-block" id="load_border_exc_inh_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.load_border_exc_inh_df">[docs]</a><span class="k">def</span> <span class="nf">load_border_exc_inh_df</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">border_df_path</span><span class="p">,</span>
                          <span class="n">path_backup</span> <span class="o">=</span> <span class="n">border_df_path_backup</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">manual_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="n">manual_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span><span class="n">path_backup</span><span class="p">)</span>
    
    <span class="k">global</span> <span class="n">border_exc_df</span>
    <span class="k">global</span> <span class="n">border_inh_df</span>
    
    <span class="n">border_exc_df</span> <span class="o">=</span> <span class="n">manual_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type_manual==&#39;excitatory&#39;&quot;</span><span class="p">)</span>
    <span class="n">border_inh_df</span> <span class="o">=</span> <span class="n">manual_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type_manual==&#39;inhibitory&#39;&quot;</span><span class="p">)</span></div>
    
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">machine_learning_tools</span> <span class="kn">import</span> <span class="n">visualizations_ml</span> <span class="k">as</span> <span class="n">vml</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">vml</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="e_i_model_as_logistic_reg_on_border_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.e_i_model_as_logistic_reg_on_border_df">[docs]</a><span class="k">def</span> <span class="nf">e_i_model_as_logistic_reg_on_border_df</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cell_type_manual&quot;</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_weight</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;excitatory&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},</span>
    <span class="n">plot_decision_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_type</span> <span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span><span class="c1"># &quot;classes&quot;</span>
    <span class="n">use_handmade_params</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_model_features_default</span>
    

    <span class="n">ctu</span><span class="o">.</span><span class="n">load_border_exc_inh_df</span><span class="p">()</span>
    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ctu</span><span class="o">.</span><span class="n">border_exc_df</span><span class="p">,</span><span class="n">ctu</span><span class="o">.</span><span class="n">border_inh_df</span><span class="p">])</span>

    <span class="n">clf</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="n">features</span><span class="p">],</span><span class="n">combined_df</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">use_handmade_params</span><span class="p">:</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_model_logistic_coef</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">e_i_model_logistic_intercept</span>

    <span class="k">if</span> <span class="n">plot_decision_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vml</span><span class="p">:</span>
            <span class="n">vml</span><span class="o">.</span><span class="n">contour_map_for_2D_classifier</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span>
                                             <span class="c1">#color_type = &quot;probability&quot;,</span>
                                             <span class="n">color_type</span> <span class="o">=</span> <span class="n">plot_type</span><span class="p">,</span>
                                             <span class="n">training_df</span><span class="o">=</span><span class="n">combined_df</span><span class="p">,</span>
                                             <span class="n">training_df_class_name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                             <span class="n">training_df_feature_names</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                                             <span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">_fit_X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">clf</span></div>



<div class="viewcode-block" id="plot_classifier_map"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.plot_classifier_map">[docs]</a><span class="k">def</span> <span class="nf">plot_classifier_map</span><span class="p">(</span><span class="n">clf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span>
                       <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">df_class_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">df_feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        
                       <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">clf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">e_i_model</span>
        
    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">_fit_X</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">_y</span>
        
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">border_training_df</span><span class="p">()</span>
        <span class="n">cell_type_manual</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
    <span class="k">if</span> <span class="n">df_feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">df_feature_names</span><span class="o">=</span> <span class="n">e_i_model_features_default</span><span class="c1">#[&quot;syn_density_shaft&quot;, &quot;spine_density&quot;]</span>
    <span class="k">if</span> <span class="n">vml</span><span class="p">:</span>
        <span class="n">vml</span><span class="o">.</span><span class="n">contour_map_for_2D_classifier</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span>
                                             <span class="c1">#color_type = &quot;probability&quot;,</span>
                                             <span class="n">color_type</span> <span class="o">=</span> <span class="n">plot_type</span><span class="p">,</span>
                                             <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span>
                                             <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                                          <span class="n">training_df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                             <span class="n">training_df_class_name</span><span class="o">=</span><span class="n">df_class_name</span><span class="p">,</span>
                                             <span class="n">training_df_feature_names</span><span class="o">=</span><span class="n">df_feature_names</span><span class="p">,</span>
                                              <span class="n">feature_names</span> <span class="o">=</span> <span class="n">df_feature_names</span><span class="p">,</span>

                                             <span class="p">)</span></div>
    
<div class="viewcode-block" id="border_training_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.border_training_df">[docs]</a><span class="k">def</span> <span class="nf">border_training_df</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ctu</span><span class="o">.</span><span class="n">border_exc_df</span><span class="p">,</span><span class="n">ctu</span><span class="o">.</span><span class="n">border_inh_df</span><span class="p">])</span></div>
<div class="viewcode-block" id="all_training_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.all_training_df">[docs]</a><span class="k">def</span> <span class="nf">all_training_df</span><span class="p">(</span><span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">ctu</span><span class="o">.</span><span class="n">load_manual_exc_inh_df</span><span class="p">()</span>
    <span class="n">ctu</span><span class="o">.</span><span class="n">load_border_exc_inh_df</span><span class="p">()</span>
    
    <span class="n">train_df</span> <span class="o">=</span>  <span class="n">pu</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ctu</span><span class="o">.</span><span class="n">manual_exc_df</span><span class="p">,</span>
           <span class="n">ctu</span><span class="o">.</span><span class="n">border_exc_df</span><span class="p">,</span>
          <span class="n">ctu</span><span class="o">.</span><span class="n">manual_inh_df</span><span class="p">,</span>
          <span class="n">ctu</span><span class="o">.</span><span class="n">border_inh_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting training data&quot;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;syn_density_post&quot;</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;spine_density&quot;</span><span class="p">,</span>
                        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cell_type&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">train_df</span></div>


<span class="n">cell_type_fine_redundant_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Unsure I&quot;</span><span class="p">:</span><span class="s2">&quot;Unsure&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MC&quot;</span><span class="p">:</span><span class="s2">&quot;Martinotti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bc&quot;</span><span class="p">:</span><span class="s2">&quot;BC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bpc&quot;</span><span class="p">:</span><span class="s2">&quot;BPC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sst&quot;</span><span class="p">:</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="cell_type_fine_name_cleaner"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.cell_type_fine_name_cleaner">[docs]</a><span class="k">def</span> <span class="nf">cell_type_fine_name_cleaner</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fine_cell_type_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;6IT&#39;</span><span class="p">:</span><span class="s2">&quot;6P_IT&quot;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="s2">&quot;pandas&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">)):</span>
        <span class="n">cell_type_fine</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cell_type_fine&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cell_type_fine</span> <span class="o">=</span> <span class="n">row</span>
        
    <span class="k">if</span> <span class="n">cell_type_fine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">cell_type_fine</span> <span class="o">=</span> <span class="n">cell_type_fine</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cell_type_fine</span> <span class="ow">in</span> <span class="n">fine_cell_type_mapping</span><span class="p">:</span>
        <span class="n">cell_type_fine</span> <span class="o">=</span> <span class="n">fine_cell_type_mapping</span><span class="p">[</span><span class="n">cell_type_fine</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">cell_type_fine</span> <span class="ow">in</span> <span class="n">cell_type_fine_redundant_mapping</span><span class="p">:</span>
        <span class="n">cell_type_fine</span> <span class="o">=</span> <span class="n">cell_type_fine_redundant_mapping</span><span class="p">[</span><span class="n">cell_type_fine</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">cell_type_fine</span></div>

<div class="viewcode-block" id="clean_cell_type_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.clean_cell_type_fine">[docs]</a><span class="k">def</span> <span class="nf">clean_cell_type_fine</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_type_fine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">new_column_from_row_function</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">cell_type_fine_name_cleaner</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



    
<div class="viewcode-block" id="df_cell_type_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.df_cell_type_fine">[docs]</a><span class="k">def</span> <span class="nf">df_cell_type_fine</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type_fine == cell_type_fine&quot;</span><span class="p">)</span>
    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">clean_cell_type_fine</span><span class="p">(</span><span class="n">df_fine</span><span class="p">)</span>
    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cell_type_fine != &#39;Unsure E&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_fine</span></div>

<span class="c1">#feature_df = pu.csv_to_df(&quot;/neuron_mesh_tools/Auto_Proofreading/Cell_Type_Classifier/microns_autoproofread_features_v2.csv&quot;)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">feature_df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">module_path</span> <span class="o">/</span> <span class="s2">&quot;microns_autoproofread_features_v2.csv&quot;</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">feature_df</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="cell_type_from_feature_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.cell_type_from_feature_df">[docs]</a><span class="k">def</span> <span class="nf">cell_type_from_feature_df</span><span class="p">(</span><span class="n">segment_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;id==&#39;</span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1"># --------------- For comparing the accuracy of cell types ---------------</span>
<div class="viewcode-block" id="accuracy_df_by_cell_type_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.accuracy_df_by_cell_type_fine">[docs]</a><span class="k">def</span> <span class="nf">accuracy_df_by_cell_type_fine</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cell_type_fine_label</span> <span class="o">=</span> <span class="s2">&quot;cell_type_fine&quot;</span><span class="p">,</span>
    <span class="n">cell_type_coarse_label</span> <span class="o">=</span> <span class="s2">&quot;cell_type_coarse&quot;</span><span class="p">,</span>
    <span class="n">add_overall</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">e_i_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;allen&quot;</span><span class="p">,</span><span class="s2">&quot;bcm&quot;</span><span class="p">,</span><span class="s2">&quot;bcm_gnn&quot;</span><span class="p">],</span>
    <span class="p">):</span>
    
    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(cell_type_fine not in [&#39;Unsure&#39;,&#39;Unsure E&#39;]) and (cell_type_fine == cell_type_fine)&quot;</span><span class="p">)</span>
    
    <span class="n">cell_type_fine_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fine</span><span class="p">[</span><span class="n">cell_type_fine_label</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cell_type_fine_classes = </span><span class="si">{</span><span class="n">cell_type_fine_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">e_i_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">e_i_methods</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;cell_type_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e_i_methods = </span><span class="si">{</span><span class="n">e_i_methods</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">accuracy_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span>  <span class="n">cell_type_fine_classes</span><span class="p">:</span>
        <span class="n">df_fine_lab</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cell_type_fine_label</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">curr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cell_type_label</span> <span class="o">=</span> <span class="n">lab</span><span class="p">,</span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_fine_lab</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of cells </span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fine_lab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ct_method</span> <span class="ow">in</span> <span class="n">e_i_methods</span><span class="p">:</span>
            <span class="n">curr_label</span> <span class="o">=</span> <span class="n">df_fine_lab</span><span class="p">[</span><span class="n">cell_type_coarse_label</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_label</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">curr_label</span> <span class="o">=</span> <span class="n">curr_label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df_fine_lab</span><span class="p">[</span><span class="n">cell_type_coarse_label</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_fine_lab</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cell_type_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="n">n_correct</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fine_lab</span><span class="p">)</span>
            <span class="n">curr_dict</span><span class="p">[</span><span class="s2">&quot;e_i_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_label</span>
            <span class="n">curr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;e_i_n_correct_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_correct</span>
            <span class="n">curr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;e_i_accuracy_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy</span>

        <span class="n">accuracy_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_dict</span><span class="p">)</span>
    <span class="n">df_fine_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">accuracy_results</span><span class="p">)</span>
    <span class="n">df_fine_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">df_fine_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;e_i_type==&#39;excitatory&#39;&quot;</span><span class="p">),</span>
        <span class="n">df_fine_results</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;e_i_type==&#39;inhibitory&#39;&quot;</span><span class="p">),</span>
    <span class="p">])</span>
    
    <span class="k">if</span> <span class="n">add_overall</span><span class="p">:</span>
        <span class="n">new_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">overall_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;excitatory&quot;</span><span class="p">,</span><span class="s2">&quot;inhibitory&quot;</span><span class="p">,</span><span class="s2">&quot;total&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">overall_type</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span>
                <span class="n">e_i_type</span> <span class="o">=</span> <span class="s2">&quot;exc and inh&quot;</span>
                <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df_fine</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e_i_type</span> <span class="o">=</span> <span class="n">overall_type</span>
                <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cell_type_coarse_label</span><span class="si">}</span><span class="s2"> == &#39;</span><span class="si">{</span><span class="n">overall_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                
                
            
            <span class="n">overall_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">cell_type_label</span> <span class="o">=</span> <span class="n">overall_type</span><span class="p">,</span>
                <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_curr</span><span class="p">),</span>
                <span class="n">e_i_type</span> <span class="o">=</span> <span class="n">e_i_type</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ct_method</span> <span class="ow">in</span> <span class="n">e_i_methods</span><span class="p">:</span>
                <span class="n">n_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df_curr</span><span class="p">[</span><span class="n">cell_type_coarse_label</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_curr</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cell_type_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
                <span class="n">accuracy</span> <span class="o">=</span> <span class="n">n_correct</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_curr</span><span class="p">)</span>
                <span class="n">overall_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;e_i_n_correct_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_correct</span>
                <span class="n">overall_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;e_i_accuracy_</span><span class="si">{</span><span class="n">ct_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy</span>
            
            <span class="n">new_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overall_dict</span><span class="p">)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">new_dicts</span><span class="p">)</span>
        <span class="n">df_fine_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fine_results</span><span class="p">,</span><span class="n">new_df</span><span class="p">])</span>
    
    <span class="n">df_fine_results</span> <span class="o">=</span> <span class="n">df_fine_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df_fine_results</span></div>

<div class="viewcode-block" id="rename_dict_for_cell_type_fine"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.rename_dict_for_cell_type_fine">[docs]</a><span class="k">def</span> <span class="nf">rename_dict_for_cell_type_fine</span><span class="p">(</span>
    <span class="n">keep_classes_inh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_classes_exc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">default_name_inh</span> <span class="o">=</span> <span class="s2">&quot;Other Inh&quot;</span><span class="p">,</span>
    <span class="n">default_name_exc</span> <span class="o">=</span> <span class="s2">&quot;Other Exc&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Generate a renaming</span>
<span class="sd">    dictionary based on which exc</span>
<span class="sd">    and inhibitory classes you want</span>
<span class="sd">    to retain their name and which</span>
<span class="sd">    you want to group into a default name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">keep_classes_inh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_classes_inh</span><span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">if</span> <span class="n">keep_classes_exc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_classes_exc</span> <span class="o">=</span> <span class="p">[]</span>
    

    <span class="n">rename_dict_inh</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
        <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keep_classes_inh</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">default_name_inh</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ctu</span><span class="o">.</span><span class="n">allen_cell_type_fine_classifier_labels_inh</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">rename_dict_exc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
        <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keep_classes_exc</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">default_name_exc</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ctu</span><span class="o">.</span><span class="n">allen_cell_type_fine_classifier_labels_exc</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">rename_dict</span> <span class="o">=</span> <span class="n">rename_dict_inh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rename_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename_dict_exc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Dict:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">rename_dict</span></div>

<div class="viewcode-block" id="rename_cell_type_fine_column"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.rename_cell_type_fine_column">[docs]</a><span class="k">def</span> <span class="nf">rename_cell_type_fine_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;gnn_cell_type_fine&quot;</span><span class="p">,</span>
    <span class="n">keep_classes_exc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_classes_inh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_place</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">fine_map</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">rename_dict_for_cell_type_fine</span><span class="p">(</span>
        <span class="n">keep_classes_exc</span> <span class="o">=</span> <span class="n">keep_classes_exc</span><span class="p">,</span>
        <span class="n">keep_classes_inh</span> <span class="o">=</span> <span class="n">keep_classes_inh</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pu</span><span class="o">.</span><span class="n">map_column_with_dict</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
        <span class="n">dict_map</span><span class="o">=</span><span class="n">fine_map</span><span class="p">,</span>
    <span class="p">)</span></div>





<div class="viewcode-block" id="plot_cell_type_gnn_embedding"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.plot_cell_type_gnn_embedding">[docs]</a><span class="k">def</span> <span class="nf">plot_cell_type_gnn_embedding</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    
    <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="n">color_map</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">trans_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;umap0&quot;</span><span class="p">,</span><span class="s2">&quot;umap1&quot;</span><span class="p">]</span> <span class="p">,</span> 
    <span class="n">nucleus_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">plot_unlabeld</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">unlabeled_color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
    
    <span class="n">use_labels_as_text_to_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="n">figure_width</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">figure_height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    
    <span class="n">size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">size_labeled</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">alpha_labeled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

    <span class="n">plot_legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 

    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;GNN Classifier - Whole Neuron</span><span class="se">\n</span><span class="s2">UMAP Embedding&quot;</span><span class="p">,</span>
    <span class="n">axes_fontsize</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">title_fontsize</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">title_append</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to plot certain embeddings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="n">ctu</span><span class="o">.</span><span class="n">cell_type_fine_color_map</span>
    
    <span class="k">if</span> <span class="n">title_append</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">title_append</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figure_width</span><span class="p">,</span><span class="n">figure_height</span><span class="p">))</span>

    <span class="c1"># Plotting the background data</span>
    <span class="k">if</span> <span class="n">plot_unlabeld</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">nucleus_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or (nucleus_id not in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">nucleus_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_plot</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">vml</span><span class="o">.</span><span class="n">plot_df_scatter_classification</span><span class="p">(</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">,</span>
            <span class="n">feature_names</span> <span class="o">=</span> <span class="n">trans_cols</span><span class="p">,</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">unlabeled_color</span><span class="p">,</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trans_cols</span><span class="p">),</span>
            <span class="n">use_labels_as_text_to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">replace_None_with_str_None</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
            <span class="n">plot_legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
        <span class="p">)</span>


    <span class="k">if</span> <span class="n">nucleus_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and (nucleus_id in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">nucleus_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>



    <span class="n">ax</span> <span class="o">=</span> <span class="n">vml</span><span class="o">.</span><span class="n">plot_df_scatter_classification</span><span class="p">(</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">,</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">trans_cols</span><span class="p">,</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="n">column</span><span class="p">,</span>
        <span class="n">target_to_color</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trans_cols</span><span class="p">),</span>
        <span class="n">use_labels_as_text_to_plot</span><span class="o">=</span><span class="n">use_labels_as_text_to_plot</span><span class="p">,</span>
        <span class="n">replace_None_with_str_None</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_labeled</span><span class="p">,</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
        <span class="n">plot_legend</span> <span class="o">=</span> <span class="n">plot_legend</span><span class="p">,</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">size_labeled</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">mu</span><span class="o">.</span><span class="n">turn_off_axes_tickmarks</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="n">mu</span><span class="o">.</span><span class="n">set_axes_title_size</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">x_fontsize</span><span class="o">=</span><span class="n">axes_fontsize</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">axes_fontsize</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">title_fontsize</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">axes_fontsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">axes_fontsize</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="cell_type_high_probability_df_from_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.cell_type_high_probability_df_from_df">[docs]</a><span class="k">def</span> <span class="nf">cell_type_high_probability_df_from_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">cell_type</span><span class="p">,</span>
    <span class="n">baylor_exc_prob_threshold</span> <span class="o">=</span> <span class="mf">0.65</span><span class="p">,</span>
    <span class="n">gnn_prob_threshold</span> <span class="o">=</span> <span class="mf">0.65</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_df</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Table after proofreading of cells</span>
<span class="sd">    that are highly likely to be excitatory</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># using the logistic regression model</span>
    <span class="n">df_filt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;(cell_type == &#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">&#39;)&quot;</span> 
        <span class="sa">f</span><span class="s2">&quot;and (baylor_cell_type_exc_probability_after_proof &gt;= </span><span class="si">{</span><span class="n">baylor_exc_prob_threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After baylor exc threshold, # of </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2"> cells = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_filt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># if there was a gnn classification it needs to be high fidelity</span>
    <span class="n">df_filt</span><span class="o">=</span> <span class="n">df_filt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;((gnn_cell_type_coarse == &#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">&#39;) and (gnn_cell_type_fine_prob &gt;= </span><span class="si">{</span><span class="n">gnn_prob_threshold</span><span class="si">}</span><span class="s2">))&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;or (gnn_cell_type_coarse != gnn_cell_type_coarse)&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After gnn exc threshold, # of </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2"> cells = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_filt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_filt</span></div>
    
<div class="viewcode-block" id="excitatory_high_probability_df_from_df"><a class="viewcode-back" href="../../neurd.html#neurd.cell_type_utils.excitatory_high_probability_df_from_df">[docs]</a><span class="k">def</span> <span class="nf">excitatory_high_probability_df_from_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">baylor_exc_prob_threshold</span> <span class="o">=</span> <span class="mf">0.65</span><span class="p">,</span>
    <span class="n">gnn_prob_threshold</span> <span class="o">=</span> <span class="mf">0.65</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

    <span class="k">return</span> <span class="n">cell_type_high_probability_df_from_df</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">cell_type</span><span class="o">=</span><span class="s1">&#39;excitatory&#39;</span><span class="p">,</span>
        <span class="n">baylor_exc_prob_threshold</span> <span class="o">=</span> <span class="n">baylor_exc_prob_threshold</span><span class="p">,</span>
        <span class="n">gnn_prob_threshold</span> <span class="o">=</span> <span class="n">gnn_prob_threshold</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>

<span class="c1"># ---------- Setting of parameters ---------- </span>

<span class="n">attributes_dict_default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="p">)</span>    

<span class="n">global_parameters_dict_default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">lower_width_bound_spine</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
    <span class="n">upper_width_bound_spine</span> <span class="o">=</span> <span class="mi">520</span><span class="p">,</span>
    
    <span class="n">apply_hand_made_low_rules</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">skeletal_length_processed_syn_min</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
    <span class="n">skeletal_length_processed_spine_min</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
    <span class="n">inhibitory_syn_density_shaft_min</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>

    <span class="c1"># spine densitys limb branch dict</span>
    <span class="n">spine_threshold_syn_density</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">skeletal_length_threshold_syn_density</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">upper_width_bound_syn_density</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">attributes_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">attributes_dict_h01</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_h01</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">lower_width_bound_spine</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">upper_width_bound_spine</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># data_type = &quot;default&quot;</span>
<span class="c1"># algorithms = None</span>
<span class="c1"># modules_to_set = [ctu, (spu,&quot;head_neck_shaft&quot;)]</span>

<span class="c1"># def set_global_parameters_and_attributes_by_data_type(dt,</span>
<span class="c1">#                                                      algorithms_list = None,</span>
<span class="c1">#                                                       modules = None,</span>
<span class="c1">#                                                      set_default_first = True,</span>
<span class="c1">#                                                       verbose=False):</span>
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     modu.set_global_parameters_and_attributes_by_data_type(modules,dt,</span>
<span class="c1">#                                                           algorithms=algorithms_list,</span>
<span class="c1">#                                                           set_default_first = set_default_first,</span>
<span class="c1">#                                                           verbose = verbose)</span>
    
<span class="c1"># set_global_parameters_and_attributes_by_data_type(data_type,</span>
<span class="c1">#                                                    algorithms)</span>

<span class="c1"># def output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#     modules = None,</span>
<span class="c1">#     algorithms = None,</span>
<span class="c1">#     verbose = True,</span>
<span class="c1">#     lowercase = True,</span>
<span class="c1">#     output_types = (&quot;global_parameters&quot;),</span>
<span class="c1">#     include_default = True,</span>
<span class="c1">#     algorithms_only = False,</span>
<span class="c1">#     **kwargs):</span>
    
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     return modu.output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#         modules,</span>
<span class="c1">#         algorithms = algorithms,</span>
<span class="c1">#         verbose = verbose,</span>
<span class="c1">#         lowercase = lowercase,</span>
<span class="c1">#         output_types = output_types,</span>
<span class="c1">#         include_default = include_default,</span>
<span class="c1">#         algorithms_only = algorithms_only,</span>
<span class="c1">#         **kwargs,</span>
<span class="c1">#         )</span>



<span class="c1">#--- from neurd_packages ---</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">axon_utils</span> <span class="k">as</span> <span class="n">au</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_searching</span> <span class="k">as</span> <span class="n">ns</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_statistics</span> <span class="k">as</span> <span class="n">nst</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_utils</span> <span class="k">as</span> <span class="n">nru</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_visualizations</span> <span class="k">as</span> <span class="n">nviz</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">spine_utils</span> <span class="k">as</span> <span class="n">spu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">synapse_utils</span> <span class="k">as</span> <span class="n">syu</span>

<span class="c1">#--- from machine_learning_tools ---</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">machine_learning_tools</span> <span class="kn">import</span> <span class="n">machine_learning_utils</span> <span class="k">as</span> <span class="n">mlu</span>
    <span class="kn">from</span> <span class="nn">machine_learning_tools</span> <span class="kn">import</span> <span class="n">visualizations_ml</span> <span class="k">as</span> <span class="n">vml</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">mlu</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vml</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#--- from mesh_tools ---</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="n">trimesh_utils</span> <span class="k">as</span> <span class="n">tu</span>

<span class="c1">#--- from datasci_tools ---</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">matplotlib_utils</span> <span class="k">as</span> <span class="n">mu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span> 
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">pandas_utils</span> <span class="k">as</span> <span class="n">pu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">pathlib_utils</span> <span class="k">as</span> <span class="n">plu</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">string_utils</span> <span class="k">as</span> <span class="n">stru</span>
<span class="kn">from</span> <span class="nn">datasci_tools</span> <span class="kn">import</span> <span class="n">system_utils</span> <span class="k">as</span> <span class="n">su</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">cell_type_utils</span> <span class="k">as</span> <span class="n">ctu</span>

<span class="n">set_e_i_model</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Brendan Celii.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>