

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neurd.axon_utils &mdash; neurd  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            neurd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">neurd</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">neurd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../neurd.html">neurd</a></li>
      <li class="breadcrumb-item active">neurd.axon_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neurd.axon_utils</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_struct_utils</span> <span class="k">as</span> <span class="n">dsu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.h01_volume_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_interface</span> <span class="k">as</span> <span class="n">hvu</span>

<span class="n">axon_version</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1">#version that finds the axon using bare synapse branches</span>
<span class="n">axon_version</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1">#improved synapse filtering for axon</span>
<span class="n">axon_version</span> <span class="o">=</span> <span class="mi">9</span> <span class="c1">#Using Baylor cell types for axon finding</span>
<span class="n">axon_thick_threshold</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">axon_ais_threshold</span> <span class="o">=</span> <span class="mi">180</span>

<span class="c1"># excitatory_axon_ais_max_search_distance = 14_000</span>
<span class="c1"># inhibitory_axon_ais_max_search_distance = 70_000</span>

<span class="c1"># excitatory_axon_soma_angle_threshold = 70</span>


<div class="viewcode-block" id="axon_width"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_width">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_width</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
              <span class="n">width_name</span><span class="o">=</span><span class="s2">&quot;no_bouton_median&quot;</span><span class="p">,</span>
               <span class="n">width_name_backup</span><span class="o">=</span><span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">,</span>
               <span class="n">width_name_backup_2</span> <span class="o">=</span> <span class="s2">&quot;median_mesh_center&quot;</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the widht of the branch (specifically in the axon case)</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    branch_obj = neuron_obj[&quot;L6&quot;][0]</span>
<span class="sd">    au.axon_width(branch_obj)</span>

<span class="sd">    nviz.visualize_neuron(neuron_obj,</span>
<span class="sd">                         limb_branch_dict=dict(L6=[0]),</span>
<span class="sd">                         mesh_color=&quot;red&quot;,</span>
<span class="sd">                         mesh_whole_neuron=True)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curr_branch</span> <span class="o">=</span> <span class="n">branch_obj</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">width_jump</span> <span class="o">=</span> <span class="n">curr_branch</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">width_name</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">width_jump</span> <span class="o">=</span> <span class="n">curr_branch</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">width_name_backup</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">width_jump</span> <span class="o">=</span> <span class="n">curr_branch</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">width_name_backup_2</span><span class="p">]</span> 
    <span class="k">return</span> <span class="n">width_jump</span></div>




<div class="viewcode-block" id="filter_axon_limb_false_positive_end_nodes"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.filter_axon_limb_false_positive_end_nodes">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">filter_axon_limb_false_positive_end_nodes</span><span class="p">(</span><span class="n">curr_limb</span><span class="p">,</span><span class="n">curr_limb_axon_like_nodes</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">skeleton_length_threshold</span><span class="o">=</span><span class="mi">30000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will remove end nodes that were accidentally mistaken as axons</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">final_axon_like_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">curr_limb_axon_like_nodes</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_limb_axon_like_nodes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1">#2) Filter for only those that are end nodes</span>
        <span class="n">axon_node_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xu</span><span class="o">.</span><span class="n">get_node_degree</span><span class="p">(</span><span class="n">curr_limb</span><span class="o">.</span><span class="n">concept_network</span><span class="p">,</span><span class="n">curr_limb_axon_like_nodes</span><span class="p">))</span>
        <span class="n">end_node_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">axon_node_degrees</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_node_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes_to_check</span> <span class="o">=</span> <span class="n">curr_limb_axon_like_nodes</span><span class="p">[</span><span class="n">end_node_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n_name</span> <span class="ow">in</span> <span class="n">nodes_to_check</span><span class="p">:</span>
                <span class="n">curr_sk_length</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">calculate_skeleton_distance</span><span class="p">(</span><span class="n">curr_limb</span><span class="p">[</span><span class="n">n_name</span><span class="p">]</span><span class="o">.</span><span class="n">skeleton</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">curr_sk_length</span> <span class="o">&gt;</span> <span class="n">skeleton_length_threshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping because skeleton too long: </span><span class="si">{</span><span class="n">curr_sk_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">curr_neighbors</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">curr_limb</span><span class="o">.</span><span class="n">concept_network</span><span class="p">,</span><span class="n">n_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;curr_neighbors = </span><span class="si">{</span><span class="n">curr_neighbors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_neighbors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping because no neighbors&quot;</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">curr_neighbors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">curr_limb_axon_like_nodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping because neighbor axon&quot;</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping end node </span><span class="si">{</span><span class="n">n_name</span><span class="si">}</span><span class="s2"> because neighbor was dendrite&quot;</span><span class="p">)</span>
                    <span class="n">final_axon_like_nodes</span> <span class="o">=</span> <span class="n">final_axon_like_nodes</span><span class="p">[</span><span class="n">final_axon_like_nodes</span> <span class="o">!=</span> <span class="n">n_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">final_axon_like_nodes</span></div>



<div class="viewcode-block" id="filter_axon_neuron_false_positive_end_nodes"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.filter_axon_neuron_false_positive_end_nodes">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">filter_axon_neuron_false_positive_end_nodes</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">current_axons_dict</span><span class="p">):</span>
    <span class="n">filtered_axon_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">limb_name_key</span><span class="p">,</span><span class="n">curr_limb_axon_like_nodes</span> <span class="ow">in</span> <span class="n">current_axons_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">curr_limb_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limb_name_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">curr_limb</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">curr_limb_idx</span><span class="p">]</span>
        <span class="n">filtered_axon_dict</span><span class="p">[</span><span class="n">limb_name_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_axon_limb_false_positive_end_nodes</span><span class="p">(</span><span class="n">curr_limb</span><span class="p">,</span><span class="n">curr_limb_axon_like_nodes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_axon_dict</span></div>

<div class="viewcode-block" id="axon_like_segments"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_like_segments">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_like_segments</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">include_ais</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">filter_away_end_false_positives</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">visualize_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">width_to_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">current_neuron</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="n">axon_like_limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">axon_width_like_segments</span><span class="p">(</span><span class="n">current_neuron</span><span class="p">,</span>
                                                        <span class="n">include_ais</span><span class="o">=</span><span class="n">include_ais</span><span class="p">,</span>
                                                             <span class="n">width_to_use</span><span class="o">=</span><span class="n">width_to_use</span><span class="p">,</span>
                                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    
    
    
    <span class="n">current_functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;axon_segment&quot;</span><span class="p">]</span>
    <span class="n">limb_branch_dict_upstream_filter</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">current_neuron</span><span class="p">,</span>
                                       <span class="n">query</span><span class="o">=</span><span class="s2">&quot;axon_segment==True&quot;</span><span class="p">,</span>
                                       <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">limb_branch_dict</span> <span class="o">=</span><span class="n">axon_like_limb_branch_dict</span><span class="p">,</span>
                                                            <span class="n">downstream_face_threshold</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
                                                            <span class="n">width_match_threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                                           <span class="n">print_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                       <span class="n">functions_list</span><span class="o">=</span><span class="n">current_functions_list</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">filter_away_end_false_positives</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using filter_away_end_false_positives&quot;</span><span class="p">)</span>
        <span class="n">limb_branch_dict_upstream_filter</span> <span class="o">=</span> <span class="n">filter_axon_neuron_false_positive_end_nodes</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                                      <span class="n">limb_branch_dict_upstream_filter</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">visualize_at_end</span><span class="p">:</span>
        <span class="n">colors_dict_returned</span> <span class="o">=</span> <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron</span><span class="p">(</span><span class="n">current_neuron</span><span class="p">,</span>
                                             <span class="n">visualize_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">],</span>
                      <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict_upstream_filter</span><span class="p">,</span>
                     <span class="n">mesh_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                     <span class="n">mesh_color_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">mesh_whole_neuron</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">return_color_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">limb_branch_dict_upstream_filter</span></div>




<div class="viewcode-block" id="bouton_meshes"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.bouton_meshes">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">bouton_meshes</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                 <span class="n">clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="c1">#4,</span>
                 <span class="n">smoothness</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">plot_segmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">filter_away_end_meshes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">cdf_threshold</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">,</span><span class="c1">#0.30,# 0.35,</span>
                  <span class="n">plot_boutons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">skeleton</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">min_size_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="c1">#50,#None,</span>
                  <span class="n">max_size_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#600,350,#185,#None,</span>
                  <span class="n">size_type</span><span class="o">=</span><span class="s2">&quot;faces&quot;</span><span class="p">,</span>
                  <span class="n">plot_boutons_after_size_threshold</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">ray_trace_filter</span> <span class="o">=</span> <span class="s2">&quot;ray_trace_percentile&quot;</span><span class="p">,</span> <span class="c1">#&quot;ray_trace_median&quot;</span>
                  <span class="n">ray_trace_percentile</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
                  <span class="n">ray_trace_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#270,</span>
                  <span class="n">return_non_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">exclude_end_meshes_from_non_boutons</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">return_cdf_widths</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">end_mesh_method</span> <span class="o">=</span> <span class="s2">&quot;endpoint_radius&quot;</span><span class="p">,</span>
                  <span class="n">endpoint_radius_threshold</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                  <span class="n">skeletal_length_max</span> <span class="o">=</span> <span class="mi">2200</span><span class="p">,</span>
                 <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">min_size_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_size_threshold</span> <span class="o">=</span> <span class="n">min_size_threshold_bouton_global</span>
    <span class="k">if</span> <span class="n">max_size_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_size_threshold</span> <span class="o">=</span> <span class="n">max_size_threshold_bouton_global</span>
    <span class="k">if</span> <span class="n">ray_trace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_trace_threshold</span> <span class="o">=</span> <span class="n">ray_trace_threshold_bouton_global</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the bouton and non-bouton mesh pieces</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    from mesh_tools import trimesh_utils as tu</span>
<span class="sd">    b_meshes,non_b_meshes = au.bouton_meshes(branch_obj,</span>
<span class="sd">                     clusters=4,</span>
<span class="sd">                     smoothness=0.1,</span>
<span class="sd">                      plot_segmentation=True,</span>
<span class="sd">                     filter_away_end_meshes=True,</span>
<span class="sd">                     cdf_threshold = 0.35,</span>
<span class="sd">                     verbose=True,</span>
<span class="sd">                     min_size_threshold =50,</span>
<span class="sd">                     max_size_threshold=200,</span>
<span class="sd">                     size_type = &quot;faces&quot;,</span>
<span class="sd">                    return_non_boutons = True,</span>
<span class="sd">                    ray_trace_filter = &quot;ray_trace_percentile&quot;,              </span>
<span class="sd">                    ray_trace_percentile = 70,</span>
<span class="sd">                      ray_trace_threshold = 270,</span>
<span class="sd">                     )</span>
<span class="sd">    b_meshes,non_b_meshes</span>
<span class="sd">    </span>
<span class="sd">    ** Note: Tried using side_length_ratios and volume_ratios as other features</span>
<span class="sd">    to filter on but did not seem immediately useful **</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">neurd</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span> <span class="o">==</span> <span class="n">neuron</span><span class="o">.</span><span class="n">Branch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">skeleton</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">skeleton</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">skeleton</span>
            
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">mesh</span>
        
        
    
    <span class="n">new_meshes</span><span class="p">,</span> <span class="n">cgal_info</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_segmentation</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                    <span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">,</span>
                    <span class="n">smoothness</span><span class="o">=</span><span class="n">smoothness</span><span class="p">)</span>
    
    <span class="n">new_meshes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_meshes</span><span class="p">)</span>
    <span class="n">cgal_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cgal_info</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_segmentation</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation Info:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">m</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">new_meshes</span><span class="p">,</span><span class="n">cgal_info</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">meshes</span><span class="o">=</span><span class="n">new_meshes</span><span class="p">,</span>
                         <span class="n">meshes_colors</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">)</span>
    
        

    <span class="n">boutons_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cgal_info</span><span class="o">&gt;</span><span class="n">cdf_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bouton_meshes</span> <span class="o">=</span> <span class="n">new_meshes</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
    <span class="n">bouton_meshes_cdf</span> <span class="o">=</span> <span class="n">cgal_info</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
    
    
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> After CDF Trheshold:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of bouton meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boutons_idx = </span><span class="si">{</span><span class="n">boutons_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes = </span><span class="si">{</span><span class="n">bouton_meshes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes_cdf = </span><span class="si">{</span><span class="n">bouton_meshes_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        

        
    <span class="c1">#calculating the indexes of the end meshes</span>
    <span class="k">if</span> <span class="n">exclude_end_meshes_from_non_boutons</span> <span class="ow">or</span> <span class="n">filter_away_end_meshes</span><span class="p">:</span>
        
        <span class="kn">from</span><span class="w"> </span><span class="nn">mesh_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">skeleton_utils</span> <span class="k">as</span> <span class="n">sk</span>
        <span class="n">end_meshes_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">end_coordinate</span> <span class="ow">in</span> <span class="n">sk</span><span class="o">.</span><span class="n">find_branch_endpoints</span><span class="p">(</span><span class="n">skeleton</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">end_mesh_method</span> <span class="o">==</span> <span class="s2">&quot;closest_mesh&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using closest_mesh method for filter_away_end_meshes&quot;</span><span class="p">)</span>
                    
                <span class="n">closest_index</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">closest_mesh_to_coordinate</span><span class="p">(</span><span class="n">new_meshes</span><span class="p">,</span><span class="n">end_coordinate</span><span class="p">,</span><span class="n">return_mesh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">distance_method</span><span class="o">=</span><span class="s2">&quot;min_distance_and_bbox_center&quot;</span><span class="p">)</span>
                <span class="n">end_meshes_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">closest_index</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">end_mesh_method</span> <span class="o">==</span> <span class="s2">&quot;endpoint_radius&quot;</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using endpoint_radius with radius </span><span class="si">{</span><span class="n">endpoint_radius_threshold</span><span class="si">}</span><span class="s2"> method for filter_away_end_meshes&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">endpoint_radius_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;end_mesh_method = </span><span class="si">{</span><span class="n">end_mesh_method</span><span class="si">}</span><span class="s2"> but endpoint_radius_threshold is None&quot;</span><span class="p">)</span>
                <span class="n">mesh_idx_within_raidus</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">filter_meshes_by_containing_coordinates</span><span class="p">(</span><span class="n">new_meshes</span><span class="p">,</span>
                                                                          <span class="n">nullifying_points</span><span class="o">=</span><span class="p">[</span><span class="n">end_coordinate</span><span class="p">],</span>
                                                <span class="n">filter_away</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span>
                                           <span class="n">distance_threshold</span><span class="o">=</span><span class="n">endpoint_radius_threshold</span><span class="p">,</span>
                                           <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">end_meshes_idx</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mesh_idx_within_raidus</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented type: </span><span class="si">{</span><span class="n">end_mesh_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        
    <span class="k">if</span> <span class="n">filter_away_end_meshes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bouton_meshes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;end_meshes_idx = </span><span class="si">{</span><span class="n">end_meshes_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">boutons_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">,</span><span class="n">end_meshes_idx</span><span class="p">)</span>
            <span class="n">bouton_meshes</span> <span class="o">=</span> <span class="n">new_meshes</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
            <span class="n">bouton_meshes_cdf</span> <span class="o">=</span> <span class="n">cgal_info</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--After Filtering End Meshes--&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of bouton meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes = </span><span class="si">{</span><span class="n">bouton_meshes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes_cdf = </span><span class="si">{</span><span class="n">bouton_meshes_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No boutons so not attmepting to filter away&quot;</span><span class="p">)</span>
                
    <span class="n">original_bouton_idx</span> <span class="o">=</span> <span class="n">boutons_idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">min_size_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_size_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying size threshold of </span><span class="si">{</span><span class="n">min_size_threshold</span><span class="si">}</span><span class="s2">&lt; </span><span class="si">{</span><span class="n">size_type</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">max_size_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if min_size_threshold is not None:</span>
<span class="sd">            boutons_idx_min = tu.filter_meshes_by_size(mesh_list=bouton_meshes,</span>
<span class="sd">                              size_threshold=min_size_threshold,</span>
<span class="sd">                             size_type=size_type,</span>
<span class="sd">                              above_threshold=True,</span>
<span class="sd">                              return_indices = True,</span>
<span class="sd">                             verbose=False)</span>
<span class="sd">            if verbose:</span>
<span class="sd">                print(f&quot;boutons_idx_min = {boutons_idx_min}&quot;)</span>
<span class="sd">        else:</span>
<span class="sd">            boutons_idx_min = np.arange(len(bouton_meshes))</span>
<span class="sd">        </span>
<span class="sd">        if min_size_threshold is not None:</span>
<span class="sd">            boutons_idx_max = tu.filter_meshes_by_size(mesh_list=bouton_meshes,</span>
<span class="sd">                              size_threshold=max_size_threshold,</span>
<span class="sd">                             size_type=size_type,</span>
<span class="sd">                              above_threshold=False,</span>
<span class="sd">                              return_indices = True,</span>
<span class="sd">                             verbose=False)</span>
<span class="sd">            if verbose:</span>
<span class="sd">                print(f&quot;boutons_idx_max = {boutons_idx_max}&quot;)</span>
<span class="sd">        else:</span>
<span class="sd">            boutons_idx_max = np.arange(len(bouton_meshes))</span>
<span class="sd">            </span>
<span class="sd">        boutons_idx = np.intersect1d(boutons_idx_min,boutons_idx_max)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boutons_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">filter_meshes_by_size_min_max</span><span class="p">(</span><span class="n">mesh_list</span><span class="o">=</span><span class="n">bouton_meshes</span><span class="p">,</span>
                              <span class="n">min_size_threshold</span><span class="o">=</span><span class="n">min_size_threshold</span><span class="p">,</span>
                            <span class="n">max_size_threshold</span><span class="o">=</span><span class="n">max_size_threshold</span><span class="p">,</span>
                             <span class="n">size_type</span><span class="o">=</span><span class="n">size_type</span><span class="p">,</span>
                              <span class="n">return_indices</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boutons_idx = </span><span class="si">{</span><span class="n">boutons_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">bouton_meshes</span> <span class="o">=</span> <span class="n">bouton_meshes</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">bouton_meshes_cdf</span> <span class="o">=</span> <span class="n">bouton_meshes_cdf</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">original_bouton_idx</span> <span class="o">=</span> <span class="n">original_bouton_idx</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--After Filtering for size --&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of bouton meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes = </span><span class="si">{</span><span class="n">bouton_meshes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes_cdf = </span><span class="si">{</span><span class="n">bouton_meshes_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;original_bouton_idx = </span><span class="si">{</span><span class="n">original_bouton_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">plot_boutons_after_size_threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boutons after size threshold of </span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;min_size_threshold=</span><span class="si">{</span><span class="n">min_size_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
                 <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">max_size_threshold = </span><span class="si">{</span><span class="n">max_size_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                             <span class="n">meshes</span><span class="o">=</span><span class="n">bouton_meshes</span><span class="p">,</span>
                             <span class="n">meshes_colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                
                
        
    <span class="k">if</span> <span class="n">ray_trace_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ray_trace_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--Applying ray trace threshold = </span><span class="si">{</span><span class="n">ray_trace_threshold</span><span class="si">}</span><span class="s2">--&quot;</span><span class="p">)</span>
            
        <span class="n">boutons_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">filter_meshes_by_size</span><span class="p">(</span><span class="n">mesh_list</span><span class="o">=</span><span class="n">bouton_meshes</span><span class="p">,</span>
                              <span class="n">size_threshold</span><span class="o">=</span><span class="n">ray_trace_threshold</span><span class="p">,</span>
                             <span class="n">size_type</span><span class="o">=</span><span class="n">ray_trace_filter</span><span class="p">,</span>
                              <span class="n">above_threshold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">return_indices</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                            <span class="n">percentile</span> <span class="o">=</span> <span class="n">ray_trace_percentile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boutons_idx = </span><span class="si">{</span><span class="n">boutons_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">bouton_meshes</span> <span class="o">=</span> <span class="n">bouton_meshes</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">bouton_meshes_cdf</span> <span class="o">=</span> <span class="n">bouton_meshes_cdf</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">original_bouton_idx</span> <span class="o">=</span> <span class="n">original_bouton_idx</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--After Filtering for ray trace distance --&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of bouton meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes = </span><span class="si">{</span><span class="n">bouton_meshes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes_cdf = </span><span class="si">{</span><span class="n">bouton_meshes_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;original_bouton_idx = </span><span class="si">{</span><span class="n">original_bouton_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    
    
    <span class="k">if</span> <span class="n">skeletal_length_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boutons_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">filter_meshes_by_size</span><span class="p">(</span><span class="n">bouton_meshes</span><span class="p">,</span>
                        <span class="n">size_threshold</span> <span class="o">=</span> <span class="n">skeletal_length_max</span><span class="p">,</span>
                        <span class="n">size_type</span><span class="o">=</span><span class="s2">&quot;skeleton&quot;</span><span class="p">,</span>
                        <span class="n">above_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boutons_idx = </span><span class="si">{</span><span class="n">boutons_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">bouton_meshes</span> <span class="o">=</span> <span class="n">bouton_meshes</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">bouton_meshes_cdf</span> <span class="o">=</span> <span class="n">bouton_meshes_cdf</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        <span class="n">original_bouton_idx</span> <span class="o">=</span> <span class="n">original_bouton_idx</span><span class="p">[</span><span class="n">boutons_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--After Skeleton Filtering Under size </span><span class="si">{</span><span class="n">skeletal_length_max</span><span class="si">}</span><span class="s2"> nm --&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of bouton meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boutons_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes = </span><span class="si">{</span><span class="n">bouton_meshes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bouton_meshes_cdf = </span><span class="si">{</span><span class="n">bouton_meshes_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;original_bouton_idx = </span><span class="si">{</span><span class="n">original_bouton_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    
    
    <span class="k">if</span> <span class="n">plot_boutons</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bouton_meshes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No boutons to plot&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                            <span class="n">meshes</span><span class="o">=</span><span class="n">bouton_meshes</span><span class="p">,</span>
                          <span class="n">meshes_colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">return_cdf_widths</span><span class="p">:</span>
        <span class="n">new_meshes_widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mesh_size</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
                            <span class="n">size_type</span><span class="o">=</span><span class="n">ray_trace_filter</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_meshes</span><span class="p">])</span>
                            
        
        
    <span class="k">if</span> <span class="n">return_non_boutons</span><span class="p">:</span>
        <span class="n">non_bouton_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_meshes</span><span class="p">)),</span><span class="n">original_bouton_idx</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">exclude_end_meshes_from_non_boutons</span><span class="p">:</span>
            <span class="n">non_bouton_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">non_bouton_idx</span><span class="p">,</span><span class="n">end_meshes_idx</span><span class="p">)</span>
        
        <span class="n">non_bouton_meshes</span> <span class="o">=</span> <span class="n">new_meshes</span><span class="p">[</span><span class="n">non_bouton_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; # of non_bouton_meshes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">non_bouton_meshes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">return_cdf_widths</span><span class="p">:</span>
            <span class="n">non_bouton_widths</span> <span class="o">=</span> <span class="n">new_meshes_widths</span><span class="p">[</span><span class="n">non_bouton_idx</span><span class="p">]</span>
            <span class="n">boutons_widths</span> <span class="o">=</span> <span class="n">new_meshes_widths</span><span class="p">[</span><span class="n">original_bouton_idx</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">bouton_meshes</span><span class="p">,</span><span class="n">non_bouton_meshes</span><span class="p">,</span><span class="n">boutons_widths</span><span class="p">,</span><span class="n">non_bouton_widths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bouton_meshes</span><span class="p">,</span><span class="n">non_bouton_meshes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_cdf_widths</span><span class="p">:</span>
            <span class="n">boutons_widths</span> <span class="o">=</span> <span class="n">new_meshes_widths</span><span class="p">[</span><span class="n">original_bouton_idx</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">bouton_meshes</span><span class="p">,</span><span class="n">boutons_widths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bouton_meshes</span></div>
        

<div class="viewcode-block" id="calculate_boutons_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.calculate_boutons_over_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_boutons_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">limb_branch_dict</span><span class="p">,</span>
                     <span class="n">width_name</span> <span class="o">=</span> <span class="s2">&quot;no_bouton_median&quot;</span><span class="p">,</span>
                    <span class="n">old_width_name</span> <span class="o">=</span> <span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">,</span>
                        <span class="n">calculate_bouton_cdfs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">catch_bouton_errors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Psuedocode: Iterate through all of the branch objects and </span>
<span class="sd">    compute the bouton meshes and store as boutons</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">l_idx</span><span class="p">,</span><span class="n">branch_list</span> <span class="ow">in</span> <span class="n">limb_branch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">branch_list</span><span class="p">):</span>
            <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">l_idx</span><span class="p">][</span><span class="n">b</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">catch_bouton_errors</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b_meshes</span><span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">bouton_meshes</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                        <span class="n">return_non_boutons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">return_cdf_widths</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                <span class="k">except</span><span class="p">:</span>
                    <span class="n">b_meshes</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b_meshes</span><span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">bouton_meshes</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                        <span class="n">return_non_boutons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">return_cdf_widths</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="n">branch_obj</span><span class="o">.</span><span class="n">boutons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b_meshes</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">calculate_bouton_cdfs</span><span class="p">:</span>
                <span class="n">branch_obj</span><span class="o">.</span><span class="n">boutons_cdfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tu</span><span class="o">.</span><span class="n">mesh_size</span><span class="p">(</span><span class="n">k</span><span class="p">,</span>
                <span class="n">size_type</span><span class="o">=</span><span class="s2">&quot;ray_trace_percentile&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">boutons</span><span class="p">]</span>


            <span class="c1"># ----- Doing the new width calculation -------- #</span>

            <span class="n">skeleton_segment_size</span><span class="o">=</span><span class="mi">1000</span>
            <span class="n">width_segment_size</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">distance_by_mesh_center</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">no_spines</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">summary_measure</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_meshes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating new width because had </span><span class="si">{</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">n_boutons</span><span class="si">}</span><span class="s2"> boutons&quot;</span><span class="p">)</span>
                <span class="n">current_width_array</span><span class="p">,</span><span class="n">current_width</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">calculate_new_width</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span> 
                              <span class="n">skeleton_segment_size</span><span class="o">=</span><span class="n">skeleton_segment_size</span><span class="p">,</span>
                              <span class="n">width_segment_size</span><span class="o">=</span><span class="n">width_segment_size</span><span class="p">,</span> 
                              <span class="n">distance_by_mesh_center</span><span class="o">=</span><span class="n">distance_by_mesh_center</span><span class="p">,</span>
                              <span class="n">no_spines</span><span class="o">=</span><span class="n">no_spines</span><span class="p">,</span>
                              <span class="n">summary_measure</span><span class="o">=</span><span class="n">summary_measure</span><span class="p">,</span>
                              <span class="n">return_average</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">print_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">no_boutons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">old_width_calculation</span><span class="o">=</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">old_width_name</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_width</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">old_width_name</span><span class="p">]</span>
                <span class="n">current_width_array</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">width_array</span><span class="p">[</span><span class="n">old_width_name</span><span class="p">]</span> 
            <span class="c1">#calculating the mean/width width of boutons and non_boutons</span>

            <span class="n">branch_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">width_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">current_width</span>
            <span class="n">branch_obj</span><span class="o">.</span><span class="n">width_array</span><span class="p">[</span><span class="n">width_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_width_array</span>
        
    <span class="k">return</span> <span class="n">neuron_obj</span></div>
    

<div class="viewcode-block" id="calculate_boutons"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.calculate_boutons">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_boutons</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                     <span class="n">max_bouton_width_to_check</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">plot_axon_branches_to_check</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">width_name</span> <span class="o">=</span> <span class="s2">&quot;no_bouton_median&quot;</span><span class="p">,</span>
                    <span class="n">old_width_name</span> <span class="o">=</span> <span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">,</span>
                    <span class="n">plot_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find boutons on axon branches </span>
<span class="sd">    and then to save off the meshes and the widths</span>
<span class="sd">    without the boutons</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Restrict the axon to only those branches that should be checked</span>
<span class="sd">    for boutons based on their width</span>
<span class="sd">    2) Compute the Boutons for the restricted axon branches</span>
<span class="sd">    3) Plot the boutons if requested</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">max_bouton_width_to_check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_bouton_width_to_check</span> <span class="o">=</span> <span class="n">max_bouton_width_to_check_global</span>



    <span class="n">ax_limb_name</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_name</span>

    <span class="k">if</span> <span class="n">max_bouton_width_to_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">axons_not_checked_for_boutons</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;median_mesh_center&quot;</span><span class="p">,</span><span class="s2">&quot;axon_label&quot;</span><span class="p">],</span>
                       <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(median_mesh_center &gt;= </span><span class="si">{</span><span class="n">max_bouton_width_to_check</span><span class="si">}</span><span class="s2">) and (axon_label == True)&quot;</span><span class="p">,</span>

                       <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">limbs_to_process</span><span class="o">=</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">],</span>
                                           <span class="p">))</span>

        <span class="n">axon_checked_for_boutons</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;median_mesh_center&quot;</span><span class="p">,</span><span class="s2">&quot;axon_label&quot;</span><span class="p">],</span>
                       <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(median_mesh_center &lt; </span><span class="si">{</span><span class="n">max_bouton_width_to_check</span><span class="si">}</span><span class="s2">) and (axon_label == True)&quot;</span><span class="p">,</span>

                       <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">limbs_to_process</span><span class="o">=</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">],</span>
                                           <span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">plot_axon_branches_to_check</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricting Axons to search for boutons using max_bouton_width_to_check = </span><span class="si">{</span><span class="n">max_bouton_width_to_check</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;axons not checked for boutons (blue) = </span><span class="si">{</span><span class="n">axons_not_checked_for_boutons</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="sa">f</span><span class="s2">&quot;axons checked for boutons (red) = </span><span class="si">{</span><span class="n">axon_checked_for_boutons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_axon_branches_to_check</span><span class="p">:</span>
            <span class="n">color_dict</span> <span class="o">=</span> <span class="n">nviz</span><span class="o">.</span><span class="n">limb_branch_dicts_to_combined_color_dict</span><span class="p">([</span><span class="n">axons_not_checked_for_boutons</span><span class="p">,</span>
                                                                       <span class="n">axon_checked_for_boutons</span><span class="p">,</span>
                                                                       <span class="p">],</span>
                                                                      <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">])</span>
            <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                      <span class="n">visualize_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">],</span>
                                      <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span><span class="p">,</span>
                                      <span class="n">mesh_color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">,</span>
                                     <span class="n">mesh_color_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">axon_checked_for_boutons</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span>


    <span class="c1"># Part 2a: Putting placeholder values for those where boutons were not searched for:</span>
    <span class="k">if</span> <span class="n">ax_limb_name</span> <span class="ow">in</span> <span class="n">axon_checked_for_boutons</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">non_bouton_checked_branches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">limb_branch_dict</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">],</span>
                                              <span class="n">axon_checked_for_boutons</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">non_bouton_checked_branches</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">limb_branch_dict</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">non_bouton_checked_branches</span><span class="p">:</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">boutons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">boutons_cdfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">width_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">old_width_name</span><span class="p">]</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">width_array</span><span class="p">[</span><span class="n">width_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span><span class="o">.</span><span class="n">width_array</span><span class="p">[</span><span class="n">old_width_name</span><span class="p">]</span>
        
        
    <span class="c1"># Part 2b: Calculating the Boutons</span>
    
    <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">calculate_boutons_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">axon_checked_for_boutons</span><span class="p">,</span>
                                           <span class="n">width_name</span><span class="o">=</span><span class="n">width_name</span><span class="p">,</span>
                                            <span class="n">old_width_name</span> <span class="o">=</span> <span class="n">old_width_name</span><span class="p">,</span>
                                           <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    
    

    <span class="c1"># Part 3: Plot the boutons if requested</span>
    <span class="k">if</span> <span class="n">plot_boutons</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_boutons</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">mesh_whole_neuron_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                         <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">neuron_obj</span></div>
        

<div class="viewcode-block" id="calculate_axon_webbing_on_branch"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.calculate_axon_webbing_on_branch">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_axon_webbing_on_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">limb_idx</span><span class="p">,</span>
                                 <span class="n">branch_idx</span><span class="p">,</span>
                            <span class="n">allow_plotting</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">plot_intersection_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_intersection_mesh_without_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">split_significance_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot_split</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_split_closest_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">upstream_node_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                            <span class="n">downstream_node_color</span> <span class="o">=</span> <span class="s2">&quot;aqua&quot;</span><span class="p">,</span>
                                     <span class="n">maximum_volume_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#in um**2</span>
                                     <span class="n">minimum_volume_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="c1">#                                      maximum_volume_threshold=None, #in um**2</span>
<span class="c1">#                                      minimum_volume_threshold = None,</span>
                                     <span class="n">smoothness</span> <span class="o">=</span> <span class="mf">0.08</span><span class="p">,</span>
                                <span class="n">clusters</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="c1">#5,</span>
                                    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: If branch has been designated to be searched for a webbing,</span>
<span class="sd">    then run the webbing finding algorithm</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split_significance_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">split_significance_threshold</span> <span class="o">=</span> <span class="n">split_significance_threshold_web_global</span>
        
    <span class="k">if</span> <span class="n">maximum_volume_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maximum_volume_threshold</span> <span class="o">=</span> <span class="n">maximum_volume_threshold_web_global</span>
        
    <span class="k">if</span> <span class="n">minimum_volume_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">minimum_volume_threshold</span> <span class="o">=</span> <span class="n">minimum_volume_threshold_web_global</span>
    
    
    <span class="n">plot_idx</span> <span class="o">=</span> <span class="n">allow_plotting</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">branch_idx</span>
    <span class="n">curr_nx</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">concept_network_directional</span>
    <span class="n">ax_limb</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span>
    
    <span class="c1">#a. find the downstream nodes and generate the mesh of combining upstream and downstream nodes</span>
    <span class="n">d_nodes</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">downstream_nodes</span><span class="p">(</span><span class="n">curr_nx</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

    <span class="n">v_obj</span> <span class="o">=</span> <span class="n">ax_limb</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">d_nodes_obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax_limb</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">d_nodes</span><span class="p">]</span>

    <span class="n">v_mesh_with_boutons</span> <span class="o">=</span> <span class="n">v_obj</span><span class="o">.</span><span class="n">mesh</span>
    <span class="n">d_meshes_with_boutons</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">mesh</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d_nodes_obj</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot_intersection_mesh</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upstream Node (</span><span class="si">{</span><span class="n">upstream_node_color</span><span class="si">}</span><span class="s2">), Downstream Nodes (</span><span class="si">{</span><span class="n">downstream_node_color</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">v_mesh_with_boutons</span><span class="p">,</span>
                          <span class="n">main_mesh_color</span><span class="o">=</span><span class="n">upstream_node_color</span><span class="p">,</span>
                          <span class="n">main_mesh_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">meshes</span><span class="o">=</span><span class="n">d_meshes_with_boutons</span><span class="p">,</span>
                         <span class="n">meshes_colors</span><span class="o">=</span><span class="n">downstream_node_color</span><span class="p">,</span>
                         <span class="n">mesh_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">v_mesh_without_boutons</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">mesh_without_boutons</span><span class="p">(</span><span class="n">v_obj</span><span class="p">)</span>
    <span class="n">d_meshes_without_boutons</span> <span class="o">=</span> <span class="p">[</span><span class="n">nru</span><span class="o">.</span><span class="n">mesh_without_boutons</span><span class="p">(</span><span class="n">d_obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">d_obj</span> <span class="ow">in</span> <span class="n">d_nodes_obj</span><span class="p">]</span>
    <span class="n">intersection_mesh</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">combine_meshes</span><span class="p">([</span><span class="n">v_mesh_without_boutons</span><span class="p">]</span> <span class="o">+</span> <span class="n">d_meshes_without_boutons</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_intersection_mesh_without_boutons</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upstream Node (</span><span class="si">{</span><span class="n">upstream_node_color</span><span class="si">}</span><span class="s2">), Downstream Nodes (</span><span class="si">{</span><span class="n">downstream_node_color</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">v_mesh_without_boutons</span><span class="p">,</span>
                          <span class="n">main_mesh_color</span><span class="o">=</span><span class="n">upstream_node_color</span><span class="p">,</span>
                          <span class="n">main_mesh_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">meshes</span><span class="o">=</span><span class="n">d_meshes_without_boutons</span><span class="p">,</span>
                         <span class="n">meshes_colors</span><span class="o">=</span><span class="n">downstream_node_color</span><span class="p">,</span>
                         <span class="n">mesh_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="c1">#b. Find skeleton points around the intersection</span>

    <span class="n">all_intersecting_skeletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">skeleton</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">d_nodes_obj</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v_obj</span><span class="o">.</span><span class="n">skeleton</span><span class="p">]</span>
    <span class="n">joining_endpoint_1</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">shared_coordiantes</span><span class="p">(</span><span class="n">all_intersecting_skeletons</span><span class="p">,</span>
                         <span class="n">return_one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coordinates_of_intersection</span> <span class="o">=</span> <span class="p">[</span><span class="n">sk</span><span class="o">.</span><span class="n">skeleton_coordinate_offset_from_endpoint</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">joining_endpoint_1</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_intersecting_skeletons</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;joining_endpoint_1 = </span><span class="si">{</span><span class="n">joining_endpoint_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coordinates_of_intersection = </span><span class="si">{</span><span class="n">coordinates_of_intersection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>



    <span class="c1">#c. Split the mesh to only include central part (after filtering away boutons)</span>
    <span class="n">potential_webbing_mesh</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">closest_split_to_coordinate</span><span class="p">(</span><span class="n">intersection_mesh</span><span class="p">,</span>
                              <span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinates_of_intersection</span><span class="p">,</span>
                              <span class="n">plot_split</span><span class="o">=</span><span class="n">plot_split</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">,</span>
                              <span class="n">plot_closest_mesh</span><span class="o">=</span><span class="n">plot_split_closest_mesh</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">,</span>
                              <span class="n">significance_threshold</span> <span class="o">=</span> <span class="n">split_significance_threshold</span><span class="p">,</span>
                              <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maximum_volume_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">minimum_volume_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">maximum_volume_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maximum_volume_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">minimum_volume_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minimum_volume_threshold</span> <span class="o">=</span> <span class="mi">0</span>
            
        
        <span class="n">mesh_segs</span><span class="p">,</span> <span class="n">cgal_info</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_segmentation</span><span class="p">(</span><span class="n">potential_webbing_mesh</span><span class="p">,</span>
                            <span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">,</span>
                            <span class="n">smoothness</span><span class="o">=</span><span class="n">smoothness</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_segmentation_before_web</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before volume filter&quot;</span><span class="p">)</span>
            <span class="n">tu</span><span class="o">.</span><span class="n">plot_segmentation</span><span class="p">(</span><span class="n">mesh_segs</span><span class="p">,</span><span class="n">cgal_info</span><span class="p">)</span>
            
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of segmentation before volume filter = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_segs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         
        
        <span class="n">mesh_segs_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">filter_meshes_by_size_min_max</span><span class="p">(</span>
                            <span class="n">mesh_list</span><span class="o">=</span><span class="n">mesh_segs</span><span class="p">,</span>
                            <span class="n">max_size_threshold</span> <span class="o">=</span> <span class="n">maximum_volume_threshold</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span>
                            <span class="n">min_size_threshold</span> <span class="o">=</span> <span class="n">minimum_volume_threshold</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span>
                            <span class="n">size_type</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span>
                            <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
        
        
<span class="c1">#         mesh_segs_sizes = []</span>
<span class="c1">#         for k in mesh_segs:</span>
<span class="c1">#             try:</span>
<span class="c1">#                 curr_volume = int(tu.mesh_volume(k.bounding_box_oriented)/1000/1000)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 curr_volume = 0</span>
<span class="c1">#             mesh_segs_sizes.append(curr_volume)</span>
            
<span class="c1">#         mesh_segs_sizes = np.array(mesh_segs_sizes)</span>
        
<span class="c1">#         #print(f&quot;mesh_segs_sizes = {mesh_segs_sizes}&quot;)</span>
        
<span class="c1">#         mesh_segs_idx = np.where((mesh_segs_sizes&lt;maximum_volume_threshold) &amp; </span>
<span class="c1">#                                 (mesh_segs_sizes&gt;=minimum_volume_threshold))[0]</span>
        
        <span class="n">mesh_segs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mesh_segs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mesh_segs_idx</span><span class="p">]</span>
        <span class="n">cgal_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">cgal_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mesh_segs_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of segmentation AFTER volume filter = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_segs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">plot_segmentation_before_web</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After volume filter&quot;</span><span class="p">)</span>
            <span class="n">tu</span><span class="o">.</span><span class="n">plot_segmentation</span><span class="p">(</span><span class="n">mesh_segs</span><span class="p">,</span><span class="n">cgal_info</span><span class="p">)</span>
            <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh_segs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cgal_info</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1">#d. Running mesh segmentation to find webbing</span>
    <span class="n">web_mesh</span><span class="p">,</span><span class="n">web_cdf</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">closest_segmentation_to_coordinate</span><span class="p">(</span><span class="n">potential_webbing_mesh</span><span class="p">,</span>
                                  <span class="n">coordinates_of_intersection</span><span class="p">,</span>
                                <span class="n">smoothness</span> <span class="o">=</span> <span class="n">smoothness</span><span class="p">,</span>
                                <span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">,</span>
                                  <span class="n">plot_segmentation</span><span class="o">=</span><span class="n">plot_segmentation_before_web</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">,</span>
                                  <span class="n">plot_closest_mesh</span><span class="o">=</span><span class="n">plot_web</span> <span class="ow">and</span> <span class="n">plot_idx</span><span class="p">,</span>
                                     <span class="n">return_cgal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">mesh_segmentation</span> <span class="o">=</span> <span class="n">mesh_segs</span><span class="p">,</span>
                                    <span class="n">mesh_segmentation_cdfs</span> <span class="o">=</span> <span class="n">cgal_info</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;web_mesh = </span><span class="si">{</span><span class="n">web_mesh</span><span class="si">}</span><span class="s2">, web_cdf = </span><span class="si">{</span><span class="n">web_cdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">web_mesh</span><span class="p">,</span><span class="n">web_cdf</span></div>
    
    

<div class="viewcode-block" id="calculate_axon_webbing"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.calculate_axon_webbing">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_axon_webbing</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">n_downstream_targets_threshold</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">width_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="c1">#90,</span>
                            <span class="n">width_name</span> <span class="o">=</span> <span class="s2">&quot;no_bouton_median&quot;</span><span class="p">,</span>
                            <span class="n">width_name_backup</span> <span class="o">=</span> <span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">,</span>
                            <span class="n">idx_to_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot_intersection_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_intersection_mesh_without_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">split_significance_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot_split</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_split_closest_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">plot_webbing_on_neuron</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">upstream_node_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                            <span class="n">downstream_node_color</span> <span class="o">=</span> <span class="s2">&quot;aqua&quot;</span>
                          <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To compute the webbing meshes for a neuron object</span>
<span class="sd">    that stores these meshes in the upstream node</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Identify all nodes that have a specific amount </span>
<span class="sd">    of downstream nodes or a minimum number and a certain width</span>

<span class="sd">    2) For each Node to check generate the webbing mesh</span>
<span class="sd">    a. find the downstream nodes and generate the mesh of combining upstream and downstream nodes</span>
<span class="sd">    b. Find skeleton points around the intersection</span>
<span class="sd">    c. Split the mesh to only include central part (after filtering away boutons)</span>
<span class="sd">    d. Running mesh segmentation to find webbing</span>
<span class="sd">    e. Saving the webbing and and webbing cdf in the branch object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">split_significance_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">split_significance_threshold</span> <span class="o">=</span> <span class="n">split_significance_threshold_web_global</span>

    <span class="n">ax_limb_name</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_name</span>
    <span class="n">ax_limb_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ax_limb_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">ax_limb</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">]</span>

    <span class="c1"># ---- Part 1: Minimum/Certain Downstream Nodes and Width Requirement ---- </span>

    <span class="n">branches_to_check_for_webbing</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n_downstream_nodes&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;width_new&quot;</span><span class="p">],</span>
                    <span class="n">query</span><span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;n_downstream_nodes&gt;=</span><span class="si">{</span><span class="n">n_downstream_targets_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; and width_new&lt;</span><span class="si">{</span><span class="n">width_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                    <span class="n">limb_branch_dict_restriction</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span><span class="p">,</span>
                    <span class="n">function_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width_new_name</span> <span class="o">=</span> <span class="n">width_name</span><span class="p">,</span>
                                           <span class="n">width_new_name_backup</span> <span class="o">=</span> <span class="n">width_name_backup</span>
                                          <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ax_limb_name</span> <span class="ow">in</span> <span class="n">branches_to_check_for_webbing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">viable_nodes</span> <span class="o">=</span> <span class="n">branches_to_check_for_webbing</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">viable_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;branches_to_check_for_webbing = </span><span class="si">{</span><span class="n">viable_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="c1">#  ---- Part 2) For each Node to check generate the webbing mesh -----</span>
    <span class="n">curr_nx</span> <span class="o">=</span> <span class="n">ax_limb</span><span class="o">.</span><span class="n">concept_network_directional</span>
    <span class="k">if</span> <span class="n">idx_to_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">viable_nodes</span><span class="p">))</span>


    
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">viable_nodes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> -- Working on Node </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">: Branch </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">plot_idx</span> <span class="o">=</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">idx_to_plot</span>


<span class="w">        </span>
<span class="w">            </span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If wanted to apply size filter then would be like </span>
<span class="sd">        web_size = tu.mesh_volume(web_mesh.bounding_box_oriented)/1000/1000</span>
<span class="sd">        </span>
<span class="sd">        A reasonable value for this is tu.mesh_volume(curr_web.bounding_box_oriented)/1000/1000</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">web_mesh</span><span class="p">,</span><span class="n">web_cdf</span> <span class="o">=</span> <span class="n">calculate_axon_webbing_on_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">limb_idx</span> <span class="o">=</span> <span class="n">ax_limb_name</span><span class="p">,</span>
                                     <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span>
                                <span class="n">allow_plotting</span> <span class="o">=</span> <span class="n">plot_idx</span><span class="p">,</span>
                                <span class="n">plot_intersection_mesh</span> <span class="o">=</span> <span class="n">plot_intersection_mesh</span><span class="p">,</span>
                                <span class="n">plot_intersection_mesh_without_boutons</span> <span class="o">=</span> <span class="n">plot_intersection_mesh_without_boutons</span><span class="p">,</span>
                                <span class="n">split_significance_threshold</span> <span class="o">=</span> <span class="n">split_significance_threshold</span><span class="p">,</span>
                                <span class="n">plot_split</span> <span class="o">=</span> <span class="n">plot_split</span><span class="p">,</span>
                                <span class="n">plot_split_closest_mesh</span> <span class="o">=</span> <span class="n">plot_split_closest_mesh</span><span class="p">,</span>
                                <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="n">plot_segmentation_before_web</span><span class="p">,</span>
                                <span class="n">plot_web</span> <span class="o">=</span> <span class="n">plot_web</span><span class="p">,</span>
                              <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>

                               <span class="n">upstream_node_color</span> <span class="o">=</span> <span class="n">upstream_node_color</span><span class="p">,</span>
                                <span class="n">downstream_node_color</span> <span class="o">=</span> <span class="n">downstream_node_color</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">web_mesh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">web_cdf</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="c1">#e. Saving the webbing and and webbing cdf in the branch object</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_idx</span><span class="p">][</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">web_mesh</span>
        <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_idx</span><span class="p">][</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">web_cdf</span> <span class="o">=</span> <span class="n">web_cdf</span>

        
    <span class="k">if</span> <span class="n">plot_webbing_on_neuron</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_boutons</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">mesh_whole_neuron_alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">plot_web</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">neuron_obj</span></div>

<div class="viewcode-block" id="axon_branching_attributes"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_branching_attributes">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_branching_attributes</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">limb_idx</span><span class="p">,</span>
                        <span class="n">branch_idx</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will compute a lot of statistics about the </span>
<span class="sd">    branching behavior in an axon branching point</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="n">attr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting web intersection for limb_idx </span><span class="si">{</span><span class="n">limb_idx</span><span class="si">}</span><span class="s2">, branch_idx </span><span class="si">{</span><span class="n">branch_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">n_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span>
    <span class="n">parent_branch_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>

    <span class="c1">#1) Get the downstream nodes of the branch</span>
    <span class="n">downstream_branches</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">downstream_nodes</span><span class="p">(</span><span class="n">limb_obj</span><span class="o">.</span><span class="n">concept_network_directional</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;downstream_branches = </span><span class="si">{</span><span class="n">downstream_branches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#2) Assemble the meshes of the parent and downstream branch</span>
    <span class="n">total_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">downstream_branches</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>


    <span class="c1">#4) Get the web mesh of parent node</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">web_mesh</span> <span class="o">=</span> <span class="n">parent_branch_obj</span><span class="o">.</span><span class="n">web</span>
        <span class="n">web_cdf</span> <span class="o">=</span> <span class="n">parent_branch_obj</span><span class="o">.</span><span class="n">web_cdf</span>

        <span class="k">if</span> <span class="n">web_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">web_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">web_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No webbing for this branch!!&quot;</span><span class="p">)</span>
        <span class="n">web_flag</span> <span class="o">=</span> <span class="kc">False</span>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) For each valid and invalid boundary collect the following statistics:</span>
<span class="sd">    a. web mesh size (skeletal length, n_faces, ray_trace percentile)</span>
<span class="sd">    b. web_cdf</span>
<span class="sd">    c. web_bbox_ratio </span>
<span class="sd">    d. web_volume_ratio</span>

<span class="sd">    information about boutons</span>
<span class="sd">    parent width (no_bouton_median/no_spine_median_mesh_center)</span>
<span class="sd">    max/min downstream width (both kinds)</span>
<span class="sd">    max/min downstream width differential (both kinds)</span>
<span class="sd">    max/min child angle</span>
<span class="sd">    max/min siblings</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#1) Attributes about webbing</span>
    <span class="n">width_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;no_bouton_median&quot;</span><span class="p">,</span><span class="s2">&quot;no_spine_median_mesh_center&quot;</span><span class="p">]</span>
    <span class="n">size_measures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">,</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span><span class="s2">&quot;skeleton&quot;</span><span class="p">,</span><span class="s2">&quot;ray_trace_percentile&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">web_flag</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size_measures</span><span class="p">:</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;web_size_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_size</span><span class="p">(</span><span class="n">web_mesh</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

        <span class="n">web_bbox_rations</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">bbox_side_length_ratios</span><span class="p">(</span><span class="n">web_mesh</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_bbox_ratios_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">web_bbox_rations</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_bbox_ratios_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">web_bbox_rations</span><span class="p">)</span>

        <span class="n">web_volume_ratio</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_volume_ratio</span><span class="p">(</span><span class="n">web_mesh</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_volume_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_volume_ratio</span>

        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_cdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_cdf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size_measures</span><span class="p">:</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;web_size_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_bbox_ratios_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_bbox_ratios_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_volume_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;web_cdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    information about parent node:</span>
<span class="sd">    a) information about boutons</span>
<span class="sd">    b) parent width (no_bouton_median/no_spine_median_mesh_center)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">large_bouton_face_threshold</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">large_bouton_ray_trace_percentile</span> <span class="o">=</span> <span class="mi">400</span>

    <span class="n">n_large_boutons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">boutons_above_thresholds</span><span class="p">(</span><span class="n">parent_branch_obj</span><span class="p">,</span>
                                <span class="n">faces</span><span class="o">=</span><span class="n">large_bouton_face_threshold</span><span class="p">,</span>
                <span class="n">ray_trace_percentile</span><span class="o">=</span><span class="n">large_bouton_ray_trace_percentile</span><span class="p">))</span>
    <span class="n">n_boutons</span> <span class="o">=</span> <span class="n">parent_branch_obj</span><span class="o">.</span><span class="n">n_boutons</span>

    <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;parent_n_large_boutons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_large_boutons</span>
    <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;parent_n_boutons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_boutons</span>

    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">width_names</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;parent_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_branch_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;parent_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information about children:</span>

<span class="sd">    max/min downstream width (both kinds)</span>
<span class="sd">    max/min downstream width differential (both kinds)</span>
<span class="sd">    max/min child angle</span>
<span class="sd">    max/min siblings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">downstream_widths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,[])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">width_names</span><span class="p">])</span>
    <span class="n">downstream_width_diff</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,[])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">width_names</span><span class="p">])</span>
    <span class="n">downstream_child_angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">downstream_n_boutons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">downstream_n_large_boutons</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">downstream_branches</span><span class="p">:</span>
        <span class="n">d_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">width_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">d_obj</span><span class="o">.</span><span class="n">width_new</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">downstream_widths</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                <span class="n">downstream_width_diff</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">-</span> <span class="n">parent_branch_obj</span><span class="o">.</span><span class="n">width_new</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>

        <span class="n">downstream_child_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">find_parent_child_skeleton_angle</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                                          <span class="n">d</span><span class="p">))</span>

        <span class="n">downstream_n_boutons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_obj</span><span class="o">.</span><span class="n">n_boutons</span><span class="p">)</span>

        <span class="n">downstream_n_large_boutons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">boutons_above_thresholds</span><span class="p">(</span><span class="n">d_obj</span><span class="p">,</span>
                                <span class="n">faces</span><span class="o">=</span><span class="n">large_bouton_face_threshold</span><span class="p">,</span>
                <span class="n">ray_trace_percentile</span><span class="o">=</span><span class="n">large_bouton_ray_trace_percentile</span><span class="p">))</span>

        <span class="p">)</span>

    <span class="c1"># finding the max and min of all the categories</span>
    <span class="n">stat_func_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;child&quot;</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat_func_names</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">s_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">curr_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">curr_func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">width_names</span><span class="p">:</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_func</span><span class="p">(</span><span class="n">downstream_widths</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
            <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">_diff_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_func</span><span class="p">(</span><span class="n">downstream_width_diff</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>

        <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_angle_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_func</span><span class="p">(</span><span class="n">downstream_child_angles</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_n_boutons_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_func</span><span class="p">(</span><span class="n">downstream_n_boutons</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_n_large_boutons_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_func</span><span class="p">(</span><span class="n">downstream_n_large_boutons</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream_branches</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;downstream_branches[0] = </span><span class="si">{</span><span class="n">downstream_branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sibling_angles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">find_sibling_child_skeleton_angle</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                                               <span class="n">downstream_branches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sibling_angles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sibling_angles</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;sibling_angles_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sibling_angles</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;sibling_angles_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sibling_angles</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;sibling_angles_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;sibling_angles_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># -- 4/19 Addition: Adding the number of downstream branches</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;n_downstream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream_branches</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="s2">&quot;n_downstream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    
    <span class="k">return</span> <span class="n">attr_dict</span></div>


<div class="viewcode-block" id="complete_axon_processing_old"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.complete_axon_processing_old">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">complete_axon_processing_old</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">perform_axon_classification</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">plot_high_fidelity_axon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_boutons_web</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">add_axon_description</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">return_filtering_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To run the following axon classification processes</span>
<span class="sd">    1) Initial axon classification</span>
<span class="sd">    2) Filtering away dendrite on axon merges</span>
<span class="sd">    3) High fidelity axon skeletonization</span>
<span class="sd">    4) Bouton Identification</span>
<span class="sd">    5) Webbing Identification</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#1) Initial axon classification</span>
    <span class="k">if</span> <span class="n">perform_axon_classification</span><span class="p">:</span>
        <span class="n">clu</span><span class="o">.</span><span class="n">axon_classification</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">plot_axons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">***No axon found for this neuron ***&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">neuron_obj</span>
    

    <span class="c1">#2) Filtering away dendrite on axon merges</span>
    <span class="n">pre_filters</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">get_exc_filters_high_fidelity_axon_preprocessing</span><span class="p">()</span>
    <span class="n">o_neuron_pre</span><span class="p">,</span> <span class="n">filtering_info_pre</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">apply_proofreading_filters_to_neuron</span><span class="p">(</span><span class="n">input_neuron</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">filter_list</span> <span class="o">=</span> <span class="n">pre_filters</span><span class="p">,</span>
                        <span class="n">plot_limb_branch_filter_with_disconnect_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">plot_limb_branch_filter_away</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">plot_final_neuron</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

                                            <span class="n">return_error_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">verbose_outline</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    
    <span class="c1">#3) High fidelity axon skeletonization</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">neuron_obj_high_fid_axon</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">refine_axon_for_high_fidelity_skeleton</span><span class="p">(</span><span class="n">o_neuron_pre</span><span class="p">,</span>
                                                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Errored in the refine_axon_for_high_fidelity_skeleton&quot;</span><span class="p">)</span>
        <span class="c1">#neuron_obj_high_fid_axon = o_neuron_pre</span>
    
    
    <span class="k">if</span> <span class="n">plot_high_fidelity_axon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Fidelity Axon&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_axon</span><span class="p">(</span><span class="n">neuron_obj_high_fid_axon</span><span class="p">)</span>
        
    <span class="c1">#4) Bouton Identification</span>
    <span class="n">neuron_obj_with_boutons</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">calculate_boutons</span><span class="p">(</span><span class="c1">#parameters for run</span>
    <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj_high_fid_axon</span><span class="p">,</span>
    <span class="n">plot_axon_branches_to_check</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    
    <span class="c1">#5) Webbing Identification</span>
    <span class="n">neuron_obj_with_web</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">calculate_axon_webbing</span><span class="p">(</span><span class="n">neuron_obj_with_boutons</span><span class="p">,</span>
                      <span class="n">idx_to_plot</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="n">plot_intersection_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_intersection_mesh_without_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_split</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_split_closest_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">plot_webbing_on_neuron</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">plot_boutons_web</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_boutons</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">,</span>
                  <span class="n">mesh_whole_neuron_alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">plot_web</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_axon_description</span><span class="p">:</span>
        <span class="n">neuron_obj_with_web</span><span class="o">.</span><span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_axon_v</span><span class="si">{</span><span class="n">au</span><span class="o">.</span><span class="n">axon_version</span><span class="si">}</span><span class="s2">&quot;</span>
        
    <span class="k">if</span> <span class="n">return_filtering_info</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neuron_obj_with_web</span><span class="p">,</span><span class="n">filtering_info_pre</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neuron_obj_with_web</span></div>



<div class="viewcode-block" id="wide_angle_t_candidates"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.wide_angle_t_candidates">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">wide_angle_t_candidates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">axon_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">child_width_maximum</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
                            <span class="n">parent_width_maximum</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
                            <span class="n">plot_two_downstream_thin_axon_limb_branch</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_wide_angled_children</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">child_skeletal_threshold</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find all of the nodes that thin and wide angle</span>
<span class="sd">    t splits in the neuron </span>
<span class="sd">    </span>
<span class="sd">    Application: Can be used to identify merge errors when</span>
<span class="sd">    there is not a valid web mesh at the location</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#1) Find all of the candidate branches in the axon</span>
    <span class="k">if</span> <span class="n">axon_only</span><span class="p">:</span>
        <span class="n">axon_branches</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">matching_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axon_branches</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">limb_branch_dict</span>


    <span class="n">two_downstream_thin_axon_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n_downstream_nodes&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;n_small_children&quot;</span><span class="p">,</span><span class="s2">&quot;axon_width&quot;</span><span class="p">],</span>
                   <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;(n_small_children == 2) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(axon_width&lt;</span><span class="si">{</span><span class="n">parent_width_maximum</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(n_downstream_nodes == 2)&quot;</span><span class="p">),</span>
                    <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width_maximum</span><span class="o">=</span><span class="n">child_width_maximum</span><span class="p">),</span>
                   <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">axon_branches</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_two_downstream_thin_axon_limb_branch</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting two_downstream_thin_axon_limb_branch&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">two_downstream_thin_axon_limb_branch</span><span class="p">)</span>

    <span class="c1"># find the ones that have wide angle children</span>
    <span class="n">child_angle_min</span> <span class="o">=</span> <span class="mi">120</span>
    <span class="n">wide_angled_children</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;two_children_angle&quot;</span><span class="p">,</span><span class="s2">&quot;children_skeletal_lengths_min&quot;</span><span class="p">],</span>
                   <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(two_children_angle &gt; </span><span class="si">{</span><span class="n">child_angle_min</span><span class="si">}</span><span class="s2">) &amp; &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;(children_skeletal_lengths_min &gt; </span><span class="si">{</span><span class="n">child_skeletal_threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
                   <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">two_downstream_thin_axon_limb_branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_wide_angled_children</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting wide_angled_children&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">wide_angled_children</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;two_downstream_thin_axon_limb_branch = </span><span class="si">{</span><span class="n">two_downstream_thin_axon_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wide_angled_children= </span><span class="si">{</span><span class="n">wide_angled_children</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">wide_angled_children</span></div>

<div class="viewcode-block" id="valid_web_for_t"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.valid_web_for_t">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">valid_web_for_t</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                    <span class="n">size_threshold</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                <span class="n">size_type</span><span class="o">=</span><span class="s2">&quot;ray_trace_median&quot;</span><span class="p">,</span>
                <span class="n">above_threshold</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return if the mesh is a valid </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m_size</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_size</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                         <span class="n">size_type</span><span class="o">=</span><span class="n">size_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Web size = </span><span class="si">{</span><span class="n">m_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">above_threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m_size</span><span class="o">&gt;</span><span class="n">size_threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m_size</span><span class="o">&lt;=</span><span class="n">size_threshold</span></div>
    
    
<div class="viewcode-block" id="short_thick_branches_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.short_thick_branches_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">short_thick_branches_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">width_min_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#120,</span>
    <span class="n">skeletal_length_max_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#3500,</span>
    <span class="n">ray_trace_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#350,</span>
    <span class="n">parent_width_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#None,#200,</span>
    <span class="n">plot_limb_branch_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exclude_starting_nodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#True,</span>
    <span class="n">add_zero_width_segments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#True,</span>
    <span class="n">width_min_threshold_parent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#95,</span>
    <span class="n">width_global_min_threshold_parent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#40,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">only_axon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Identify short thick branches a neuron object</span>
<span class="sd">    (excluding the starter node)</span>

<span class="sd">    Application: Can be filtered away from high_degree_coordinate</span>
<span class="sd">    resolution for error detection</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Query the limb or neuron using the </span>
<span class="sd">    - width threshold</span>
<span class="sd">    - skeletal length threshold</span>
<span class="sd">    - end node threshold (can exclude the starting node)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">width_min_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_min_threshold</span> <span class="o">=</span> <span class="n">width_min_threshold_short_thick_global</span>
    <span class="k">if</span> <span class="n">skeletal_length_max_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_max_threshold</span> <span class="o">=</span> <span class="n">skeletal_length_max_threshold_short_thick_global</span>
    <span class="k">if</span> <span class="n">ray_trace_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_trace_threshold</span> <span class="o">=</span> <span class="n">ray_trace_threshold_short_thick_global</span>
    <span class="k">if</span> <span class="n">parent_width_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parent_width_threshold</span> <span class="o">=</span> <span class="n">parent_width_threshold_short_thick_global</span>
    <span class="k">if</span> <span class="n">exclude_starting_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude_starting_nodes</span> <span class="o">=</span> <span class="n">exclude_starting_nodes_short_thick_global</span>
    <span class="k">if</span> <span class="n">add_zero_width_segments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">add_zero_width_segments</span> <span class="o">=</span> <span class="n">add_zero_width_segments_short_thick_global</span>
    <span class="k">if</span> <span class="n">width_min_threshold_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_min_threshold_parent</span> <span class="o">=</span> <span class="n">width_min_threshold_parent_short_thick_global</span>
    <span class="k">if</span> <span class="n">width_global_min_threshold_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_global_min_threshold_parent</span> <span class="o">=</span> <span class="n">width_global_min_threshold_parent_short_thick_global</span>
    

    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon_width&quot;</span><span class="p">,</span><span class="s2">&quot;skeletal_length&quot;</span><span class="p">,</span><span class="s2">&quot;n_downstream_nodes&quot;</span><span class="p">,</span><span class="s2">&quot;ray_trace_perc&quot;</span><span class="p">,</span><span class="s2">&quot;parent_width&quot;</span><span class="p">],</span>
                   <span class="n">query</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;((axon_width &gt; </span><span class="si">{</span><span class="n">width_min_threshold</span><span class="si">}</span><span class="s2">) or ( ray_trace_perc &gt; </span><span class="si">{</span><span class="n">ray_trace_threshold</span><span class="si">}</span><span class="s2">)) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(skeletal_length &lt; </span><span class="si">{</span><span class="n">skeletal_length_max_threshold</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_downstream_nodes == 0) &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;and (parent_width &gt; </span><span class="si">{</span><span class="n">width_min_threshold_parent</span><span class="si">}</span><span class="s2">) &quot;</span>
                          <span class="c1">#f&quot;and (parent_width &gt; {width_global_min_threshold_parent})&quot;</span>
                         <span class="p">),</span>
                    <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
    


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict before starting node removal:</span><span class="se">\n</span><span class="si">{</span><span class="n">limb_branch_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_zero_width_segments</span><span class="p">:</span>
        <span class="n">limb_branch_dict_zero</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon_width&quot;</span><span class="p">,</span><span class="s2">&quot;width_new&quot;</span><span class="p">],</span>
                   <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(axon_width == 0) or (width_new == 0)&quot;</span><span class="p">,</span>
                                          <span class="p">)</span>
        <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">limb_branch_dict_zero</span><span class="p">,</span><span class="n">limb_branch_dict</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict after zero segment add:</span><span class="se">\n</span><span class="si">{</span><span class="n">limb_branch_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exclude_starting_nodes</span><span class="p">:</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">limb_name</span><span class="p">,</span><span class="n">branch_list</span> <span class="ow">in</span> <span class="n">limb_branch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">branch_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">branch_list</span><span class="p">)</span>
            <span class="n">leftover_branches</span> <span class="o">=</span> <span class="n">branch_list</span><span class="p">[</span><span class="n">branch_list</span> <span class="o">!=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]</span><span class="o">.</span><span class="n">current_starting_node</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leftover_branches</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">return_dict</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">leftover_branches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="n">limb_branch_dict</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict AFTER starting node removal:</span><span class="se">\n</span><span class="si">{</span><span class="n">return_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        

                                
        
        
    <span class="k">if</span> <span class="n">parent_width_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent_width&quot;</span><span class="p">,</span><span class="s2">&quot;skeletal_length&quot;</span><span class="p">,</span><span class="s2">&quot;n_downstream_nodes&quot;</span><span class="p">,</span><span class="s2">&quot;ray_trace_perc&quot;</span><span class="p">],</span>
                   <span class="n">query</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(parent_width &gt; </span><span class="si">{</span><span class="n">parent_width_threshold</span><span class="si">}</span><span class="s2">)&quot;</span>
                         <span class="p">),</span>
                    <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">return_dict</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered only those segments with a parent width of greater than </span><span class="si">{</span><span class="n">parent_width_threshold</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict = </span><span class="si">{</span><span class="n">return_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">only_axon</span><span class="p">:</span>
        <span class="n">axon_labels</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span> <span class="n">matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_intersection</span><span class="p">([</span><span class="n">return_dict</span><span class="p">,</span><span class="n">axon_labels</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricting to only axon&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict = </span><span class="si">{</span><span class="n">return_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">plot_limb_branch_dict</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">return_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_dict</span></div>

<span class="sd">&#39;&#39;&#39;def short_thick_branches_from_limb(limb_obj,</span>
<span class="sd">    width_min_threshold = 170,</span>
<span class="sd">    width_min_threshold_parent = 95,</span>
<span class="sd">    skeletal_length_max_threshold = 6000,</span>
<span class="sd">    max_ray_trace_percentile = 500,</span>
<span class="sd">    exclude_starting_nodes = True,</span>
<span class="sd">    verbose = False,</span>
<span class="sd">    ):</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    Purpose: Identify short thick branches on a limb object</span>
<span class="sd">    (maybe excluding the starter node)</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Query the limb or neuron using the </span>
<span class="sd">    - width threshold</span>
<span class="sd">    - skeletal length threshold</span>
<span class="sd">    - end node threshold (can exclude the starting node)</span>
<span class="sd">    2) Remove the starting node</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">#     more_relaxed_conditions = False</span>
<span class="sd">    </span>
<span class="sd">#     if more_relaxed_conditions:</span>
<span class="sd">#         width_min_threshold = 120</span>
<span class="sd">#         skeletal_length_max_threshold = 10000</span>
<span class="sd">#         max_ray_trace_percentile = 400</span>
<span class="sd">    </span>
<span class="sd">    short_thick_branches = []</span>
<span class="sd">    for b_idx in limb_obj.get_branch_names():</span>
<span class="sd">        b_obj = limb_obj[b_idx]</span>
<span class="sd">        if (((ns.axon_width(b_obj) &gt; width_min_threshold) or </span>
<span class="sd">                 (tu.mesh_size(b_obj.mesh,size_type=&quot;ray_trace_percentile&quot;) &gt; max_ray_trace_percentile)) and</span>
<span class="sd">            (ns.skeletal_length(b_obj)&lt;skeletal_length_max_threshold) and </span>
<span class="sd">            (xu.n_downstream_nodes(limb_obj.concept_network_directional,b_idx) == 0)):</span>
<span class="sd">            </span>
<span class="sd">            if parent_width(limb_obj,b_idx) &gt; width_min_threshold_parent:</span>
<span class="sd">                short_thick_branches.append(b_idx)</span>
<span class="sd">    </span>
<span class="sd">    short_thick_branches = np.array(short_thick_branches)</span>

<span class="sd">    if verbose:</span>
<span class="sd">        print(f&quot;short_thick_branches before starting node removal:\n{short_thick_branches}&quot;)</span>

<span class="sd">    if exclude_starting_nodes:</span>
<span class="sd">        leftover_branches = short_thick_branches[short_thick_branches != limb_obj.current_starting_node ]</span>
<span class="sd">    else:</span>
<span class="sd">        leftover_branches = short_thick_branches</span>

<span class="sd">    if verbose:</span>
<span class="sd">        print(f&quot;leftover_branches AFTER starting node removal:\n{leftover_branches}&quot;)</span>

<span class="sd">    return leftover_branches&#39;&#39;&#39;</span>
    

<div class="viewcode-block" id="axon_angles"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_angles">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_angles</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To compute the axon angles for a neuron</span>
<span class="sd">    object that already has the axon identified</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">limb_branch_dict_axon</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limb_branch_dict_axon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    
    <span class="n">axon_angles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">axon_limb_name</span><span class="p">,</span><span class="n">candidate_nodes</span> <span class="ow">in</span> <span class="n">limb_branch_dict_axon</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">local_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">axon_limb_name</span><span class="p">]</span>
        <span class="n">sub_graph</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="o">.</span><span class="n">concept_network</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">candidate_nodes</span><span class="p">)</span>
        <span class="n">sub_graph_conn_comp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">sub_graph</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">limb_obj</span><span class="o">.</span><span class="n">current_starting_node</span> <span class="ow">in</span> <span class="n">candidate_nodes</span><span class="p">:</span>
            <span class="n">sh_path</span><span class="p">,</span><span class="n">st_node</span><span class="p">,</span><span class="n">end_node</span> <span class="o">=</span> <span class="n">xu</span><span class="o">.</span><span class="n">shortest_path_between_two_sets_of_nodes</span><span class="p">(</span><span class="n">limb_obj</span><span class="o">.</span><span class="n">concept_network_directional</span><span class="p">,</span>
                                                                                  <span class="p">[</span><span class="n">limb_obj</span><span class="o">.</span><span class="n">current_starting_node</span><span class="p">],</span>
                                                                                  <span class="n">candidate_nodes</span><span class="p">,</span>
                                                                                  <span class="p">)</span>
            <span class="n">candidate_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">candidate_nodes</span><span class="p">,</span><span class="n">sh_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">s_graph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_graph_conn_comp</span><span class="p">):</span>
            <span class="n">local_axon_angles</span> <span class="o">=</span> <span class="n">clu</span><span class="o">.</span><span class="n">candidate_starting_skeletal_angle</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">candidate_nodes</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;local_axon_angles = </span><span class="si">{</span><span class="n">local_axon_angles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">local_dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_axon_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axon_angles</span><span class="p">[</span><span class="n">nru</span><span class="o">.</span><span class="n">get_limb_int_name</span><span class="p">(</span><span class="n">axon_limb_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">local_dict</span>
    <span class="k">return</span> <span class="n">axon_angles</span></div>



<div class="viewcode-block" id="axon_features_from_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_features_from_neuron_obj">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_features_from_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">add_axon_prefix_to_all_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">features_to_exclude</span><span class="o">=</span><span class="p">(),</span>
                                  <span class="n">add_axon_start_features</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="c1">#     if neuron_obj.axon_limb_name is None:</span>
<span class="c1">#         return dict()</span>

    <span class="n">axon_dict</span><span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">compartment_features_from_skeleton_and_soma_center</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                  <span class="n">compartment_label</span> <span class="o">=</span> <span class="s2">&quot;axon&quot;</span><span class="p">,</span>
                                                      <span class="n">features_to_exclude</span><span class="o">=</span><span class="n">features_to_exclude</span><span class="p">,</span>
                                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1">#     axon_dict = axon_features_from_axon_sk_and_soma_center(neuron_obj.axon_skeleton,</span>
<span class="c1">#                                                      neuron_obj[&quot;S0&quot;].mesh_center,</span>
<span class="c1">#                                                      **kwargs)</span>
    <span class="k">if</span> <span class="n">add_axon_prefix_to_all_keys</span><span class="p">:</span>
        <span class="n">axon_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;axon_&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">else</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">axon_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        
    <span class="k">if</span> <span class="n">add_axon_start_features</span><span class="p">:</span>
        <span class="n">axon_dict</span><span class="p">[</span><span class="s2">&quot;axon_start_distance_from_soma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">axon_start_distance_from_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
        
    <span class="k">return</span> <span class="n">axon_dict</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def axon_features_from_axon_sk_and_soma_center_old(axon_sk,</span>
<span class="sd">                                               soma_center,</span>
<span class="sd">                                               short_threshold = 6000,</span>
<span class="sd">                                    long_threshold = 100000,</span>
<span class="sd">                                    volume_divisor = (10**14),</span>
<span class="sd">                                               verbose = False,</span>
<span class="sd">                                    in_um = True,):</span>
<span class="sd">    </span>
<span class="sd">    # Calculating the boudning box</span>
<span class="sd">    sk_branches = sk.decompose_skeleton_to_branches(axon_sk)</span>

<span class="sd">    sk_branches_dist = np.array([sk.calculate_skeleton_distance(k) for k in sk_branches])</span>

<span class="sd">    n_branches = len(sk_branches)</span>
<span class="sd">    n_short_branches = np.sum(sk_branches_dist&lt;short_threshold)</span>
<span class="sd">    n_long_branches = np.sum(sk_branches_dist&gt;long_threshold)</span>
<span class="sd">    n_medium_branches = np.sum((sk_branches_dist&lt;=long_threshold) &amp; </span>
<span class="sd">                              (sk_branches_dist&gt;=short_threshold))</span>

<span class="sd">    if verbose:</span>
<span class="sd">        print(f&quot;Total Number of Branches = {(n_branches)}&quot;)</span>
<span class="sd">        print(f&quot;n_short_branches = {n_short_branches}, n_medium_branches = {n_medium_branches}, n_long_branches = {n_long_branches}&quot;)</span>

<span class="sd">    # calculating the skeletal lengths</span>
<span class="sd">    if in_um:</span>
<span class="sd">        divisor = 1000</span>
<span class="sd">    else:</span>
<span class="sd">        divisor = 1</span>

<span class="sd">    axon_length = np.sum(sk_branches_dist)/divisor</span>
<span class="sd">    axon_branch_length_median = np.median(sk_branches_dist)/divisor</span>
<span class="sd">    axon_branch_length_mean = np.mean(sk_branches_dist)/divisor</span>

<span class="sd">    if verbose:</span>
<span class="sd">        print(f&quot;axon_length = {axon_length}, axon_branch_length_median = {axon_branch_length_median}, axon_branch_length_mean = {axon_branch_length_mean}&quot;)</span>

<span class="sd">    sk_points = axon_sk.reshape(-1,3)</span>
<span class="sd">    bbox = tu.coordinates_to_bounding_box(sk_points)</span>
<span class="sd">    bbox_volume = tu.bbox_volume(bbox)/volume_divisor</span>
<span class="sd">    bbox_corners = tu.bounding_box_corners(bbox)</span>
<span class="sd">    bbox_corners_soma_relative = bbox_corners - soma_center</span>

<span class="sd">    if verbose:</span>
<span class="sd">        print(f&quot;bbox_volume = {bbox_volume}&quot;)</span>
<span class="sd">        print(f&quot;bbox_corners = {bbox_corners}&quot;)</span>
<span class="sd">        print(f&quot;bbox_corners_soma_relative = {bbox_corners_soma_relative}&quot;)</span>

<span class="sd">    axon_dict = dict(</span>

<span class="sd">                    axon_length = axon_length,</span>
<span class="sd">                    axon_branch_length_median = axon_branch_length_median,</span>
<span class="sd">                    axon_branch_length_mean = axon_branch_length_mean,</span>

<span class="sd">                    n_branches = n_branches,</span>
<span class="sd">                    n_short_branches = n_short_branches,</span>
<span class="sd">                    n_long_branches = n_long_branches,</span>
<span class="sd">                    n_medium_branches = n_medium_branches,</span>

<span class="sd">                    bbox_volume=bbox_volume,</span>
<span class="sd">                    bbox_x_min=bbox_corners[0][0],</span>
<span class="sd">                    bbox_y_min=bbox_corners[0][1],</span>
<span class="sd">                    bbox_z_min=bbox_corners[0][2],</span>
<span class="sd">                    bbox_x_max=bbox_corners[1][0],</span>
<span class="sd">                    bbox_y_max=bbox_corners[1][1],</span>
<span class="sd">                    bbox_z_max=bbox_corners[1][2],</span>

<span class="sd">                    bbox_x_min_soma_relative=bbox_corners_soma_relative[0][0],</span>
<span class="sd">                    bbox_y_min_soma_relative=bbox_corners_soma_relative[0][1],</span>
<span class="sd">                    bbox_z_min_soma_relative=bbox_corners_soma_relative[0][2],</span>
<span class="sd">                    bbox_x_max_soma_relative=bbox_corners_soma_relative[1][0],</span>
<span class="sd">                    bbox_y_max_soma_relative=bbox_corners_soma_relative[1][1],</span>
<span class="sd">                    bbox_z_max_soma_relative=bbox_corners_soma_relative[1][2],</span>

<span class="sd">                    )</span>
<span class="sd">    return axon_dict</span>
<span class="sd">&quot;&quot;&quot;</span>


    
<div class="viewcode-block" id="axon_spines_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_spines_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_spines_limb_branch_dict</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">ray_trace_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#270,</span>
    <span class="n">ray_trace_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1200,</span>
    <span class="n">skeletal_length_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1000,</span>
    <span class="n">skeletal_length_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#6000,</span>
    <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1,</span>
    <span class="n">n_synapses_pre_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#3,</span>
    <span class="n">n_faces_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#90,</span>
    <span class="n">downstream_upstream_dist_diff</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1000,</span>
    <span class="n">downstream_dist_min_over_syn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>                        
    <span class="n">plot_short_end_nodes_with_syn</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_axon_spines_branch_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exclude_starting_nodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#True,</span>
                                
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To identify all of the </span>
<span class="sd">    boutons that sprout off </span>
<span class="sd">    that should not cause a high order degree</span>

<span class="sd">    Brainstorming:</span>
<span class="sd">    end_node</span>
<span class="sd">    has one or two synapses</span>
<span class="sd">    between certain length: 1000 - 5000</span>


<span class="sd">    85% ray trace: above 270 (ray_trace_perc)</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from neurd import axon_utils as au</span>
<span class="sd">    au.axon_spines_limb_branch_dict(neuron_obj,</span>
<span class="sd">        ray_trace_min = 270,</span>
<span class="sd">        ray_trace_max = 1200,</span>
<span class="sd">        skeletal_length_min = 1000,</span>
<span class="sd">        skeletal_length_max = 10000,</span>
<span class="sd">        n_synapses_pre_min = 1,</span>
<span class="sd">        n_synapses_pre_max = 3,</span>
<span class="sd">        n_faces_min = 150,</span>
<span class="sd">        plot_short_end_nodes_with_syn = False,</span>
<span class="sd">        plot_axon_spines_branch_dict = False,</span>
<span class="sd">        exclude_starting_nodes = True,</span>
<span class="sd">        verbose = False,</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">ray_trace_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_trace_min</span> <span class="o">=</span> <span class="n">ray_trace_min_axon_spines_global</span>
    <span class="k">if</span> <span class="n">ray_trace_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_trace_max</span> <span class="o">=</span> <span class="n">ray_trace_max_axon_spines_global</span>
    <span class="k">if</span> <span class="n">skeletal_length_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_min</span> <span class="o">=</span> <span class="n">skeletal_length_min_axon_spines_global</span>
    <span class="k">if</span> <span class="n">skeletal_length_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_max</span> <span class="o">=</span> <span class="n">skeletal_length_max_axon_spines_global</span>
    <span class="k">if</span> <span class="n">n_synapses_pre_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="n">n_synapses_pre_min_axon_spines_global</span>
    <span class="k">if</span> <span class="n">n_synapses_pre_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_pre_max</span> <span class="o">=</span> <span class="n">n_synapses_pre_max_axon_spines_global</span>
    <span class="k">if</span> <span class="n">n_faces_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_faces_min</span> <span class="o">=</span> <span class="n">n_faces_min_axon_spines_global</span>
    <span class="k">if</span> <span class="n">downstream_upstream_dist_diff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downstream_upstream_dist_diff</span> <span class="o">=</span> <span class="n">downstream_upstream_dist_diff_axon_spines_global</span>
    <span class="k">if</span> <span class="n">downstream_dist_min_over_syn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downstream_dist_min_over_syn</span> <span class="o">=</span> <span class="n">downstream_dist_min_over_syn_axon_spines_global</span>
    <span class="k">if</span> <span class="n">exclude_starting_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude_starting_nodes</span> <span class="o">=</span> <span class="n">exclude_starting_nodes_axon_spines_global</span>
    
    <span class="n">short_end_nodes_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(ray_trace_perc &gt;= </span><span class="si">{</span><span class="n">ray_trace_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(ray_trace_perc &lt;= </span><span class="si">{</span><span class="n">ray_trace_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt;= </span><span class="si">{</span><span class="n">skeletal_length_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(skeletal_length &lt;= </span><span class="si">{</span><span class="n">skeletal_length_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_synapses_post == </span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_synapses_pre &gt;= </span><span class="si">{</span><span class="n">n_synapses_pre_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_synapses_pre &lt;= </span><span class="si">{</span><span class="n">n_synapses_pre_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_faces_branch &gt;= </span><span class="si">{</span><span class="n">n_faces_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_downstream_nodes == 0) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;((skeletal_length &lt; 2500) or (synapse_closer_to_downstream_endpoint_than_upstream)) and &quot;</span> <span class="c1"># part that makes sure synapse is at the end</span>
                          <span class="sa">f</span><span class="s2">&quot;(downstream_upstream_diff_of_most_downstream_syn &lt; </span><span class="si">{</span><span class="n">downstream_upstream_dist_diff</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; and (downstream_dist_min_over_syn &lt; </span><span class="si">{</span><span class="n">downstream_dist_min_over_syn</span><span class="si">}</span><span class="s2">)&quot;</span>
                         <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;short_end_nodes_query = </span><span class="si">{</span><span class="n">short_end_nodes_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">short_end_nodes_with_syn</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ray_trace_perc&quot;</span><span class="p">,</span><span class="s2">&quot;skeletal_length&quot;</span><span class="p">,</span><span class="s2">&quot;n_downstream_nodes&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;n_synapses_post&quot;</span><span class="p">,</span><span class="s2">&quot;n_synapses_pre&quot;</span><span class="p">,</span><span class="s2">&quot;n_faces_branch&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;synapse_closer_to_downstream_endpoint_than_upstream&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;downstream_upstream_diff_of_most_downstream_syn&quot;</span><span class="p">,</span>
                                  <span class="n">syu</span><span class="o">.</span><span class="n">downstream_dist_min_over_syn</span><span class="p">],</span>
                   <span class="n">query</span><span class="o">=</span><span class="n">short_end_nodes_query</span><span class="p">,</span>
                                              <span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_short_end_nodes_with_syn</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;short_end_nodes_with_syn = </span><span class="si">{</span><span class="n">short_end_nodes_with_syn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">short_end_nodes_with_syn</span><span class="p">)</span>
                             
    
    <span class="n">axon_spines_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(ray_trace_perc &gt;= </span><span class="si">{</span><span class="n">ray_trace_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(ray_trace_perc &lt;= </span><span class="si">{</span><span class="n">ray_trace_max</span><span class="si">}</span><span class="s2">) &quot;</span>
                         <span class="p">)</span>
    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ray_trace_perc&quot;</span><span class="p">],</span>
                   <span class="n">query</span><span class="o">=</span><span class="n">axon_spines_query</span><span class="p">,</span>
                    <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">short_end_nodes_with_syn</span>
                    <span class="p">)</span>
    


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict before starting node removal:</span><span class="se">\n</span><span class="si">{</span><span class="n">limb_branch_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exclude_starting_nodes</span><span class="p">:</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">limb_name</span><span class="p">,</span><span class="n">branch_list</span> <span class="ow">in</span> <span class="n">limb_branch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">branch_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">branch_list</span><span class="p">)</span>
            <span class="n">leftover_branches</span> <span class="o">=</span> <span class="n">branch_list</span><span class="p">[</span><span class="n">branch_list</span> <span class="o">!=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]</span><span class="o">.</span><span class="n">current_starting_node</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leftover_branches</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">return_dict</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">leftover_branches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="n">limb_branch_dict</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch_dict AFTER starting node removal:</span><span class="se">\n</span><span class="si">{</span><span class="n">return_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_axon_spines_branch_dict</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plot_axon_spines_branch_dict = </span><span class="si">{</span><span class="n">return_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">return_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_dict</span>

    <span class="k">return</span> <span class="n">axon_dict</span></div>

<span class="c1"># ------------ 7/17: New axon classification ------------ #</span>
<div class="viewcode-block" id="axon_classification_using_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_classification_using_synapses">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_classification_using_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#70, # for excitatory</span>

    <span class="c1"># neuron_obj = n_obj_syn_inh</span>
    <span class="c1"># axon_soma_angle_threshold = None</span>

    <span class="c1">#inital query arguments</span>
    <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.00007,#0.0003,</span>
    <span class="n">ais_syn_alternative_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_n_syn_pre_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">ais_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#95,#140,</span>
    <span class="n">ais_width_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#550,</span>
    <span class="n">max_search_distance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#inhibitory_axon_ais_max_search_distance, # 20_000 for excitatory</span>
    <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_filt_branches_without_postsyn_req</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1">#arguments for postsyn downstream</span>
    <span class="n">n_postsyn_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">postsyn_distance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_low_postsyn_branches</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="c1">#arguments for ais filtering</span>
    <span class="n">ais_width_filter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_new_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#170,#170,</span>
    <span class="n">ais_new_width_downstream_skeletal_length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1"># --- New filters added 8/11 -----</span>
    <span class="c1">#arguments for ais branch off filtering</span>
    <span class="c1">#for inhibitory use au.inhibitory_axon_ais_max_search_distance</span>
    <span class="c1">#for excitatory use ais_max_distance_from_soma = au.excitatory_axon_ais_max_search_distance</span>
    <span class="n">ais_max_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    
    <span class="c1">#arguments for spine filtering</span>
<span class="c1">#     ais_spine_density_max = 0.00015,</span>
<span class="c1">#     n_spines_max_per_branch = 9,</span>
    <span class="n">n_synapses_spine_offset_endpoint_upstream_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#4,</span>
    
    <span class="c1"># arguments if the there is no winningn candidate</span>
    <span class="n">attempt_second_pass</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_n_syn_pre_max_backup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_search_distance_addition_backup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># for phase 3: picking the winning candidate</span>
    <span class="n">return_best_candidate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">best_candidate_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_skeletal_length_above_threshold_and_buffer_soma_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10_000</span><span class="p">,</span><span class="mi">25_000</span><span class="p">,</span><span class="mi">50_000</span><span class="p">,</span><span class="mi">75_000</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
    
    <span class="c1">#arguments for max_skeletal_length_above_threshold_and_buffer</span>
    <span class="n">max_skeletal_length_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_skeletal_length_buffer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1">#arguments for significant_lowest_density option</span>
    <span class="n">significant_lowest_density_min_skeletal_length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lowest_density_ratio</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">backup_best_candidate_method</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;significant_lowest_density&quot;</span><span class="p">,</span><span class="s2">&quot;max_skeletal_length&quot;</span><span class="p">],</span>

    <span class="n">plot_final_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">clean_prior_axon_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">set_axon_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    
    <span class="c1">#for labeling the merge errors</span>
    <span class="n">label_merge_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">plot_axon_on_dendrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_dendrite_on_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="n">return_axon_angle_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">downstream_distance_for_axon_angle</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1"># will default to the one closer to the soma if both have certain length</span>
    

    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">candidate_downstream_postsyn_density_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the axon limb branch for a generic neuron</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode: </span>

<span class="sd">    Phase 1: Filtering</span>
<span class="sd">    0) Optionally restrict limbs by the connection of the soma</span>
<span class="sd">    1) Do a query to find branches that</span>
<span class="sd">    - low synapse desnity</span>
<span class="sd">    - min width</span>
<span class="sd">    - have min distance to the soma</span>
<span class="sd">    2) Restrict the branches to only those without a lot of downstream postsyns in the near vicitnity</span>

<span class="sd">    Phase 2: Gathering into Candidates</span>

<span class="sd">    Phase 3: Picking winning Candidate</span>


<span class="sd">    Things to improve:</span>
<span class="sd">    Can think about looking at insignificant limbs for axon</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from neurd import axon_utils as au</span>
<span class="sd">    axon_limb_branch_dict,axon_angles_dict = au.axon_classification_using_synapses(neuron_obj_exc_syn_sp,</span>
<span class="sd">                                          plot_filt_branches_without_postsyn_req = False,</span>
<span class="sd">                                          plot_low_postsyn_branches = False,</span>
<span class="sd">                                         plot_final_axon=True,</span>
<span class="sd">                                         verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axon_soma_angle_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="n">axon_soma_angle_threshold_global</span>
    <span class="k">if</span> <span class="n">ais_syn_density_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="n">ais_syn_density_max_global</span>
    <span class="k">if</span> <span class="n">ais_syn_alternative_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_syn_alternative_max</span> <span class="o">=</span> <span class="n">ais_syn_alternative_max_global</span>
    <span class="k">if</span> <span class="n">ais_n_syn_pre_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_n_syn_pre_max</span> <span class="o">=</span> <span class="n">ais_n_syn_pre_max_global</span>
    <span class="k">if</span> <span class="n">ais_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_width_min</span> <span class="o">=</span> <span class="n">ais_width_min_global</span>
    <span class="k">if</span> <span class="n">ais_width_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_width_max</span> <span class="o">=</span> <span class="n">ais_width_max_global</span>
    <span class="k">if</span> <span class="n">max_search_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_search_distance</span> <span class="o">=</span> <span class="n">max_search_distance_global</span>
    <span class="k">if</span> <span class="n">min_skeletal_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="n">min_skeletal_length_global</span>
    <span class="k">if</span> <span class="n">n_postsyn_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_postsyn_max</span> <span class="o">=</span> <span class="n">n_postsyn_max_global</span>
    <span class="k">if</span> <span class="n">postsyn_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">postsyn_distance</span> <span class="o">=</span> <span class="n">postsyn_distance_global</span>
    <span class="k">if</span> <span class="n">ais_width_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_width_filter</span> <span class="o">=</span> <span class="n">ais_width_filter_global</span>
    <span class="k">if</span> <span class="n">ais_new_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_new_width_min</span> <span class="o">=</span> <span class="n">ais_new_width_min_global</span>
    <span class="k">if</span> <span class="n">ais_new_width_downstream_skeletal_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_new_width_downstream_skeletal_length</span> <span class="o">=</span> <span class="n">ais_new_width_downstream_skeletal_length_global</span>
    <span class="k">if</span> <span class="n">ais_max_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_max_distance_from_soma</span> <span class="o">=</span> <span class="n">ais_max_distance_from_soma_global</span>
    <span class="k">if</span> <span class="n">n_synapses_spine_offset_endpoint_upstream_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_spine_offset_endpoint_upstream_max</span> <span class="o">=</span> <span class="n">n_synapses_spine_offset_endpoint_upstream_max_global</span>
    <span class="k">if</span> <span class="n">attempt_second_pass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attempt_second_pass</span> <span class="o">=</span> <span class="n">attempt_second_pass_global</span>
    <span class="k">if</span> <span class="n">ais_syn_density_max_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="n">ais_syn_density_max_backup_global</span>
    <span class="k">if</span> <span class="n">ais_n_syn_pre_max_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_n_syn_pre_max_backup</span> <span class="o">=</span> <span class="n">ais_n_syn_pre_max_backup_global</span>
    <span class="k">if</span> <span class="n">max_search_distance_addition_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_search_distance_addition_backup</span> <span class="o">=</span> <span class="n">max_search_distance_addition_backup_global</span>
    <span class="k">if</span> <span class="n">return_best_candidate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">return_best_candidate</span> <span class="o">=</span> <span class="n">return_best_candidate_global</span>
    <span class="k">if</span> <span class="n">best_candidate_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_candidate_method</span> <span class="o">=</span> <span class="n">best_candidate_method_global</span>
    <span class="k">if</span> <span class="n">max_skeletal_length_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_skeletal_length_min</span> <span class="o">=</span> <span class="n">max_skeletal_length_min_global</span>
    <span class="k">if</span> <span class="n">max_skeletal_length_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_skeletal_length_buffer</span> <span class="o">=</span> <span class="n">max_skeletal_length_buffer_global</span>
    <span class="k">if</span> <span class="n">significant_lowest_density_min_skeletal_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">significant_lowest_density_min_skeletal_length</span> <span class="o">=</span> <span class="n">significant_lowest_density_min_skeletal_length_global</span>
    <span class="k">if</span> <span class="n">lowest_density_ratio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lowest_density_ratio</span> <span class="o">=</span> <span class="n">lowest_density_ratio_global</span>
    <span class="k">if</span> <span class="n">downstream_distance_for_axon_angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downstream_distance_for_axon_angle</span> <span class="o">=</span> <span class="n">downstream_distance_for_axon_angle_global</span>
    <span class="k">if</span> <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses_if_no_candidate_global</span>
    <span class="k">if</span> <span class="n">axon_classification_without_synapses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses_global</span>
    <span class="k">if</span> <span class="n">candidate_downstream_postsyn_density_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">candidate_downstream_postsyn_density_max</span> <span class="o">=</span> <span class="n">candidate_downstream_postsyn_density_max_global</span>
        
        
    <span class="k">if</span> <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon_global</span>
    
    
    
    <span class="c1">#print(f&quot;ais_syn_density_max= {ais_syn_density_max}, ais_syn_density_max_backup = {ais_syn_density_max_backup}&quot;)</span>
    
    <span class="c1">#------------------ 0) Filter Limbs By Starting Angle  ------------------</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axon_classification_without_synapses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axon_soma_angle_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricting limbs to those greater than </span><span class="si">{</span><span class="n">axon_soma_angle_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">soma_center</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mesh_center</span>

            <span class="n">possible_axon_limbs_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">query</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;soma_starting_angle&gt;</span><span class="si">{</span><span class="n">axon_soma_angle_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">soma_starting_angle</span><span class="p">],</span>
                           <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">soma_center</span><span class="o">=</span><span class="n">soma_center</span><span class="p">,</span>
                                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>

            <span class="n">possible_axon_limbs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">possible_axon_limbs_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">possible_axon_limbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nru</span><span class="o">.</span><span class="n">get_limb_int_name</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">possible_axon_limbs</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">possible_axon_limbs</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_limb_names</span><span class="p">(</span><span class="n">return_int</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Part 0: possible_axon_limbs = </span><span class="si">{</span><span class="n">possible_axon_limbs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


        <span class="c1">#---------1) Initial query to filter branches ---------</span>
    <span class="c1">#     low_density_limb_branch = ns.query_neuron(neuron_obj,</span>
    <span class="c1">#                    functions_list=[ns.synapse_density,ns.width_new,ns.n_spines,ns.n_synapses_post_spine,</span>
    <span class="c1">#                                   ns.synapse_density_post_offset_endpoint_upstream,</span>
    <span class="c1">#                                   ns.n_synapses_spine_offset_endpoint_upstream],</span>
    <span class="c1">#                     query=(f&quot;((synapse_density&lt;{ais_syn_density_max}) or ((synapse_density_post_offset_endpoint_upstream &lt; {ais_syn_density_max_offset}) and (synapse_density &lt; {ais_syn_density_max_backup})))&quot;</span>
    <span class="c1">#                            f&quot; and (width_new &gt; {ais_width_min}) &quot;</span>
    <span class="c1">#                            f&quot;and (n_synapses_spine_offset_endpoint_upstream &lt; {n_synapses_spine_offset_endpoint_upstream_max})&quot;),  </span>
    <span class="c1">#                                               limbs_to_process=possible_axon_limbs,</span>
    <span class="c1">#                    )</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">curr_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skeletal_length &gt; </span><span class="si">{</span><span class="n">min_skeletal_length</span><span class="si">}</span><span class="s2"> &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot; and ((synapse_density_offset_endpoint_upstream &lt; </span><span class="si">{</span><span class="n">ais_syn_density_max</span><span class="si">}</span><span class="s2">) or (n_synapses_offset_endpoint_upstream &lt;= </span><span class="si">{</span><span class="n">ais_syn_alternative_max</span><span class="si">}</span><span class="s2">))&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot; and (n_synapses_pre_offset_endpoint_upstream &lt;= </span><span class="si">{</span><span class="n">ais_n_syn_pre_max</span><span class="si">}</span><span class="s2">)&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot; and (width_new &gt; </span><span class="si">{</span><span class="n">ais_width_min</span><span class="si">}</span><span class="s2">) and (width_new &lt; </span><span class="si">{</span><span class="n">ais_width_max</span><span class="si">}</span><span class="s2">) &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;and (n_synapses_spine_offset_endpoint_upstream &lt; </span><span class="si">{</span><span class="n">n_synapses_spine_offset_endpoint_upstream_max</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">low_density_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">synapse_density</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">width_new</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">n_spines</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_spine</span><span class="p">,</span>
                                          <span class="n">ns</span><span class="o">.</span><span class="n">synapse_density_offset_endpoint_upstream</span><span class="p">,</span>
                                          <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_spine_offset_endpoint_upstream</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_offset_endpoint_upstream</span><span class="p">,</span>
                                           <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_pre_offset_endpoint_upstream</span><span class="p">,</span>
                                          <span class="p">],</span>
                            <span class="n">query</span><span class="o">=</span><span class="n">curr_query</span><span class="p">,</span>  
                                                      <span class="n">limbs_to_process</span><span class="o">=</span><span class="n">possible_axon_limbs</span><span class="p">,</span>
                           <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;branches_without_postsyn_req query = </span><span class="se">\n</span><span class="si">{</span><span class="n">curr_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">low_density_limb_branch_within_dist</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">skeletal_distance_from_soma_excluding_node</span><span class="p">],</span>
                    <span class="n">query</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;skeletal_distance_from_soma_excluding_node &lt; </span><span class="si">{</span><span class="n">max_search_distance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">low_density_limb_branch</span><span class="p">,</span>
                                                                 <span class="n">limbs_to_process</span><span class="o">=</span><span class="n">possible_axon_limbs</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;low_density_limb_branch = </span><span class="si">{</span><span class="n">low_density_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;low_density_limb_branch_within_dist = </span><span class="si">{</span><span class="n">low_density_limb_branch_within_dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_filt_branches_without_postsyn_req</span><span class="p">:</span>
                <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                          <span class="n">low_density_limb_branch_within_dist</span><span class="p">)</span>

            <span class="c1"># ------ 2) Restrict to Branches without a lot of postsyns downstream nearby -----</span>
            <span class="n">low_postsyn</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_downstream_within_dist</span><span class="p">],</span>
                    <span class="n">query</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;n_synapses_post_downstream_within_dist &lt; </span><span class="si">{</span><span class="n">n_postsyn_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                                                  <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="n">postsyn_distance</span><span class="p">),</span>
                           <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">low_density_limb_branch_within_dist</span><span class="p">)</span>


            <span class="c1"># ------- Phase 2: Gathering into Candidates ----------</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;low_postsyn = </span><span class="si">{</span><span class="n">low_postsyn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_low_postsyn_branches</span><span class="p">:</span>
                <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                          <span class="n">low_postsyn</span><span class="p">)</span>

        <span class="c1">#     axon_candidates = []</span>
        <span class="c1">#     for l_idx,b_idxs in low_postsyn.items():</span>
        <span class="c1">#         limb_obj = neuron_obj[l_idx]</span>
        <span class="c1">#         G = limb_obj.concept_network_directional</span>

        <span class="c1">#         limb_conn_comp = xu.downstream_conn_comps(G,</span>
        <span class="c1">#         nodes = b_idxs,</span>
        <span class="c1">#         start_node = limb_obj.current_starting_node,</span>
        <span class="c1">#         verbose = False</span>
        <span class="c1">#         )</span>

        <span class="c1">#         if verbose:</span>
        <span class="c1">#             print(f&quot;{l_idx} : limb_conn_comp = {limb_conn_comp}&quot;)</span>

        <span class="c1">#         limb_candidates = [dict(limb_idx = l_idx,start_node=k,branches=v,) for k,v in limb_conn_comp.items()]</span>
        <span class="c1">#         axon_candidates += limb_candidates</span>

            <span class="n">axon_candidates</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">candidate_groups_from_limb_branch</span><span class="p">(</span>
                                <span class="n">neuron_obj</span><span class="p">,</span>
                                <span class="n">low_postsyn</span><span class="p">,</span>
                                <span class="n">print_candidates</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">connected_component_method</span> <span class="o">=</span> <span class="s2">&quot;local_radius&quot;</span><span class="p">,</span>
                                <span class="n">radius</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
                                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before filtering canddiate, axon_candidates = </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">axon_candidates</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">filter_candidate_branches_by_downstream_postsyn</span><span class="p">(</span>
                <span class="n">neuron_obj</span><span class="p">,</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="n">axon_candidates</span><span class="p">,</span>
                <span class="n">postsyn_density_max</span><span class="o">=</span><span class="n">candidate_downstream_postsyn_density_max</span><span class="p">,</span>
            <span class="p">)</span>
            

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(axon_candidates) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates = </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ais_width_filter</span><span class="p">:</span>
                <span class="n">axon_candidates_ais_width</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">:</span>
                    <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]]</span>
                    <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;start_node&quot;</span><span class="p">]</span>
                    <span class="n">downstream_nodes</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]</span>

                    <span class="n">ais_width_ac</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">width_downstream_restricted</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                                                  <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">branch_idx</span><span class="p">,</span>
                                <span class="n">downstream_skeletal_length</span><span class="o">=</span><span class="n">ais_new_width_downstream_skeletal_length</span><span class="p">,</span>
                                                                   <span class="n">downstream_nodes</span><span class="o">=</span><span class="n">downstream_nodes</span><span class="p">,</span>
                                                                  <span class="p">)</span>
                    <span class="n">axon_candidates_ais_width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ais_width_ac</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates_ais_width = </span><span class="si">{</span><span class="n">axon_candidates_ais_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">a_w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">,</span><span class="n">axon_candidates_ais_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">a_w</span> <span class="o">&gt;</span> <span class="n">ais_new_width_min</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After AIS width threhold&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(axon_candidates) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates = </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ais_max_distance_from_soma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                --- 8/11 </span>
<span class="sd">                    Purpose: Will require that the start of the canddiate is within a certain distance</span>
<span class="sd">                    of the soma</span>

<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">axon_candidates_soma_dist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">:</span>
                    <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]]</span>
                    <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;start_node&quot;</span><span class="p">]</span>
                    <span class="n">downstream_nodes</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]</span>

                    <span class="n">curr_soma_dist</span> <span class="o">=</span> <span class="n">nst</span><span class="o">.</span><span class="n">distance_from_soma</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">)</span>
                    <span class="n">axon_candidates_soma_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_soma_dist</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates_soma_dist = </span><span class="si">{</span><span class="n">axon_candidates_soma_dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">a_w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">,</span><span class="n">axon_candidates_soma_dist</span><span class="p">)</span> <span class="k">if</span> <span class="n">a_w</span> <span class="o">&lt;</span> <span class="n">ais_max_distance_from_soma</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After AIS distance from soma threshold&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(axon_candidates) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates = </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="c1"># ------- Phase 3: Picking winning Candidate ----------s</span>




            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">attempt_second_pass</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found at least one candidate so breaking&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">!!No candidates found so trying to find candidate again with new parameters&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing ais_syn_density_max (</span><span class="si">{</span><span class="n">ais_syn_density_max</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">ais_syn_density_max_backup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing ais_n_syn_pre_max (</span><span class="si">{</span><span class="n">ais_n_syn_pre_max</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">ais_n_syn_pre_max_backup</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="n">ais_syn_density_max_backup</span>
                <span class="n">ais_n_syn_pre_max</span> <span class="o">=</span> <span class="n">ais_n_syn_pre_max_backup</span>
                <span class="n">max_search_distance</span> <span class="o">+=</span> <span class="n">max_search_distance</span> <span class="o">+</span> <span class="n">max_search_distance_addition_backup</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">axon_classification_without_synapses_if_no_candidate</span><span class="p">)</span> <span class="ow">or</span> <span class="n">axon_classification_without_synapses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running axon_classification_without_synapses because no axon candidates found&quot;</span><span class="p">)</span>
        <span class="n">ax_cand_no_syn</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">axon_classification_without_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">plot_final_axon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                     <span class="n">return_candidate</span><span class="o">=</span><span class="kc">True</span>
                                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">ax_cand_no_syn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax_cand_no_syn</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">return_best_candidate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        
        <span class="n">found_best_candidate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">skeletal_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">skeletal_length</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">])</span>

<span class="c1">#         if ((best_candidate_method == &quot;large_skeletal_length_within_close_soma_distance&quot;) and (not found_best_candidate)):</span>
<span class="c1">#             &quot;&quot;&quot;</span>
<span class="c1">#             Added 12/6</span>
<span class="c1">#             Purpose: If there are candidate that have a large skeletal length and within a close distance to soma, </span>
<span class="c1">#             chose the largest one of those</span>
            
<span class="c1">#             Pseudocode: </span>
<span class="c1">#             1) Find the distance of all candidates to the soma</span>
<span class="c1">#             2) Find the lengths of all of the candidates</span>
<span class="c1">#             3) Check to see if any meet the soma distance and skeletal length criterion</span>
<span class="c1">#             4) If so choose the closest candidate</span>
            
<span class="c1">#             &quot;&quot;&quot;</span>
<span class="c1">#             large_skeletal_length_within_close_soma_distance_sk_length_threshold = 35_000</span>
<span class="c1">#             large_skeletal_length_within_close_soma_distance_soma_distance_threshold = 20_000</span>
            
<span class="c1">#             axon_candidates_soma_dist = np.array([nst.distance_from_soma_candidate(neuron_obj,a) for a in axon_candidates])</span>
            
            
        
        <span class="k">if</span> <span class="p">((</span><span class="n">best_candidate_method</span> <span class="o">==</span> <span class="s2">&quot;max_skeletal_length_above_threshold_and_buffer&quot;</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">((</span><span class="s2">&quot;max_skeletal_length_above_threshold_and_buffer&quot;</span> <span class="ow">in</span> <span class="n">backup_best_candidate_method</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">found_best_candidate</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Method max_skeletal_length_above_threshold_and_buffer&quot;</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Purpose: If there is a lot of section that is low density and more than other sections</span>
<span class="sd">            --&gt; then make this the axon</span>
<span class="sd">            </span>
<span class="sd">            Psueodocde: </span>
<span class="sd">            1) Check if any of the skeletal length is above the threshold</span>
<span class="sd">            2) Check that the buffer between max skeletal length and others is above the buffer</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">max_skeletal_length_above_threshold_and_buffer_soma_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">max_skeletal_length_above_threshold_and_buffer_soma_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
                
            
            <span class="n">axon_candidates_soma_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nst</span><span class="o">.</span><span class="n">distance_from_soma_candidate</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">sm_dist</span> <span class="ow">in</span> <span class="n">max_skeletal_length_above_threshold_and_buffer_soma_ranges</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">found_best_candidate</span><span class="p">:</span>
                    <span class="k">break</span>
                    
                <span class="n">above_threshold_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">skeletal_lengths</span> <span class="o">&gt;</span> <span class="n">max_skeletal_length_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                               <span class="p">(</span><span class="n">axon_candidates_soma_dist</span> <span class="o">&lt;</span> <span class="n">sm_dist</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;above_threshold_len (for sm_dist = </span><span class="si">{</span><span class="n">sm_dist</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">above_threshold_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_threshold_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axon_candidates_local</span> <span class="o">=</span> <span class="p">[</span><span class="n">axon_candidates</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">above_threshold_len</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">skeletal_lengths_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nru</span><span class="o">.</span><span class="n">skeletal_length_over_candidate</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates_local</span><span class="p">])</span>
                    
                    <span class="n">max_sk_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skeletal_lengths_local</span><span class="p">)</span>
                    <span class="n">below_max_sk_len</span> <span class="o">=</span> <span class="n">skeletal_lengths_local</span><span class="o">-</span><span class="n">max_sk_len</span>
                    <span class="n">n_above_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">below_max_sk_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">max_skeletal_length_buffer</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;below_max_sk_len = </span><span class="si">{</span><span class="n">below_max_sk_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_above_buffer = </span><span class="si">{</span><span class="n">n_above_buffer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span>  <span class="n">n_above_buffer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">winning_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">skeletal_lengths_local</span><span class="p">)</span>
                        <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">axon_candidates_local</span><span class="p">[</span><span class="n">winning_idx</span><span class="p">]]</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding axon candidate </span><span class="si">{</span><span class="n">winning_idx</span><span class="si">}</span><span class="s2"> as winner due to max_skeletal_length_above_threshold_and_buffer&quot;</span><span class="p">)</span>

                        <span class="n">found_best_candidate</span> <span class="o">=</span> <span class="kc">True</span>
                
        
        <span class="k">if</span> <span class="n">best_candidate_method</span> <span class="o">==</span> <span class="s2">&quot;significant_lowest_density&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Psuedocode: </span>
<span class="sd">            1) Restrict the candidates to only those of a certain length</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">viable_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">skeletal_lengths</span> <span class="o">&gt;</span> <span class="n">significant_lowest_density_min_skeletal_length</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;viable_lengths = </span><span class="si">{</span><span class="n">viable_lengths</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viable_lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axon_candid_limb_branch</span> <span class="o">=</span> <span class="p">[{</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]:</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">]</span>
                <span class="n">syn_densities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">syu</span><span class="o">.</span><span class="n">synapse_density_over_limb_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                        <span class="n">axon_candid_limb_branch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">viable_lengths</span><span class="p">])</span>
                    
                <span class="n">min_syn_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">syn_densities</span><span class="p">)</span>
                <span class="n">syn_density_ratio</span> <span class="o">=</span> <span class="n">syn_densities</span><span class="o">/</span><span class="n">min_syn_density</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_densities = </span><span class="si">{</span><span class="n">syn_densities</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;min_syn_density = </span><span class="si">{</span><span class="n">min_syn_density</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_density_ratio = </span><span class="si">{</span><span class="n">syn_density_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="n">one_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">syn_density_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_ratio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">syn_density_ratio</span><span class="p">[</span><span class="n">syn_density_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="n">min_syn_density_2nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">syn_density_ratio</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;min_syn_density_2nd = </span><span class="si">{</span><span class="n">min_syn_density_2nd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">min_syn_density_2nd</span> <span class="o">&gt;</span> <span class="n">lowest_density_ratio</span><span class="p">:</span>
                        <span class="n">winning_idx</span> <span class="o">=</span> <span class="n">viable_lengths</span><span class="p">[</span><span class="n">one_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">axon_candidates</span><span class="p">[</span><span class="n">winning_idx</span><span class="p">]]</span>
                        <span class="n">found_best_candidate</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting winning axon candidate (</span><span class="si">{</span><span class="n">winning_idx</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">best_candidate_method</span> <span class="o">==</span> <span class="s2">&quot;max_skeletal_length&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s2">&quot;max_skeletal_length&quot;</span> <span class="ow">in</span> <span class="n">backup_best_candidate_method</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">found_best_candidate</span><span class="p">)):</span>
            <span class="n">winning_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">skeletal_lengths</span><span class="p">)</span>
            <span class="n">axon_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">axon_candidates</span><span class="p">[</span><span class="n">winning_idx</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using max_skeletal_length for setting the axon &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skeletal_lengths = </span><span class="si">{</span><span class="n">skeletal_lengths</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;winning_idx = </span><span class="si">{</span><span class="n">winning_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_candidates = </span><span class="si">{</span><span class="n">axon_candidates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise Exception(f&quot;Unimplmented best_candidate_method = {best_candidate_method}&quot;)</span>

    <span class="c1"># determing all downstream axon branches from the remaining axon candidates</span>
    <span class="n">axon_full_candidates</span> <span class="o">=</span> <span class="p">[{</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]:</span><span class="n">cnu</span><span class="o">.</span><span class="n">all_downtream_branches_including_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]],</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;start_node&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axon_candidates</span><span class="p">]</span>

    <span class="n">full_axon_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">(</span><span class="n">axon_full_candidates</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;full_axon_limb_branch = </span><span class="si">{</span><span class="n">full_axon_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_final_axon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of final axon groups = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_full_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;full_axon_limb_branch = </span><span class="si">{</span><span class="n">full_axon_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">full_axon_limb_branch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After plotting plot_limb_branch_dict&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">set_axon_labels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clean_prior_axon_labels</span><span class="p">:</span>
            <span class="n">nru</span><span class="o">.</span><span class="n">clear_all_branch_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>

        <span class="n">nru</span><span class="o">.</span><span class="n">add_branch_label</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">full_axon_limb_branch</span><span class="p">,</span>
                        <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;axon&quot;</span><span class="p">)</span>

    <span class="n">full_axon_limb_branch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">full_axon_limb_branch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    7/22: Will label the merge errors</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">label_merge_errors</span><span class="p">:</span>
        <span class="n">axon_on_dendrite_dict</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">compute_axon_on_dendrite_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                        <span class="n">plot_axon_on_dendrite</span><span class="o">=</span><span class="n">plot_axon_on_dendrite</span><span class="p">,</span>
                                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_on_dendrite_dict= </span><span class="si">{</span><span class="n">axon_on_dendrite_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        
        
        <span class="n">dendrite_on_axon_dict</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">compute_dendrite_on_axon_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                            <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma_dendr_on_axon</span><span class="p">,</span>
                                             <span class="n">plot_final_dendrite_on_axon</span> <span class="o">=</span> <span class="n">plot_dendrite_on_axon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dendrite_on_axon_dict= </span><span class="si">{</span><span class="n">dendrite_on_axon_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    7/22: Will calculate the trajectory of the axon </span>
<span class="sd">    candidates</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">return_axon_angle_info</span><span class="p">:</span>
        <span class="n">axon_full_candidates_axon_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">short_thick_limb_branch</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">short_thick_branches_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">plot_limb_branch_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">a_full</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">,</span><span class="n">axon_full_candidates</span><span class="p">):</span>
                <span class="n">limb_idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">])</span>
                <span class="n">max_angle</span><span class="p">,</span><span class="n">min_angle</span><span class="p">,</span><span class="n">n_angles</span> <span class="o">=</span> <span class="n">nst</span><span class="o">.</span><span class="n">trajectory_angle_from_start_branch_and_subtree</span><span class="p">(</span><span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">],</span>
                                                                                                  <span class="n">start_branch_idx</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;start_node&quot;</span><span class="p">],</span>
                                                                                                  <span class="n">subtree_branches</span> <span class="o">=</span> <span class="n">a_full</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">],</span>
                                                                                    <span class="n">nodes_to_exclude</span><span class="o">=</span><span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_get</span><span class="p">(</span><span class="n">short_thick_limb_branch</span><span class="p">,</span><span class="n">limb_idx</span><span class="p">),</span>
                                                                                                  <span class="n">return_max_min</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_n_angles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                                                 <span class="n">downstream_distance</span><span class="o">=</span><span class="n">downstream_distance_for_axon_angle</span><span class="p">)</span>
                <span class="n">axon_full_candidates_axon_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">axon_angle_max</span> <span class="o">=</span> <span class="n">max_angle</span><span class="p">,</span>
                                                       <span class="n">axon_angle_min</span> <span class="o">=</span> <span class="n">min_angle</span><span class="p">,</span>
                                                       <span class="n">n_axon_angles</span> <span class="o">=</span><span class="n">n_angles</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axon_full_candidates_axon_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">axon_angle_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">axon_angle_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">n_axon_angles</span> <span class="o">=</span><span class="mi">0</span> <span class="p">))</span>
            
        <span class="k">if</span> <span class="n">return_best_candidate</span><span class="p">:</span>
            <span class="n">axon_full_candidates_axon_angles</span> <span class="o">=</span> <span class="n">axon_full_candidates_axon_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">full_axon_limb_branch</span><span class="p">,</span><span class="n">axon_full_candidates_axon_angles</span>
    
    <span class="k">return</span> <span class="n">full_axon_limb_branch</span></div>


<div class="viewcode-block" id="axon_classification_excitatory"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_classification_excitatory">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_classification_excitatory</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># for excitatory</span>
    <span class="n">ais_max_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="c1">#dendrite on soma</span>
    <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1">#100000  </span>
    
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To label the axon on an excitatory neuron</span>
<span class="sd">    </span>
<span class="sd">    Example: </span>
<span class="sd">    </span>
<span class="sd">    segment_id = 864691136333776819</span>
<span class="sd">    neuron_obj = du.decomposition_with_spine_recalculation(segment_id,0,</span>
<span class="sd">                                                        ignore_DecompositionCellType=True )</span>
<span class="sd">    validation=True</span>
<span class="sd">    n_obj_exc_1 = syu.add_synapses_to_neuron_obj(neuron_obj,</span>
<span class="sd">                                validation = validation,</span>
<span class="sd">                                verbose  = True,</span>
<span class="sd">                                original_mesh = None,</span>
<span class="sd">                                plot_valid_error_synapses = True,</span>
<span class="sd">                                calculate_synapse_soma_distance = False,</span>
<span class="sd">                                add_valid_synapses = True,</span>
<span class="sd">                                  add_error_synapses=False)</span>

<span class="sd">    au.axon_classification_excitatory(</span>
<span class="sd">        neuron_obj = n_obj_exc_1</span>
<span class="sd">    )</span>
<span class="sd">    nviz.plot_axon(n_obj_exc_1)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axon_soma_angle_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="n">axon_soma_angle_threshold_excitatory_global</span>
        
    <span class="k">if</span> <span class="n">ais_max_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_max_distance_from_soma</span> <span class="o">=</span> <span class="n">ais_max_distance_from_soma_excitatory_global</span>
        
    <span class="k">if</span> <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses_if_no_candidate_excitatory_global</span>
        
    <span class="k">if</span> <span class="n">axon_classification_without_synapses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses_excitatory_global</span>
        
        
    <span class="k">if</span> <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="n">min_distance_from_soma_excitatory_dendr_on_axon_global</span>
        
    <span class="k">if</span> <span class="n">ais_syn_density_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="n">ais_syn_density_max_excitatory_global</span>
    <span class="k">if</span> <span class="n">ais_syn_density_max_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="n">ais_syn_density_max_backup_excitatory_global</span>
        
    
    <span class="k">return</span> <span class="n">axon_classification_using_synapses</span><span class="p">(</span>
                <span class="n">neuron_obj</span><span class="p">,</span>
                <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="n">axon_soma_angle_threshold</span><span class="p">,</span>
                <span class="n">ais_max_distance_from_soma</span><span class="o">=</span><span class="n">ais_max_distance_from_soma</span><span class="p">,</span>
                <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses_if_no_candidate</span><span class="p">,</span>
                <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="n">axon_classification_without_synapses</span><span class="p">,</span>
                <span class="n">min_distance_from_soma_dendr_on_axon</span><span class="o">=</span><span class="n">min_distance_from_soma_dendr_on_axon</span><span class="p">,</span>
                <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="n">ais_syn_density_max</span><span class="p">,</span>
                <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="n">ais_syn_density_max_backup</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="axon_classification_inhibitory"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_classification_inhibitory">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_classification_inhibitory</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span><span class="c1"># for excitatory</span>
    <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_new_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma_dendr_on_axon</span> <span class="o">=</span> <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon_global</span>
        
    <span class="k">if</span> <span class="n">ais_new_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_new_width_min</span><span class="o">=</span> <span class="n">ais_new_width_min_inhibitory_global</span>
        
    <span class="k">return</span> <span class="n">axon_classification_using_synapses</span><span class="p">(</span>
                <span class="n">neuron_obj</span><span class="p">,</span>
                <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">min_distance_from_soma_dendr_on_axon</span><span class="o">=</span><span class="n">min_distance_from_soma_dendr_on_axon</span><span class="p">,</span>
                <span class="n">ais_new_width_min</span><span class="o">=</span><span class="n">ais_new_width_min</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="myelination_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.myelination_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">myelination_limb_branch_dict</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#8_000,</span>
    <span class="n">max_synapse_density</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.00007,</span>
    <span class="n">max_synapse_density_pass_2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1"># 0.0001,</span>
    <span class="n">min_skeletal_length_pass_2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#20_000,</span>
    <span class="n">max_width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#650,</span>
    <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#10_000,</span>
    <span class="n">min_distance_from_soma_pass_2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limb_branch_dict_restriction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skeletal_length_downstream_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_synapses_post_downstream_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the parts of the axon that are myelinated</span>
<span class="sd">    with low postsyn and low width</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">min_skeletal_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="n">min_skeletal_length_myelin_global</span>
    <span class="k">if</span> <span class="n">max_synapse_density</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_synapse_density</span> <span class="o">=</span> <span class="n">max_synapse_density_myelin_global</span>
        
        
    <span class="k">if</span> <span class="n">min_skeletal_length_pass_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_skeletal_length_pass_2</span> <span class="o">=</span> <span class="n">min_skeletal_length_pass_2_myelin_global</span>
    <span class="k">if</span> <span class="n">max_synapse_density_pass_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_synapse_density_pass_2</span> <span class="o">=</span> <span class="n">max_synapse_density_pass_2_myelin_global</span>  
    <span class="k">if</span> <span class="n">min_distance_from_soma_pass_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma_pass_2</span> <span class="o">=</span> <span class="n">min_distance_from_soma_pass_2_myelin_global</span>
    
    <span class="k">if</span> <span class="n">max_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="n">max_width_myelin_global</span>
    <span class="k">if</span> <span class="n">min_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma_myelin_global</span>
    <span class="k">if</span> <span class="n">skeletal_length_downstream_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_downstream_min</span> <span class="o">=</span> <span class="n">skeletal_length_downstream_min_ax_on_dendr_global</span>
        
    <span class="k">if</span> <span class="n">n_synapses_post_downstream_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_post_downstream_max</span> <span class="o">=</span> <span class="n">n_synapses_post_downstream_max_myelin_global</span>
        
    <span class="n">total_myelin_lb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">min_sk_len</span><span class="p">,</span><span class="n">max_syn_density</span><span class="p">,</span><span class="n">min_soma_dist</span><span class="p">,</span><span class="n">downstr_post_max</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">min_skeletal_length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">min_skeletal_length</span><span class="p">,</span><span class="n">min_skeletal_length_pass_2</span><span class="p">],</span>
               <span class="p">[</span><span class="n">max_synapse_density</span><span class="p">,</span><span class="n">max_synapse_density</span><span class="p">,</span><span class="n">max_synapse_density_pass_2</span><span class="p">],</span>
               <span class="p">[</span><span class="n">min_distance_from_soma</span><span class="p">,</span><span class="n">min_distance_from_soma</span><span class="p">,</span><span class="n">min_distance_from_soma_pass_2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">n_synapses_post_downstream_max_myelin_global</span><span class="p">,</span><span class="n">n_synapses_post_downstream_max_myelin_global</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">100000000</span><span class="p">])):</span>
        <span class="n">myelination_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt; </span><span class="si">{</span><span class="n">min_sk_len</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and (synapse_density_post &lt; </span><span class="si">{</span><span class="n">max_syn_density</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and (axon_width &lt; </span><span class="si">{</span><span class="n">max_width</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="c1">#f&quot;and (is_axon_like == False)&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and (is_axon == False)&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and (distance_from_soma &gt; </span><span class="si">{</span><span class="n">min_soma_dist</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; and (skeletal_length_downstream &gt; </span><span class="si">{</span><span class="n">skeletal_length_downstream_min</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
        <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;skeletal_length&quot;</span><span class="p">,</span>
                            <span class="n">ns</span><span class="o">.</span><span class="n">synapse_density_post</span><span class="p">,</span>
                            <span class="n">ns</span><span class="o">.</span><span class="n">axon_width</span><span class="p">,</span>
                            <span class="c1">#ns.is_axon_like,</span>
                            <span class="n">ns</span><span class="o">.</span><span class="n">is_axon</span><span class="p">,</span>
                            <span class="n">ns</span><span class="o">.</span><span class="n">distance_from_soma</span><span class="p">,</span>
                            <span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length_downstream</span><span class="p">,</span>
                           <span class="p">]</span>
        <span class="k">if</span> <span class="n">downstr_post_max</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">myelination_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and (n_synapses_post_downstream &lt; </span><span class="si">{</span><span class="n">downstr_post_max</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">functions_list</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_downstream</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;myelination_query </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">myelination_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">myelin_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">functions_list</span><span class="o">=</span><span class="n">functions_list</span><span class="p">,</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">myelination_query</span><span class="p">,</span>
            <span class="n">plot_limb_branch_dict</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">dendrite_limb_branch_dict</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;myelin_dict_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">myelin_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">total_myelin_lb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myelin_dict</span><span class="p">)</span>
        
    <span class="n">myelin_dict_total</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">(</span><span class="n">total_myelin_lb</span><span class="p">)</span>   
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;myelin_dict_total= </span><span class="si">{</span><span class="n">myelin_dict_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        
    <span class="k">return</span> <span class="n">myelin_dict_total</span></div>

    


<div class="viewcode-block" id="compute_axon_on_dendrite_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.compute_axon_on_dendrite_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compute_axon_on_dendrite_limb_branch_dict</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    
    <span class="n">width_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#270,</span>
    <span class="n">n_spines_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#10,</span>
    <span class="n">n_synapses_post_spine_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#3,</span>
    <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1,</span>
    <span class="n">synapse_pre_perc_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.6,</span>
    <span class="n">synapse_pre_perc_downstream_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.9,</span>
    <span class="n">axon_skeletal_legnth_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#3000,</span>
                                      
    
    <span class="n">skeletal_length_downstream_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#7000</span>
    <span class="n">filter_away_thin_branches</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#True,</span>
    <span class="n">dendrite_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#80,</span>
    <span class="n">thin_axon_skeletal_length_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#4000,</span>
    <span class="n">thin_axon_n_synapses_post_downstream_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#3,</span>
    
    <span class="c1">#for the thick myelinated axon</span>
    <span class="n">filter_away_myelination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#True</span>
                                              
    <span class="c1">#safety nets for insignificant branches</span>
    <span class="n">mesh_area_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#1,</span>
    <span class="n">closest_mesh_skeleton_dist_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#500,</span>
                                      
    <span class="n">plot_axon_on_dendrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">set_axon_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">clean_prior_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                              
    <span class="n">prevent_downstream_axon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                      
                                      
                
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the dendritic</span>
<span class="sd">    branches that are axon-like</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Query for dendritic branhes that are</span>
<span class="sd">    a. thin</span>
<span class="sd">    b. Have at least one presyn</span>
<span class="sd">    c. have a high pre_percentage</span>

<span class="sd">    2) Restrict the query to only those</span>
<span class="sd">    with a high pre percentage</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">width_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_max</span> <span class="o">=</span> <span class="n">width_max_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">n_spines_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_spines_max</span> <span class="o">=</span> <span class="n">n_spines_max_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">n_synapses_post_spine_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_post_spine_max</span> <span class="o">=</span> <span class="n">n_synapses_post_spine_max_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">n_synapses_pre_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="n">n_synapses_pre_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">synapse_pre_perc_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_pre_perc_min</span> <span class="o">=</span> <span class="n">synapse_pre_perc_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">synapse_pre_perc_downstream_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_pre_perc_downstream_min</span> <span class="o">=</span> <span class="n">synapse_pre_perc_downstream_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">axon_skeletal_legnth_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_skeletal_legnth_min</span> <span class="o">=</span> <span class="n">axon_skeletal_legnth_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">filter_away_thin_branches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_away_thin_branches</span> <span class="o">=</span> <span class="n">filter_away_thin_branches_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">filter_away_myelination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_away_myelination</span> <span class="o">=</span> <span class="n">filter_away_myelination_myelin_global</span>
    <span class="k">if</span> <span class="n">dendrite_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dendrite_width_min</span> <span class="o">=</span> <span class="n">dendrite_width_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">thin_axon_skeletal_length_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thin_axon_skeletal_length_min</span> <span class="o">=</span> <span class="n">thin_axon_skeletal_length_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">thin_axon_n_synapses_post_downstream_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thin_axon_n_synapses_post_downstream_max</span> <span class="o">=</span> <span class="n">thin_axon_n_synapses_post_downstream_max_ax_on_dendr_global</span>
        
    <span class="k">if</span> <span class="n">mesh_area_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh_area_min</span> <span class="o">=</span> <span class="n">mesh_area_min_ax_on_dendr_global</span>
    <span class="k">if</span> <span class="n">closest_mesh_skeleton_dist_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">closest_mesh_skeleton_dist_max</span> <span class="o">=</span> <span class="n">closest_mesh_skeleton_dist_max_ax_on_dendr_global</span>
    
    <span class="k">if</span> <span class="n">skeletal_length_downstream_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skeletal_length_downstream_min</span> <span class="o">=</span> <span class="n">skeletal_length_downstream_min_ax_on_dendr_global</span>
    
    <span class="n">pre_limb_branch</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">dendrite_limb_branch_dict</span>
    
    
    
    <span class="n">axon_like_dendr_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(n_synapses_pre &gt;= </span><span class="si">{</span><span class="n">n_synapses_pre_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(synapse_pre_perc &gt;= </span><span class="si">{</span><span class="n">synapse_pre_perc_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(axon_width &lt;= </span><span class="si">{</span><span class="n">width_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(n_spines &lt;= </span><span class="si">{</span><span class="n">n_spines_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(n_synapses_post_spine &lt;= </span><span class="si">{</span><span class="n">n_synapses_post_spine_max</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt; </span><span class="si">{</span><span class="n">axon_skeletal_legnth_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(area &gt; </span><span class="si">{</span><span class="n">mesh_area_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(closest_mesh_skeleton_dist &lt; </span><span class="si">{</span><span class="n">closest_mesh_skeleton_dist_max</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_like_dendr_query = </span><span class="si">{</span><span class="n">axon_like_dendr_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">axon_like_dendr</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                   <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_pre</span><span class="p">,</span>
                                   <span class="n">ns</span><span class="o">.</span><span class="n">synapse_pre_perc</span><span class="p">,</span>
                                  <span class="n">ns</span><span class="o">.</span><span class="n">axon_width</span><span class="p">,</span>
                                  <span class="n">ns</span><span class="o">.</span><span class="n">n_spines</span><span class="p">,</span>
                                  <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_spine</span><span class="p">,</span>
                                  <span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span>
                                  <span class="n">ns</span><span class="o">.</span><span class="n">closest_mesh_skeleton_dist</span><span class="p">,</span>
                                    <span class="n">ns</span><span class="o">.</span><span class="n">area</span><span class="p">],</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="n">axon_like_dendr_query</span><span class="p">,</span>
                    <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span>
                   <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_like_dendr = </span><span class="si">{</span><span class="n">axon_like_dendr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">pre_down_limb_branch_query</span> <span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(synapse_pre_perc_downstream &gt;= </span><span class="si">{</span><span class="n">synapse_pre_perc_downstream_min</span><span class="si">}</span><span class="s2">) or &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(n_synapses_downstream == 0) or (n_synapses_post_downstream &lt; </span><span class="si">{</span><span class="n">thin_axon_n_synapses_post_downstream_max</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_down_limb_branch_query = </span><span class="si">{</span><span class="n">pre_down_limb_branch_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">pre_down_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">synapse_pre_perc_downstream</span><span class="p">,</span>
                                                          <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_downstream</span><span class="p">,</span>
                                                          <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_downstream</span><span class="p">,],</span>
                                           <span class="n">query</span> <span class="o">=</span> <span class="n">pre_down_limb_branch_query</span><span class="p">,</span>
                                           <span class="n">limb_branch_dict_restriction</span> <span class="o">=</span> <span class="n">axon_like_dendr</span>
                                                        <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_down_limb_branch = </span><span class="si">{</span><span class="n">pre_down_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">filter_away_thin_branches</span><span class="p">:</span>
        <span class="n">thin_branches_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(width_new &lt;= </span><span class="si">{</span><span class="n">dendrite_width_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                                <span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt; </span><span class="si">{</span><span class="n">thin_axon_skeletal_length_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                                <span class="sa">f</span><span class="s2">&quot;(n_synapses_post_downstream &lt;= </span><span class="si">{</span><span class="n">thin_axon_n_synapses_post_downstream_max</span><span class="si">}</span><span class="s2">) and&quot;</span>
                                                <span class="sa">f</span><span class="s2">&quot;(area &gt; </span><span class="si">{</span><span class="n">mesh_area_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                                <span class="sa">f</span><span class="s2">&quot;(closest_mesh_skeleton_dist &lt; </span><span class="si">{</span><span class="n">closest_mesh_skeleton_dist_max</span><span class="si">}</span><span class="s2">)&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot; and (skeletal_length_downstream &gt; </span><span class="si">{</span><span class="n">skeletal_length_downstream_min</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;thin_branches_query= </span><span class="si">{</span><span class="n">thin_branches_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">thin_axon_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                               <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">width_new</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span>
                                                                <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_downstream</span><span class="p">,</span>
                                                              <span class="n">ns</span><span class="o">.</span><span class="n">closest_mesh_skeleton_dist</span><span class="p">,</span>
                                                                 <span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length_downstream</span><span class="p">,</span>
                                                              <span class="n">ns</span><span class="o">.</span><span class="n">area</span><span class="p">],</span>
                                <span class="n">query</span> <span class="o">=</span> <span class="n">thin_branches_query</span><span class="p">,</span>
                                                   <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_away_thin_branches = </span><span class="si">{</span><span class="n">filter_away_thin_branches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;thin_axon_limb_branch = </span><span class="si">{</span><span class="n">thin_axon_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">pre_down_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">thin_axon_limb_branch</span><span class="p">,</span><span class="n">pre_down_limb_branch</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="n">filter_away_myelination</span><span class="p">:</span>
        <span class="n">myelin_limb_branch</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">myelination_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                            <span class="n">skeletal_length_downstream_min</span><span class="o">=</span><span class="n">skeletal_length_downstream_min</span><span class="p">,</span>
                                                             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
                                                            <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filter_away_myelination set&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;myelin_limb_branch = </span><span class="si">{</span><span class="n">myelin_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">pre_down_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">myelin_limb_branch</span><span class="p">,</span><span class="n">pre_down_limb_branch</span><span class="p">])</span>
        
        
    <span class="k">if</span> <span class="n">prevent_downstream_axon</span><span class="p">:</span>
        <span class="n">axon_downstream</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">is_axon_in_downstream_branches</span><span class="p">,</span>
                                                             <span class="p">],</span>
                                            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;is_axon_in_downstream_branches&quot;</span><span class="p">,)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_downstream= </span><span class="si">{</span><span class="n">axon_downstream</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">pre_down_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_setdiff</span><span class="p">([</span><span class="n">pre_down_limb_branch</span><span class="p">,</span><span class="n">axon_downstream</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_down_limb_branch = </span><span class="si">{</span><span class="n">pre_down_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_axon_on_dendrite</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">pre_down_limb_branch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_axon_labels</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;axon-like&quot;</span><span class="p">,</span><span class="s2">&quot;axon-error&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clean_prior_labels</span><span class="p">:</span>
            <span class="n">nru</span><span class="o">.</span><span class="n">clear_all_branch_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
            
        <span class="n">nru</span><span class="o">.</span><span class="n">add_branch_label</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">pre_down_limb_branch</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pre_down_limb_branch</span></div>


<div class="viewcode-block" id="compute_dendrite_on_axon_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.compute_dendrite_on_axon_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compute_dendrite_on_axon_limb_branch_dict</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
                                              
    <span class="c1"># for filtering away starter ais branches</span>
    <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">synapse_post_perc_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dendrite_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dendrite_skeletal_length_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spine_density_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.00012,</span>
    <span class="n">plot_dendr_like_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="c1">#--- for a coarser catch for the dendrites -------</span>
    <span class="n">coarse_dendrite_filter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coarse_dendrite_axon_width_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#330</span>
    <span class="n">coarse_dendrite_synapse_post_perc_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.75</span>
    <span class="n">coarse_dendrite_n_synapses_post_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#20</span>
    <span class="n">coarse_dendrite_n_spines_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#10</span>
    <span class="n">coarse_dendrtie_spine_density</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="c1">#0.00015</span>
    
    <span class="n">add_low_branch_cluster_filter</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_low_branch_cluster_filter</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">synapse_post_perc_downstream_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_synapses_pre_downstream_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># arguments for filtering away thick banches</span>
    <span class="n">filter_away_spiney_branches</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_synapses_post_spine_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spine_density_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_spiney_branches</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="n">plot_final_dendrite_on_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">set_axon_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">clean_prior_labels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the axon branches that</span>
<span class="sd">    are dendritic-like</span>

<span class="sd">    Previous things used to find dendrites: </span>

<span class="sd">    dendritic_merge_on_axon_query=None,</span>
<span class="sd">    dendrite_merge_skeletal_length_min = 20000,</span>
<span class="sd">    dendrite_merge_width_min = 100,</span>
<span class="sd">    dendritie_spine_density_min = 0.00015,</span>

<span class="sd">    dendritic_merge_on_axon_query = (f&quot;labels_restriction == True and &quot;</span>
<span class="sd">                        f&quot;(median_mesh_center &gt; {dendrite_merge_width_min}) and  &quot;</span>
<span class="sd">                        f&quot;(skeletal_length &gt; {dendrite_merge_skeletal_length_min}) and &quot;</span>
<span class="sd">                        f&quot;(spine_density) &gt; {dendritie_spine_density_min}&quot;)</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Filter away the safe postsyn group</span>
<span class="sd">    - thick</span>
<span class="sd">    - has a postsyn</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">min_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">n_synapses_pre_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_pre_min</span> <span class="o">=</span> <span class="n">n_synapses_pre_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">synapse_post_perc_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_post_perc_min</span> <span class="o">=</span> <span class="n">synapse_post_perc_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">spine_density_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spine_density_min</span> <span class="o">=</span> <span class="n">spine_density_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">dendrite_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dendrite_width_min</span> <span class="o">=</span> <span class="n">dendrite_width_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">dendrite_skeletal_length_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dendrite_skeletal_length_min</span> <span class="o">=</span> <span class="n">dendrite_skeletal_length_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">synapse_post_perc_downstream_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_post_perc_downstream_min</span> <span class="o">=</span> <span class="n">synapse_post_perc_downstream_min_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">n_synapses_pre_downstream_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_pre_downstream_max</span> <span class="o">=</span> <span class="n">n_synapses_pre_downstream_max_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">filter_away_spiney_branches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_away_spiney_branches</span> <span class="o">=</span> <span class="n">filter_away_spiney_branches_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">n_synapses_post_spine_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_synapses_post_spine_max</span> <span class="o">=</span> <span class="n">n_synapses_post_spine_max_dendr_on_axon_global</span>
    <span class="k">if</span> <span class="n">spine_density_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spine_density_max</span> <span class="o">=</span> <span class="n">spine_density_max_dendr_on_axon_global</span>
        
        
    <span class="c1"># coarse dendrite filter: </span>
    <span class="k">if</span> <span class="n">coarse_dendrite_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrite_filter</span> <span class="o">=</span> <span class="n">coarse_dendrite_filter_global</span>
    <span class="k">if</span> <span class="n">coarse_dendrite_axon_width_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrite_axon_width_min</span> <span class="o">=</span> <span class="n">coarse_dendrite_axon_width_min_global</span>
    <span class="k">if</span> <span class="n">coarse_dendrite_synapse_post_perc_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrite_synapse_post_perc_min</span> <span class="o">=</span> <span class="n">coarse_dendrite_synapse_post_perc_min_global</span>
    <span class="k">if</span> <span class="n">coarse_dendrite_n_synapses_post_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrite_n_synapses_post_min</span> <span class="o">=</span> <span class="n">coarse_dendrite_n_synapses_post_min_global</span>
    <span class="k">if</span> <span class="n">coarse_dendrite_n_spines_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrite_n_spines_min</span> <span class="o">=</span> <span class="n">coarse_dendrite_n_spines_min_global</span>
    <span class="k">if</span> <span class="n">coarse_dendrtie_spine_density</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coarse_dendrtie_spine_density</span> <span class="o">=</span> <span class="n">coarse_dendrtie_spine_density_global</span>
        
    
    


    <span class="n">pre_limb_branch</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span>
    
    <span class="k">if</span> <span class="n">min_distance_from_soma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pre_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                         <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">distance_from_soma</span><span class="p">],</span>
                                         <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;distance_from_soma &gt; </span><span class="si">{</span><span class="n">min_distance_from_soma</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                         <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricting branches to only those a certain distance away from soma (</span><span class="si">{</span><span class="n">min_distance_from_soma</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_limb_branch AFTER restriction = </span><span class="si">{</span><span class="n">pre_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dendr_like_axon_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(n_synapses_pre &gt;= </span><span class="si">{</span><span class="n">n_synapses_pre_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;(synapse_post_perc &gt;= </span><span class="si">{</span><span class="n">synapse_post_perc_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(axon_width &gt;= </span><span class="si">{</span><span class="n">dendrite_width_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(spine_density &gt;= </span><span class="si">{</span><span class="n">spine_density_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                <span class="c1">#f&quot;(n_spines &lt;= {n_spines_max}) and &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt; </span><span class="si">{</span><span class="n">dendrite_skeletal_length_min</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dendr_like_axon_query = </span><span class="si">{</span><span class="n">dendr_like_axon_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">dendr_like_axon</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_pre</span><span class="p">,</span>
                                       <span class="n">ns</span><span class="o">.</span><span class="n">synapse_post_perc</span><span class="p">,</span>
                                      <span class="n">ns</span><span class="o">.</span><span class="n">axon_width</span><span class="p">,</span>
                                      <span class="n">ns</span><span class="o">.</span><span class="n">n_spines</span><span class="p">,</span>
                                      <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_spine</span><span class="p">,</span>
                                      <span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span>
                                      <span class="n">ns</span><span class="o">.</span><span class="n">spine_density</span><span class="p">],</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">dendr_like_axon_query</span><span class="p">,</span>
                        <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span>
                       <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dendr_like_axon = </span><span class="si">{</span><span class="n">dendr_like_axon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_dendr_like_axon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting: plot_dendr_like_axon&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">dendr_like_axon</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">coarse_dendrite_filter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using coarse dendrite filter&quot;</span><span class="p">)</span>
            
        <span class="n">coarse_dendrite_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(axon_width &gt;  </span><span class="si">{</span><span class="n">coarse_dendrite_axon_width_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;(synapse_post_perc &gt; </span><span class="si">{</span><span class="n">coarse_dendrite_synapse_post_perc_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(n_synapses_post &gt; </span><span class="si">{</span><span class="n">coarse_dendrite_n_synapses_post_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;(n_spines &gt; </span><span class="si">{</span><span class="n">coarse_dendrite_n_spines_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;(spine_density &gt; </span><span class="si">{</span><span class="n">coarse_dendrtie_spine_density</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">coarse_dendrite_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                               <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_pre</span><span class="p">,</span>
                                               <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post</span><span class="p">,</span>
                                               <span class="n">ns</span><span class="o">.</span><span class="n">synapse_post_perc</span><span class="p">,</span>
                                              <span class="n">ns</span><span class="o">.</span><span class="n">axon_width</span><span class="p">,</span>
                                              <span class="n">ns</span><span class="o">.</span><span class="n">n_spines</span><span class="p">,</span>
                                              <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_spine</span><span class="p">,</span>
                                              <span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span>
                                              <span class="n">ns</span><span class="o">.</span><span class="n">spine_density</span><span class="p">],</span>
                                <span class="n">query</span> <span class="o">=</span> <span class="n">coarse_dendrite_query</span><span class="p">,</span>
                                          <span class="n">return_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span><span class="p">,</span>
                                             <span class="n">plot_limb_branch_dict</span><span class="o">=</span><span class="kc">True</span>
                               <span class="p">)</span>
        
        
        <span class="n">dendr_like_axon</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">dendr_like_axon</span><span class="p">,</span><span class="n">coarse_dendrite_limb_branch</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coarse_dendrite_query = </span><span class="si">{</span><span class="n">coarse_dendrite_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coarse_dendrite_limb_branch = </span><span class="si">{</span><span class="n">coarse_dendrite_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After COARSE: dendr_like_axon = </span><span class="si">{</span><span class="n">dendr_like_axon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        
        
    <span class="n">post_down_limb_branch_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(synapse_post_perc_downstream &gt;= </span><span class="si">{</span><span class="n">synapse_post_perc_downstream_min</span><span class="si">}</span><span class="s2">) or &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;(n_synapses_downstream == 0) or (n_synapses_pre_downstream &lt; </span><span class="si">{</span><span class="n">n_synapses_pre_downstream_max</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">post_down_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">synapse_post_perc_downstream</span><span class="p">,</span>
                                                              <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_downstream</span><span class="p">,</span>
                                                              <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_pre_downstream</span><span class="p">],</span>
                                               <span class="n">query</span><span class="o">=</span><span class="n">post_down_limb_branch_query</span><span class="p">,</span>
                                               <span class="n">limb_branch_dict_restriction</span> <span class="o">=</span> <span class="n">dendr_like_axon</span>
                                                            <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;post_down_limb_branch_query= </span><span class="si">{</span><span class="n">post_down_limb_branch_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;post_down_limb_branch = </span><span class="si">{</span><span class="n">post_down_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_low_branch_cluster_filter</span><span class="p">:</span>
        <span class="n">low_branch_cluster_limb_branch</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">low_branch_length_large_clusters_axon</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                                  <span class="n">plot</span> <span class="o">=</span> <span class="n">plot_low_branch_cluster_filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;low_branch_cluster_limb_branch = </span><span class="si">{</span><span class="n">low_branch_cluster_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">post_down_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">low_branch_cluster_limb_branch</span><span class="p">,</span><span class="n">post_down_limb_branch</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">filter_away_spiney_branches</span><span class="p">:</span>
        <span class="n">spiney_limb_branch_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(axon_width &gt;= </span><span class="si">{</span><span class="n">dendrite_width_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                                    <span class="sa">f</span><span class="s2">&quot;(skeletal_length &gt; </span><span class="si">{</span><span class="n">dendrite_skeletal_length_min</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                                    <span class="sa">f</span><span class="s2">&quot;((n_synapses_post_spine &gt;= </span><span class="si">{</span><span class="n">n_synapses_post_spine_max</span><span class="si">}</span><span class="s2">) or &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;(spine_density &gt; </span><span class="si">{</span><span class="n">spine_density_max</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span>
        <span class="n">spiney_limb_branch</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                   <span class="n">functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">axon_width</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">skeletal_length</span><span class="p">,</span>
                                                                    <span class="n">ns</span><span class="o">.</span><span class="n">n_synapses_post_spine</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">spine_density</span><span class="p">],</span>
                                    <span class="n">query</span> <span class="o">=</span> <span class="n">spiney_limb_branch_query</span><span class="p">,</span>
                                                       <span class="n">limb_branch_dict_restriction</span><span class="o">=</span><span class="n">pre_limb_branch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spiney_limb_branch_query = </span><span class="si">{</span><span class="n">spiney_limb_branch_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spiney_limb_branch = </span><span class="si">{</span><span class="n">spiney_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_spiney_branches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting: spiney_limb_branch&quot;</span><span class="p">)</span>
            <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">spiney_limb_branch</span><span class="p">)</span>

        <span class="n">post_down_limb_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_union</span><span class="p">([</span><span class="n">spiney_limb_branch</span><span class="p">,</span><span class="n">post_down_limb_branch</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final dendrite on axon: </span><span class="si">{</span><span class="n">post_down_limb_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_final_dendrite_on_axon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting: final_dendrite_on_axon&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">post_down_limb_branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">set_axon_labels</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dendrite-like&quot;</span><span class="p">,</span><span class="s2">&quot;dendrite-error&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clean_prior_labels</span><span class="p">:</span>
            <span class="n">nru</span><span class="o">.</span><span class="n">clear_all_branch_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">nru</span><span class="o">.</span><span class="n">add_branch_label</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">post_down_limb_branch</span><span class="p">,</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>    

    <span class="k">return</span> <span class="n">post_down_limb_branch</span></div>


<div class="viewcode-block" id="compute_dendrite_on_axon_limb_branch_dict_excitatory"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.compute_dendrite_on_axon_limb_branch_dict_excitatory">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compute_dendrite_on_axon_limb_branch_dict_excitatory</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">min_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma_excitatory_dendr_on_axon_global</span>
    
    <span class="k">return</span> <span class="n">compute_dendrite_on_axon_limb_branch_dict</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargss</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="compute_dendrite_on_axon_limb_branch_dict_inhibitory"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.compute_dendrite_on_axon_limb_branch_dict_inhibitory">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compute_dendrite_on_axon_limb_branch_dict_inhibitory</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">min_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon_global</span>
    
    <span class="k">return</span> <span class="n">compute_dendrite_on_axon_limb_branch_dict</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">min_distance_from_soma</span> <span class="o">=</span> <span class="n">min_distance_from_soma</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargss</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="axon_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">axon_limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">axon_limb_branch_dict</span></div>

<div class="viewcode-block" id="dendrite_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.dendrite_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">dendrite_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">dendrite_limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">not_matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dendrite_limb_branch_dict</span></div>

<div class="viewcode-block" id="axon_on_dendrite_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_on_dendrite_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_on_dendrite_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">axon_limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon-error&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">axon_limb_branch_dict</span></div>

<div class="viewcode-block" id="dendrite_on_axon_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.dendrite_on_axon_limb_branch_dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">dendrite_on_axon_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">axon_limb_branch_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron_by_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">matching_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dendrite-error&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">axon_limb_branch_dict</span></div>
    
<div class="viewcode-block" id="axon_angles_from_neuron"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_angles_from_neuron">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_angles_from_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">return_max_min</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">return_n_angles</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">downstream_distance_for_axon_angle</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">return_dict</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to find the axon starting angle</span>
<span class="sd">    given an axon has already been classified</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the name of the axon limb</span>
<span class="sd">    2) if it has a name:</span>
<span class="sd">    - get the axon limb branch dict and extract out the branches</span>
<span class="sd">    3) send the branches to the trajectory angle function to get the axon angles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">downstream_distance_for_axon_angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downstream_distance_for_axon_angle</span> <span class="o">=</span> <span class="n">downstream_distance_for_axon_angle_global</span>

    <span class="n">axon_limb_name</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_name</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_limb_name = </span><span class="si">{</span><span class="n">axon_limb_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axon_limb_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_limb_name was None so setting angles to -1&quot;</span><span class="p">)</span>
        <span class="n">subtree_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">return_max_min</span><span class="p">:</span>
            <span class="n">max_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subtree_angles</span><span class="p">)</span>
            <span class="n">min_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">subtree_angles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_n_angles</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">max_angle</span><span class="p">,</span><span class="n">min_angle</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">max_angle</span><span class="p">,</span><span class="n">min_angle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">subtree_angles</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">short_thick_limb_branch</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">short_thick_branches_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">plot_limb_branch_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">axon_branches</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span><span class="p">[</span><span class="n">axon_limb_name</span><span class="p">]</span>
        <span class="n">return_axon_info</span> <span class="o">=</span>  <span class="n">nst</span><span class="o">.</span><span class="n">trajectory_angle_from_start_branch_and_subtree</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">axon_limb_name</span><span class="p">],</span>
                                                                 <span class="n">subtree_branches</span><span class="o">=</span><span class="n">axon_branches</span><span class="p">,</span>
                                                                  <span class="n">nodes_to_exclude</span><span class="o">=</span><span class="n">short_thick_limb_branch</span><span class="p">[</span><span class="n">axon_limb_name</span><span class="p">],</span>
                                                                <span class="n">return_max_min</span><span class="o">=</span><span class="n">return_max_min</span><span class="p">,</span><span class="n">return_n_angles</span><span class="o">=</span><span class="n">return_n_angles</span><span class="p">,</span>
                                                                  <span class="n">downstream_distance</span><span class="o">=</span><span class="n">downstream_distance_for_axon_angle</span><span class="p">,</span>
                                                                               <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                                                  <span class="o">**</span><span class="n">kwargs</span>
                                                                 <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="n">axon_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">return_max_min</span><span class="p">:</span>
                <span class="n">axon_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">axon_angle_max</span> <span class="o">=</span> <span class="n">return_axon_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">axon_angle_min</span> <span class="o">=</span> <span class="n">return_axon_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
                <span class="k">if</span> <span class="n">return_n_angles</span><span class="p">:</span>
                    <span class="n">axon_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_axon_angles</span> <span class="o">=</span><span class="n">return_axon_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">))</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axon_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">axon_angles</span> <span class="o">=</span> <span class="n">return_axon_info</span><span class="p">)</span>
            <span class="n">return_axon_info</span> <span class="o">=</span> <span class="n">axon_dict</span>
                                 
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return_axon_info = </span><span class="si">{</span><span class="n">return_axon_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">return_axon_info</span></div>
    
<div class="viewcode-block" id="complete_axon_processing"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.complete_axon_processing">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">complete_axon_processing</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="c1">#arguments for synapses and head neck spine</span>
                             <span class="n">cell_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             
                             <span class="n">add_synapses_and_head_neck_shaft_spines</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             
                             <span class="c1">#arguments for initial axon finding</span>
                             <span class="n">perform_axon_classification</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">plot_initial_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">rotation_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">unrotation_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             
                             <span class="c1">#arguments for axon on dendrite/ dendrite on axon finding</span>
                             <span class="n">label_merge_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">plot_axon_on_dendrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">plot_dendrite_on_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             
                            <span class="n">plot_high_fidelity_axon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">plot_boutons_web</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             
                             <span class="c1">#arguments for readding the synapses to the high fidelity axon</span>
                             <span class="n">add_synapses_after_high_fidelity_axon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">add_axon_description</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">return_filtering_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">return_axon_angle_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             
                             <span class="n">filter_dendrite_on_axon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">neuron_simplification</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             
                             <span class="n">return_G_axon_labeled</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To run the following axon classification processes</span>
<span class="sd">    1) Initial axon classification</span>
<span class="sd">    2) Filtering away dendrite on axon merges</span>
<span class="sd">    3) High fidelity axon skeletonization</span>
<span class="sd">    4) Bouton Identification</span>
<span class="sd">    5) Webbing Identification</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rotation_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rotation_function</span> <span class="o">=</span> <span class="n">align_neuron_obj</span>
    <span class="k">if</span> <span class="n">unrotation_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unrotation_function</span> <span class="o">=</span> <span class="n">unalign_neuron_obj</span>
    
    <span class="k">if</span> <span class="n">add_synapses_and_head_neck_shaft_spines</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding the synapses and the head_neck_shaft&quot;</span><span class="p">)</span>
        <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">add_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="p">,</span>
                            <span class="n">verbose</span>  <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                            <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot_valid_error_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">calculate_synapse_soma_distance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">add_valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">add_error_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">add_head_neck_shaft_spine_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                           <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
                                                          <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done adding synapses and head_neck_shaft: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cell_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_fun</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">axon_classification_using_synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;excitatory&quot;</span><span class="p">:</span>
            <span class="n">axon_fun</span> <span class="o">=</span> <span class="n">axon_classification_excitatory</span>
        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;inhibitory&quot;</span><span class="p">:</span>
            <span class="n">axon_fun</span> <span class="o">=</span> <span class="n">axon_classification_inhibitory</span>
            
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_fun = </span><span class="si">{</span><span class="n">axon_fun</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="p">(</span><span class="n">rotation_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">unrotation_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">rotation_function</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    <span class="c1">#1) Initial axon classification</span>
    <span class="k">if</span> <span class="n">perform_axon_classification</span><span class="p">:</span>
        <span class="n">axon_limb_branch_dict</span><span class="p">,</span><span class="n">axon_angles_dict</span> <span class="o">=</span> <span class="n">axon_fun</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">plot_final_axon</span><span class="o">=</span><span class="n">plot_initial_axon</span><span class="p">,</span>
                                    <span class="n">label_merge_errors</span><span class="o">=</span><span class="n">label_merge_errors</span><span class="p">,</span>
                                    <span class="n">plot_axon_on_dendrite</span><span class="o">=</span><span class="n">plot_axon_on_dendrite</span><span class="p">,</span>
                                    <span class="n">plot_dendrite_on_axon</span><span class="o">=</span><span class="n">plot_dendrite_on_axon</span><span class="p">,</span>                               
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axon_limb_branch_dict</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span>
        <span class="n">axon_angles_dict</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">axon_angles_from_neuron</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
                       <span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">rotation_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">unrotation_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">unrotation_function</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
    
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of neuron_obj.synapses_somas = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_angles_dict = </span><span class="si">{</span><span class="n">axon_angles_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axon_limb_branch_dict = </span><span class="si">{</span><span class="n">axon_limb_branch_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;neuron_obj.align_matrix = </span><span class="si">{</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">align_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        

    <span class="k">if</span> <span class="n">return_G_axon_labeled</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">neurd</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_graph_lite_utils</span> <span class="k">as</span> <span class="n">ctcu</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing the axon labeled graph&quot;</span><span class="p">)</span>
        <span class="n">G_axon_labeled</span> <span class="o">=</span> <span class="n">ctcu</span><span class="o">.</span><span class="n">G_with_attrs_from_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">plot_G</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
    
    <span class="k">if</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">***No axon found for this neuron ***&quot;</span><span class="p">)</span>
        <span class="n">filtering_info_pre</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dendrite_on_axon_merges_error_area</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">dendrite_on_axon_merges_error_length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">neuron_obj_with_web</span><span class="o">=</span> <span class="n">neuron_obj</span>
    
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># -------- Now do the merge error labels ----------- #</span>


        
        <span class="c1">#2) Filtering away dendrite on axon merges</span>
        <span class="k">if</span> <span class="n">filter_dendrite_on_axon</span><span class="p">:</span><span class="c1"># and len(au.dendrite_on_axon_limb_branch_dict(neuron_obj)) &gt; 0:</span>
            <span class="n">pre_filters</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">get_exc_filters_high_fidelity_axon_preprocessing</span><span class="p">()</span>
            <span class="n">o_neuron_pre</span><span class="p">,</span> <span class="n">filtering_info_pre</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">apply_proofreading_filters_to_neuron</span><span class="p">(</span><span class="n">input_neuron</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">,</span>
                                                    <span class="n">filter_list</span> <span class="o">=</span> <span class="n">pre_filters</span><span class="p">,</span>
                                <span class="n">plot_limb_branch_filter_with_disconnect_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">plot_limb_branch_filter_away</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">plot_final_neuron</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

                                                    <span class="n">return_error_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">verbose_outline</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtering_info_pre</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dendrite_on_axon_merges_error_area</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">dendrite_on_axon_merges_error_length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">o_neuron_pre</span> <span class="o">=</span> <span class="n">neuron_obj</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After pre filtering: # of neuron_obj.synapses_somas = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;o_neuron_pre.align_matrix = </span><span class="si">{</span><span class="n">o_neuron_pre</span><span class="o">.</span><span class="n">align_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">o_neuron_pre</span><span class="o">.</span><span class="n">axon_limb_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1">#3) High fidelity axon skeletonization</span>
            
            
            <span class="n">neuron_obj_high_fid_axon</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">refine_axon_for_high_fidelity_skeleton</span><span class="p">(</span><span class="n">o_neuron_pre</span><span class="p">,</span>
                                                                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After high fidelity: # of neuron_obj.synapses_somas = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">plot_high_fidelity_axon</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Fidelity Axon&quot;</span><span class="p">)</span>
                <span class="n">nviz</span><span class="o">.</span><span class="n">plot_axon</span><span class="p">(</span><span class="n">neuron_obj_high_fid_axon</span><span class="p">)</span>

            <span class="c1">#4) Bouton Identification</span>
            <span class="n">neuron_obj_with_boutons</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">calculate_boutons</span><span class="p">(</span><span class="c1">#parameters for run</span>
                <span class="n">neuron_obj</span> <span class="o">=</span> <span class="n">neuron_obj_high_fid_axon</span><span class="p">,</span>
                <span class="n">plot_axon_branches_to_check</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After pre bouton: # of neuron_obj.synapses_somas = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;neuron_obj_with_boutons.align_matrix = </span><span class="si">{</span><span class="n">neuron_obj_with_boutons</span><span class="o">.</span><span class="n">align_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        

            <span class="c1">#5) Webbing Identification</span>
            <span class="n">neuron_obj_with_web</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">calculate_axon_webbing</span><span class="p">(</span><span class="n">neuron_obj_with_boutons</span><span class="p">,</span>
                <span class="n">idx_to_plot</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="n">plot_intersection_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_intersection_mesh_without_boutons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_split</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_split_closest_mesh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_segmentation_before_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_web</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">plot_webbing_on_neuron</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;neuron_obj_with_web.align_matrix = </span><span class="si">{</span><span class="n">neuron_obj_with_web</span><span class="o">.</span><span class="n">align_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">plot_boutons_web</span><span class="p">:</span>
                <span class="n">nviz</span><span class="o">.</span><span class="n">plot_boutons</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">,</span>
                          <span class="n">mesh_whole_neuron_alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                         <span class="n">plot_web</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_axon_description</span><span class="p">:</span>
                <span class="n">neuron_obj_with_web</span><span class="o">.</span><span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_axon_v</span><span class="si">{</span><span class="n">au</span><span class="o">.</span><span class="n">axon_version</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">add_synapses_after_high_fidelity_axon</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Readding Synapses to the high fidelity axon after all processing donw&quot;</span><span class="p">)</span>
                <span class="n">neuron_obj_with_web</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">add_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">,</span>
                        <span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="p">,</span>
                        <span class="n">verbose</span>  <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                        <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
                        <span class="n">plot_valid_error_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">calculate_synapse_soma_distance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">add_valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">add_error_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">limb_branch_dict_to_add_synapses</span><span class="o">=</span><span class="n">neuron_obj_with_web</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After add_synapses_after_high_fidelity_axon: # of neuron_obj.synapses_somas = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;neuron_obj_with_web.align_matrix = </span><span class="si">{</span><span class="n">neuron_obj_with_web</span><span class="o">.</span><span class="n">align_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No axon after the dendrites filtered away&quot;</span><span class="p">)</span>
            <span class="n">neuron_obj_with_web</span> <span class="o">=</span> <span class="n">o_neuron_pre</span>
    
    <span class="k">if</span> <span class="n">neuron_simplification</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on branch simplification after axon finding&quot;</span><span class="p">)</span>
        <span class="n">neuron_obj_with_web</span> <span class="o">=</span> <span class="n">nsimp</span><span class="o">.</span><span class="n">branching_simplification</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">,</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        
    <span class="c1">#adding the spining info and idx to the newly added axon synapses from the high fidelity axon</span>
    <span class="n">spu</span><span class="o">.</span><span class="n">set_neuron_head_neck_shaft_idx</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">)</span>
    <span class="n">spu</span><span class="o">.</span><span class="n">set_neuron_synapses_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">)</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">set_limb_branch_idx_to_synapses</span><span class="p">(</span><span class="n">neuron_obj_with_web</span><span class="p">)</span>
    
    
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_filtering_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_axon_angle_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_G_axon_labeled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neuron_obj_with_web</span>
    
    <span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">neuron_obj_with_web</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">return_filtering_info</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtering_info_pre</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_axon_angle_info</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axon_angles_dict</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_G_axon_labeled</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G_axon_labeled</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">return_value</span></div>


<div class="viewcode-block" id="axon_classification_without_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_classification_without_synapses">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_classification_without_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">plot_axon_like_segments</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_max_search_distance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_candidates</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_final_axon</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">axon_verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_candidate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">axon_soma_angle_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="n">axon_soma_angle_threshold_excitatory_global</span>
        
    <span class="k">if</span> <span class="n">ais_max_search_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ais_max_search_distance</span> <span class="o">=</span> <span class="n">ais_max_distance_from_soma_excitatory_global</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To run the axon classification developed</span>
<span class="sd">    previously without synapses</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    axon_candidate = au.axon_classification_without_synapses(n_obj,</span>
<span class="sd">                                     plot_final_axon=True,</span>
<span class="sd">                                     verbose = True,</span>
<span class="sd">                                     return_candidate=True</span>
<span class="sd">                                    )</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="n">clu</span><span class="o">.</span><span class="n">axon_classification</span><span class="p">(</span>
                    <span class="n">neuron_obj</span><span class="o">=</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">axon_soma_angle_threshold</span> <span class="o">=</span> <span class="n">axon_soma_angle_threshold</span><span class="p">,</span>
                    <span class="n">ais_threshold</span> <span class="o">=</span> <span class="n">ais_max_search_distance</span><span class="p">,</span>
                    <span class="n">plot_axon_like_segments</span><span class="o">=</span><span class="n">plot_axon_like_segments</span><span class="p">,</span>
                    <span class="n">plot_candidates</span> <span class="o">=</span> <span class="n">plot_candidates</span><span class="p">,</span>
                        
                    <span class="c1">#Part 4: Filtering Candidates</span>
                    <span class="n">plot_axons</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">plot_axon_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">add_axon_labels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">clean_prior_axon_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  
                    <span class="n">label_axon_errors</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>


                    <span class="n">return_axon_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">return_axon_angles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

                    <span class="n">return_error_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">best_axon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

                    <span class="n">no_dendritic_branches_off_axon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>


                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">axon_verbose</span><span class="p">,</span>

                        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final axon limb branch = </span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">plot_final_axon</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting final axon after classification with no synapses: </span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">return_value</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_candidate</span><span class="p">:</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">candidate_groups_from_limb_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                            <span class="n">return_value</span><span class="p">,</span>
                                                             <span class="n">return_one</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="c1">#connected_component_method = &quot;local_radius&quot;,</span>
                                                             <span class="c1">#radius = 5_000</span>
                                                            <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final axon candidate = </span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">return_value</span></div>


<div class="viewcode-block" id="filter_candidates_away_with_downstream_high_postsyn_branches_NOT_USED"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.filter_candidates_away_with_downstream_high_postsyn_branches_NOT_USED">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">filter_candidates_away_with_downstream_high_postsyn_branches_NOT_USED</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">axon_candidates</span><span class="p">,</span>
    <span class="n">plot_ais_skeleton_restriction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_search_skeletal_length</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
    <span class="n">skeletal_length_min</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
    <span class="n">postsyn_density_max</span> <span class="o">=</span> <span class="mf">0.0015</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To outrule a candidate because if the postsyn</span>
<span class="sd">    density is high far from the ais then </span>
<span class="sd">    probably not the right candidate</span>

<span class="sd">    Pseudocode:</span>
<span class="sd">    1) get the branches farther than AIS distance</span>
<span class="sd">    For each candidate</span>
<span class="sd">    2) Filter the candidates by the limb branch to get remaining branches</span>
<span class="sd">    3) Decide if enough skeletal length to work with (if not then continue)</span>
<span class="sd">    4) Compute the postsynaptic density</span>
<span class="sd">    5) if postsynaptic density is too high then don&#39;t add to final candidates</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    au.filter_candidates_away_with_downstream_high_postsyn_branches_NOT_USED(</span>
<span class="sd">    neuron_obj,</span>
<span class="sd">    axon_candidates = [{&#39;limb_idx&#39;: &#39;L0&#39;, &#39;start_node&#39;: 5, &#39;branches&#39;: [5]}, {&#39;limb_idx&#39;: &#39;L0&#39;, &#39;start_node&#39;: 14, &#39;branches&#39;: [14]}]</span>
<span class="sd">    ,verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="kn">from</span><span class="w"> </span><span class="nn">neurd</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_searching</span> <span class="k">as</span> <span class="n">ns</span>
    <span class="n">restr_limb_b</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(distance_from_soma &gt; </span><span class="si">{</span><span class="n">au</span><span class="o">.</span><span class="n">max_ais_distance_from_soma</span><span class="si">}</span><span class="s2">)&quot;</span>
                 <span class="sa">f</span><span class="s2">&quot; and (distance_from_soma &lt; </span><span class="si">{</span><span class="n">max_search_skeletal_length</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="n">plot_limb_branch_dict</span><span class="o">=</span><span class="n">plot_ais_skeleton_restriction</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">candidates_remaining</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axon_candidates</span><span class="p">):</span>
        <span class="n">new_cand</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_cand</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">all_downstream_branches_from_candidate</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">include_candidate_branches</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">remaining_branches</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">candidate_limb_branch_dict_branch_intersection</span><span class="p">(</span><span class="n">candidate</span><span class="o">=</span><span class="n">new_cand</span><span class="p">,</span><span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">restr_limb_b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- working on candidate </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remaining_branches = </span><span class="si">{</span><span class="n">remaining_branches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_branches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding canddiate because no remaining branches&quot;</span><span class="p">)</span>
            <span class="n">candidates_remaining</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">total_skeletal_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">skeletal_length</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">remaining_branches</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_skeletal_length = </span><span class="si">{</span><span class="n">total_skeletal_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_skeletal_length</span> <span class="o">&lt;</span> <span class="n">skeletal_length_min</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding canddiate because not enough skeleton&quot;</span><span class="p">)</span>
            <span class="n">candidates_remaining</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">total_postsyns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">n_synapses_post</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">remaining_branches</span><span class="p">])</span>
        <span class="n">postsyn_density</span> <span class="o">=</span> <span class="n">total_postsyns</span><span class="o">/</span><span class="n">total_skeletal_length</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_postsyns = </span><span class="si">{</span><span class="n">total_postsyns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;postsyn_density = </span><span class="si">{</span><span class="n">postsyn_density</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">postsyn_density</span> <span class="o">&lt;</span> <span class="n">postsyn_density_max</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding canddiate because small postsyn density&quot;</span><span class="p">)</span>
            <span class="n">candidates_remaining</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">candidates_remaining</span></div>

<div class="viewcode-block" id="filter_candidate_branches_by_downstream_postsyn"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.filter_candidate_branches_by_downstream_postsyn">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">filter_candidate_branches_by_downstream_postsyn</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">candidates</span><span class="p">,</span>
    <span class="n">max_search_distance</span> <span class="o">=</span> <span class="mi">80_000</span><span class="p">,</span>
    <span class="n">max_search_distance_downstream</span> <span class="o">=</span> <span class="mi">50_000</span><span class="p">,</span>
    <span class="n">skeletal_length_min_downstream</span> <span class="o">=</span> <span class="mi">15_000</span><span class="p">,</span>
    <span class="n">postsyn_density_max</span> <span class="o">=</span> <span class="mf">0.00015</span><span class="p">,</span>
    <span class="n">filter_away_empty_candidates</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Need to refine the candidates so that they don&#39;t extend too far up because then the propogation down will be bad</span>
<span class="sd">    - want to only to apply to branches close to the soma</span>

<span class="sd">    Psueodocode:</span>
<span class="sd">    For branches with an endpoint closer than the max split distance</span>
<span class="sd">    1) Find the children</span>
<span class="sd">    2) find allb ranches within a certain downstream distance of of children</span>
<span class="sd">    3) If have a one of them has a significant skeleton that have any axon, then </span>
<span class="sd">    remove the branch from the candidate</span>

<span class="sd">    &quot;&quot;&quot;</span>




    <span class="n">candidate_check_lb</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">distance_from_soma</span><span class="p">],</span>
        <span class="n">function_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">include_node_skeleton_dist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;distance_from_soma &lt; </span><span class="si">{</span><span class="n">max_search_distance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;candidate_check_lb = </span><span class="si">{</span><span class="n">candidate_check_lb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="n">final_candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
        <span class="n">nodes_to_check</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">candidate_limb_branch_dict_branch_intersection</span><span class="p">(</span><span class="n">candidate</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">candidate_check_lb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--Candidate </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nodes_to_check = </span><span class="si">{</span><span class="n">nodes_to_check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">limb_idx</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]</span>
        <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span>

        <span class="n">branches_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_to_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">branches_to_remove</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already processed </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> so continuing&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--&gt; checking node </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">child_nodes</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">children_nodes</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;child_nodes = </span><span class="si">{</span><span class="n">child_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax_children</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">branches_to_remove_local</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maybe_remove_branches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">child_nodes</span><span class="p">:</span>
                <span class="n">downstream_branches</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">branches_within_skeletal_distance</span><span class="p">(</span>
                    <span class="n">limb_obj</span><span class="p">,</span>
                    <span class="n">start_branch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">,</span>
                    <span class="n">max_distance_from_start</span><span class="o">=</span><span class="n">max_search_distance_downstream</span><span class="p">,</span>
                    <span class="n">include_start_branch_length</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">include_node_branch_length</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">only_consider_downstream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="p">)</span>
                
                <span class="n">all_sub_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">all_downstream_branches</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">ch</span><span class="p">,</span><span class="n">n</span><span class="p">]</span>

                <span class="n">downstream_branches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">downstream_branches</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">ch</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; child branch with downstream_branches = </span><span class="si">{</span><span class="n">downstream_branches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1">#get the skeletal length of all the downstream branches</span>
                <span class="n">total_skeletal_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">limb_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">skeletal_length</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">downstream_branches</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_skeletal_length = </span><span class="si">{</span><span class="n">total_skeletal_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">total_skeletal_length</span> <span class="o">&lt;=</span>  <span class="n">skeletal_length_min_downstream</span><span class="p">:</span>
                    <span class="n">maybe_remove_branches</span> <span class="o">+=</span> <span class="n">all_sub_nodes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enough skeleton was computed so &quot;</span><span class="p">)</span>

                    <span class="n">total_postsyns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">limb_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">n_synapses_post</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">downstream_branches</span><span class="p">])</span>
                    <span class="n">postsyn_density</span> <span class="o">=</span> <span class="n">total_postsyns</span><span class="o">/</span><span class="n">total_skeletal_length</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;postsyn_density=</span><span class="si">{</span><span class="n">postsyn_density</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">postsyn_density</span> <span class="o">&gt;</span> <span class="n">postsyn_density_max</span><span class="p">:</span>
                        
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Removing the following nodes because the synapse density was too high: </span><span class="si">{</span><span class="n">all_sub_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="n">branches_to_remove_local</span> <span class="o">+=</span> <span class="n">all_sub_nodes</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax_children</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches_to_remove_local</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">branches_to_remove_local</span> <span class="o">+=</span> <span class="n">maybe_remove_branches</span>
            <span class="k">if</span> <span class="n">ax_children</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">branches_to_remove</span> <span class="o">+=</span> <span class="n">branches_to_remove_local</span>


        <span class="n">c_new</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c_new</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">c_new</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">],</span><span class="n">branches_to_remove</span><span class="p">)</span>
        

        <span class="k">if</span> <span class="n">filter_away_empty_candidates</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_new</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_new</span><span class="p">[</span><span class="s2">&quot;start_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">most_upstream_branch</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">c_new</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">])</span>
            <span class="n">final_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_new</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_candidates</span></div>


<div class="viewcode-block" id="axon_start_distance_from_soma"><a class="viewcode-back" href="../../neurd.html#neurd.axon_utils.axon_start_distance_from_soma">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">axon_start_distance_from_soma</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To find the distance of the </span>
<span class="sd">    start of an axon from the soma</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Find the most upstream branch of the axon limb branch</span>
<span class="sd">    2) Find the distance of that branch from the soma</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax_lb</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_limb_branch_dict</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">default_value</span>

    <span class="k">if</span> <span class="n">ax_lb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_lb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax_limb_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax_lb</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axon Limb Name = </span><span class="si">{</span><span class="n">ax_limb_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ax_branches</span> <span class="o">=</span> <span class="n">ax_lb</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">]</span>
            <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">ax_limb_name</span><span class="p">]</span>
            <span class="n">upstream_branch</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">most_upstream_branch</span><span class="p">(</span>
                <span class="n">limb_obj</span><span class="p">,</span>
                <span class="n">branches</span> <span class="o">=</span> <span class="n">ax_branches</span><span class="p">,)</span>

            <span class="n">distance_from_soma</span> <span class="o">=</span> <span class="n">nst</span><span class="o">.</span><span class="n">distance_from_soma</span><span class="p">(</span>
                <span class="n">limb_obj</span><span class="p">,</span>
                <span class="n">upstream_branch</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upstream_branch = </span><span class="si">{</span><span class="n">upstream_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axon distance from soma = </span><span class="si">{</span><span class="n">distance_from_soma</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">return_value</span> <span class="o">=</span> <span class="n">distance_from_soma</span>

    <span class="k">return</span> <span class="n">return_value</span></div>



<span class="c1"># ---------- Setting of parameters ---------- </span>

<span class="n">attributes_dict_default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">align_neuron_obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unalign_neuron_obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_ais_distance_from_soma</span> <span class="o">=</span> <span class="mi">50_000</span><span class="p">,</span>
<span class="p">)</span>    

<span class="n">global_parameters_dict_default_axon_finding</span> <span class="o">=</span> <span class="n">dsu</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span>
    <span class="c1">#-- cell type specific axon finding --</span>
    <span class="c1"># -- excitatory</span>
    <span class="n">axon_soma_angle_threshold_excitatory</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
    <span class="n">ais_max_distance_from_soma_excitatory</span> <span class="o">=</span> <span class="mi">14_000</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses_excitatory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses_if_no_candidate_excitatory</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># -- inhibitory</span>
    <span class="n">ais_max_distance_from_soma_inhibitory</span> <span class="o">=</span> <span class="mi">70_000</span><span class="p">,</span>

    
    
    <span class="c1"># ----- for the axon finding with synapses -------</span>
    <span class="n">axon_soma_angle_threshold</span><span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;int unsigned&quot;</span><span class="p">),</span>
    
    <span class="c1">#inital query arguments</span>
    <span class="n">ais_syn_density_max</span> <span class="o">=</span> <span class="mf">0.00015</span><span class="p">,</span>
    <span class="n">ais_syn_alternative_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">ais_n_syn_pre_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>


    <span class="n">ais_width_min</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span><span class="c1">#95,#140,</span>
    <span class="n">ais_width_max</span> <span class="o">=</span> <span class="mi">650</span><span class="p">,</span><span class="c1">#550,</span>
    <span class="n">max_search_distance</span> <span class="o">=</span> <span class="mi">80_000</span><span class="p">,</span>
    <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>

    <span class="c1">#arguments for postsyn downstream</span>
    <span class="n">n_postsyn_max</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">postsyn_distance</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>

    <span class="c1">#arguments for ais filtering</span>
    <span class="n">ais_width_filter</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ais_new_width_min</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span><span class="c1">#170,#170,</span>
    <span class="n">ais_new_width_min_inhibitory</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
    <span class="n">ais_new_width_downstream_skeletal_length</span> <span class="o">=</span> <span class="mi">20_000</span><span class="p">,</span>

    <span class="c1"># --- New filters added 8/11 -----</span>
    <span class="c1">#arguments for ais branch off filtering</span>
    <span class="c1">#for inhibitory use au.inhibitory_axon_ais_max_search_distance</span>
    <span class="c1">#for excitatory use ais_max_distance_from_soma = au.excitatory_axon_ais_max_search_distance</span>
    <span class="n">ais_max_distance_from_soma</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;int unsigned&quot;</span><span class="p">),</span>

    <span class="c1">#arguments for spine filtering</span>
    <span class="n">n_synapses_spine_offset_endpoint_upstream_max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="c1">#4,</span>

    <span class="c1"># arguments if the there is no winningn candidate</span>
    <span class="n">attempt_second_pass</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ais_syn_density_max_backup</span> <span class="o">=</span> <span class="mf">0.0007</span><span class="p">,</span>
    <span class="n">ais_n_syn_pre_max_backup</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">max_search_distance_addition_backup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

    <span class="c1"># for phase 3: picking the winning candidate</span>
    <span class="n">return_best_candidate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">best_candidate_method</span> <span class="o">=</span> <span class="s2">&quot;max_skeletal_length_above_threshold_and_buffer&quot;</span><span class="p">,</span>

    <span class="c1">#arguments for max_skeletal_length_above_threshold_and_buffer</span>
    <span class="n">max_skeletal_length_min</span> <span class="o">=</span> <span class="mi">50_000</span><span class="p">,</span>
    <span class="n">max_skeletal_length_buffer</span> <span class="o">=</span> <span class="mi">20_000</span><span class="p">,</span>

    <span class="c1">#arguments for significant_lowest_density option</span>
    <span class="n">significant_lowest_density_min_skeletal_length</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">,</span>
    <span class="n">lowest_density_ratio</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>

    <span class="c1">#for labeling the merge errors</span>
    <span class="n">downstream_distance_for_axon_angle</span> <span class="o">=</span> <span class="mi">30_000</span><span class="p">,</span>

    <span class="c1"># for backup axon finding if didn&#39;t find one</span>
    <span class="n">axon_classification_without_synapses_if_no_candidate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">axon_classification_without_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    
    
    <span class="c1">#excitatory</span>
    <span class="n">ais_syn_density_max_excitatory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ais_syn_density_max_backup_excitatory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">candidate_downstream_postsyn_density_max</span> <span class="o">=</span> <span class="mf">0.00015</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_default_dendr_on_axon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1">#base dendrite like restriction for width,synapses and min length</span>
    <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_excitatory_dendr_on_axon</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    <span class="n">n_synapses_pre_min_dendr_on_axon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">synapse_post_perc_min_dendr_on_axon</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">spine_density_min_dendr_on_axon</span> <span class="o">=</span> <span class="mf">0.00012</span><span class="p">,</span>
    <span class="n">dendrite_width_min_dendr_on_axon</span> <span class="o">=</span> <span class="mi">170</span><span class="p">,</span>
    <span class="n">dendrite_skeletal_length_min_dendr_on_axon</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>

    <span class="c1"># for the coarse filtering of the dendrites to catch any that might have been missed</span>
    <span class="n">coarse_dendrite_filter</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">coarse_dendrite_axon_width_min</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">coarse_dendrite_synapse_post_perc_min</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="n">coarse_dendrite_n_synapses_post_min</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">coarse_dendrite_n_spines_min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">coarse_dendrtie_spine_density</span> <span class="o">=</span> <span class="mf">0.00015</span><span class="p">,</span>
    
    <span class="c1"># restricting dendrites to only those with synapses downstream</span>
    <span class="n">synapse_post_perc_downstream_min_dendr_on_axon</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">n_synapses_pre_downstream_max_dendr_on_axon</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>

    <span class="c1"># arguments for filtering away spiney branches</span>
    <span class="n">filter_away_spiney_branches_dendr_on_axon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_synapses_post_spine_max_dendr_on_axon</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">spine_density_max_dendr_on_axon</span> <span class="o">=</span> <span class="mf">0.00015</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_default_bouton_webbing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">max_bouton_width_to_check</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
    
    <span class="c1">#bouton calculation</span>
    <span class="n">min_size_threshold_bouton</span> <span class="o">=</span> <span class="mi">27</span><span class="p">,</span>
    <span class="n">max_size_threshold_bouton</span> <span class="o">=</span> <span class="mi">350</span><span class="p">,</span>
    <span class="n">ray_trace_threshold_bouton</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    
    <span class="c1">#web calculations</span>
    <span class="n">split_significance_threshold_web</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">maximum_volume_threshold_web</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="c1">#in um**2</span>
    <span class="n">minimum_volume_threshold_web</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_default_auto_proof</span> <span class="o">=</span> <span class="n">dsu</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span>
    
    <span class="c1"># ---axon spines ----</span>
    <span class="n">ray_trace_min_axon_spines</span> <span class="o">=</span> <span class="mi">270</span><span class="p">,</span>
    <span class="n">ray_trace_max_axon_spines</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span>
    <span class="n">skeletal_length_min_axon_spines</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">skeletal_length_max_axon_spines</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">,</span>
    <span class="n">n_synapses_pre_min_axon_spines</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">n_synapses_pre_max_axon_spines</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_faces_min_axon_spines</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
    <span class="n">downstream_upstream_dist_diff_axon_spines</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">downstream_dist_min_over_syn_axon_spines</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">exclude_starting_nodes_axon_spines</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    
    <span class="c1"># -- short_thick_branches_limb_branch_dict --</span>
    <span class="n">width_min_threshold_short_thick</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
    <span class="n">skeletal_length_max_threshold_short_thick</span> <span class="o">=</span> <span class="mi">3500</span><span class="p">,</span>
    <span class="n">ray_trace_threshold_short_thick</span> <span class="o">=</span> <span class="mi">350</span><span class="p">,</span>
    <span class="n">parent_width_threshold_short_thick</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;int unsigned&quot;</span><span class="p">),</span><span class="c1">#200,</span>
    <span class="n">exclude_starting_nodes_short_thick</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_zero_width_segments_short_thick</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">width_min_threshold_parent_short_thick</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
    <span class="n">width_global_min_threshold_parent_short_thick</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
    
<span class="p">)</span>

<span class="n">global_parameters_dict_default_axon_on_dendrite</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">width_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">270</span><span class="p">,</span>
    <span class="n">n_spines_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_synapses_post_spine_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">n_synapses_pre_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">synapse_pre_perc_min_ax_on_dendr</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">synapse_pre_perc_downstream_min_ax_on_dendr</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="n">axon_skeletal_legnth_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span><span class="c1">#3000,</span>
                                      
    <span class="n">filter_away_thin_branches_ax_on_dendr</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dendrite_width_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">thin_axon_skeletal_length_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span><span class="c1">#4000,</span>
    <span class="n">thin_axon_n_synapses_post_downstream_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    
    <span class="n">mesh_area_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">closest_mesh_skeleton_dist_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    
    <span class="c1">#myelination</span>
    <span class="n">filter_away_myelination_myelin</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_skeletal_length_myelin</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
    <span class="n">max_synapse_density_myelin</span> <span class="o">=</span> <span class="mf">0.00007</span><span class="p">,</span>
    <span class="n">max_synapse_density_pass_2_myelin</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">min_skeletal_length_pass_2_myelin</span> <span class="o">=</span> <span class="mi">25_000</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_pass_2_myelin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_width_myelin</span> <span class="o">=</span> <span class="mi">650</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_myelin</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    <span class="n">skeletal_length_downstream_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">7_000</span><span class="p">,</span>
    <span class="n">n_synapses_post_downstream_max_myelin</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_default</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([</span>
    <span class="n">global_parameters_dict_default_axon_finding</span><span class="p">,</span>
    <span class="n">global_parameters_dict_default_dendr_on_axon</span><span class="p">,</span>
    <span class="n">global_parameters_dict_default_bouton_webbing</span><span class="p">,</span>
    <span class="n">global_parameters_dict_default_auto_proof</span><span class="p">,</span>
    <span class="n">global_parameters_dict_default_axon_on_dendrite</span>
    <span class="p">])</span>


<span class="n">global_parameters_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">global_parameters_dict_microns_auto_proof</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">attributes_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">attributes_dict_h01</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">align_neuron_obj</span> <span class="o">=</span> <span class="n">hvu</span><span class="o">.</span><span class="n">align_neuron_obj</span><span class="p">,</span>
    <span class="n">unalign_neuron_obj</span> <span class="o">=</span> <span class="n">hvu</span><span class="o">.</span><span class="n">unalign_neuron_obj</span><span class="p">,</span>
    
    <span class="n">max_ais_distance_from_soma</span> <span class="o">=</span> <span class="mi">50_000</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_h01_axon_finding</span> <span class="o">=</span> <span class="n">dsu</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span>
    <span class="n">axon_classification_without_synapses_excitatory</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    
    
    <span class="c1">#ais_width_max = 1200,</span>
    <span class="n">ais_width_max</span> <span class="o">=</span> <span class="mi">900</span><span class="p">,</span>
    
    <span class="n">ais_new_width_min</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
    
    <span class="n">min_skeletal_length</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    <span class="c1">#min_skeletal_length = 5000,</span>
    <span class="n">ais_syn_density_max_excitatory</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="n">ais_syn_density_max_backup_excitatory</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> 
    
    <span class="c1">#--- inhibitory parameters ---</span>
    <span class="n">ais_new_width_min_inhibitory</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
    
    <span class="n">n_postsyn_max</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="n">postsyn_distance</span> <span class="o">=</span> <span class="mi">90_000</span><span class="p">,</span>
    
    <span class="n">max_search_distance_addition_backup</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
                                                                 
<span class="p">)</span>

<span class="n">global_parameters_dict_h01_dendr_on_axon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">dendrite_width_min_dendr_on_axon</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_excitatory_dendr_on_axon</span> <span class="o">=</span> <span class="mi">60_000</span><span class="p">,</span>
    <span class="n">min_distance_from_soma_inhibitory_dendr_on_axon</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
    
    <span class="n">coarse_dendrite_filter</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">n_synapses_pre_min_dendr_on_axon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    
    <span class="n">min_skeletal_length_myelin</span> <span class="o">=</span> <span class="mi">12_000</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_h01_bouton_webbing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">max_bouton_width_to_check</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
    
    <span class="c1">#bouton calculation</span>
    <span class="n">min_size_threshold_bouton</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">max_size_threshold_bouton</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
    
    <span class="c1">#web calculations</span>
    <span class="n">split_significance_threshold_web</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
    <span class="n">maximum_volume_threshold_web</span><span class="o">=</span><span class="mi">3500</span><span class="p">,</span> <span class="c1">#in um**2</span>
    <span class="n">minimum_volume_threshold_web</span> <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
    
    
<span class="p">)</span>

<span class="n">global_parameters_dict_h01_auto_proof</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">skeletal_length_max_axon_spines</span> <span class="o">=</span> <span class="mi">12_000</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">global_parameters_dict_h01_axon_on_dendrite</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">n_synapses_pre_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">synapse_pre_perc_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">width_max_ax_on_dendr</span> <span class="o">=</span> <span class="mi">350</span><span class="p">,</span>
    <span class="n">dendrite_width_min_ax_on_dendr</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">global_parameters_dict_h01</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([</span>
    <span class="n">global_parameters_dict_h01_axon_finding</span><span class="p">,</span>
    <span class="n">global_parameters_dict_h01_dendr_on_axon</span><span class="p">,</span>
    <span class="n">global_parameters_dict_h01_bouton_webbing</span><span class="p">,</span>
    <span class="n">global_parameters_dict_h01_auto_proof</span><span class="p">,</span>
    <span class="n">global_parameters_dict_h01_axon_on_dendrite</span>
<span class="p">])</span>


<span class="c1"># data_type = &quot;default&quot;</span>
<span class="c1"># algorithms = None</span>
<span class="c1"># modules_to_set = [au,(pre,&quot;axon_decomp&quot;),(clu,&quot;axon&quot;),nst,(pru,&quot;low_branch_clusters&quot;)]</span>

<span class="c1"># def set_global_parameters_and_attributes_by_data_type(dt,</span>
<span class="c1">#                                                      algorithms_list = None,</span>
<span class="c1">#                                                       modules = None,</span>
<span class="c1">#                                                      set_default_first = True,</span>
<span class="c1">#                                                       verbose=False):</span>
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     modu.set_global_parameters_and_attributes_by_data_type(modules,dt,</span>
<span class="c1">#                                                           algorithms=algorithms_list,</span>
<span class="c1">#                                                           set_default_first = set_default_first,</span>
<span class="c1">#                                                           verbose = verbose)</span>
    
<span class="c1"># set_global_parameters_and_attributes_by_data_type(data_type,</span>
<span class="c1">#                                                    algorithms,)</span>

<span class="c1"># def output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#     modules = None,</span>
<span class="c1">#     algorithms = None,</span>
<span class="c1">#     verbose = True,</span>
<span class="c1">#     lowercase = True,</span>
<span class="c1">#     output_types = (&quot;global_parameters&quot;),</span>
<span class="c1">#     include_default = True,</span>
<span class="c1">#     algorithms_only = False,</span>
<span class="c1">#     **kwargs):</span>
    
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     return modu.output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#         modules,</span>
<span class="c1">#         algorithms = algorithms,</span>
<span class="c1">#         verbose = verbose,</span>
<span class="c1">#         lowercase = lowercase,</span>
<span class="c1">#         output_types = output_types,</span>
<span class="c1">#         include_default = include_default,</span>
<span class="c1">#         algorithms_only = algorithms_only,</span>
<span class="c1">#         **kwargs,</span>
<span class="c1">#         )</span>


<span class="c1">#--- from neurd_packages ---</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">apical_utils</span> <span class="k">as</span> <span class="n">apu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_utils</span> <span class="k">as</span> <span class="n">clu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">concept_network_utils</span> <span class="k">as</span> <span class="n">cnu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.h01_volume_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_interface</span> <span class="k">as</span> <span class="n">hvu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_searching</span> <span class="k">as</span> <span class="n">ns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_simplification</span> <span class="k">as</span> <span class="n">nsimp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_statistics</span> <span class="k">as</span> <span class="n">nst</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_utils</span> <span class="k">as</span> <span class="n">nru</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">neuron_visualizations</span> <span class="k">as</span> <span class="n">nviz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">preprocess_neuron</span> <span class="k">as</span> <span class="n">pre</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">proofreading_utils</span> <span class="k">as</span> <span class="n">pru</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">spine_utils</span> <span class="k">as</span> <span class="n">spu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">synapse_utils</span> <span class="k">as</span> <span class="n">syu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">width_utils</span> <span class="k">as</span> <span class="n">wu</span>

<span class="c1">#--- from mesh_tools ---</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mesh_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">skeleton_utils</span> <span class="k">as</span> <span class="n">sk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mesh_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">trimesh_utils</span> <span class="k">as</span> <span class="n">tu</span>

<span class="c1">#--- from datasci_tools ---</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_struct_utils</span> <span class="k">as</span> <span class="n">dsu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">ipyvolume_utils</span> <span class="k">as</span> <span class="n">ipvu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">networkx_utils</span> <span class="k">as</span> <span class="n">xu</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasci_tools.tqdm_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">axon_utils</span> <span class="k">as</span> <span class="n">au</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Brendan Celii.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>