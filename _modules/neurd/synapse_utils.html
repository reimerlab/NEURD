<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neurd.synapse_utils &mdash; neurd  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            neurd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">neurd</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">neurd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../neurd.html">neurd</a></li>
      <li class="breadcrumb-item active">neurd.synapse_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neurd.synapse_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>




<span class="sd">How to adjust the features on synapses</span>
<span class="sd">based on the closest skeleton point</span>

<span class="sd"># to calculate the closest skeleton point</span>
<span class="sd">syn_coord_sk = sk.closest_skeleton_coordinate(curr_branch.skeleton,</span>
<span class="sd">                            face_coord)</span>
<span class="sd">#after have closest skeleton coordinate</span>
<span class="sd">syu.calculate_endpoints_dist()</span>
<span class="sd">syu.calculate_upstream_downstream_dist_from_down_idx(syn,down_idx)</span>






<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">microns_volume_utils</span> <span class="k">as</span> <span class="n">mvu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">h01_volume_utils</span> <span class="k">as</span> <span class="n">hvu</span>


<div class="viewcode-block" id="Synapse"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.Synapse">[docs]</a><span class="k">class</span> <span class="nc">Synapse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classs that will hold information about </span>
<span class="sd">    the synapses that will be attributes of a neuron object</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Synapse.__init__"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.Synapse.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">synapse_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">synapse_attributes</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">synapse_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">synapse_obj</span><span class="o">.</span><span class="n">export</span><span class="p">())</span>
        <span class="c1">#if synapse_dict is not None:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_attributes</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="Synapse.export"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.Synapse.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>
    


    
<span class="n">synapse_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;syn_type&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;syn_id&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;endpoints_dist&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;upstream_dist&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;downstream_dist&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;closest_sk_coordinate&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;closest_face_idx&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;closest_branch_face_idx&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;closest_face_dist&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;soma_distance&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;soma_distance_euclidean&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;compartment&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;limb_idx&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;branch_idx&quot;</span>
                     <span class="p">]</span>
<span class="n">synapse_coordinate_system_dependent_attributes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;closest_sk_coordinate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;closest_face_coordinate&quot;</span>
<span class="p">]</span>


<span class="c1">#soma_synapse_offset = nru.soma_face_offset</span>

<span class="n">synapse_error_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;distance_errored&quot;</span><span class="p">,</span><span class="s2">&quot;mesh_errored&quot;</span><span class="p">]</span>

<span class="n">synapse_type_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">presyn</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="s2">&quot;valid_syn_centers_presyn&quot;</span><span class="p">,</span>
                                     <span class="n">error</span><span class="o">=</span><span class="s2">&quot;errored_syn_centers_presyn&quot;</span><span class="p">),</span>
                         <span class="n">postsyn</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="s2">&quot;valid_syn_centers_postsyn&quot;</span><span class="p">,</span>
                                       <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;errored_syn_centers_postsyn&quot;</span><span class="p">))</span>


<span class="n">valid_pre_color</span> <span class="o">=</span> <span class="s2">&quot;yellow&quot;</span>
<span class="n">valid_post_color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
<span class="n">error_pre_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">error_post_color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
<span class="n">distance_errored_synapses_pre_color</span> <span class="o">=</span> <span class="s2">&quot;tan&quot;</span>
<span class="n">distance_errored_synapses_post_color</span> <span class="o">=</span> <span class="s2">&quot;pink&quot;</span>
<span class="n">mesh_errored_synapses_pre_color</span> <span class="o">=</span> <span class="s2">&quot;brown&quot;</span>
<span class="n">mesh_errored_synapses_post_color</span> <span class="o">=</span> <span class="s2">&quot;lime&quot;</span>
<span class="n">soma_pre_color</span> <span class="o">=</span> <span class="s2">&quot;aqua&quot;</span>
<span class="n">soma_post_color</span> <span class="o">=</span> <span class="s2">&quot;purple&quot;</span>

<span class="n">default_synapse_size</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">synapse_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">soma</span><span class="o">=</span><span class="s2">&quot;synapses_somas&quot;</span><span class="p">,</span>
    <span class="n">limb_branch</span><span class="o">=</span><span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
    <span class="n">mesh_errored</span><span class="o">=</span><span class="s2">&quot;mesh_errored_synapses&quot;</span><span class="p">,</span>
    <span class="n">distance_errored</span><span class="o">=</span><span class="s2">&quot;distance_errored_synapses&quot;</span>
<span class="p">)</span>






<div class="viewcode-block" id="get_synapse_types"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.get_synapse_types">[docs]</a><span class="k">def</span> <span class="nf">get_synapse_types</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">synapse_types</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<span class="c1"># ------ different queries for synapses ------- #</span>
<span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="set_presyns_on_dendrite_as_errors_default"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_presyns_on_dendrite_as_errors_default">[docs]</a><span class="k">def</span> <span class="nf">set_presyns_on_dendrite_as_errors_default</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_presyns_on_dendrite_as_errors to default of True&quot;</span><span class="p">)</span>
    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="set_presyns_on_dendrite_as_errors"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_presyns_on_dendrite_as_errors">[docs]</a><span class="k">def</span> <span class="nf">set_presyns_on_dendrite_as_errors</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_presyns_on_dendrite_as_errors to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="error_query"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.error_query">[docs]</a><span class="k">def</span> <span class="nf">error_query</span><span class="p">():</span>
    <span class="c1">#query = f&quot;(compartment==&#39;error&#39;)&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(soma_distance == -1) or (compartment == &#39;error&#39;) or (label in [&#39;mesh_errored&#39;,&#39;distance_errored&#39;])&quot;</span>
    <span class="k">if</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; or </span><span class="si">{</span><span class="n">presyns_on_dendrite_query</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="valid_query"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.valid_query">[docs]</a><span class="k">def</span> <span class="nf">valid_query</span><span class="p">():</span>
    <span class="c1">#query = f&quot;(compartment !=&#39;error&#39;)&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;not (</span><span class="si">{</span><span class="n">error_query</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and not(</span><span class="si">{</span><span class="n">presyns_on_dendrite_query</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">return</span> <span class="n">query</span></div>
    





    
    
<span class="c1"># ------- Synapse Plotting ------------- #</span>




<div class="viewcode-block" id="plot_valid_error_synpases"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_valid_error_synpases">[docs]</a><span class="k">def</span> <span class="nf">plot_valid_error_synpases</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">synapse_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">synapses_type_to_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">synapses_type_to_not_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">keyword_to_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">TP_color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                            <span class="n">TN_color</span><span class="o">=</span><span class="s2">&quot;aqua&quot;</span><span class="p">,</span>
                            <span class="n">FP_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                            <span class="n">FN_color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                             <span class="n">synapse_scatter_size</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                             
                             <span class="c1">#for plotting the actual mesh parts to go along</span>
                             <span class="n">plot_only_axon_skeleton</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">error_mesh_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                             <span class="n">valid_mesh_color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                             <span class="n">valid_skeleton_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                             <span class="n">mesh_alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                             <span class="n">print_color_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="c1">#                              mapping = dict(TP= &quot;valid_syn_centers_presyn&quot;,</span>
<span class="c1">#                                               FP = &quot;errored_syn_centers_presyn&quot;,</span>
<span class="c1">#                                               TN = &quot;valid_syn_centers_postsyn&quot;,</span>
<span class="c1">#                                               FN = &quot;errored_syn_centers_postsyn&quot;,),</span>
                            <span class="n">mapping</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will plot the synapse centers against </span>
<span class="sd">    a proofread neuron</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    output_syn_dict = syu.synapse_dict_mesh_labels_to_synapse_coordinate_dict(synapse_mesh_labels_dict=mesh_label_dict,</span>
<span class="sd">                                                           synapse_dict=synapse_dict)</span>
<span class="sd">    syu.plot_valid_error_synpases(</span>
<span class="sd">                             synapse_dict=output_syn_dict,</span>
<span class="sd">                             neuron_obj = None,</span>
<span class="sd">                            mesh = mesh,</span>
<span class="sd">                            original_mesh = original_mesh,</span>
<span class="sd">                            keyword_to_plot = &quot;error&quot;,</span>
<span class="sd">        synapse_scatter_size=2,</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">synapse_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_pre_post_valid_errror_coordinates_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">synapses_type_to_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synapses_type_to_plot</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">new_dict</span>

    <span class="k">if</span> <span class="n">synapses_type_to_not_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapses_type_to_not_plot</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">new_dict</span>
        
    <span class="k">if</span> <span class="n">keyword_to_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keyword_to_plot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">new_dict</span>

    
    
    <span class="k">if</span> <span class="n">mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;valid_syn_centers_presyn&quot;</span><span class="p">,</span><span class="s2">&quot;errored_syn_centers_presyn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;valid_syn_centers_postsyn&quot;</span><span class="p">,</span><span class="s2">&quot;errored_syn_centers_postsyn&quot;</span><span class="p">]</span>
        <span class="n">synapse_dict_pre</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_types</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">synapse_dict_pre</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">synapse_dict_pre</span>

    <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">TP_color</span><span class="o">=</span><span class="n">TP_color</span><span class="p">,</span>
                        <span class="n">TN_color</span><span class="o">=</span><span class="n">TN_color</span><span class="p">,</span>
                        <span class="n">FP_color</span><span class="o">=</span><span class="n">FP_color</span><span class="p">,</span>
                        <span class="n">FN_color</span><span class="o">=</span><span class="n">FN_color</span><span class="p">,)</span>

    <span class="c1"># ---- Part B: Prepares the Mesh Part of the Visual --------#</span>

<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Plot the valid faces and the invalid faces of neuron</span>
<span class="sd">    (including maybe the axon skeleton of the valid portion), and then to plot the synapses</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the error mesh from the original mesh and then the mesh after proofreading</span>
<span class="sd">    2) Get the valid skeleton</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">neuron_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using the mesh from the neuron object&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">validation_utils</span> <span class="k">as</span> <span class="nn">vu</span>
        
        <span class="n">error_mesh</span><span class="p">,</span> <span class="n">valid_mesh</span> <span class="o">=</span> <span class="n">vu</span><span class="o">.</span><span class="n">mesh_errored_after_neuron_proofreading</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">return_valid_mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_only_axon_skeleton</span><span class="p">:</span>
            <span class="n">valid_skeleton</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">axon_skeleton</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_skeleton</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">skeleton</span>
        <span class="n">skeletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">valid_skeleton</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="k">if</span> <span class="n">original_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_mesh</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">subtract_mesh</span><span class="p">(</span><span class="n">original_mesh</span><span class="p">,</span><span class="n">valid_mesh</span><span class="p">)</span>
        <span class="n">skeletons</span> <span class="o">=</span> <span class="p">[]</span>
        

    <span class="n">meshes</span> <span class="o">=</span> <span class="p">[</span><span class="n">error_mesh</span><span class="p">,</span><span class="n">valid_mesh</span><span class="p">]</span>
    <span class="n">meshes_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">error_mesh_color</span><span class="p">,</span><span class="n">valid_mesh_color</span><span class="p">]</span>
    
    <span class="n">skeletons_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">valid_skeleton_color</span><span class="p">]</span>
    
    <span class="c1">#print(f&quot;synapse_dict = {synapse_dict}&quot;)</span>
    <span class="n">nviz</span><span class="o">.</span><span class="n">plot_valid_error_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">synapse_dict</span> <span class="o">=</span><span class="n">synapse_dict</span><span class="p">,</span>
                           <span class="n">meshes</span><span class="o">=</span><span class="n">meshes</span><span class="p">,</span>
                           <span class="n">meshes_colors</span><span class="o">=</span><span class="n">meshes_colors</span><span class="p">,</span>
                           <span class="n">synapse_scatter_size</span><span class="o">=</span><span class="n">synapse_scatter_size</span><span class="p">,</span>

<span class="c1">#                                 scatters=scatters,</span>
<span class="c1">#                                 scatter_size=scatter_size,</span>
<span class="c1">#                                    scatters_colors=scatters_colors,</span>

                          <span class="n">valid_presyn_color</span><span class="o">=</span><span class="n">TP_color</span><span class="p">,</span>
                        <span class="n">valid_postsyn_color</span><span class="o">=</span><span class="n">TN_color</span><span class="p">,</span>
                        <span class="n">error_presyn_color</span><span class="o">=</span><span class="n">FP_color</span><span class="p">,</span>
                        <span class="n">error_postsyn_color</span><span class="o">=</span><span class="n">FN_color</span><span class="p">,</span>

                            <span class="n">plot_error_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

                            <span class="n">skeletons</span><span class="o">=</span><span class="n">skeletons</span><span class="p">,</span>
                              <span class="n">skeletons_colors</span><span class="o">=</span><span class="n">skeletons_colors</span><span class="p">,</span> 
                            <span class="n">mesh_alpha</span><span class="o">=</span><span class="n">mesh_alpha</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span>
                          <span class="p">)</span>
    <span class="k">if</span> <span class="n">print_color_key</span><span class="p">:</span>
        <span class="n">curr_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">TP_color</span><span class="p">,</span><span class="n">TN_color</span><span class="p">,</span><span class="n">FP_color</span><span class="p">,</span><span class="n">FN_color</span><span class="p">]</span>
        <span class="n">curr_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;valid_presyn_color&quot;</span><span class="p">,</span><span class="s2">&quot;valid_postsyn_color&quot;</span><span class="p">,</span><span class="s2">&quot;error_presyn_color&quot;</span><span class="p">,</span><span class="s2">&quot;error_postsyn_color&quot;</span><span class="p">]</span>
        <span class="c1">#print(f&quot;\nColor Key:&quot;)</span>
        <span class="k">for</span> <span class="n">c_type</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">curr_types</span><span class="p">,</span><span class="n">curr_colors</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c_type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="soma_synapses_to_scatter_info"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.soma_synapses_to_scatter_info">[docs]</a><span class="k">def</span> <span class="nf">soma_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">pre_color</span><span class="o">=</span><span class="n">soma_pre_color</span><span class="p">,</span>
                             <span class="n">post_color</span> <span class="o">=</span> <span class="n">soma_post_color</span><span class="p">,</span>
                                 <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To Turn the soma synapses into plottable scatters</span>
<span class="sd">    </span>
<span class="sd">    Ex: syu.soma_synapses_to_scatter_info(neuron_obj)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">soma_name</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_node_names</span><span class="p">():</span>
        <span class="n">soma_syns_pre</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">soma_name</span><span class="p">]</span><span class="o">.</span><span class="n">synapses_pre</span>
        <span class="n">soma_syns_post</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">soma_name</span><span class="p">]</span><span class="o">.</span><span class="n">synapses_post</span>
        
        <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">soma_syns_pre</span><span class="p">))</span>
        <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">soma_syns_post</span><span class="p">))</span>
        
        <span class="n">scatters_colors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pre_color</span><span class="p">,</span><span class="n">post_color</span><span class="p">]</span>
        <span class="n">scatter_size_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">scatter_size</span><span class="p">,</span><span class="n">scatter_size</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">scatters</span><span class="p">,</span><span class="n">scatters_colors</span><span class="p">,</span><span class="n">scatter_size_list</span></div>



<div class="viewcode-block" id="error_synapses_to_scatter_info"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.error_synapses_to_scatter_info">[docs]</a><span class="k">def</span> <span class="nf">error_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                   <span class="n">error_synapses_names</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">pre_color</span><span class="o">=</span><span class="n">error_pre_color</span><span class="p">,</span>
                                 <span class="n">post_color</span> <span class="o">=</span> <span class="n">error_post_color</span><span class="p">,</span>
                                   <span class="n">color_mapping</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">distance_errored_synapses_pre</span> <span class="o">=</span> <span class="n">distance_errored_synapses_pre_color</span><span class="p">,</span>
                                                     <span class="n">distance_errored_synapses_post</span> <span class="o">=</span> <span class="n">distance_errored_synapses_post_color</span><span class="p">,</span>
                                                     <span class="n">mesh_errored_synapses_pre</span> <span class="o">=</span> <span class="n">mesh_errored_synapses_pre_color</span><span class="p">,</span>
                                                     <span class="n">mesh_errored_synapses_post</span> <span class="o">=</span> <span class="n">mesh_errored_synapses_post_color</span><span class="p">,),</span>
                                     <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To turn the error synapses into plottable scatters</span>
<span class="sd">    </span>
<span class="sd">    Ex: syu.error_synapses_to_scatter_info(neuron_obj)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">default_color_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">pre_color</span><span class="p">,</span>
                                <span class="n">post</span><span class="o">=</span><span class="n">post_color</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">error_synapses_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error_synapses_names</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">get_errored_synapses_names</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">err_syn</span> <span class="ow">in</span> <span class="n">error_synapses_names</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">syn_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span><span class="s2">&quot;post&quot;</span><span class="p">]:</span>
            
            <span class="n">err_syn_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err_syn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syn_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">err_syn_type</span> <span class="ow">in</span> <span class="n">color_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">curr_color</span> <span class="o">=</span> <span class="n">color_mapping</span><span class="p">[</span><span class="n">err_syn_type</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr_color</span> <span class="o">=</span> <span class="n">default_color_mapping</span><span class="p">[</span><span class="n">syn_type</span><span class="p">]</span>
            
            <span class="n">curr_synapses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">err_syn_type</span><span class="p">)</span>
            
            <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">))</span>
            <span class="n">scatters_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_color</span><span class="p">)</span>
            <span class="n">scatter_size_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter_size</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">scatters</span><span class="p">,</span><span class="n">scatters_colors</span><span class="p">,</span><span class="n">scatter_size_list</span></div>

<div class="viewcode-block" id="limb_branch_synapses_to_scatter_info"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.limb_branch_synapses_to_scatter_info">[docs]</a><span class="k">def</span> <span class="nf">limb_branch_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                                        <span class="n">pre_color</span> <span class="o">=</span> <span class="n">valid_pre_color</span><span class="p">,</span>
                                        <span class="n">post_color</span> <span class="o">=</span> <span class="n">valid_post_color</span><span class="p">,</span>
                                        <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
                                        <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To make the synapses on the limb and branches</span>
<span class="sd">    plottable</span>
<span class="sd">    </span>
<span class="sd">    Ex: limb_branch_synapses_to_scatter_info(neuron_obj)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">limb_branch_dict</span>
    
    <span class="n">pre_syn</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">concatenate_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                 <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                                 <span class="n">feature</span><span class="o">=</span><span class="s2">&quot;synapses_pre&quot;</span><span class="p">)</span>
    <span class="n">post_syn</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">concatenate_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                 <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                                 <span class="n">feature</span><span class="o">=</span><span class="s2">&quot;synapses_post&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">synapse_type</span> <span class="o">==</span> <span class="s2">&quot;synapses&quot;</span><span class="p">:</span>
        <span class="n">scatters</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">pre_syn</span><span class="p">),</span>
                    <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">post_syn</span><span class="p">)]</span>
        <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pre_color</span><span class="p">,</span><span class="n">post_color</span><span class="p">]</span>
        <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">scatter_size</span><span class="p">,</span><span class="n">scatter_size</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">synapse_type</span> <span class="o">==</span> <span class="s2">&quot;synapses_pre&quot;</span><span class="p">:</span>
        <span class="n">scatters</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">pre_syn</span><span class="p">)]</span>
        <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pre_color</span><span class="p">]</span>
        <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">scatter_size</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">synapse_type</span> <span class="o">==</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">:</span>
        <span class="n">scatters</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">post_syn</span><span class="p">)]</span>
        <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">post_color</span><span class="p">]</span>
        <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">scatter_size</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown synapse type = </span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">scatters</span><span class="p">,</span><span class="n">scatters_colors</span><span class="p">,</span><span class="n">scatter_size_list</span></div>


<div class="viewcode-block" id="append_synapses_to_plot"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.append_synapses_to_plot">[docs]</a><span class="k">def</span> <span class="nf">append_synapses_to_plot</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">total_synapses_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>

    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">limb_branch_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">limb_branch_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
    <span class="n">limb_branch_synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>

    <span class="n">distance_errored_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">distance_errored_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>

    <span class="n">mesh_errored_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">mesh_errored_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>

    <span class="n">soma_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">soma_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>


    <span class="n">return_plottable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">append_figure</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">show_at_end</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To add synapse scatter plots</span>
<span class="sd">    to an existing plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatters_colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatter_size_list</span> <span class="o">=</span> <span class="p">[]</span>




    <span class="k">if</span> <span class="n">total_synapses</span><span class="p">:</span>
        <span class="n">limb_branch_size</span> <span class="o">=</span> <span class="n">total_synapses_size</span>
        <span class="n">distance_errored_size</span> <span class="o">=</span> <span class="n">total_synapses_size</span>
        <span class="n">mesh_errored_size</span> <span class="o">=</span> <span class="n">total_synapses_size</span>
        <span class="n">soma_size</span> <span class="o">=</span> <span class="n">total_synapses_size</span>
        
        <span class="n">limb_branch_synapses</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">distance_errored_size</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mesh_errored_synapses</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">soma_synapses</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>


    <span class="k">if</span> <span class="n">limb_branch_synapses</span><span class="p">:</span>
        <span class="n">curr_sc</span><span class="p">,</span><span class="n">curr_c</span><span class="p">,</span><span class="n">curr_sz</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">limb_branch_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                         <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">limb_branch_size</span><span class="p">,</span>
                                                                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                                                         <span class="n">synapse_type</span><span class="o">=</span><span class="n">limb_branch_synapse_type</span><span class="p">)</span>
        
        <span class="n">scatters</span><span class="o">+=</span> <span class="n">curr_sc</span>
        <span class="n">scatters_colors</span><span class="o">+=</span><span class="n">curr_c</span>
        <span class="n">scatter_size_list</span> <span class="o">+=</span> <span class="n">curr_sz</span>

    <span class="k">if</span> <span class="n">mesh_errored_synapses</span><span class="p">:</span>
        <span class="n">curr_sc</span><span class="p">,</span><span class="n">curr_c</span><span class="p">,</span><span class="n">curr_sz</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">error_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mesh_errored_synapses&quot;</span><span class="p">],</span>
                                                                         <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">mesh_errored_size</span><span class="p">)</span>
        <span class="n">scatters</span><span class="o">+=</span> <span class="n">curr_sc</span>
        <span class="n">scatters_colors</span><span class="o">+=</span><span class="n">curr_c</span>
        <span class="n">scatter_size_list</span> <span class="o">+=</span> <span class="n">curr_sz</span>

    <span class="k">if</span> <span class="n">distance_errored_synapses</span><span class="p">:</span>
        <span class="n">curr_sc</span><span class="p">,</span><span class="n">curr_c</span><span class="p">,</span><span class="n">curr_sz</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">error_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance_errored_synapses&quot;</span><span class="p">],</span>
                                                                         <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">distance_errored_size</span><span class="p">)</span>
        <span class="n">scatters</span><span class="o">+=</span> <span class="n">curr_sc</span>
        <span class="n">scatters_colors</span><span class="o">+=</span><span class="n">curr_c</span>
        <span class="n">scatter_size_list</span> <span class="o">+=</span> <span class="n">curr_sz</span>

    <span class="k">if</span> <span class="n">soma_synapses</span><span class="p">:</span>
        <span class="n">curr_sc</span><span class="p">,</span><span class="n">curr_c</span><span class="p">,</span><span class="n">curr_sz</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">soma_synapses_to_scatter_info</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                         <span class="n">scatter_size</span> <span class="o">=</span> <span class="n">soma_size</span><span class="p">)</span>
        <span class="n">scatters</span><span class="o">+=</span> <span class="n">curr_sc</span>
        <span class="n">scatters_colors</span><span class="o">+=</span><span class="n">curr_c</span>
        <span class="n">scatter_size_list</span> <span class="o">+=</span> <span class="n">curr_sz</span>
        
    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scatters</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scatters = </span><span class="si">{</span><span class="n">scatters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scatters_colors= </span><span class="si">{</span><span class="n">scatters_colors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scatter_size_list = </span><span class="si">{</span><span class="n">scatter_size_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scatters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">scatters</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Synapses to plot&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">scatters</span><span class="o">=</span><span class="n">scatters</span><span class="p">,</span>
                         <span class="n">scatters_colors</span><span class="o">=</span><span class="n">scatters_colors</span><span class="p">,</span>
                         <span class="n">scatter_size</span><span class="o">=</span><span class="n">scatter_size_list</span><span class="p">,</span>
                         <span class="n">append_figure</span><span class="o">=</span><span class="n">append_figure</span><span class="p">,</span>
                         <span class="n">show_at_end</span><span class="o">=</span><span class="n">show_at_end</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_plottable</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">scatters</span><span class="p">,</span><span class="n">scatter_size_list</span><span class="p">,</span><span class="n">scatter_size_list</span><span class="p">]</span></div>

<div class="viewcode-block" id="plot_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
    <span class="n">total_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">limb_branch_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
    <span class="n">distance_errored_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
    <span class="n">mesh_errored_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
    <span class="n">soma_size</span> <span class="o">=</span> <span class="n">default_synapse_size</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The synapse types</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span><span class="c1">#dict(L2=&quot;all&quot;),</span>
        <span class="n">limb_branch_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">limb_branch_synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
        <span class="n">total_synapses</span><span class="o">=</span><span class="n">total_synapses</span><span class="p">,</span>
        <span class="n">limb_branch_size</span> <span class="o">=</span> <span class="n">limb_branch_size</span><span class="p">,</span>
        <span class="n">distance_errored_size</span> <span class="o">=</span> <span class="n">distance_errored_size</span><span class="p">,</span>
        <span class="n">mesh_errored_size</span> <span class="o">=</span> <span class="n">mesh_errored_size</span><span class="p">,</span>
        <span class="n">soma_size</span> <span class="o">=</span> <span class="n">soma_size</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>
<span class="c1"># --------- End of Synapse Plotting -------#</span>
                    
<div class="viewcode-block" id="export"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.export">[docs]</a><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">synapse_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="n">synapse_obj</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_attributes</span><span class="p">}</span></div>
                    
    
       
 
<div class="viewcode-block" id="combine_synapse_dict_into_presyn_postsyn_valid_error_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.combine_synapse_dict_into_presyn_postsyn_valid_error_dict">[docs]</a><span class="k">def</span> <span class="nf">combine_synapse_dict_into_presyn_postsyn_valid_error_dict</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">,</span>
                                                             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To concatenate all of the valid and error synapses</span>
<span class="sd">    into one synapse dict (application: which can eventually be plotted)</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) iterate through presyn,postsyn</span>
<span class="sd">        2) iterate through error valid</span>
<span class="sd">           Find all the keys that have the following in the name</span>
<span class="sd">           Concatenate the lists</span>
<span class="sd">           Store </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]:</span>
        <span class="n">synapse_info</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">synapse_info_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">synapse_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span><span class="s2">&quot;error&quot;</span><span class="p">]:</span>
            <span class="n">curr_name</span> <span class="o">=</span> <span class="n">synapse_type_names</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="n">curr_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">synapse_info_keys</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For </span><span class="si">{</span><span class="n">curr_name</span><span class="si">}</span><span class="s2"> using keys </span><span class="si">{</span><span class="n">curr_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curr_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">synapse_info</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">curr_keys</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of coordinates = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_arrays</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="n">output_dict</span><span class="p">[</span><span class="n">curr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_arrays</span>
            
    <span class="k">return</span> <span class="n">output_dict</span></div>


<div class="viewcode-block" id="synapse_dict_mesh_labels_to_synapse_attribute_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_dict_mesh_labels_to_synapse_attribute_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_dict_mesh_labels_to_synapse_attribute_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="p">,</span>
                                                       <span class="n">attribute</span><span class="p">,</span>
                                                      <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
    <span class="n">coord_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">synapse_type</span><span class="p">,</span><span class="n">syn_info</span> <span class="ow">in</span> <span class="n">synapse_mesh_labels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">coord_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">l_ids</span> <span class="ow">in</span> <span class="n">syn_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_indices</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">intersect_indices</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="s2">&quot;synapse_ids&quot;</span><span class="p">],</span><span class="n">l_ids</span><span class="p">)</span>
            <span class="n">coord_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="n">attribute</span><span class="p">][</span><span class="n">current_indices</span><span class="p">]</span>
            
    <span class="k">if</span> <span class="n">return_presyn_postsyn_valid_error_dict</span><span class="p">:</span>
        <span class="n">coord_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">combine_synapse_dict_into_presyn_postsyn_valid_error_dict</span><span class="p">(</span><span class="n">coord_dict</span><span class="p">,</span>
                                                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord_dict</span></div>

<div class="viewcode-block" id="synapse_dict_mesh_labels_to_synapse_coordinate_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_dict_mesh_labels_to_synapse_coordinate_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_dict_mesh_labels_to_synapse_coordinate_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="p">,</span>
                                                      <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_dict_mesh_labels_to_synapse_attribute_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="p">,</span>
                                                       <span class="n">attribute</span> <span class="o">=</span> <span class="s2">&quot;synapse_coordinates&quot;</span><span class="p">,</span>
                                <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="p">)</span></div>
    
<div class="viewcode-block" id="synapse_dict_mesh_labels_to_synapse_volume_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_dict_mesh_labels_to_synapse_volume_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_dict_mesh_labels_to_synapse_volume_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="p">,</span>
                                                      <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_dict_mesh_labels_to_synapse_attribute_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="p">,</span>
                                                       <span class="n">attribute</span> <span class="o">=</span> <span class="s2">&quot;synapse_sizes&quot;</span><span class="p">,</span>
                                <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="p">)</span></div>



            



<div class="viewcode-block" id="n_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses">[docs]</a><span class="k">def</span> <span class="nf">n_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapse_density"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density">[docs]</a><span class="k">def</span> <span class="nf">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">synapses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">synapses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
        
    
    <span class="n">skeletal_length</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skeletal_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spine_density</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span><span class="o">/</span><span class="n">skeletal_length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spine_density</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">spine_density</span></div>

<div class="viewcode-block" id="synapses_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_pre">[docs]</a><span class="k">def</span> <span class="nf">synapses_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;syn_type&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="s2">&quot;presyn&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses">[docs]</a><span class="k">def</span> <span class="nf">synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
        
    <span class="k">return</span> <span class="n">curr_synapses</span></div>

<div class="viewcode-block" id="synapses_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post">[docs]</a><span class="k">def</span> <span class="nf">synapses_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;syn_type&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="s2">&quot;postsyn&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapse_density_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_pre">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
                          <span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapse_density_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_post">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
                          <span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapse_pre_perc"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_pre_perc">[docs]</a><span class="k">def</span> <span class="nf">synapse_pre_perc</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_synapses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span><span class="o">/</span><span class="n">total_synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    

    
<div class="viewcode-block" id="synapse_post_perc"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_post_perc">[docs]</a><span class="k">def</span> <span class="nf">synapse_post_perc</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_synapses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span><span class="o">/</span><span class="n">total_synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    
    
<span class="c1"># -------- 7/19: Has all of the head_neck_shaft classifications ----- #</span>
<div class="viewcode-block" id="synapses_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_head">[docs]</a><span class="k">def</span> <span class="nf">synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">])</span></div>
<div class="viewcode-block" id="synapses_neck"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_neck">[docs]</a><span class="k">def</span> <span class="nf">synapses_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;neck&quot;</span><span class="p">])</span></div>
<div class="viewcode-block" id="synapses_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_shaft">[docs]</a><span class="k">def</span> <span class="nf">synapses_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;shaft&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="synapses_no_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_no_head">[docs]</a><span class="k">def</span> <span class="nf">synapses_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;no_head&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="synapses_non_bouton"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_non_bouton">[docs]</a><span class="k">def</span> <span class="nf">synapses_non_bouton</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;non_bouton&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="synapses_bouton"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_bouton">[docs]</a><span class="k">def</span> <span class="nf">synapses_bouton</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_with_feature</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                                    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">,</span>
                                    <span class="n">comparison_value</span><span class="o">=</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="s2">&quot;bouton&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="synapses_type_and_head_neck_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_type_and_head_neck_shaft">[docs]</a><span class="k">def</span> <span class="nf">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                    <span class="n">syn_type</span><span class="p">,</span> 
                                     <span class="n">head_neck_shaft_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">curr_synapses</span><span class="p">,</span>
                       <span class="n">query</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(syn_type == &#39;</span><span class="si">{</span><span class="n">syn_type</span><span class="si">}</span><span class="s2">&#39;) and &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(head_neck_shaft == </span><span class="si">{</span><span class="n">spu</span><span class="o">.</span><span class="n">head_neck_shaft_dict</span><span class="p">[</span><span class="n">head_neck_shaft_type</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
                       <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span>
                      <span class="p">)</span></div>

<div class="viewcode-block" id="synapses_post_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_head">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">,</span><span class="s2">&quot;head&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_post_neck"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_neck">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">,</span><span class="s2">&quot;neck&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_post_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_shaft">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">,</span><span class="s2">&quot;shaft&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_post_no_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_no_head">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">,</span><span class="s2">&quot;no_head&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_post_spine"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_spine">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_post_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">+</span> <span class="n">synapses_post_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">+</span> <span class="n">synapses_post_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_pre_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_pre_shaft">[docs]</a><span class="k">def</span> <span class="nf">synapses_pre_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapses_type_and_head_neck_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;shaft&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_spine"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_spine">[docs]</a><span class="k">def</span> <span class="nf">synapses_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">+</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">+</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_head">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>
<div class="viewcode-block" id="n_synapses_neck"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_neck">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>
<div class="viewcode-block" id="n_synapses_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_shaft">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_no_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_no_head">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_spine"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_spine">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_head">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post_neck"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_neck">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post_no_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_no_head">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post_spine"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_spine">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_post_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_shaft">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_pre_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_shaft">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>


<div class="viewcode-block" id="synapse_density_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_head">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span><span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapse_density_neck"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_neck">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span><span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapse_density_shaft"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_shaft">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_shaft</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>
<div class="viewcode-block" id="synapse_density_no_head"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_no_head">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_no_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span><span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapse_density_spine"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_spine">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_density</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                          <span class="n">synapses</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span><span class="n">density_type</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapse_head_perc"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_head_perc">[docs]</a><span class="k">def</span> <span class="nf">synapse_head_perc</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_synapses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_head</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span><span class="o">/</span><span class="n">total_synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    
<div class="viewcode-block" id="synapse_spine_perc"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_spine_perc">[docs]</a><span class="k">def</span> <span class="nf">synapse_spine_perc</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_synapses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_spine</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span><span class="o">/</span><span class="n">total_synapses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<span class="c1"># --------- End of head neck shaft --------------</span>

<div class="viewcode-block" id="synapses_with_feature"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_with_feature">[docs]</a><span class="k">def</span> <span class="nf">synapses_with_feature</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span>
                         <span class="n">feature_name</span><span class="p">,</span>
                          <span class="n">comparison_value</span><span class="p">,</span>
                         <span class="n">operator_func</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
                         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will find synapses with a certain feature</span>
<span class="sd">    </span>
<span class="sd">    Possible operators:</span>
<span class="sd">    operator.eq</span>
<span class="sd">    operator.gt</span>
<span class="sd">    operator.ge</span>
<span class="sd">    operator.lt</span>
<span class="sd">    operator.le</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    synapses_with_feature(neuron_obj.synapses,</span>
<span class="sd">                     feature_name=&quot;syn_type&quot;,</span>
<span class="sd">                     comparison_value=&quot;postsyn&quot;,</span>
<span class="sd">                     verbose=True)</span>
<span class="sd">                     </span>
<span class="sd">    Ex: </span>
<span class="sd">    import operator</span>
<span class="sd">    syu.calculate_neuron_soma_distance(neuron_obj)</span>
<span class="sd">    syn_from_soma = syu.synapses_with_feature(neuron_obj.synapses,</span>
<span class="sd">                              feature_name = &quot;soma_distance&quot;,</span>
<span class="sd">                              comparison_value = 4000,</span>
<span class="sd">                              operator_func=operator.le,</span>
<span class="sd">                              verbose = True)</span>

<span class="sd">    syn_coords = syu.synapses_to_coordinates(syn_from_soma)</span>

<span class="sd">    nviz.plot_objects(neuron_obj.mesh,</span>
<span class="sd">                     scatters=[syn_coords])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">feature_name</span><span class="p">):</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">comparison_value</span><span class="p">):</span>
        <span class="n">comparison_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">comparison_value</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">operator_func</span><span class="p">):</span>
        <span class="n">operator_func</span> <span class="o">=</span> <span class="p">[</span><span class="n">operator_func</span><span class="p">]</span>
    
    <span class="n">match_synapses</span> <span class="o">=</span> <span class="n">synapses</span>
    <span class="k">for</span> <span class="n">feat</span><span class="p">,</span><span class="n">cv</span><span class="p">,</span><span class="n">of</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span><span class="n">comparison_value</span><span class="p">,</span><span class="n">operator_func</span><span class="p">):</span>
        <span class="n">match_synapses</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">match_synapses</span> <span class="k">if</span> 
                              <span class="n">of</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">feat</span><span class="p">),</span><span class="n">cv</span><span class="p">)]</span>
    
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of match_synapses with </span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">operator_func</span><span class="si">}</span><span class="s2"> to value </span><span class="si">{</span><span class="n">comparison_value</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">match_synapses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">match_synapses</span></div>



<div class="viewcode-block" id="exports_to_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.exports_to_synapses">[docs]</a><span class="k">def</span> <span class="nf">exports_to_synapses</span><span class="p">(</span><span class="n">exports</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exports</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">exports</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="o">**</span><span class="n">j</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">syu</span><span class="o">.</span><span class="n">Synapse</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">return_list</span></div>

<div class="viewcode-block" id="synapses_to_exports"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_exports">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_exports</span><span class="p">(</span><span class="n">synapses</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">export</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">]</span></div>

<div class="viewcode-block" id="calculate_limb_synapse_soma_distances"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_limb_synapse_soma_distances">[docs]</a><span class="k">def</span> <span class="nf">calculate_limb_synapse_soma_distances</span><span class="p">(</span>
    <span class="n">limb_obj</span><span class="p">,</span>
    <span class="n">calculate_endpoints_dist_if_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To store the distances to the soma </span>
<span class="sd">    for all of the synapses</span>

<span class="sd">    Computing the upstream soma distance</span>
<span class="sd">    for each branch</span>
<span class="sd">    1) calculate the upstream distance</span>
<span class="sd">    2) Calcualte the upstream endpoint</span>
<span class="sd">        For each synapse:</span>
<span class="sd">        3) Soma distance = endpoint_dist</span>
<span class="sd">        </span>
<span class="sd">    Ex: </span>
<span class="sd">    calculate_limb_synapse_soma_distances(limb_obj = neuron_obj[2],</span>
<span class="sd">    verbose = True)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">branch_idx</span> <span class="ow">in</span> <span class="n">limb_obj</span><span class="o">.</span><span class="n">get_branch_names</span><span class="p">():</span>
        <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>

        <span class="c1">#1) Calculate the upstream distance</span>
        <span class="n">upstream_dist</span> <span class="o">=</span> <span class="n">nst</span><span class="o">.</span><span class="n">total_upstream_skeletal_length</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">)</span>
        <span class="n">upstream_endpoint_idx</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">upstream_endpoint</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">return_endpoint_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
            <span class="n">endpoint_dist</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">endpoints_dist</span><span class="p">[</span><span class="n">upstream_endpoint_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">endpoint_dist</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">calculate_endpoints_dist_if_empty</span><span class="p">:</span>
                    <span class="n">syu</span><span class="o">.</span><span class="n">calculate_endpoints_dist</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span><span class="n">syn</span><span class="p">)</span>
                    <span class="n">syu</span><span class="o">.</span><span class="n">calculate_upstream_downstream_dist</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">syn</span><span class="p">)</span>
                    <span class="c1">#endpoint_dist = syn.endpoints_dist[upstream_endpoint_idx]</span>
                    <span class="n">endpoint_dist</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">upstream_dist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Endpoint distance was not calculated yet and calculate_endpoint_dist_if_empty not set&quot;</span><span class="p">)</span>
            <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance</span> <span class="o">=</span> <span class="n">endpoint_dist</span> <span class="o">+</span> <span class="n">upstream_dist</span></div>
            
<div class="viewcode-block" id="calculate_endpoints_dist"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_endpoints_dist">[docs]</a><span class="k">def</span> <span class="nf">calculate_endpoints_dist</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span><span class="n">syn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will calculate the endpoint distance for a synapse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bau</span><span class="o">.</span><span class="n">calculate_endpoints_dist</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span><span class="n">syn</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="calculate_upstream_downstream_dist"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_upstream_downstream_dist">[docs]</a><span class="k">def</span> <span class="nf">calculate_upstream_downstream_dist</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                       <span class="n">branch_idx</span><span class="p">,</span>
                                       <span class="n">syn</span><span class="p">):</span>
    <span class="n">bau</span><span class="o">.</span><span class="n">calculate_upstream_downstream_dist</span><span class="p">(</span><span class="n">limb_ob</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">syn</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="calculate_upstream_downstream_dist_from_down_idx"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_upstream_downstream_dist_from_down_idx">[docs]</a><span class="k">def</span> <span class="nf">calculate_upstream_downstream_dist_from_down_idx</span><span class="p">(</span>
    <span class="n">syn</span><span class="p">,</span><span class="n">down_idx</span><span class="p">):</span>
    <span class="n">bau</span><span class="o">.</span><span class="n">calculate_upstream_downstream_dist_from_down_idx</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span><span class="n">down_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="calculate_upstream_downstream_dist_from_up_idx"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_upstream_downstream_dist_from_up_idx">[docs]</a><span class="k">def</span> <span class="nf">calculate_upstream_downstream_dist_from_up_idx</span><span class="p">(</span>
    <span class="n">syn</span><span class="p">,</span><span class="n">up_idx</span><span class="p">):</span>
    <span class="n">bau</span><span class="o">.</span><span class="n">calculate_upstream_downstream_dist_from_up_idx</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span><span class="n">up_idx</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="calculate_neuron_soma_distance"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_neuron_soma_distance">[docs]</a><span class="k">def</span> <span class="nf">calculate_neuron_soma_distance</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">verbose</span>  <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">store_soma_placeholder</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">store_error_placeholder</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To calculate all of the soma distances for all the valid synapses</span>
<span class="sd">    on limbs</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    calculate_neuron_soma_distance(neuron_obj,</span>
<span class="sd">                              verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">limb_name</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_limb_names</span><span class="p">():</span>
        <span class="n">st_loc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">calculate_limb_synapse_soma_distances</span><span class="p">(</span><span class="n">limb_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Limb </span><span class="si">{</span><span class="n">limb_name</span><span class="si">}</span><span class="s2"> soma calculation time = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st_loc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        
    <span class="k">if</span> <span class="n">store_soma_placeholder</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Putting Soma Placeholders&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_indexes</span><span class="p">():</span>
            <span class="n">st_loc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">soma_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;S</span><span class="si">{</span><span class="n">s_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span>
            <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">soma_synapses</span><span class="p">:</span>
                <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">soma_face_offset</span> <span class="o">+</span> <span class="n">s_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Soma </span><span class="si">{</span><span class="n">s_idx</span><span class="si">}</span><span class="s2"> soma calculation time = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st_loc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="k">if</span> <span class="n">store_error_placeholder</span><span class="p">:</span>
        <span class="n">st_loc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Putting Error Placeholders&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">:</span>
            <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Error soma calculation time = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st_loc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total soma distance calculation time = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        

        
<span class="c1"># -------------- 6/9 For Applying the synapses ------------ #</span>

<div class="viewcode-block" id="add_valid_soma_synapses_to_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.add_valid_soma_synapses_to_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">add_valid_soma_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                          <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">add_valid_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                                <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
                                                <span class="n">add_only_soma_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span>
                                               <span class="p">)</span></div>
<div class="viewcode-block" id="add_valid_synapses_to_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.add_valid_synapses_to_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">add_valid_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                    <span class="n">synapse_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">mesh_label_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">debug_time</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">calualate_endpoints_dist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">limb_branch_dict_to_add_synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="c1">#set_head_neck_shaft = False,</span>
                                     <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">add_only_soma_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To add valid synapses to a neuron object</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># ----- Phase 0: Getting the Synapse Info ------ #</span>
    <span class="k">if</span> <span class="n">synapse_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">segment_id_to_synapse_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
                                                 <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">mesh_label_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh_label_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">fetch_synapse_dict_by_mesh_labels</span><span class="p">(</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">neuron_mesh_from_branches</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
            <span class="n">segment_id</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
            <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">,</span>
            <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
            <span class="c1">#original_mesh_kd=original_mesh_kd,</span>
            <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
            <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    



    <span class="c1"># ----- Phase 1: Computing the features of the Synapses ------ #</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">valid_synapse_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">presyn</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="n">mesh_label_dict</span><span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]),</span>
                              <span class="n">postsyn</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="n">mesh_label_dict</span><span class="p">[</span><span class="s2">&quot;postsyn&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]))</span>
    
    
        
    
    <span class="n">valid_synapse_dict_coord</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_dict_mesh_labels_to_synapse_coordinate_dict</span><span class="p">(</span><span class="n">valid_synapse_dict</span><span class="p">,</span>
                                                            <span class="n">synapse_dict</span><span class="p">,</span>
                                                            <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">valid_synapse_dict_volume</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_dict_mesh_labels_to_synapse_volume_dict</span><span class="p">(</span><span class="n">valid_synapse_dict</span><span class="p">,</span>
                                                            <span class="n">synapse_dict</span><span class="p">,</span>
                                                            <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synapse dict: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">original_mesh_proof</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">mesh_from_branches</span>
    <span class="n">original_mesh_kdtree_proof</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">mesh_to_kdtree</span><span class="p">(</span><span class="n">original_mesh_proof</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original Mesh: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">limb_branch_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]:</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">limb_branch_idx</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">closest_faces</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">coordinates_to_closest_limb_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                               <span class="n">coordinates</span><span class="o">=</span><span class="n">valid_synapse_dict_coord</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">],</span>
                                                <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh_proof</span><span class="p">,</span>
                                                <span class="n">original_mesh_kdtree</span> <span class="o">=</span> <span class="n">original_mesh_kdtree_proof</span><span class="p">,</span>
                                               <span class="n">return_distances_to_limb_branch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                              <span class="n">return_closest_faces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_only_soma_synapses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricting to only soma synapses&quot;</span><span class="p">)</span>
                
            <span class="n">keep_map</span> <span class="o">=</span> <span class="n">limb_branch_idx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">valid_synapse_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_synapse_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="n">keep_map</span><span class="p">]</span>
            <span class="n">valid_synapse_dict_coord</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_synapse_dict_coord</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="n">keep_map</span><span class="p">]</span>
            <span class="n">valid_synapse_dict_volume</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_synapse_dict_volume</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="n">keep_map</span><span class="p">]</span>
            <span class="n">limb_branch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limb_branch_idx</span><span class="p">)[</span><span class="n">keep_map</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="n">keep_map</span><span class="p">]</span>
            <span class="n">closest_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">closest_faces</span><span class="p">)[</span><span class="n">keep_map</span><span class="p">]</span>
            
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limb_branch_idx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;branch_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limb_branch_idx</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">closest_faces</span>
        

        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_mesh_proof</span><span class="o">.</span><span class="n">triangles_center</span><span class="p">[</span><span class="n">closest_faces</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closest Branch: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1">#computing the closest skeleton vertex and endpoint distance</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_sk_coordinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;endpoints_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">*-</span><span class="mi">1</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;upstream_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*-</span><span class="mi">1</span>
        <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;downstream_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*-</span><span class="mi">1</span>

        
        <span class="n">downstream_endpoint_idx_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">limb_idx</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">face_coord</span><span class="p">,</span><span class="n">curr_face_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">],</span>
                                                  <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;branch_idx&quot;</span><span class="p">],</span>
                                                  <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_coordinate&quot;</span><span class="p">],</span>
                                                <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_face_idx&quot;</span><span class="p">])):</span>


            <span class="k">if</span> <span class="n">limb_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">branch_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">syn_coord_sk</span> <span class="o">=</span> <span class="n">face_coord</span>
                <span class="n">endpoints_dist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">upstream_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">downstream_dist</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#                 if set_head_neck_shaft:</span>
<span class="c1">#                     head_neck_shaft_val = spu.head_neck_shaft_dict[&quot;no_label&quot;]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">limb_branch_dict_to_add_synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nru</span><span class="o">.</span><span class="n">in_limb_branch_dict</span><span class="p">(</span><span class="n">limb_branch_dict_to_add_synapses</span><span class="p">,</span><span class="n">limb_idx</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">):</span>
                        <span class="k">continue</span>
                
                <span class="n">curr_branch</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">][</span><span class="n">branch_idx</span><span class="p">]</span>
                
<span class="c1">#                 if set_head_neck_shaft:</span>
<span class="c1">#                     head_neck_shaft_val = curr_branch.head_neck_shaft_idx[curr_face_idx]</span>
                
                
                <span class="n">syn_coord_sk</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">closest_skeleton_coordinate</span><span class="p">(</span><span class="n">curr_branch</span><span class="o">.</span><span class="n">skeleton</span><span class="p">,</span>
                            <span class="n">face_coord</span><span class="p">)</span>
                <span class="c1">#getting the distances to endpoint1 and endpoint2</span>

                <span class="k">if</span> <span class="n">calualate_endpoints_dist</span><span class="p">:</span>
                    <span class="n">endpoints_dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">sk</span><span class="o">.</span><span class="n">skeleton_path_between_skeleton_coordinates</span><span class="p">(</span>
                                <span class="n">starting_coordinate</span> <span class="o">=</span> <span class="n">syn_coord_sk</span><span class="p">,</span>
                                <span class="n">destination_node</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                                <span class="n">skeleton_graph</span> <span class="o">=</span> <span class="n">curr_branch</span><span class="o">.</span><span class="n">skeleton_graph</span><span class="p">,</span>
                                <span class="n">only_skeleton_distance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">curr_branch</span><span class="o">.</span><span class="n">endpoints_nodes</span><span class="p">]</span>
    <span class="c1">#                 if debug_time:</span>
    <span class="c1">#                     print(f&quot;endpoints_dist {limb_idx},{branch_idx}: {np.round(time.time() - st,4)}&quot;)</span>
    <span class="c1">#                     st = time.time()</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Need to figure out which index is upstream and which is downstream</span>
<span class="sd">                    &quot;&quot;&quot;</span>


                    <span class="k">if</span> <span class="n">limb_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">downstream_endpoint_idx_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">downstream_endpoint_idx_dict</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            
                    <span class="k">if</span> <span class="n">branch_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">downstream_endpoint_idx_dict</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">downstream_endpoint_idx_dict</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">][</span><span class="n">branch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">downstream_endpoint</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">],</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">return_endpoint_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        
                    <span class="n">down_idx</span> <span class="o">=</span> <span class="n">downstream_endpoint_idx_dict</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">][</span><span class="n">branch_idx</span><span class="p">]</span>
                    <span class="n">downstream_dist</span> <span class="o">=</span> <span class="n">endpoints_dist</span><span class="p">[</span><span class="n">down_idx</span><span class="p">]</span>
                    <span class="n">upstream_dist</span> <span class="o">=</span> <span class="n">endpoints_dist</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">down_idx</span><span class="p">]</span>
    
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">upstream_dist</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">downstream_dist</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">endpoints_dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">upstream_dist</span><span class="p">,</span><span class="n">downstream_dist</span><span class="p">]</span>
                    

            <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;endpoints_dist&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoints_dist</span>
            <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;upstream_dist&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">upstream_dist</span>
            <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;downstream_dist&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">downstream_dist</span>
            <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;closest_sk_coordinate&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn_coord_sk</span>
<span class="c1">#             limb_branch_info[k][&quot;head_neck_shaft&quot;][j] = head_neck_shaft_val</span>

        <span class="c1"># THIS IS VERY LONG STEP IN THE KUBERNETES VERSION</span>
        <span class="k">if</span> <span class="n">debug_time</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closest Skeleton Branch and distance from endpoint: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


    <span class="c1"># ----- Phase 2: Creating the Synapse Objects ------ #</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#print(f&quot;limb_branch_dict_to_add_synapses = {limb_branch_dict_to_add_synapses}&quot;)</span>
    
    <span class="n">limb_branch_to_synapse_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">syn_type</span><span class="p">,</span><span class="n">valid_dict</span> <span class="ow">in</span> <span class="n">valid_synapse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">syn_ids</span> <span class="o">=</span> <span class="n">valid_dict</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">syn_idx</span><span class="p">,</span><span class="n">syn_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">syn_ids</span><span class="p">):</span>
            <span class="n">limb_idx</span> <span class="o">=</span> <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
            <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="s2">&quot;branch_idx&quot;</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">limb_branch_dict_to_add_synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nru</span><span class="o">.</span><span class="n">in_limb_branch_dict</span><span class="p">(</span><span class="n">limb_branch_dict_to_add_synapses</span><span class="p">,</span><span class="n">limb_idx</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="n">syn_coord</span> <span class="o">=</span> <span class="n">valid_synapse_dict_coord</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
            <span class="n">syn_volume</span> <span class="o">=</span> <span class="n">valid_synapse_dict_volume</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
            <span class="n">syn_obj_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">syn_type</span><span class="o">=</span><span class="n">syn_type</span><span class="p">,</span>
                            <span class="n">syn_id</span> <span class="o">=</span> <span class="n">syn_id</span><span class="p">,</span>
                            <span class="n">volume</span> <span class="o">=</span> <span class="n">syn_volume</span><span class="p">,</span>
                                <span class="n">coordinate</span> <span class="o">=</span> <span class="n">syn_coord</span><span class="p">,</span>
                               <span class="p">)</span>
            <span class="n">syn_obj_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="n">syn_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">limb_branch_info</span><span class="p">[</span><span class="n">syn_type</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">,</span><span class="s2">&quot;branch_idx&quot;</span><span class="p">]})</span>
            


    <span class="c1">#         curr_branch = neuron_obj[limb_idx][branch_idx]</span>
    <span class="c1">#         nviz.plot_objects(curr_branch.mesh,</span>
    <span class="c1">#                          scatters=[curr_branch.endpoints[0],</span>
    <span class="c1">#                                   curr_branch.endpoints[1],</span>
    <span class="c1">#                                   syn_obj_dict[&quot;coordinate&quot;]],</span>
    <span class="c1">#                          scatters_colors=[&quot;red&quot;,&quot;blue&quot;,&quot;orange&quot;],</span>
    <span class="c1">#                          scatter_size=0.5)</span>


            <span class="k">if</span> <span class="n">limb_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limb_branch_to_synapse_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">limb_branch_to_synapse_list</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">branch_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limb_branch_to_synapse_list</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">limb_branch_to_synapse_list</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">][</span><span class="n">branch_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">limb_branch_to_synapse_list</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">][</span><span class="n">branch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="o">**</span><span class="n">syn_obj_dict</span><span class="p">))</span>
            
    <span class="c1">#return limb_branch_to_synapse_list</span>

    <span class="c1">#----- Phase 2: Adding the Synapse Objects ------ #</span>
    <span class="n">soma_synapses</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_indexes</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">limb_data</span> <span class="ow">in</span> <span class="n">limb_branch_to_synapse_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">limb_name</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">get_limb_string_name</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limb_branch_dict_to_add_synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">limb_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limb_branch_dict_to_add_synapses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
        <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">branch_synapses</span> <span class="ow">in</span> <span class="n">limb_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">limb_branch_dict_to_add_synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limb_branch_dict_to_add_synapses</span><span class="p">[</span><span class="n">limb_name</span><span class="p">]:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">soma_synapses</span><span class="p">[</span><span class="o">-</span><span class="n">l</span> <span class="o">-</span> <span class="n">nru</span><span class="o">.</span><span class="n">soma_face_offset</span><span class="p">]</span><span class="o">+=</span> <span class="n">branch_synapses</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neuron_obj</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span> <span class="o">=</span> <span class="n">branch_synapses</span>

    <span class="c1"># storing the soma synapses</span>
    <span class="k">if</span> <span class="n">limb_branch_dict_to_add_synapses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">soma_synapses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="c1">#             for v_syn in v:</span>
<span class="c1">#                 v.compartment = &quot;soma&quot;</span>
            <span class="n">neuron_obj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;S</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span> <span class="o">=</span> <span class="n">v</span>

<span class="c1">#     print(f&quot;soma_synapses= {soma_synapses}&quot;)</span>
<span class="c1">#     print(f&quot;neuron_obj.syanspes_somas = {neuron_obj.synapses_somas}&quot;)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for valid synapse objects = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="add_error_synapses_to_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.add_error_synapses_to_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">add_error_synapses_to_neuron_obj</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">synapse_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mesh_label_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    0) Get the coordinates and volumes of each </span>
<span class="sd">    For each error type</span>
<span class="sd">    a) Create a list for storage</span>
<span class="sd">    For presyn/postsyn:</span>
<span class="sd">        c) Build the synapses from the information</span>
<span class="sd">        d) store in the list</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># ----- Phase 0: Getting the Synapse Info ------ #</span>
    <span class="k">if</span> <span class="n">synapse_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">segment_id_to_synapse_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
                                                 <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">mesh_label_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh_label_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">fetch_synapse_dict_by_mesh_labels</span><span class="p">(</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">neuron_mesh_from_branches</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
            <span class="n">segment_id</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
            <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">,</span>
            <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
            <span class="c1">#original_mesh_kd=original_mesh_kd,</span>
            <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
            <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>                        
                    

    <span class="c1"># ------ Phase 1: Getting the Error Dictionaries set Up -------</span>
    <span class="n">error_synapse_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]:</span>
        <span class="n">error_synapse_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mesh_label_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>



    <span class="n">error_synapse_dict_coord</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_dict_mesh_labels_to_synapse_coordinate_dict</span><span class="p">(</span><span class="n">error_synapse_dict</span><span class="p">,</span>
                                                            <span class="n">synapse_dict</span><span class="p">,</span>
                                                            <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">error_synapse_dict_volume</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_dict_mesh_labels_to_synapse_volume_dict</span><span class="p">(</span><span class="n">error_synapse_dict</span><span class="p">,</span>
                                                            <span class="n">synapse_dict</span><span class="p">,</span>
                                                            <span class="n">return_presyn_postsyn_valid_error_dict</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ------ Phase 2: Creating the Error Synapses From the Dictionary Info -------</span>
    <span class="n">syn_error_lists</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_error_types</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_error_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on error_type = </span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">syn_type</span><span class="p">,</span><span class="n">valid_dict</span> <span class="ow">in</span> <span class="n">error_synapse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">syn_ids</span> <span class="o">=</span> <span class="n">valid_dict</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">syn_idx</span><span class="p">,</span><span class="n">syn_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">syn_ids</span><span class="p">):</span>
                <span class="n">syn_coord</span> <span class="o">=</span> <span class="n">error_synapse_dict_coord</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="n">error_type</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
                <span class="n">syn_volume</span> <span class="o">=</span> <span class="n">error_synapse_dict_volume</span><span class="p">[</span><span class="n">syn_type</span><span class="p">][</span><span class="n">error_type</span><span class="p">][</span><span class="n">syn_idx</span><span class="p">]</span>
                <span class="n">syn_obj_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">syn_type</span><span class="o">=</span><span class="n">syn_type</span><span class="p">,</span>
                                <span class="n">syn_id</span> <span class="o">=</span> <span class="n">syn_id</span><span class="p">,</span>
                                <span class="n">volume</span> <span class="o">=</span> <span class="n">syn_volume</span><span class="p">,</span>
                                    <span class="n">coordinate</span> <span class="o">=</span> <span class="n">syn_coord</span><span class="p">,</span>
                                    <span class="n">soma_distance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="p">)</span>
                <span class="n">syn_error_lists</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="o">**</span><span class="n">syn_obj_dict</span><span class="p">))</span>


        <span class="nb">setattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">_synapses&quot;</span><span class="p">,</span><span class="n">syn_error_lists</span><span class="p">[</span><span class="n">error_type</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for valid synapse objects = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="add_synapses_to_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.add_synapses_to_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">add_synapses_to_neuron_obj</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">segment_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_valid_error_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">calculate_synapse_soma_distance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_error_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">limb_branch_dict_to_add_synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="c1">#set_head_neck_shaft=True</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To add the synapse information </span>
<span class="sd">    to the neuron object</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    0) Get the KDTree of the original mesh</span>
<span class="sd">    1) Get </span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Step 1: Computing synapse_dict---&quot;</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">segment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">segment_id</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span>
    <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">segment_id_to_synapse_dict</span><span class="p">(</span>
        <span class="n">segment_id</span> <span class="o">=</span> <span class="n">segment_id</span><span class="p">,</span>
        <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1">#original_mesh_kd = tu.mesh_to_kdtree(original_mesh)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Step 2: Computing mesh_label_dict---&quot;</span><span class="p">)</span>
    <span class="n">mesh_label_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">fetch_synapse_dict_by_mesh_labels</span><span class="p">(</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">neuron_mesh_from_branches</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">segment_id</span><span class="o">=</span><span class="n">segment_id</span><span class="p">,</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">,</span>
        <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
        <span class="c1">#original_mesh_kd=original_mesh_kd,</span>
        <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
        <span class="n">plot_synapses</span><span class="o">=</span><span class="n">plot_valid_error_synapses</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>


    <span class="c1"># Apply the Valid Synapses</span>
    <span class="k">if</span> <span class="n">add_valid_synapses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Step 3: add_valid_synapses_to_neuron_obj---&quot;</span><span class="p">)</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">add_valid_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">synapse_dict</span><span class="o">=</span><span class="n">synapse_dict</span><span class="p">,</span>
                                            <span class="n">mesh_label_dict</span><span class="o">=</span><span class="n">mesh_label_dict</span><span class="p">,</span>
                                             <span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="p">,</span>
                                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                            <span class="n">debug_time</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                            <span class="n">calualate_endpoints_dist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">limb_branch_dict_to_add_synapses</span> <span class="o">=</span> <span class="n">limb_branch_dict_to_add_synapses</span>
                                             <span class="c1">#set_head_neck_shaft=set_head_neck_shaft</span>
                                            <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">add_error_synapses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Step 4: add_error_synapses_to_neuron_obj---&quot;</span><span class="p">)</span>

        <span class="n">syu</span><span class="o">.</span><span class="n">add_error_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                            <span class="n">synapse_dict</span><span class="o">=</span><span class="n">synapse_dict</span><span class="p">,</span>
                                            <span class="n">mesh_label_dict</span><span class="o">=</span><span class="n">mesh_label_dict</span><span class="p">,</span>
                                             <span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="p">,</span>
                                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calculate_synapse_soma_distance</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---Step 5: Adding Soma distances to synapse objects---&quot;</span><span class="p">)</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">calculate_neuron_soma_distance</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
        
    <span class="n">syu</span><span class="o">.</span><span class="n">set_limb_branch_idx_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">neuron_obj</span></div>

<span class="k">def</span> <span class="nf">synapses_to_coordinates</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span>
                           <span class="n">coordinate_type</span> <span class="o">=</span> <span class="s2">&quot;coordinate&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will export the coordinates of a list of synapse</span>
<span class="sd">    </span>
<span class="sd">    Other coordinate types:</span>
<span class="sd">    1) coordinate</span>
<span class="sd">    2) closest_sk_coordinate</span>
<span class="sd">    3) closest_face_coordinate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">coordinate_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">synapses_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">,</span>
                                  <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To gather all of the synapses over a limb branch dict restriction</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapses_over_limb_branch_dict(neuron_obj,</span>
<span class="sd">                                  limb_branch_dict=dict(L2=[5,6,7]),</span>
<span class="sd">                                  synapse_type = &quot;synapses&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">nru</span><span class="o">.</span><span class="n">concatenate_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">feature</span><span class="o">=</span><span class="n">synapse_type</span><span class="p">)</span>

<div class="viewcode-block" id="n_synapses_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">,</span>
                                  <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To gather all of the synapses over a limb branch dict restriction</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapses_over_limb_branch_dict(neuron_obj,</span>
<span class="sd">                                  limb_branch_dict=dict(L2=[5,6,7]),</span>
<span class="sd">                                  synapse_type = &quot;synapses&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">nru</span><span class="o">.</span><span class="n">sum_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">feature</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;n_</span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_pre_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To gather all of the synapses over a limb branch dict restriction</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapses_over_limb_branch_dict(neuron_obj,</span>
<span class="sd">                                  limb_branch_dict=dict(L2=[5,6,7]),</span>
<span class="sd">                                  synapse_type = &quot;synapses&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">nru</span><span class="o">.</span><span class="n">sum_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">feature</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;n_synapses_pre&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_post_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To gather all of the synapses over a limb branch dict restriction</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapses_over_limb_branch_dict(neuron_obj,</span>
<span class="sd">                                  limb_branch_dict=dict(L2=[5,6,7]),</span>
<span class="sd">                                  synapse_type = &quot;synapses&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">nru</span><span class="o">.</span><span class="n">sum_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                             <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                            <span class="n">feature</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;n_synapses_post&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapse_pre_perc_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_pre_perc_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_pre_perc_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">limb_branch_dict</span>
                                          <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will compute the percentage of synapses that are presyn over a limb branch dict</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    branches = [0,5,6,7]</span>
<span class="sd">    lb = dict(L0=branches)</span>
<span class="sd">    syn_pre_perc = syu.synapse_pre_perc_over_limb_branch_dict(neuron_obj_exc_syn_sp,</span>
<span class="sd">                                                             lb)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curr_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_pre_perc</span><span class="p">(</span><span class="n">curr_syns</span><span class="p">)</span></div>


<div class="viewcode-block" id="synapse_post_perc_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_post_perc_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_post_perc_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">limb_branch_dict</span>
                                          <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will compute the percentage of synapses that are postsyn over a limb branch dict</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    lb = dict(L0=branches)</span>
<span class="sd">    syn_post_perc = syu.synapse_post_perc_over_limb_branch_dict(neuron_obj_exc_syn_sp,</span>
<span class="sd">                                                             lb)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curr_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">limb_branch_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_post_perc</span><span class="p">(</span><span class="n">curr_syns</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_errored_synapses_names"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.get_errored_synapses_names">[docs]</a><span class="k">def</span> <span class="nf">get_errored_synapses_names</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;errored_synapses&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span></div>


<div class="viewcode-block" id="synapses_somas"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_somas">[docs]</a><span class="k">def</span> <span class="nf">synapses_somas</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_node_names</span><span class="p">():</span>
        <span class="n">total_synapses</span> <span class="o">+=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">return</span> <span class="n">total_synapses</span></div>

<span class="n">soma_synapses</span> <span class="o">=</span> <span class="n">synapses_somas</span>

<div class="viewcode-block" id="synapses_somas_postsyn"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_somas_postsyn">[docs]</a><span class="k">def</span> <span class="nf">synapses_somas_postsyn</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(compartment == &#39;soma&#39;) and (syn_type == &#39;postsyn&#39;) &quot;</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_somas_postsyn"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_somas_postsyn">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_somas_postsyn</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_somas_postsyn</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>
    

    

<div class="viewcode-block" id="synapses_valid_old"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid_old">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid_old</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">include_soma</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return all valid synapses and somas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">if</span> <span class="n">include_soma</span><span class="p">:</span>
        <span class="n">valid_synapses</span> <span class="o">+=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_somas</span>
    <span class="k">return</span> <span class="n">valid_synapses</span></div>

<div class="viewcode-block" id="synapses_valid"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">include_soma</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return all valid synapses and somas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span> <span class="o">=</span> <span class="n">valid_query</span><span class="p">(),</span>
                        <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_syns</span></div>

<div class="viewcode-block" id="n_synapses_valid"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_valid">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">include_soma</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_valid_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid_pre">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_valid_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid_post">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_valid_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_valid_pre">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_valid_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_valid_post">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_error_old"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_old">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_old</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will get all of the errored synapses stored in the object</span>
<span class="sd">    </span>
<span class="sd">    syu.error_synpases(neuron_obj,</span>
<span class="sd">                verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">total_error_synapses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">error_synapses_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error_synapses_names</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">get_errored_synapses_names</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error_synapses_names = </span><span class="si">{</span><span class="n">error_synapses_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">err_syn</span> <span class="ow">in</span> <span class="n">error_synapses_names</span><span class="p">:</span>
        <span class="n">total_error_synapses</span> <span class="o">+=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">err_syn</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">total_error_synapses</span></div>

<div class="viewcode-block" id="synapses_error"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error">[docs]</a><span class="k">def</span> <span class="nf">synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will get all of the errored synapses stored in the object</span>
<span class="sd">    </span>
<span class="sd">    syu.error_synpases(neuron_obj,</span>
<span class="sd">                verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">error_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span> <span class="o">=</span> <span class="n">error_query</span><span class="p">(),</span>
                    <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_syns</span></div>

<div class="viewcode-block" id="n_synapses_error"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_error">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">error_synapses_names</span><span class="o">=</span><span class="n">error_synapses_names</span><span class="p">,</span>
                    <span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">presyns_on_dendrite_as_errors</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_error_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_pre">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_error_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_post">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_error_pre"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_error_pre">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_error_post"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_error_post">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>


<div class="viewcode-block" id="synapses_total"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_total">[docs]</a><span class="k">def</span> <span class="nf">synapses_total</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to find the total number of synapses stored</span>
<span class="sd">    in the neuron object</span>
<span class="sd">    </span>
<span class="sd">    Pseducode: </span>
<span class="sd">    1) get all of the soma synapses</span>
<span class="sd">    2) get all of the errored synapses</span>
<span class="sd">    3) get all of the limb_branch synapses</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#     # old way of compiling</span>
<span class="c1">#     soma_synapses = neuron_obj.synapses_somas</span>
<span class="c1">#     errored_synapses = neuron_obj.synapses_error</span>
<span class="c1">#     limb_branch_synapses = neuron_obj.synapses</span>
<span class="c1">#     soma_synapses + errored_synapses + limb_branch_synapses</span>
    
    <span class="n">total_synapses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s_type</span><span class="p">,</span><span class="n">s_type_att</span> <span class="ow">in</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">curr_syns</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">s_type_att</span><span class="p">)</span>
        <span class="n">total_synapses</span> <span class="o">+=</span> <span class="n">curr_syns</span>
    
    <span class="k">return</span> <span class="n">total_synapses</span></div>


<div class="viewcode-block" id="synapses_to_synapses_df"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_synapses_df">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_synapses_df</span><span class="p">(</span>
    <span class="n">synapses</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;no_label&quot;</span><span class="p">,</span>
    <span class="n">add_compartment_coarse_fine</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_head_neck_shaft_idx</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
    <span class="n">synapse_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">export</span><span class="p">(),</span>
                                   <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                   <span class="p">)</span>
                                   <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">dicts_to_dataframe</span><span class="p">(</span><span class="n">synapse_dicts</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_synapse_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">add_compartment_coarse_fine</span><span class="o">=</span><span class="n">add_compartment_coarse_fine</span><span class="p">,</span>
        <span class="n">decode_head_neck_shaft_idx</span> <span class="o">=</span> <span class="n">decode_head_neck_shaft_idx</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="synapses_df"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_df">[docs]</a><span class="k">def</span> <span class="nf">synapses_df</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">synapse_types_to_process</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_compartment_coarse_fine</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_head_neck_shaft_idx</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To create a dataframe with all of the features</span>
<span class="sd">    of the synapses so the synapses can be queried</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_synapses_df</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">add_compartment_coarse_fine</span><span class="o">=</span><span class="n">add_compartment_coarse_fine</span><span class="p">,</span>
            <span class="n">decode_head_neck_shaft_idx</span><span class="o">=</span><span class="n">decode_head_neck_shaft_idx</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">synapse_types_to_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">curr_synapse_types</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> 
                              <span class="n">syu</span><span class="o">.</span><span class="n">synapse_types</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_types_to_process</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_synapse_types</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_types</span>

    <span class="n">synapse_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s_type</span><span class="p">,</span><span class="n">s_type_att</span> <span class="ow">in</span> <span class="n">curr_synapse_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">s_type</span> <span class="o">!=</span> <span class="s2">&quot;limb_branch&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s_type</span> <span class="o">==</span> <span class="s2">&quot;soma&quot;</span><span class="p">:</span>
                <span class="n">compartment</span> <span class="o">=</span> <span class="s2">&quot;soma&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">s_type</span><span class="p">:</span>
                <span class="n">compartment</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown stype = </span><span class="si">{</span><span class="n">s_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="n">curr_syns</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">s_type_att</span><span class="p">)</span>
            <span class="n">curr_synapse_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">curr_syns</span><span class="p">:</span>
                <span class="n">curr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">s_type</span><span class="p">,</span>
                                       <span class="n">limb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">branch_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">compartment</span> <span class="o">=</span> <span class="n">compartment</span><span class="p">,)</span>
                <span class="n">curr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">j</span><span class="p">:</span><span class="n">b</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">export</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                                                        <span class="ow">or</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">,</span><span class="s2">&quot;brnach_idx&quot;</span><span class="p">,</span><span class="s2">&quot;compartment&quot;</span><span class="p">])})</span>
                <span class="n">curr_synapse_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_dict</span><span class="p">)</span>
<span class="c1">#             curr_synapse_dicts = [dict(k.export(),</span>
<span class="c1">#                                        label=s_type,</span>
<span class="c1">#                                        limb_idx = -1,</span>
<span class="c1">#                                        branch_idx = -1,</span>
<span class="c1">#                                        compartment = compartment,</span>
<span class="c1">#                                        )</span>
<span class="c1">#                                        for k in curr_syns]</span>
            <span class="n">synapse_dicts</span> <span class="o">+=</span> <span class="n">curr_synapse_dicts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">limb_idx</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_limb_names</span><span class="p">(</span><span class="n">return_int</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">branch_idx</span> <span class="ow">in</span> <span class="n">limb_obj</span><span class="o">.</span><span class="n">get_branch_names</span><span class="p">():</span>
                    <span class="n">curr_synapse_dicts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
                        <span class="n">curr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">s_type</span><span class="p">,</span>
                                        <span class="n">limb_idx</span> <span class="o">=</span> <span class="n">limb_idx</span><span class="p">,</span>
                                       <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">branch_idx</span><span class="p">,</span>
                                        <span class="n">compartment</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">axon_compartment</span><span class="p">,</span>
                                        <span class="c1">#width = </span>
                                        <span class="p">)</span>
                        <span class="n">curr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">j</span><span class="p">:</span><span class="n">b</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">export</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                                                        <span class="ow">or</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">,</span><span class="s2">&quot;brnach_idx&quot;</span><span class="p">,</span><span class="s2">&quot;compartment&quot;</span><span class="p">])})</span>
                        <span class="n">curr_synapse_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_dict</span><span class="p">)</span>
<span class="c1">#                         curr_synapse_dicts = [dict(k.export(),</span>
<span class="c1">#                                        label=s_type,</span>
<span class="c1">#                                         limb_idx = limb_idx,</span>
<span class="c1">#                                        branch_idx = branch_idx,</span>
<span class="c1">#                                         compartment = limb_obj[branch_idx].axon_compartment,</span>
<span class="c1">#                                        )</span>
<span class="c1">#                                        for k in limb_obj[branch_idx].synapses]</span>
                    <span class="n">synapse_dicts</span> <span class="o">+=</span> <span class="n">curr_synapse_dicts</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of synapses processed = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_dicts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">dicts_to_dataframe</span><span class="p">(</span><span class="n">synapse_dicts</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">add_limb_branch_combined_name_to_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_synapse_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">add_compartment_coarse_fine</span><span class="o">=</span><span class="n">add_compartment_coarse_fine</span><span class="p">,</span>
        <span class="n">decode_head_neck_shaft_idx</span> <span class="o">=</span> <span class="n">decode_head_neck_shaft_idx</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="annotate_synapse_df"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.annotate_synapse_df">[docs]</a><span class="k">def</span> <span class="nf">annotate_synapse_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">add_compartment_coarse_fine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_head_neck_shaft_idx</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">add_compartment_coarse_fine</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">add_compartment_coarse_fine_to_df</span><span class="p">(</span>
            <span class="n">df</span>
        <span class="p">)</span>
        
    <span class="k">if</span> <span class="n">decode_head_neck_shaft_idx</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;head_neck_shaft&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">decode_head_neck_shaft_idx</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">head_neck_shaft</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>

<span class="n">synapse_df</span> <span class="o">=</span> <span class="n">synapses_df</span>


<div class="viewcode-block" id="restrict_synapses_df_by_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.restrict_synapses_df_by_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">restrict_synapses_df_by_limb_branch_dict</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">limb_branch_dict</span><span class="p">,</span>
    <span class="p">):</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limb_branch in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_str_names_from_limb_branch_dict</span><span class="p">(</span><span class="n">limb_branch_dict</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="query_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.query_synapses">[docs]</a><span class="k">def</span> <span class="nf">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">query</span><span class="p">,</span>
                  <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">return_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">return_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">return_column</span> <span class="o">=</span> <span class="s2">&quot;syn_id&quot;</span><span class="p">,</span>
                  <span class="n">local_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
                   <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">synapse_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To return a dataframe </span>
<span class="sd">    </span>
<span class="sd">    Pseudocode:</span>
<span class="sd">    1) Create synapse dataframe</span>
<span class="sd">    2) Use the query function to reduce the dataframe</span>
<span class="sd">    3) Return the desired output</span>
<span class="sd">    </span>
<span class="sd">    Note: YOU CAN SEND THIS FUNCTION A LIST OF SYNAPSES NOW</span>
<span class="sd">    </span>
<span class="sd">    EX: </span>
<span class="sd">    syn_type = &quot;presyn&quot;</span>
<span class="sd">    head_neck_shaft_type = &quot;shaft&quot;</span>
<span class="sd">    syu.query_synapses(neuron_obj_exc_syn_sp[0][0].synapses,</span>
<span class="sd">                       query=(f&quot;(syn_type == &#39;{syn_type}&#39;) and &quot;</span>
<span class="sd">                             f&quot;(head_neck_shaft == {spu.head_neck_shaft_dict[head_neck_shaft_type]})&quot;),</span>
<span class="sd">                       return_synapses=True</span>
<span class="sd">                      )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">synapse_df</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_df</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">query_df</span> <span class="o">=</span> <span class="n">synapse_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">local_dict</span><span class="o">=</span><span class="n">local_dict</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limb_branch_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query_df</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">restrict_synapses_df_by_limb_branch_dict</span><span class="p">(</span>
               <span class="n">query_df</span><span class="p">,</span>
               <span class="n">limb_branch_dict</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of synapses in query = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">query_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">syn_indexes</span> <span class="o">=</span> <span class="n">query_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">synapse_objs</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_indexes_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                          <span class="n">syn_indexes</span><span class="p">)</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">synapse_objs</span><span class="p">,</span>
                <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_synapses</span><span class="p">:</span>
        <span class="n">syn_indexes</span> <span class="o">=</span> <span class="n">query_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">neuron_obj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syn_indexes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">synapse_indexes_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                          <span class="n">syn_indexes</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_df</span>
    <span class="k">elif</span> <span class="n">return_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_df</span><span class="p">[</span><span class="n">return_column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>


<span class="c1"># ---------- 6:11 For creating datajoint entries ----------</span>
<div class="viewcode-block" id="synapses_dj_export_dict_valid"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_dj_export_dict_valid">[docs]</a><span class="k">def</span> <span class="nf">synapses_dj_export_dict_valid</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span>
                                 <span class="n">output_spine_str</span><span class="o">=</span><span class="kc">True</span><span class="p">,):</span>
    <span class="n">syn</span><span class="o">=</span><span class="n">synapse</span>
    <span class="n">spine_label</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">head_neck_shaft</span>
    
    <span class="n">compartment_coarse</span><span class="p">,</span><span class="n">compartment_fine</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">coarse_fine_compartment_from_label</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">compartment</span><span class="p">)</span>
        
    <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">synapse_id</span><span class="o">=</span><span class="n">syn</span><span class="o">.</span><span class="n">syn_id</span><span class="p">,</span>
          <span class="n">synapse_type</span><span class="o">=</span><span class="n">syn</span><span class="o">.</span><span class="n">syn_type</span><span class="p">,</span>
          <span class="n">skeletal_distance_to_soma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">soma_distance</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
          <span class="n">limb_idx</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">limb_idx</span><span class="p">,</span>
          <span class="n">branch_idx</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">branch_idx</span><span class="p">,</span>
          <span class="n">compartment_coarse</span><span class="o">=</span><span class="n">compartment_coarse</span><span class="p">,</span>
          <span class="n">compartment_fine</span><span class="o">=</span><span class="n">compartment_fine</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">output_spine_str</span><span class="p">:</span>
        <span class="n">spine_label</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_str_label</span><span class="p">(</span><span class="n">spine_label</span><span class="p">)</span>
        <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;spine_bouton&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spine_label</span>
    
    <span class="k">return</span> <span class="n">return_dict</span></div>
    
<div class="viewcode-block" id="synapses_dj_export_dict_error"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_dj_export_dict_error">[docs]</a><span class="k">def</span> <span class="nf">synapses_dj_export_dict_error</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">syn</span><span class="o">=</span><span class="n">synapse</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">synapse_id</span><span class="o">=</span><span class="n">syn</span><span class="o">.</span><span class="n">syn_id</span><span class="p">,</span>
          <span class="n">synapse_type</span><span class="o">=</span><span class="n">syn</span><span class="o">.</span><span class="n">syn_type</span><span class="p">,)</span></div>
        


<div class="viewcode-block" id="synapses_to_dj_keys_old"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_dj_keys_old">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_dj_keys_old</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">nucleus_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">split_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_spine_str</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get either the valid of invalid synapses</span>
<span class="sd">    2) For each synapses export the following as dict</span>

<span class="sd">    synapse_id=syn,</span>
<span class="sd">    synapse_type=synapse_type,</span>
<span class="sd">    nucleus_id = nucleus_id,</span>
<span class="sd">    segment_id = segment_id,</span>
<span class="sd">    split_index = split_index,</span>
<span class="sd">    skeletal_distance_to_soma=np.round(syn_dist[syn_i],2),</span>

<span class="sd">    return the list</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from python_tools import numpy_dep as np</span>
<span class="sd">    dj_keys = syu.synapses_to_dj_keys(neuron_obj,</span>
<span class="sd">                           verbose = True,</span>
<span class="sd">                           nucleus_id=12345,</span>
<span class="sd">                           split_index=0)</span>
<span class="sd">    np.unique([k[&quot;compartment&quot;] for k in dj_keys],return_counts=True)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Ex:  How to get error keys with version:</span>
<span class="sd">    dj_keys = syu.synapses_to_dj_keys(neuron_obj,</span>
<span class="sd">                                  valid_synapses = False,</span>
<span class="sd">                       verbose = True,</span>
<span class="sd">                       nucleus_id=12345,</span>
<span class="sd">                       split_index=0,</span>
<span class="sd">                                 ver=158)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segment_id</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span>
    
    <span class="k">if</span> <span class="n">nucleus_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neuron_obj</span><span class="o">.</span><span class="n">nucleus_id</span> <span class="o">=</span> <span class="n">nucleus_id</span>
    <span class="k">if</span> <span class="n">split_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neuron_obj</span><span class="o">.</span><span class="n">split_index</span> <span class="o">=</span> <span class="n">split_index</span>
    
    <span class="k">if</span> <span class="n">valid_synapses</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_valid</span>
        <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_valid</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_error</span>
        <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_error</span>
        
    <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nucleus_id&quot;</span><span class="p">,</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span><span class="s2">&quot;split_index&quot;</span><span class="p">]:</span>
<span class="c1">#         globs = globals()</span>
<span class="c1">#         locs = locals()</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">eval</span><span class="p">(</span><span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">att</span><span class="si">}</span><span class="s2"> is None&quot;</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1">#     syn_keys = [dict(synapse_id=syn.syn_id,</span>
<span class="c1">#                      synapse_type=syn.syn_type,</span>
<span class="c1">#                     nucleus_id=neuron_obj.nucleus_id,</span>
<span class="c1">#                     segment_id=neuron_obj.segment_id,</span>
<span class="c1">#                     split_index = neuron_obj.split_index,</span>
<span class="c1">#         skeletal_distance_to_soma = np.round(syn.soma_distance,2)) for syn in synapses]</span>

    <span class="n">syn_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">export_func</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span><span class="n">output_spine_str</span><span class="o">=</span><span class="n">output_spine_str</span><span class="p">),</span>
                                <span class="n">nucleus_id</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;nucleus_id&quot;</span><span class="p">,</span><span class="n">nucleus_id</span><span class="p">),</span>
                    <span class="n">segment_id</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
                    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;split_index&quot;</span><span class="p">,</span><span class="n">split_index</span><span class="p">))</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">]</span>
    
    <span class="c1">#adding on the secondary seg</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valid_synapses = </span><span class="si">{</span><span class="n">valid_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> synapse entries = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">syn_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ver</span><span class="o">=</span><span class="n">ver</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syn_keys</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">syn_keys</span></div>



<div class="viewcode-block" id="presyn_on_dendrite_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.presyn_on_dendrite_synapses">[docs]</a><span class="k">def</span> <span class="nf">presyn_on_dendrite_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">split_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">nucleus_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">return_dj_keys</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>


    <span class="n">syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;(compartment==&#39;dendrite&#39;) and (syn_type==&#39;presyn&#39;)&quot;</span><span class="p">,</span>
        <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of presyns on dendrite = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_dj_keys</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_dj_keys</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">synapses</span><span class="o">=</span><span class="n">syns</span><span class="p">,</span>
            <span class="n">valid_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">nucleus_id</span><span class="o">=</span><span class="n">nucleus_id</span><span class="p">,</span>
            <span class="n">split_index</span> <span class="o">=</span> <span class="n">split_index</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">syns</span></div>

<div class="viewcode-block" id="presyn_on_dendrite_synapses_non_axon_like"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.presyn_on_dendrite_synapses_non_axon_like">[docs]</a><span class="k">def</span> <span class="nf">presyn_on_dendrite_synapses_non_axon_like</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get the presyns on dendrites</span>
<span class="sd">    where the dendrites are restricted to </span>
<span class="sd">    those that aren&#39;t axon-like</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limb_branch_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limb_branch_dict</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">non_axon_like_limb_branch_on_dendrite</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite_query</span><span class="p">,</span>
        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>




<div class="viewcode-block" id="presyns_on_dendrite"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.presyns_on_dendrite">[docs]</a><span class="k">def</span> <span class="nf">presyns_on_dendrite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">return_column</span> <span class="o">=</span> <span class="s2">&quot;syn_id&quot;</span><span class="p">,</span>
                       <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Be able to find the synapses that are presyn on dendrite</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) query the synapses_df for &quot;(label==&#39;limb_branch&#39;) and (compartment==&#39;dendrite&#39;) and (syn_type==&#39;presyn&#39;)&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query_df</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">presyns_on_dendrite_query</span><span class="p">,</span>
                   <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_df</span><span class="p">[</span><span class="n">return_column</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="axon_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.axon_synapses">[docs]</a><span class="k">def</span> <span class="nf">axon_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                <span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">query</span><span class="o">=</span><span class="s2">&quot;compartment==&#39;axon&#39;&quot;</span><span class="p">,</span>
                   <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="n_presyns_on_dendrite"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_presyns_on_dendrite">[docs]</a><span class="k">def</span> <span class="nf">n_presyns_on_dendrite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="synapse_ids_to_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_ids_to_synapses">[docs]</a><span class="k">def</span> <span class="nf">synapse_ids_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">synapse_ids</span><span class="p">,</span>
                           <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If have list of synapse ids and want to find the corresponding objects</span>
<span class="sd">    </span>
<span class="sd">    (not used in queries at all)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="n">match_syn</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_total</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">syn_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">synapse_ids</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for retrieving synapses: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">match_syn</span></div>

<div class="viewcode-block" id="synapse_indexes_to_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_indexes_to_synapses">[docs]</a><span class="k">def</span> <span class="nf">synapse_indexes_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                           <span class="n">synapse_indexes</span><span class="p">,</span>
                           <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="n">match_syn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_total</span><span class="p">)[</span><span class="n">synapse_indexes</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time for retrieving synapses: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">match_syn</span></div>

<div class="viewcode-block" id="synapses_to_feature"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_feature">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_feature</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span><span class="n">feature</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">feature</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">]</span></div>
<div class="viewcode-block" id="synapses_to_synapse_ids"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_synapse_ids">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_synapse_ids</span><span class="p">(</span><span class="n">synapses</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_feature</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span><span class="n">feature</span><span class="o">=</span><span class="s2">&quot;syn_id&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapses_to_coordinates"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_coordinates">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_coordinates</span><span class="p">(</span><span class="n">synapses</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_feature</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span><span class="n">feature</span><span class="o">=</span><span class="s2">&quot;coordinate&quot;</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="synapses_error_pre_coordinates"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_pre_coordinates">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_pre_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_error_post_coordinates"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_post_coordinates">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_post_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_valid_pre_coordinates"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid_pre_coordinates">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid_pre_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_valid_post_coordinates"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_valid_post_coordinates">[docs]</a><span class="k">def</span> <span class="nf">synapses_valid_post_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="synapse_pre_post_valid_errror_stats_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_pre_post_valid_errror_stats_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_pre_post_valid_errror_stats_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="n">presyn_error_syn_non_axon_ids</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="n">stats_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_valid_syn_presyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)),</span>
    <span class="n">n_valid_syn_postsyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)),</span>
    <span class="n">n_errored_syn_presyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)),</span>
    <span class="n">n_errored_syn_postsyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)),</span>
    <span class="n">presyn_error_syn_non_axon_ids</span> <span class="o">=</span> <span class="n">presyn_error_syn_non_axon_ids</span><span class="p">,</span>
    <span class="n">n_errored_syn_presyn_non_axon</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">presyn_error_syn_non_axon_ids</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">stats_dict</span></div>

<div class="viewcode-block" id="synapses_error_ids"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_error_ids">[docs]</a><span class="k">def</span> <span class="nf">synapses_error_ids</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span><span class="o">=</span><span class="n">error_query</span><span class="p">())</span></div>

<div class="viewcode-block" id="synapse_pre_post_valid_errror_coordinates_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_pre_post_valid_errror_coordinates_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_pre_post_valid_errror_coordinates_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To make a dictionary that has</span>
<span class="sd">    the valid and error synapses</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    For valid and error: </span>
<span class="sd">        for presyn and postsyn</span>
<span class="sd">        1) Get the corresponding synapses</span>
<span class="sd">        2) extract the coordinates from the synapses</span>
<span class="sd">        3) store in the dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">valid_syn_centers_presyn</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_pre_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
    <span class="n">errored_syn_centers_presyn</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_pre_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
    <span class="n">valid_syn_centers_postsyn</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid_post_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
    <span class="n">errored_syn_centers_postsyn</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_post_coordinates</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>




<span class="c1"># ------------ Function to replace the old filtering function ----------- #</span>
<div class="viewcode-block" id="synapse_filtering_vp2"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_filtering_vp2">[docs]</a><span class="k">def</span> <span class="nf">synapse_filtering_vp2</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">split_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nucleus_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">compute_synapse_to_soma_skeletal_distance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_synapse_filter_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_error_synapse_ids</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_synapse_center_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_errored_synapses_ids_non_axons</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_error_table_entries</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_neuron_obj</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_non_axon_presyn_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Applying the synpase filtering </span>
<span class="sd">    by using the synapses incorporated in the</span>
<span class="sd">    neuron object</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">syu</span><span class="o">.</span><span class="n">add_synapses_to_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                <span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="p">,</span>
                                <span class="n">verbose</span>  <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
                                <span class="n">plot_valid_error_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">calculate_synapse_soma_distance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">add_valid_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="n">add_error_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#---- 8/29: Will add limb and branch idx to synapses ------</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">set_limb_branch_idx_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>

    <span class="c1"># prework: adding the nucleus_id,split-index and calculating the soma distances</span>
    <span class="k">if</span> <span class="n">nucleus_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neuron_obj</span><span class="o">.</span><span class="n">nucleus_id</span> <span class="o">=</span> <span class="n">nucleus_id</span>

    <span class="k">if</span> <span class="n">split_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neuron_obj</span><span class="o">.</span><span class="n">split_index</span> <span class="o">=</span> <span class="n">split_index</span>


    <span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite_as_errors</span> <span class="o">=</span> <span class="n">apply_non_axon_presyn_errors</span>

    <span class="k">if</span> <span class="n">compute_synapse_to_soma_skeletal_distance</span><span class="p">:</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">calculate_neuron_soma_distance</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">keys_to_write_without_version</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_dj_keys</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">keys_to_write_without_version_errors</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_dj_keys</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">valid_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">synapse_stats</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_pre_post_valid_errror_stats_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>

    <span class="n">total_error_synapse_ids</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_error_ids</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of total_error_synapse_ids = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_error_synapse_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    
    
    <span class="k">if</span> <span class="n">return_synapse_center_data</span><span class="p">:</span>
        <span class="n">synapse_center_coordinates</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_pre_post_valid_errror_coordinates_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_synapses</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Displaying the Synapse Classifications&quot;</span><span class="p">)</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">plot_valid_error_synpases</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    
    <span class="n">syu</span><span class="o">.</span><span class="n">set_presyns_on_dendrite_as_errors_default</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">return_synapse_filter_info</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_synapse_center_data</span><span class="p">)</span> 
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_error_synapse_ids</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_error_table_entries</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">return_neuron_obj</span><span class="p">)</span>
       <span class="p">):</span>
        <span class="k">return</span> <span class="n">data_to_write</span>
    
    <span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys_to_write_without_version</span><span class="p">]</span>
    
    
    <span class="k">if</span> <span class="n">return_synapse_filter_info</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synapse_stats</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_synapse_center_data</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synapse_center_coordinates</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_error_synapse_ids</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_error_synapse_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_error_table_entries</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keys_to_write_without_version_errors</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_neuron_obj</span><span class="p">:</span>
        <span class="n">return_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">return_value</span></div>

<span class="c1"># ------------- 6/25: For the synapse near the endpoint -----------</span>
<div class="viewcode-block" id="synapse_endpoint_dist_upstream_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_endpoint_dist_upstream_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_endpoint_dist_upstream_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">,</span>
                                              <span class="n">direction</span><span class="p">,</span>
                                         <span class="n">synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will compute the upstream or downstream</span>
<span class="sd">    distance of a synapse or group of synapses</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode:</span>
<span class="sd">    1) Get the upstream or downstream endpoint index</span>
<span class="sd">    </span>
<span class="sd">    For each synapse</span>
<span class="sd">    2) Get the upstream or downstream distance</span>
<span class="sd">    </span>
<span class="sd">    3) Return the list</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    from neurd import synapse_utils as syu</span>
<span class="sd">    syu.synapse_endpoint_dist_upstream_downstream(limb_obj,</span>
<span class="sd">                                             branch_idx = 16,</span>
<span class="sd">                                             direction=&quot;downstream&quot;,</span>
<span class="sd">                                             verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">singular_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">synapses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">],</span><span class="n">synapse_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">synapses</span><span class="p">):</span>
            <span class="n">singular_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="p">[</span><span class="n">synapses</span><span class="p">]</span>
        
    <span class="c1">#1) Get the upstream or downstream endpoint index</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;upstream&quot;</span><span class="p">:</span>
        <span class="n">endpoint_idx</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">upstream_endpoint</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">return_endpoint_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;downstream&quot;</span><span class="p">:</span>
        <span class="n">endpoint_idx</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">downstream_endpoint</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span><span class="n">return_endpoint_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using direction </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">, endpoint_idx = </span><span class="si">{</span><span class="n">endpoint_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">dist_from_endpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">syn</span><span class="o">.</span><span class="n">endpoints_dist</span><span class="p">[</span><span class="n">endpoint_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dist_from_endpoint = </span><span class="si">{</span><span class="n">dist_from_endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">singular_flag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dist_from_endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dist_from_endpoint</span></div>

<div class="viewcode-block" id="synapse_endpoint_dist_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_endpoint_dist_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_endpoint_dist_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">,</span>
                                         <span class="n">synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_endpoint_dist_upstream_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">,</span>
                                              <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
                                         <span class="n">synapses</span> <span class="o">=</span> <span class="n">synapses</span><span class="p">,</span>
                                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapse_endpoint_dist_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_endpoint_dist_upstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_endpoint_dist_upstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">,</span>
                                         <span class="n">synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">synapse_endpoint_dist_upstream_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                                              <span class="n">branch_idx</span><span class="p">,</span>
                                              <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;upstream&quot;</span><span class="p">,</span>
                                         <span class="n">synapses</span> <span class="o">=</span> <span class="n">synapses</span><span class="p">,</span>
                                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_synapses_objs"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_objs">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                     <span class="n">synapses</span><span class="p">,</span>
                      <span class="n">plot_with_spines</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">synapse_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                      <span class="n">synapse_size</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To plot a certain group of synapses on top</span>
<span class="sd">    of the neuron object</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.plot_synapse_objs(neuron_obj_exc_syn_sp,</span>
<span class="sd">                 synapses = syu.synapses_shaft(neuron_obj_exc_syn_sp),</span>
<span class="sd">                  synapse_color=&quot;yellow&quot;</span>
<span class="sd">                 )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nru</span><span class="o">.</span><span class="n">is_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_with_spines</span><span class="p">:</span>
            <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron_lite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                      <span class="n">show_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spu</span><span class="o">.</span><span class="n">plot_spines_head_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">show_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">show_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
    <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span>
                     <span class="n">scatters</span><span class="o">=</span><span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">synapses</span><span class="p">)],</span>
                     <span class="n">scatter_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">,</span>
                     <span class="n">scatters_colors</span><span class="o">=</span><span class="n">synapse_color</span><span class="p">,</span>
                     <span class="n">append_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_head_neck_shaft_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_head_neck_shaft_synapses">[docs]</a><span class="k">def</span> <span class="nf">plot_head_neck_shaft_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">plot_with_spines</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">head_color</span> <span class="o">=</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                        <span class="n">neck_color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="n">shaft_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="n">no_head_color</span> <span class="o">=</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
                        <span class="n">bouton_color</span> <span class="o">=</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span>
                        <span class="n">non_bouton_color</span> <span class="o">=</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span>
                      <span class="n">synapse_size</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
                                  <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To plot all of the head neck and shaft spines of a neuron</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.plot_head_neck_shaft_synapses(neuron_obj_exc_syn_sp,</span>
<span class="sd">                                 synapse_size=0.08)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_with_spines</span> <span class="ow">or</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">n_spines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron_lite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">show_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spu</span><span class="o">.</span><span class="n">plot_spines_head_neck</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">show_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">synapses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">synapses_colors</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;head&quot;</span><span class="p">,</span><span class="s2">&quot;neck&quot;</span><span class="p">,</span><span class="s2">&quot;shaft&quot;</span><span class="p">,</span><span class="s2">&quot;no_head&quot;</span><span class="p">,</span><span class="s2">&quot;bouton&quot;</span><span class="p">,</span><span class="s2">&quot;non_bouton&quot;</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">head_color</span><span class="p">,</span><span class="n">neck_color</span><span class="p">,</span><span class="n">shaft_color</span><span class="p">,</span><span class="n">no_head_color</span><span class="p">,</span><span class="n">bouton_color</span><span class="p">,</span><span class="n">non_bouton_color</span><span class="p">]):</span>
        <span class="n">syns</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">syu</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;synapses_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="n">neuron_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syns</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">) &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">syns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">synapses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">syns</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">synapses_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            
    <span class="n">nviz</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">(</span>
                     <span class="n">scatters</span><span class="o">=</span><span class="n">synapses</span><span class="p">,</span>
                     <span class="n">scatter_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">,</span>
                     <span class="n">scatters_colors</span><span class="o">=</span><span class="n">synapses_colors</span><span class="p">,</span>
                     <span class="n">append_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    


<div class="viewcode-block" id="synapses_over_limb_branch_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_over_limb_branch_dict">[docs]</a><span class="k">def</span> <span class="nf">synapses_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                   <span class="n">limb_branch_dict</span><span class="p">,</span>
                                  <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                  <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">synapses</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                     <span class="n">branch_func_instead_of_feature</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">syu</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">plot_synapses</span><span class="p">:</span>
        <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">synapses</span><span class="o">=</span><span class="n">synapses</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">synapses</span></div>
    
    
<div class="viewcode-block" id="synapse_density_over_limb_branch"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_over_limb_branch">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_over_limb_branch</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">limb_branch_dict</span><span class="p">,</span>
                                    <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="n">return_skeletal_length</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="n">density_type</span> <span class="o">=</span> <span class="s2">&quot;skeletal_length&quot;</span><span class="p">,</span>
                                    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To calculate the </span>
<span class="sd">    synapse density over lmb branch</span>

<span class="sd">    Application: To be used for cell type (E/I)</span>
<span class="sd">    classification</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Restrict the neuron branches to be processed</span>
<span class="sd">    for postsynaptic density</span>
<span class="sd">    2) Calculate the skeletal length over the limb branch</span>
<span class="sd">    3) Find the number of postsyns over limb branch</span>
<span class="sd">    4) Compute postsynaptic density</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapse_density_over_limb_branch(neuron_obj = neuron_obj_exc_syn_sp,</span>
<span class="sd">                                     limb_branch_dict=syn_dens_limb_branch,</span>
<span class="sd">    #neuron_obj = neuron_obj_inh_syn_sp,</span>
<span class="sd">    verbose = True,</span>
<span class="sd">    synapse_type = &quot;synapses_post&quot;,</span>
<span class="sd">    #synapse_type = &quot;synapses_head&quot;,</span>
<span class="sd">    #synapse_type = &quot;synapses_shaft&quot;,</span>
<span class="sd">    multiplier = 1000)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sk_length</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">sum_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                         <span class="n">feature</span><span class="o">=</span><span class="n">density_type</span><span class="p">)</span>

    <span class="n">n_synapses</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">sum_feature_over_limb_branch_dict</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">limb_branch_dict</span><span class="p">,</span>
                                         <span class="n">branch_func_instead_of_feature</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">syu</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;n_</span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">sk_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">n_synapses</span><span class="o">/</span><span class="n">sk_length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">density</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">multiplier</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">density_type</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">sk_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of </span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">n_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Density = </span><span class="si">{</span><span class="n">density</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_skeletal_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">density</span><span class="p">,</span><span class="n">sk_length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">density</span></div>
    
<span class="c1"># ----------------- 7/20: helping with axon and dendrite merge errors ---------- #</span>
<div class="viewcode-block" id="synapse_pre_perc_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_pre_perc_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_pre_perc_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Find the downstream</span>
<span class="sd">    downstream of a branch</span>
<span class="sd">    </span>
<span class="sd">    syu.synapse_pre_perc_downstream(   limb_obj = neuron_obj_exc_syn_sp[0],</span>
<span class="sd">    branch_idx = 6,</span>
<span class="sd">    verbose = True,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapses_downstream</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span>
                                                 <span class="n">only_non_branching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pre_perc</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_pre_perc</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of downstream synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_perc = </span><span class="si">{</span><span class="n">pre_perc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pre_perc</span></div>

<div class="viewcode-block" id="synapse_post_perc_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_post_perc_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_post_perc_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Find the downstream</span>
<span class="sd">    downstream of a branch</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.synapse_post_perc_downstream(   limb_obj = neuron_obj_exc_syn_sp[0],</span>
<span class="sd">    branch_idx = 6,</span>
<span class="sd">    verbose = True,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapses_downstream</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span>
                                                 <span class="n">only_non_branching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">post_perc</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_post_perc</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of downstream synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;post_perc = </span><span class="si">{</span><span class="n">post_perc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">post_perc</span></div>


<div class="viewcode-block" id="synapses_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                       <span class="n">branch_idx</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">synapses_downstream</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span>
                                                 <span class="n">only_non_branching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of downstream synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">synapses_downstream</span></div>

<div class="viewcode-block" id="n_synapses_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="p">))</span></div>

<div class="viewcode-block" id="synapses_post_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_post_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapses_post_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Find the downstream</span>
<span class="sd">    downstream of a branch</span>
<span class="sd">    </span>
<span class="sd">    syu.synapse_pre_perc_downstream(   limb_obj = neuron_obj_exc_syn_sp[0],</span>
<span class="sd">    branch_idx = 6,</span>
<span class="sd">    verbose = True,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapses_downstream</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span>
                                                 <span class="n">only_non_branching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">post_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of downstream synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;post_synapses = </span><span class="si">{</span><span class="n">post_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">post_synapses</span></div>

<div class="viewcode-block" id="synapses_pre_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_pre_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapses_pre_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Find the downstream</span>
<span class="sd">    downstream of a branch</span>
<span class="sd">    </span>
<span class="sd">    syu.synapse_pre_perc_downstream(   limb_obj = neuron_obj_exc_syn_sp[0],</span>
<span class="sd">    branch_idx = 6,</span>
<span class="sd">    verbose = True,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapses_downstream</span> <span class="o">=</span> <span class="n">cnu</span><span class="o">.</span><span class="n">synapses_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span><span class="n">branch_idx</span><span class="p">,</span>
                                                 <span class="n">only_non_branching</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pre_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of downstream synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses_downstream</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre_synapses = </span><span class="si">{</span><span class="n">pre_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pre_synapses</span></div>
<div class="viewcode-block" id="n_synapses_post_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses_post_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_pre_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses_pre_downstream</span><span class="p">(</span><span class="n">limb_obj</span><span class="p">,</span>
                               <span class="n">branch_idx</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="p">))</span></div>
<span class="c1"># --------------- 7/26: Help with axon identification -------------</span>
<div class="viewcode-block" id="synapses_within_distance_of_endpoint_upstream_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_within_distance_of_endpoint_upstream_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapses_within_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will measure the number of synapses</span>
<span class="sd">    within a certain distance of the upstream or downstream endpoint</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the desired synapses</span>
<span class="sd">    2) Query the synapses based on the direction attribute</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    branch_obj = neuron_obj[0][2]</span>
<span class="sd">    synapses_within_upstream_downstream_endpoint(branch_obj,</span>
<span class="sd">                                         direction=&quot;downstream&quot;,</span>
<span class="sd">                                         distance =15000,</span>
<span class="sd">                                         synapse_type=&quot;synapses_post&quot;,</span>
<span class="sd">                                         )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span><span class="n">synapse_type</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of unfiltered synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">syn_filtered</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span>
                          <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">_dist &lt; </span><span class="si">{</span><span class="n">distance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of syn_filtered = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">syn_filtered</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>
    
<div class="viewcode-block" id="n_synapses_within_distance_of_endpoint_upstream_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_within_distance_of_endpoint_upstream_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_within_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_within_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_within_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_within_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="n_synapses_within_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_within_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_within_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                    <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;upstream&quot;</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_pre_within_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_within_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_within_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_pre&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_post_within_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_within_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_within_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_pre_within_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_within_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_pre&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_post_within_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_within_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_downstream_endpoint</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_spine_within_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_spine_within_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_spine_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_spine&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="synapse_density_post_within_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_post_within_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_post_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n_post_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_within_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n_post_syns</span><span class="o">/</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">skeletal_length</span></div>

<span class="c1"># ---- offset n_synapses ------------</span>
<div class="viewcode-block" id="synapses_offset_distance_of_endpoint_upstream_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_offset_distance_of_endpoint_upstream_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapses_offset_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will measure the number of synapses</span>
<span class="sd">    within a certain distance of the upstream or downstream endpoint</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the desired synapses</span>
<span class="sd">    2) Query the synapses based on the direction attribute</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    branch_obj = neuron_obj[0][2]</span>
<span class="sd">    synapses_within_upstream_downstream_endpoint(branch_obj,</span>
<span class="sd">                                         direction=&quot;downstream&quot;,</span>
<span class="sd">                                         distance =15000,</span>
<span class="sd">                                         synapse_type=&quot;synapses_post&quot;,</span>
<span class="sd">                                         )</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#     verbose = True</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;distance = </span><span class="si">{</span><span class="n">distance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">synapses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span><span class="n">synapse_type</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of unfiltered synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">syn_filtered</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">synapses</span><span class="p">,</span>
                          <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">_dist &gt; </span><span class="si">{</span><span class="n">distance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of syn_filtered = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">syn_filtered</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="n_synapses_offset_distance_of_endpoint_upstream_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_offset_distance_of_endpoint_upstream_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_offset_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_offset_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_offset_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_offset_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="n_synapses_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                    <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;upstream&quot;</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="n">synapse_type</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_pre_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_pre&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="n_synapses_pre_offset_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_pre_offset_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_pre_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_pre&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_post_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_post_offset_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_post_offset_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_post_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_post&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_spine_offset_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_spine_offset_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_spine_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_spine&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="n_synapses_spine_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_spine_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_spine_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                      <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses_spine&quot;</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="synapse_density_post_offset_distance_of_endpoint_downstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_post_offset_distance_of_endpoint_downstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_post_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n_post_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_post_offset_distance_of_endpoint_downstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n_post_syns</span><span class="o">/</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">skeletal_length</span></div>

<div class="viewcode-block" id="synapse_density_post_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_post_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_post_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n_post_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_post_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n_post_syns</span><span class="o">/</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">skeletal_length</span></div>

<div class="viewcode-block" id="synapse_density_offset_distance_of_endpoint_upstream"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_density_offset_distance_of_endpoint_upstream">[docs]</a><span class="k">def</span> <span class="nf">synapse_density_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n_post_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_offset_distance_of_endpoint_upstream</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                      <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n_post_syns</span><span class="o">/</span><span class="n">branch_obj</span><span class="o">.</span><span class="n">skeletal_length</span></div>
        
    
<div class="viewcode-block" id="plot_synapses_on_limb"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_on_limb">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_on_limb</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                        <span class="n">limb_idx</span><span class="p">,</span>
                          <span class="n">limb_branch_synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span>
                        <span class="p">):</span>
    <span class="n">limb_name</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">get_limb_string_name</span><span class="p">(</span><span class="n">limb_idx</span><span class="p">)</span>
    <span class="n">nviz</span><span class="o">.</span><span class="n">visualize_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                         <span class="n">limb_branch_dict</span><span class="o">=</span><span class="p">{</span><span class="n">limb_name</span><span class="p">:</span><span class="s2">&quot;all&quot;</span><span class="p">},</span>
                         <span class="n">limb_branch_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="n">limb_branch_synapse_type</span><span class="o">=</span><span class="n">limb_branch_synapse_type</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="limb_branch_with_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.limb_branch_with_synapses">[docs]</a><span class="k">def</span> <span class="nf">limb_branch_with_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">min_n_synapses</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">synapse_type</span> <span class="o">=</span> <span class="s2">&quot;synapses&quot;</span><span class="p">):</span>
    <span class="n">syn_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_</span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">ns</span><span class="o">.</span><span class="n">query_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
               <span class="n">functions_list</span><span class="o">=</span><span class="p">[</span><span class="n">syn_name</span><span class="p">],</span>
               <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">syn_name</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">min_n_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,)</span></div>

<div class="viewcode-block" id="set_branch_synapses_attribute"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_branch_synapses_attribute">[docs]</a><span class="k">def</span> <span class="nf">set_branch_synapses_attribute</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                         <span class="n">synapse_attribute</span><span class="p">,</span>
                                         <span class="n">branch_func</span><span class="p">,</span>
                                          <span class="n">catch_errors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will set the synapse attributes on a branch object</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    def new_func(branch_obj):</span>
<span class="sd">        raise Exception(&quot;&quot;)</span>
<span class="sd">    syu.set_branch_synapses_attribute(neuron_obj[0][0],</span>
<span class="sd">                                 synapse_attribute=&quot;compartment&quot;,</span>
<span class="sd">                                 #branch_func = apu.compartment_label_from_branch_obj,</span>
<span class="sd">                                      branch_func = new_func,</span>
<span class="sd">                                      catch_errors=True,</span>
<span class="sd">                                      default_value=&quot;exception_label&quot;,</span>
<span class="sd">                                 verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">branch_val</span> <span class="o">=</span> <span class="n">branch_func</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">catch_errors</span><span class="p">:</span> 
            <span class="n">branch_val</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;branch_val = </span><span class="si">{</span><span class="n">branch_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">synapse_attribute</span><span class="p">,</span><span class="n">branch_val</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="set_branch_synapses_compartment"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_branch_synapses_compartment">[docs]</a><span class="k">def</span> <span class="nf">set_branch_synapses_compartment</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                          <span class="n">catch_errors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="p">):</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">set_branch_synapses_attribute</span><span class="p">(</span><span class="n">branch_obj</span><span class="p">,</span>
                                         <span class="n">synapse_attribute</span><span class="o">=</span><span class="s2">&quot;compartment&quot;</span><span class="p">,</span>
                                         <span class="n">branch_func</span><span class="o">=</span><span class="n">apu</span><span class="o">.</span><span class="n">compartment_label_from_branch_obj</span><span class="p">,</span>
                                          <span class="n">catch_errors</span> <span class="o">=</span> <span class="n">catch_errors</span><span class="p">,</span>
                                         <span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
                                          <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                         <span class="p">)</span></div>
    
<div class="viewcode-block" id="set_neuron_synapses_compartment"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_neuron_synapses_compartment">[docs]</a><span class="k">def</span> <span class="nf">set_neuron_synapses_compartment</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                   <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will set the compartment labels of all synapses</span>
<span class="sd">    based on the compartment label of te branch</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nru</span><span class="o">.</span><span class="n">set_branch_attribute_over_neuron</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                 <span class="n">branch_func</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">set_branch_synapses_compartment</span><span class="p">,</span>
                                  <span class="n">catch_errors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                 <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,)</span>
    <span class="k">for</span> <span class="n">s_name</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_node_names</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">s_syn</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">s_name</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
            <span class="n">s_syn</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="s2">&quot;soma&quot;</span></div>
<span class="w">    </span>
<span class="w">    </span>
<span class="sd">&#39;&#39;&#39;        </span>
<span class="sd">def set_neuron_synapses_attribute(neuron_obj,</span>
<span class="sd">                                 synapse_attribute,</span>
<span class="sd">                                 branch_func,</span>
<span class="sd">                                  catch_errors = False,</span>
<span class="sd">                                 default_value=None,</span>
<span class="sd">                                  verbose = False,):</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    Purpose: To set the  attribute of synapses in an entire neuron</span>
<span class="sd">    based on a value computed from the branch</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    nru.set_branch_attribute_over_neuron(neuron_obj,</span>
<span class="sd">                                        branch_func=branch_func,</span>
<span class="sd">                                        verbose = verbose,</span>
<span class="sd">                                        synapse_attribute=synapse_attribute,</span>
<span class="sd">                                        catch_errors=catch_errors,</span>
<span class="sd">                                        default_value=default_value)</span>
<span class="sd">&#39;&#39;&#39;</span>
<div class="viewcode-block" id="soma_face_offset_value"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.soma_face_offset_value">[docs]</a><span class="k">def</span> <span class="nf">soma_face_offset_value</span><span class="p">(</span><span class="n">soma_name</span><span class="p">):</span>
    <span class="n">soma_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">soma_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">soma_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">soma_face_offset</span> <span class="o">+</span> <span class="n">soma_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_limb_branch_idx_to_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.set_limb_branch_idx_to_synapses">[docs]</a><span class="k">def</span> <span class="nf">set_limb_branch_idx_to_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: Will add limb and branch indexes for</span>
<span class="sd">    all synapses in a Neuron object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">limb_idx</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_limb_names</span><span class="p">(</span><span class="n">return_int</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">limb_obj</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">limb_idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">branch_idx</span> <span class="ow">in</span> <span class="n">limb_obj</span><span class="o">.</span><span class="n">get_branch_names</span><span class="p">():</span>
            <span class="n">branch_obj</span> <span class="o">=</span> <span class="n">limb_obj</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">limb_idx</span> <span class="o">=</span> <span class="n">limb_idx</span>
                <span class="n">s</span><span class="o">.</span><span class="n">branch_idx</span> <span class="o">=</span> <span class="n">branch_idx</span>
                
    <span class="k">for</span> <span class="n">soma_name</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_node_names</span><span class="p">():</span>
        <span class="n">soma_value</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">soma_face_offset_value</span><span class="p">(</span><span class="n">soma_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="n">soma_name</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">limb_idx</span> <span class="o">=</span> <span class="n">soma_value</span>
            <span class="n">s</span><span class="o">.</span><span class="n">branch_idx</span> <span class="o">=</span> <span class="n">soma_value</span></div>
            
            
<div class="viewcode-block" id="get_synapses_compartment"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.get_synapses_compartment">[docs]</a><span class="k">def</span> <span class="nf">get_synapses_compartment</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                            <span class="n">compartments</span><span class="p">,</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: will get synapses of a certain </span>
<span class="sd">    compartment if synapses are labeled</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    synapses = syu.get_synapses_compartment(o_neuron,</span>
<span class="sd">                                           compartments=[&quot;apical&quot;,&quot;oblique&quot;],</span>
<span class="sd">                                           verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compartments</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compartment in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query = </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">synapse_objs</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span>
                  <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synapses in </span><span class="si">{</span><span class="n">compartments</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_objs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">synapse_objs</span></div>
    
<div class="viewcode-block" id="plot_synapses_compartment"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_compartment">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_compartment</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">compartments</span><span class="p">,</span>
                              <span class="n">synapse_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">verbose</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To plot all synapses of a certain compartment</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    synapses = syu.get_synapses_compartment(o_neuron,</span>
<span class="sd">                                           compartments=[&quot;apical&quot;,&quot;oblique&quot;],</span>
<span class="sd">                                           verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">get_synapses_compartment</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                           <span class="n">compartments</span><span class="p">,</span>
                                           <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">synapses</span><span class="p">,</span>
                      <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_synapses_query"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_query">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_query</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">query</span><span class="p">,</span>
                       <span class="n">synapse_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To plot the synapses from a query</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    syu.plot_synapses_query(neuron_obj,</span>
<span class="sd">                       query = &quot;syn_type==&#39;presyn&#39;&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synapse_objs</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span>
                  <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of synapses in query = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_objs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">synapse_objs</span><span class="p">,</span>
                      <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_synapses_presyn_dendrite_errors"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_presyn_dendrite_errors">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_presyn_dendrite_errors</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_query</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite_query</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_synapses_soma"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_soma">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_soma</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                       <span class="n">synapse_size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                       <span class="n">verbose</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ex: syu.plot_synapses_soma(o_neuron)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_compartment</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">compartments</span><span class="o">=</span><span class="s2">&quot;soma&quot;</span><span class="p">,</span>
                              <span class="n">synapse_size</span> <span class="o">=</span> <span class="n">synapse_size</span><span class="p">,</span>
                              <span class="n">verbose</span> <span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                             <span class="p">)</span></div>
    
<div class="viewcode-block" id="plot_synapses_valid_from_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_valid_from_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_valid_from_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                       <span class="n">synapse_size</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
                                      <span class="p">):</span>
    <span class="n">valid_syn</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_valid</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of valid synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_syn</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">valid_syn</span><span class="p">,</span>
                      <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span></div>
<div class="viewcode-block" id="plot_synapses_error_from_neuron_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.plot_synapses_error_from_neuron_obj">[docs]</a><span class="k">def</span> <span class="nf">plot_synapses_error_from_neuron_obj</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                       <span class="n">synapse_size</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                                        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
                                      <span class="p">):</span>
    <span class="n">valid_syn</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_error</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of error synapses = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_syn</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                  <span class="n">valid_syn</span><span class="p">,</span>
                      <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="synapse_compartment_spine_type_title"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_compartment_spine_type_title">[docs]</a><span class="k">def</span> <span class="nf">synapse_compartment_spine_type_title</span><span class="p">(</span>
    <span class="n">compartment_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">spine_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">syn_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">compartment_label</span>
    <span class="n">sp_l</span><span class="o">=</span> <span class="n">spine_label</span>
    <span class="n">syn_l</span> <span class="o">=</span> <span class="n">syn_type</span>
    
    
    <span class="n">title_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">sp_l</span><span class="p">,</span><span class="n">syn_l</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_syns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">add_n_syn_to_title</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_syn_</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        
    <span class="k">return</span> <span class="n">title</span></div>

<div class="viewcode-block" id="synapses_by_compartment_spine_type"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_by_compartment_spine_type">[docs]</a><span class="k">def</span> <span class="nf">synapses_by_compartment_spine_type</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">compartment_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spine_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">syn_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">synapse_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_title</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To be able to </span>
<span class="sd">    get the synapses of any specification</span>
<span class="sd">    of compartment and head_neck_shaft</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Get the spine int label</span>
<span class="sd">    2) Get the compartment string label</span>
<span class="sd">    3) Decide whether should be presyn or postsyn</span>
<span class="sd">    4) Assemble query</span>
<span class="sd">    5) Query the synapses</span>
<span class="sd">    6) Return the synapses</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compartment_label_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">compartment_label</span><span class="p">)</span>
    <span class="n">spine_label_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spine_label</span><span class="p">)</span>
    <span class="n">syn_type_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">syn_type</span><span class="p">)</span>
    
    <span class="n">compartment_query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">compartment_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">compartment_label</span><span class="p">):</span>
            <span class="n">compartment_label</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">compartment_label_to_all_labels</span><span class="p">(</span><span class="n">compartment_label</span><span class="p">)</span>

        <span class="n">compartment_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(compartment in </span><span class="si">{</span><span class="n">compartment_label</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="n">spine_query</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">spine_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nu</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">spine_label</span><span class="p">):</span>
            <span class="n">spine_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">spine_label</span><span class="p">]</span>

        <span class="n">spine_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">spu</span><span class="o">.</span><span class="n">spine_int_label</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spine_label</span><span class="p">]</span>

        <span class="n">spine_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(head_neck_shaft in </span><span class="si">{</span><span class="n">spine_label</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="n">syn_type_query</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">syn_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compartment_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">apu</span><span class="o">.</span><span class="n">dendrite_labels</span><span class="p">,</span><span class="n">compartment_label</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">syn_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]</span>
<span class="c1">#         elif len(np.intersect1d(apu.dendrite_labels,[&quot;axon&quot;])) &gt; 0:</span>
<span class="c1">#             syn_type = [&quot;presyn&quot;]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">syn_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">syn_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">syn_type</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">syn_type</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">syn_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">syn_type</span><span class="p">:</span>
        <span class="n">syn_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">syn_type</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">convert_to_array_like</span><span class="p">(</span><span class="n">syn_type</span><span class="p">)</span>

    <span class="n">syn_type_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(syn_type in </span><span class="si">{</span><span class="n">syn_type</span><span class="si">}</span><span class="s2">)&quot;</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;compartment_query = </span><span class="si">{</span><span class="n">compartment_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spine_query = </span><span class="si">{</span><span class="n">spine_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syn_type_query = </span><span class="si">{</span><span class="n">syn_type_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">non_none_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">compartment_query</span><span class="p">,</span><span class="n">spine_query</span><span class="p">,</span><span class="n">syn_type_query</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No non None queries&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">final_query</span> <span class="o">=</span> <span class="n">non_none_queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_query</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">non_none_queries</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s2">&quot;final_query = </span><span class="si">{</span><span class="n">final_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">returned_syns</span> <span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span><span class="o">=</span><span class="n">final_query</span><span class="p">,</span>
                       <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of synapses in query = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returned_syns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_synapses</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returned_syns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">syu</span><span class="o">.</span><span class="n">plot_synapses_objs</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                             <span class="n">returned_syns</span><span class="p">,</span>
                                  <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No synapses to plot&quot;</span><span class="p">)</span>

            
    <span class="k">if</span> <span class="n">return_title</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_compartment_spine_type_title</span><span class="p">(</span>
            <span class="n">compartment_label</span> <span class="o">=</span> <span class="n">compartment_label_original</span> <span class="p">,</span>
            <span class="n">spine_label</span> <span class="o">=</span> <span class="n">spine_label_original</span> <span class="p">,</span>
            <span class="n">syn_type</span> <span class="o">=</span> <span class="n">syn_type_original</span> <span class="p">,</span>
            <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="n">add_n_syn_to_title</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">returned_syns</span><span class="p">,</span><span class="n">title</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">returned_syns</span></div>

<div class="viewcode-block" id="n_synapses_by_compartment_spine_type"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_by_compartment_spine_type">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_by_compartment_spine_type</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">compartment_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">spine_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">syn_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    
    <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">synapse_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    
    <span class="n">return_title</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the number of synapses</span>
<span class="sd">    of a certain type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_by_compartment_spine_type</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">compartment_label</span> <span class="o">=</span> <span class="n">compartment_label</span><span class="p">,</span>
    <span class="n">spine_label</span> <span class="o">=</span> <span class="n">spine_label</span><span class="p">,</span>
    <span class="n">syn_type</span> <span class="o">=</span> <span class="n">syn_type</span><span class="p">,</span>
    
    <span class="n">plot_synapses</span><span class="o">=</span><span class="n">plot_synapses</span><span class="p">,</span>
    <span class="n">synapse_size</span><span class="o">=</span><span class="n">synapse_size</span><span class="p">,</span>
        
    <span class="n">return_title</span> <span class="o">=</span> <span class="n">return_title</span><span class="p">,</span>
    <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="n">add_n_syn_to_title</span><span class="p">,</span>
    
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_title</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">return_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span></div>

    
        
<div class="viewcode-block" id="n_synapses_all_compartment_spine_type"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_all_compartment_spine_type">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_all_compartment_spine_type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">compartment_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">spine_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">syn_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_synapse_objs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">add_n_syn_in_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get all combinations</span>
<span class="sd">    of compartments, spine labels and synapse types</span>
<span class="sd">    that should be computed</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">synapse_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">compartment_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">compartment_labels</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">compartment_labels_for_synapses_stats</span><span class="p">()</span>

    <span class="c1"># if spine_labels is None:</span>
    <span class="c1">#     spine_labels = spu.spine_labels()</span>

    <span class="c1"># if syn_types is None:</span>
    <span class="c1">#     syn_types = [&quot;presyn&quot;,&quot;postsyn&quot;]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;compartment_labels = </span><span class="si">{</span><span class="n">compartment_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">#     print(f&quot;spine_labels = {spine_labels}&quot;)</span>
    <span class="c1">#     print(f&quot;syn_types = {syn_types}&quot;)</span>

    <span class="n">all_combs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_synapse_objs</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_by_compartment_spine_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_by_compartment_spine_type</span>
    
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartment_labels</span><span class="p">:</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Working on comparment </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">spine_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_spine_labels</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">spine_labels_from_compartment</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_spine_labels</span> <span class="o">=</span> <span class="n">spine_labels</span>
            
        <span class="k">if</span> <span class="n">syn_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">c_syn_type</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">syn_type_from_compartment</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_syn_type</span> <span class="o">=</span> <span class="n">syn_types</span>

        <span class="k">for</span> <span class="n">sp_l</span> <span class="ow">in</span> <span class="n">c_spine_labels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">syn_l</span> <span class="ow">in</span> <span class="n">c_syn_type</span><span class="p">:</span>
                <span class="c1">#print(f&quot;{c}_{sp_l}_{syn_l}&quot;)</span>
                <span class="n">n_syns</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span>
                    <span class="n">neuron_obj</span><span class="p">,</span>
                    <span class="n">compartment_label</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
                    <span class="n">spine_label</span> <span class="o">=</span> <span class="n">sp_l</span><span class="p">,</span>
                    <span class="n">syn_type</span> <span class="o">=</span> <span class="n">syn_l</span><span class="p">,</span>
                    <span class="n">plot_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">return_title</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">add_n_syn_to_title</span> <span class="o">=</span> <span class="n">add_n_syn_in_keys</span>
                    <span class="p">)</span>
                

                <span class="n">synapse_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_syns</span>

<span class="c1">#     if add_n_syn_in_keys:</span>
<span class="c1">#         synapse_dict = {f&quot;n_syn_{k}&quot;:v for k,v in synapse_dict.items()}</span>

    <span class="k">return</span> <span class="n">synapse_dict</span></div>

<div class="viewcode-block" id="n_synapses_all_compartments"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_all_compartments">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_all_compartments</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">compartment_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_synapse_objs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get all combinations</span>
<span class="sd">    of compartments, spine labels and synapse types</span>
<span class="sd">    that should be computed</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">n_synapses_all_compartment_spine_type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">compartment_labels</span> <span class="o">=</span> <span class="n">compartment_labels</span><span class="p">,</span>
                                     <span class="n">spine_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                                     <span class="n">syn_types</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                      <span class="n">return_synapse_objs</span> <span class="o">=</span> <span class="n">return_synapse_objs</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="n_synapses_all_spine_labels"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_all_spine_labels">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_all_spine_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">compartment_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">return_synapse_objs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To get all combinations</span>
<span class="sd">    of compartments, spine labels and synapse types</span>
<span class="sd">    that should be computed</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">n_synapses_all_compartment_spine_type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                     <span class="n">compartment_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                                     <span class="n">spine_labels</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_labels</span><span class="p">(</span><span class="n">include_no_label</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                     <span class="n">syn_types</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                      <span class="n">return_synapse_objs</span> <span class="o">=</span> <span class="n">return_synapse_objs</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="synapses_mesh_errored"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_mesh_errored">[docs]</a><span class="k">def</span> <span class="nf">synapses_mesh_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span><span class="o">=</span><span class="s2">&quot;label == &#39;mesh_errored&#39;&quot;</span><span class="p">,</span>
                      <span class="n">return_synapse_objs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="synapses_distance_errored"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_distance_errored">[docs]</a><span class="k">def</span> <span class="nf">synapses_distance_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                      <span class="n">query</span><span class="o">=</span><span class="s2">&quot;label == &#39;distance_errored&#39;&quot;</span><span class="p">,</span>
                      <span class="n">return_synapse_objs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="n_synapses_mesh_errored"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_mesh_errored">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_mesh_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_mesh_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_distance_errored"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_distance_errored">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_distance_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_distance_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="n_synapses_all_valid_error"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_all_valid_error">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_all_valid_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">n_syn_valid</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_valid_pre</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_valid_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_valid_post</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_valid_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_error</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_error_pre</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_error_pre</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_error_post</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_error_post</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_presyns_on_dendrite</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_presyns_on_dendrite</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_mesh_errored</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_mesh_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        <span class="n">n_syn_distance_errored</span><span class="o">=</span><span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_distance_errored</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">),</span>
        
    <span class="p">)</span></div>

<div class="viewcode-block" id="complete_n_synapses_analysis"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.complete_n_synapses_analysis">[docs]</a><span class="k">def</span> <span class="nf">complete_n_synapses_analysis</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                <span class="n">include_axon_ais_syn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">syn_valid_error_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_all_valid_error</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="n">syn_spine_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_all_spine_labels</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="n">syn_compartment_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_all_compartments</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    <span class="n">syn_comp_spine_type_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_all_compartment_spine_type</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                                                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="n">syn_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">include_axon_ais_syn</span><span class="p">:</span>
        <span class="n">syn_dict</span><span class="p">[</span><span class="s2">&quot;n_syn_axon_ais_postsyn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_axon_ais_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([</span><span class="n">syn_valid_error_dict</span><span class="p">,</span>
                           <span class="n">syn_spine_dict</span><span class="p">,</span>
                           <span class="n">syn_compartment_dict</span><span class="p">,</span>
                           <span class="n">syn_comp_spine_type_dict</span><span class="p">,</span>
                          <span class="n">syn_dict</span><span class="p">])</span></div>

<div class="viewcode-block" id="n_synapses_analysis_axon_dendrite"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_synapses_analysis_axon_dendrite">[docs]</a><span class="k">def</span> <span class="nf">n_synapses_analysis_axon_dendrite</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_axon_ais_syn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_soma_syn</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Puporse: calculating synapses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">syn_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_all_compartment_spine_type</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">compartment_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;axon&quot;</span><span class="p">,</span><span class="s2">&quot;dendrite&quot;</span><span class="p">],</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">include_axon_ais_syn</span><span class="p">:</span>
        <span class="n">syn_dict</span><span class="p">[</span><span class="s2">&quot;n_syn_axon_ais_postsyn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_axon_ais_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">include_soma_syn</span><span class="p">:</span>
        <span class="n">syn_dict</span><span class="p">[</span><span class="s2">&quot;n_syn_soma_postsyn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">n_synapses_somas_postsyn</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">syn_dict</span></div>



<span class="n">synapse_attribute_to_dj_key_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="n">syn_type</span><span class="o">=</span><span class="s2">&quot;synapse_type&quot;</span><span class="p">,</span>
<span class="n">syn_id</span><span class="o">=</span><span class="s2">&quot;synapse_id&quot;</span><span class="p">,</span>
<span class="n">soma_distance</span> <span class="o">=</span> <span class="s2">&quot;skeletal_distance_to_soma&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dj_key_to_synapse_attribute_map</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">invert_mapping</span><span class="p">(</span><span class="n">synapse_attribute_to_dj_key_map</span><span class="p">,</span><span class="n">one_to_one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dj_key_to_synapse_attribute_map</span>

<div class="viewcode-block" id="synapse_obj_from_dj_synapse_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_obj_from_dj_synapse_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_obj_from_dj_synapse_dict</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">,</span>
                       <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To convert a list of dictionaries</span>
<span class="sd">    to synapses objects</span>
<span class="sd">    </span>
<span class="sd">    Pseudocode: </span>
<span class="sd">    1) convert the compartment_fine to just one label</span>
<span class="sd">    2) convert the spine_bouton to the number</span>
<span class="sd">    3) Send the new dictionary to a spine object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;compartment_fine&quot;</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="s2">&quot;compartment_fine&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="s2">&quot;compartment_fine&quot;</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compartment</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="s2">&quot;compartment_coarse&quot;</span><span class="p">]</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compartment</span> <span class="o">=</span>  <span class="s2">&quot;error&quot;</span>
        
    <span class="k">if</span> <span class="s2">&quot;spine_bouton&quot;</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>   
        <span class="n">head_neck_shaft</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_int_label</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">[</span><span class="s2">&quot;spine_bouton&quot;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_neck_shaft</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">if</span> <span class="s2">&quot;skeletal_distance_to_soma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">synapse_dict</span><span class="p">[</span><span class="s2">&quot;skeletal_distance_to_soma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="n">new_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;compartment_coarse&quot;</span><span class="p">,</span>
                                                               <span class="s2">&quot;compartment_fine&quot;</span><span class="p">,</span>
                                                               <span class="s2">&quot;spine_bouton&quot;</span><span class="p">]}</span>
    
    <span class="n">new_key</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">compartment</span><span class="o">=</span><span class="n">compartment</span><span class="p">,</span><span class="n">head_neck_shaft</span> <span class="o">=</span> <span class="n">head_neck_shaft</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dj_key_to_synapse_attribute_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_key</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_key</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    
    <span class="c1">#return new_key</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="o">**</span><span class="n">new_key</span><span class="p">)</span></div>


<div class="viewcode-block" id="synapses_obj_groups_from_queries"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_obj_groups_from_queries">[docs]</a><span class="k">def</span> <span class="nf">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                    <span class="n">queries</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose; Will divide synapses ob into groups based on </span>
<span class="sd">    a xeries of queries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">return_syns</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span><span class="n">q</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                     <span class="n">return_synapses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">return_syns</span></div>

<div class="viewcode-block" id="valid_error_groups_from_synapses_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.valid_error_groups_from_synapses_obj">[docs]</a><span class="k">def</span> <span class="nf">valid_error_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">):</span>
    <span class="n">syn_groups</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                    <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">valid_query</span><span class="p">(),</span>
                                              <span class="n">syu</span><span class="o">.</span><span class="n">error_query</span><span class="p">()])</span> 
    <span class="k">return</span> <span class="n">syn_groups</span></div>



<div class="viewcode-block" id="compartment_groups_from_synapses_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.compartment_groups_from_synapses_obj">[docs]</a><span class="k">def</span> <span class="nf">compartment_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                        <span class="n">compartments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">compartments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">compartments</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">compartments_to_plot</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;compartment == &#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For compartments: </span><span class="si">{</span><span class="n">compartments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                    <span class="n">queries</span> <span class="o">=</span> <span class="n">queries</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="spine_bouton_groups_from_synapses_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.spine_bouton_groups_from_synapses_obj">[docs]</a><span class="k">def</span> <span class="nf">spine_bouton_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                         <span class="n">spine_bouton_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">spine_bouton_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spine_bouton_labels</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_labels</span><span class="p">(</span><span class="n">include_no_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head_neck_shaft == &#39;</span><span class="si">{</span><span class="n">spu</span><span class="o">.</span><span class="n">spine_int_label</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spine_bouton_labels</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For spine_bouton_labels: </span><span class="si">{</span><span class="n">spine_bouton_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                    <span class="n">queries</span> <span class="o">=</span> <span class="n">queries</span><span class="p">,</span>
                                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="presyn_postsyn_groups_from_synapses_obj"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.presyn_postsyn_groups_from_synapses_obj">[docs]</a><span class="k">def</span> <span class="nf">presyn_postsyn_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">,</span>
                                           <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_pre</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">),</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_post</span><span class="p">(</span><span class="n">synapses_obj</span><span class="p">)]</span></div>

<div class="viewcode-block" id="synapse_plot_items_by_type_or_query"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_plot_items_by_type_or_query">[docs]</a><span class="k">def</span> <span class="nf">synapse_plot_items_by_type_or_query</span><span class="p">(</span>
    <span class="n">synapses_objs</span><span class="p">,</span>
    <span class="n">synapses_size</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
    <span class="n">synapse_plot_type</span> <span class="o">=</span> <span class="s2">&quot;spine_bouton&quot;</span><span class="p">,</span><span class="c1">#&quot;compartment&quot;#  &quot;valid_error&quot;, &quot;soma&quot;</span>
    <span class="n">synapse_compartments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">synapse_spine_bouton_labels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_error_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">valid_synapses_color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">error_synapses_color</span> <span class="o">=</span> <span class="s2">&quot;aliceblue&quot;</span><span class="p">,</span>
    <span class="n">synapse_queries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">synapse_queries_colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">print_spine_colors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">synapse_compartments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_compartments</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">compartments_to_plot</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: will  </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">synapse_spine_bouton_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse_spine_bouton_labels</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">spine_bouton_labels_to_plot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">print_color_dict</span><span class="p">(</span><span class="n">color_dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synapse Colors:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">already_plotted_errors</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">synapse_queries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">synapse_plot_type</span> <span class="o">==</span> <span class="s2">&quot;valid_error&quot;</span><span class="p">:</span>
            <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">valid_error_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">)</span>
            <span class="n">synapse_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">valid_synapses_color</span><span class="p">,</span><span class="n">error_synapses_color</span><span class="p">]</span>
            
            
            <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="n">valid_synapses_color</span><span class="p">,</span><span class="n">error</span><span class="o">=</span><span class="n">error_synapses_color</span><span class="p">)</span>
            
            <span class="n">already_plotted_errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">synapse_plot_type</span> <span class="o">==</span> <span class="s2">&quot;compartment&quot;</span><span class="p">:</span>
            <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">compartment_groups_from_synapses_obj</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">,</span>
                                                     <span class="n">compartments</span> <span class="o">=</span> <span class="n">synapse_compartments</span><span class="p">,</span>
                                                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">synapse_colors</span> <span class="o">=</span> <span class="n">apu</span><span class="o">.</span><span class="n">colors_from_compartments</span><span class="p">(</span><span class="n">synapse_compartments</span><span class="p">)</span>
            <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">synapse_compartments</span><span class="p">,</span><span class="n">synapse_colors</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">synapse_plot_type</span> <span class="o">==</span> <span class="s2">&quot;spine_bouton&quot;</span><span class="p">:</span>
            <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">spine_bouton_groups_from_synapses_obj</span><span class="p">(</span>
                <span class="n">synapses_objs</span><span class="p">,</span>
                <span class="n">spine_bouton_labels</span> <span class="o">=</span> <span class="n">synapse_spine_bouton_labels</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">synapse_colors</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">colors_from_spine_bouton_labels</span><span class="p">(</span><span class="n">synapse_spine_bouton_labels</span><span class="p">)</span>
            <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">synapse_spine_bouton_labels</span><span class="p">,</span><span class="n">synapse_colors</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">synapse_plot_type</span> <span class="o">==</span> <span class="s2">&quot;valid_presyn_postsyn&quot;</span><span class="p">:</span>
            <span class="n">valid_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">,[</span><span class="n">syu</span><span class="o">.</span><span class="n">valid_query</span><span class="p">()])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">presyn_postsyn_groups_from_synapses_obj</span><span class="p">(</span><span class="n">valid_syns</span><span class="p">)</span>
            <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">presyn</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="n">postsyn</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
            <span class="n">synapse_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">synapse_plot_type</span> <span class="o">==</span> <span class="s2">&quot;soma&quot;</span><span class="p">:</span>
            <span class="n">valid_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">,[</span><span class="s2">&quot;compartment == &#39;soma&#39;&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">presyn_postsyn_groups_from_synapses_obj</span><span class="p">(</span><span class="n">valid_syns</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of syn_soma_pre = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;, # of syn_soma_post = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">presyn</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="n">postsyn</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
            <span class="n">synapse_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented synapse_plot_type = </span><span class="si">{</span><span class="n">synapse_plot_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">synapse_groups</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_obj_groups_from_queries</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">,</span>
                                                             <span class="n">queries</span><span class="o">=</span><span class="n">synapse_queries</span><span class="p">,</span>
                                                             <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">synapse_colors</span> <span class="o">=</span> <span class="n">synapse_queries_colors</span>
        <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;query_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">synapse_colors</span><span class="p">)}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_plotted_errors</span> <span class="ow">and</span> <span class="n">plot_error_synapses</span><span class="p">:</span>
        <span class="n">error_syn</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">(</span><span class="n">synapses_objs</span><span class="p">)</span>
        <span class="n">synapse_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_syn</span><span class="p">)</span>
        <span class="n">synapse_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_synapses_color</span><span class="p">)</span>
        <span class="n">color_dict</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_synapses_color</span>
        
    <span class="k">if</span> <span class="n">print_spine_colors</span><span class="p">:</span>
        <span class="n">print_color_dict</span><span class="p">(</span><span class="n">color_dict</span><span class="p">)</span>
        
    <span class="n">scatters</span> <span class="o">=</span> <span class="p">[</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_to_coordinates</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">synapse_groups</span><span class="p">]</span>
    <span class="n">scatters_colors</span> <span class="o">=</span> <span class="n">synapse_colors</span>
    <span class="n">scatters_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">synapses_size</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_groups</span><span class="p">)</span>
    
    
    <span class="k">return</span> <span class="n">scatters</span><span class="p">,</span><span class="n">scatters_colors</span><span class="p">,</span><span class="n">scatters_sizes</span></div>


<span class="c1"># --------------- 10/25 --------------------#</span>
<div class="viewcode-block" id="calculate_neuron_soma_distance_euclidean"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.calculate_neuron_soma_distance_euclidean">[docs]</a><span class="k">def</span> <span class="nf">calculate_neuron_soma_distance_euclidean</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                                  <span class="n">verbose</span>  <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">store_soma_placeholder</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="n">store_error_placeholder</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To calculate all of the soma distances for all the valid synapses</span>
<span class="sd">    on limbs</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    calculate_neuron_soma_distance(neuron_obj,</span>
<span class="sd">                              verbose = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">soma_center</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mesh_center</span>
    
    <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses</span><span class="p">:</span>
        <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance_euclidean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">soma_center</span> <span class="o">-</span> <span class="n">syn</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">store_soma_placeholder</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Putting Soma Placeholders&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">get_soma_indexes</span><span class="p">():</span>
            <span class="n">st_loc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">soma_synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;S</span><span class="si">{</span><span class="n">s_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">synapses</span>
            <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">soma_synapses</span><span class="p">:</span>
                <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance_euclidean</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">nru</span><span class="o">.</span><span class="n">soma_face_offset</span> <span class="o">+</span> <span class="n">s_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Soma </span><span class="si">{</span><span class="n">s_idx</span><span class="si">}</span><span class="s2"> soma calculation time = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st_loc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="k">if</span> <span class="n">store_error_placeholder</span><span class="p">:</span>
        <span class="n">st_loc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Putting Error Placeholders&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_error</span><span class="p">:</span>
            <span class="n">syn</span><span class="o">.</span><span class="n">soma_distance_euclidean</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Error soma calculation time = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st_loc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total soma distance calculation time = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        
        
<span class="c1"># -------- attempting to get ais synapses -------</span>
<div class="viewcode-block" id="axon_ais_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.axon_ais_synapses">[docs]</a><span class="k">def</span> <span class="nf">axon_ais_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">max_ais_distance_from_soma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_synapses</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to get the postsyns synapses of those</span>
<span class="sd">    on the axon within a certain distance of </span>
<span class="sd">    the soma (so ideally the ais)</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max_ais_distance_from_soma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_ais_distance_from_soma</span> <span class="o">=</span> <span class="n">au</span><span class="o">.</span><span class="n">max_ais_distance_from_soma</span>
    
    <span class="n">syu</span><span class="o">.</span><span class="n">calculate_neuron_soma_distance</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">)</span>
    
    <span class="n">curr_syns</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="s2">&quot;(compartment == &#39;axon&#39;) and (syn_type==&#39;postsyn&#39;)&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; and (soma_distance &lt; </span><span class="si">{</span><span class="n">max_ais_distance_from_soma</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">return_synapses</span><span class="o">=</span><span class="n">return_synapses</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of AIS postsyns = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_syns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">curr_syns</span></div>

<div class="viewcode-block" id="n_axon_ais_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.n_axon_ais_synapses">[docs]</a><span class="k">def</span> <span class="nf">n_axon_ais_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">axon_ais_synapses</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">))</span></div>



<div class="viewcode-block" id="adjust_obj_with_face_offset"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.adjust_obj_with_face_offset">[docs]</a><span class="k">def</span> <span class="nf">adjust_obj_with_face_offset</span><span class="p">(</span>
    <span class="n">synapse_obj</span><span class="p">,</span>
    <span class="n">face_offset</span><span class="p">,</span>
    <span class="n">attributes_not_to_adjust</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;closest_face_idx&quot;</span><span class="p">,),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: To adjust the spine properties that</span>
<span class="sd">    would be affected by a different face idx</span>
<span class="sd">    </span>
<span class="sd">    Ex: </span>
<span class="sd">    b_test = neuron_obj[0][18]</span>
<span class="sd">    sp_obj = b_test.spines_obj[0]</span>
<span class="sd">    sp_obj.export()</span>

<span class="sd">    spu.adjust_spine_obj_with_face_offset(</span>
<span class="sd">        sp_obj,</span>
<span class="sd">        face_offset = face_offset,</span>
<span class="sd">        verbose = True</span>
<span class="sd">    ).export()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">synapse_obj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">synapse_obj</span><span class="o">.</span><span class="n">export</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;face_idx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attributes_not_to_adjust</span><span class="p">:</span>
            <span class="c1">#print(f&quot;skipping {v} to not adjust&quot;)</span>
            <span class="k">continue</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusting </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> because face_idx and not None&quot;</span><span class="p">)</span>
            
        <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="o">+</span> <span class="n">face_offset</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">new_obj</span></div>


<div class="viewcode-block" id="endpoint_dist_extrema_over_syn"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.endpoint_dist_extrema_over_syn">[docs]</a><span class="k">def</span> <span class="nf">endpoint_dist_extrema_over_syn</span><span class="p">(</span>
    <span class="n">branch_obj</span><span class="p">,</span>
    <span class="n">endpoint_type</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
    <span class="n">extrema_type</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="n">default_dist</span> <span class="o">=</span> <span class="mi">100000000</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="n">syns</span> <span class="o">=</span> <span class="n">branch_obj</span><span class="o">.</span><span class="n">synapses</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">syns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">endpoint_type</span><span class="si">}</span><span class="s2">_dist&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syns</span><span class="p">])</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">extrema_type</span><span class="p">)(</span><span class="n">dists</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">default_dist</span>
        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extrema_type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint_type</span><span class="si">}</span><span class="s2"> dist = </span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">return_value</span></div>

<div class="viewcode-block" id="downstream_dist_min_over_syn"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.downstream_dist_min_over_syn">[docs]</a><span class="k">def</span> <span class="nf">downstream_dist_min_over_syn</span><span class="p">(</span>
    <span class="n">branch_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">endpoint_dist_extrema_over_syn</span><span class="p">(</span>
    <span class="n">branch_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="n">endpoint_type</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
    <span class="n">extrema_type</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="downstream_dist_max_over_syn"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.downstream_dist_max_over_syn">[docs]</a><span class="k">def</span> <span class="nf">downstream_dist_max_over_syn</span><span class="p">(</span>
    <span class="n">branch_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">endpoint_dist_extrema_over_syn</span><span class="p">(</span>
    <span class="n">branch_obj</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="n">endpoint_type</span><span class="o">=</span><span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
    <span class="n">extrema_type</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="synapse_coordinates_from_synapse_df"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_coordinates_from_synapse_df">[docs]</a><span class="k">def</span> <span class="nf">synapse_coordinates_from_synapse_df</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="axon_on_dendrite_synapses"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.axon_on_dendrite_synapses">[docs]</a><span class="k">def</span> <span class="nf">axon_on_dendrite_synapses</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">plot_limb_branch</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="n">ax_on_d_lb</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">axon_on_dendrite_plus_downstream</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">plot_limb_branch</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">axon_on_dendrite_synapses</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_over_limb_branch_dict</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">ax_on_d_lb</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of axon on dendrite merge synapses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axon_on_dendrite_synapses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">axon_on_dendrite_synapses</span></div>

<div class="viewcode-block" id="presyn_on_dendrite_synapses_after_axon_on_dendrite_filter_away"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.presyn_on_dendrite_synapses_after_axon_on_dendrite_filter_away">[docs]</a><span class="k">def</span> <span class="nf">presyn_on_dendrite_synapses_after_axon_on_dendrite_filter_away</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="n">axon_on_dendrite_limb_branch_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
    
    <span class="k">if</span> <span class="n">axon_on_dendrite_limb_branch_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axon_on_dendrite_limb_branch_dict</span> <span class="o">=</span> <span class="n">ax_on_d_lb</span> <span class="o">=</span> <span class="n">pru</span><span class="o">.</span><span class="n">axon_on_dendrite_plus_downstream</span><span class="p">(</span>
            <span class="n">neuron_obj</span><span class="p">,</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="n">lb</span> <span class="o">=</span> <span class="n">nru</span><span class="o">.</span><span class="n">limb_branch_invert</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">axon_on_dendrite_limb_branch_dict</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">syu</span><span class="o">.</span><span class="n">query_synapses</span><span class="p">(</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">presyns_on_dendrite_query</span><span class="p">,</span>
        <span class="n">limb_branch_dict</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>
    
<div class="viewcode-block" id="synapses_to_dj_keys"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapses_to_dj_keys">[docs]</a><span class="k">def</span> <span class="nf">synapses_to_dj_keys</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">neuron_obj</span><span class="p">,</span>
        <span class="n">valid_synapses</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">nucleus_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_spine_str</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_secondary_segment</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">synapses</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pseudocode: </span>
<span class="sd">        1) Get either the valid of invalid synapses</span>
<span class="sd">        2) For each synapses export the following as dict</span>

<span class="sd">        synapse_id=syn,</span>
<span class="sd">        synapse_type=synapse_type,</span>
<span class="sd">        nucleus_id = nucleus_id,</span>
<span class="sd">        segment_id = segment_id,</span>
<span class="sd">        split_index = split_index,</span>
<span class="sd">        skeletal_distance_to_soma=np.round(syn_dist[syn_i],2),</span>

<span class="sd">        return the list</span>
<span class="sd">        </span>
<span class="sd">        Ex: </span>
<span class="sd">        import numpy as np</span>
<span class="sd">        dj_keys = syu.synapses_to_dj_keys(neuron_obj,</span>
<span class="sd">                            verbose = True,</span>
<span class="sd">                            nucleus_id=12345,</span>
<span class="sd">                            split_index=0)</span>
<span class="sd">        np.unique([k[&quot;compartment&quot;] for k in dj_keys],return_counts=True)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Ex:  How to get error keys with version:</span>
<span class="sd">        dj_keys = syu.synapses_to_dj_keys(neuron_obj,</span>
<span class="sd">                                    valid_synapses = False,</span>
<span class="sd">                        verbose = True,</span>
<span class="sd">                        nucleus_id=12345,</span>
<span class="sd">                        split_index=0,</span>
<span class="sd">                                    ver=158)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segment_id</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span>
        
        <span class="k">if</span> <span class="n">nucleus_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neuron_obj</span><span class="o">.</span><span class="n">nucleus_id</span> <span class="o">=</span> <span class="n">nucleus_id</span>
        <span class="k">if</span> <span class="n">split_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neuron_obj</span><span class="o">.</span><span class="n">split_index</span> <span class="o">=</span> <span class="n">split_index</span>
        
        <span class="k">if</span> <span class="n">synapses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">valid_synapses</span><span class="p">:</span>
                <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_valid</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_error</span>
        <span class="k">elif</span> <span class="n">valid_synapses</span><span class="p">:</span>
            <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_valid</span>
            <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_valid</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">synapses</span> <span class="o">=</span> <span class="n">neuron_obj</span><span class="o">.</span><span class="n">synapses_error</span>
            <span class="n">export_func</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_dj_export_dict_error</span>
            
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nucleus_id&quot;</span><span class="p">,</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span><span class="s2">&quot;split_index&quot;</span><span class="p">]:</span>
    <span class="c1">#         globs = globals()</span>
    <span class="c1">#         locs = locals()</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">eval</span><span class="p">(</span><span class="n">att</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">att</span><span class="si">}</span><span class="s2"> is None&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">syn_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">export_func</span><span class="p">(</span><span class="n">syn</span><span class="p">,</span><span class="n">output_spine_str</span><span class="o">=</span><span class="n">output_spine_str</span><span class="p">),</span>
                                    <span class="n">primary_nucleus_id</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;nucleus_id&quot;</span><span class="p">,</span><span class="n">nucleus_id</span><span class="p">),</span>
                        <span class="n">primary_seg_id</span><span class="o">=</span><span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
                        <span class="n">split_index</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">,</span><span class="s2">&quot;split_index&quot;</span><span class="p">,</span><span class="n">split_index</span><span class="p">))</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">]</span>
        
        <span class="c1">#adding on the secondary seg</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Purpose: To add on the secondary </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">add_secondary_segment</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">syn_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">syn_keys_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">syn_keys</span><span class="p">)</span>
            
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_id_to_synapse_table_optimized</span><span class="p">(</span>
                <span class="n">neuron_obj</span><span class="o">.</span><span class="n">segment_id</span><span class="p">,</span>
                <span class="n">return_df</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">df_secondary</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;synapse_id&quot;</span><span class="p">,</span><span class="s2">&quot;secondary_seg_id&quot;</span><span class="p">]]</span>
            <span class="n">syn_keys</span><span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">df_to_dicts</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">syn_keys_df</span><span class="p">,</span><span class="n">df_secondary</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;synapse_id&quot;</span><span class="p">))</span>
                
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valid_synapses = </span><span class="si">{</span><span class="n">valid_synapses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> synapse entries = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">syn_keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ver</span><span class="o">=</span><span class="n">ver</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syn_keys</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">syn_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">gu</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">key</span><span class="o">.</span><span class="n">copy</span><span class="p">()])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">syn_keys</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">syn_keys</span></div>


<div class="viewcode-block" id="synapse_df_from_synapse_dict"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_df_from_synapse_dict">[docs]</a><span class="k">def</span> <span class="nf">synapse_df_from_synapse_dict</span><span class="p">(</span>
    <span class="n">synapse_dict</span><span class="p">,</span>
    <span class="n">segment_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: convert synapse dict into a dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prepost</span><span class="p">,</span><span class="n">p_data</span> <span class="ow">in</span> <span class="n">synapse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">syn_id</span><span class="p">,</span><span class="n">syn_coord</span><span class="p">,</span><span class="n">syn_size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">p_data</span><span class="p">[</span><span class="s2">&quot;synapse_ids&quot;</span><span class="p">],</span>
            <span class="n">p_data</span><span class="p">[</span><span class="s2">&quot;synapse_coordinates&quot;</span><span class="p">],</span>
            <span class="n">p_data</span><span class="p">[</span><span class="s2">&quot;synapse_sizes&quot;</span><span class="p">],</span>
            <span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">syn_coord</span>
            <span class="n">curr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">prepost</span> <span class="o">=</span> <span class="n">prepost</span><span class="p">,</span>
                <span class="n">synapse_id</span> <span class="o">=</span> <span class="n">syn_id</span><span class="p">,</span>
                <span class="n">synapse_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span>
                <span class="n">synapse_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                <span class="n">synapse_z</span> <span class="o">=</span> <span class="n">z</span><span class="p">,</span>
                <span class="n">synapse_size</span> <span class="o">=</span> <span class="n">syn_size</span>
            <span class="p">)</span>
            
            <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_dict</span><span class="p">)</span>
            
            
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">segment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;segment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_id</span>
        
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="synapse_df_from_csv"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_df_from_csv">[docs]</a><span class="k">def</span> <span class="nf">synapse_df_from_csv</span><span class="p">(</span>
    <span class="n">synapse_filepath</span><span class="p">,</span>
    <span class="n">segment_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">coordinates_nm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to read in a csv file </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">voxel_to_nm_scaling</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">csv_to_df</span><span class="p">(</span>
        <span class="n">synapse_filepath</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">segment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;segment_id == </span><span class="si">{</span><span class="n">segment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">coordinates_nm</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;synapse_x_nm&quot;</span><span class="p">,</span><span class="s1">&#39;synapse_y_nm&#39;</span><span class="p">,</span><span class="s1">&#39;synapse_z_nm&#39;</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;synapse_x&quot;</span><span class="p">,</span><span class="s1">&#39;synapse_y&#39;</span><span class="p">,</span><span class="s1">&#39;synapse_z&#39;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">scaling</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;synapse_size_nm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;synapse_size&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">scaling</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
        
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="synapse_dict_from_synapse_csv"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_dict_from_synapse_csv">[docs]</a><span class="k">def</span> <span class="nf">synapse_dict_from_synapse_csv</span><span class="p">(</span>
    <span class="n">synapse_filepath</span><span class="p">,</span>
    <span class="n">segment_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">coordinates_nm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purpose: to injest the synapse information for a segment id in some manner</span>

<span class="sd">    Example implementation: injesting synapse inforation from a csv</span>

<span class="sd">    Pseudocode: </span>
<span class="sd">    1) Read in the csv</span>
<span class="sd">    2) Filter to the segment id</span>
<span class="sd">    3) Creates the prepost dictionary to be filled:</span>
<span class="sd">    Iterates through pre and post (call preprost):</span>
<span class="sd">        a) filters for certain prepost</span>
<span class="sd">        b) Gets the synapse id, x, y, z and synapse size</span>
<span class="sd">        c) Stacks the syz and scales them if need</span>
<span class="sd">        d) Stores all data in dictionary for that prepost</span>

<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">df</span> <span class="o">=</span> <span class="n">synapse_df_from_csv</span><span class="p">(</span>
        <span class="n">synapse_filepath</span><span class="p">,</span>
        <span class="n">segment_id</span> <span class="o">=</span> <span class="n">segment_id</span><span class="p">,</span>
        <span class="n">coordinates_nm</span> <span class="o">=</span> <span class="n">coordinates_nm</span><span class="p">,</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">scaling</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">coordinates_nm</span><span class="p">:</span>
        <span class="n">syn_coord_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;synapse_x_nm&quot;</span><span class="p">,</span><span class="s1">&#39;synapse_y_nm&#39;</span><span class="p">,</span><span class="s1">&#39;synapse_z_nm&#39;</span><span class="p">,</span><span class="s1">&#39;synapse_size_nm&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">syn_coord_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;synapse_x&quot;</span><span class="p">,</span><span class="s1">&#39;synapse_y&#39;</span><span class="p">,</span><span class="s1">&#39;synapse_z&#39;</span><span class="p">,</span><span class="s2">&quot;synapse_size&quot;</span><span class="p">]</span>

    <span class="n">synapse_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">synapse_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]:</span>
        <span class="n">df_curr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prepost == &#39;</span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">synapse_ids</span><span class="p">,</span> <span class="n">centroid_xs</span><span class="p">,</span> <span class="n">centroid_ys</span><span class="p">,</span> <span class="n">centroid_zs</span><span class="p">,</span><span class="n">synapse_sizes</span> <span class="o">=</span> <span class="n">df_curr</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;synapse_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">syn_coord_names</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapse_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">synapse_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">centroid_xs</span><span class="p">,</span><span class="n">centroid_ys</span><span class="p">,</span><span class="n">centroid_zs</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">synapse_centers</span> <span class="o">=</span> <span class="n">synapse_centers</span><span class="o">*</span> <span class="n">scaling</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">synapse_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">synapse_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">synapse_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">synapse_ids</span> <span class="o">=</span> <span class="n">synapse_ids</span><span class="p">,</span>
            <span class="n">synapse_coordinates</span><span class="o">=</span> <span class="n">synapse_centers</span><span class="p">,</span>
            <span class="n">synapse_sizes</span> <span class="o">=</span> <span class="n">synapse_sizes</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of </span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="s1">&#39;synapse_coordinates&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">synapse_dict</span></div>


<div class="viewcode-block" id="fetch_synapse_dict_by_mesh_labels"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.fetch_synapse_dict_by_mesh_labels">[docs]</a><span class="k">def</span> <span class="nf">fetch_synapse_dict_by_mesh_labels</span><span class="p">(</span>
        <span class="n">segment_id</span><span class="p">,</span>
        <span class="n">mesh</span><span class="p">,</span>
        <span class="n">synapse_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">original_mesh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">original_mesh_kd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">original_mesh_method</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mapping_threshold</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        
        <span class="n">plot_synapses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_synapses_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Purpose: To return a synapse dictionary mapping</span>

<span class="sd">        type (presyn/postsyn)---&gt; mesh_label  --&gt; list of synapse ids</span>

<span class="sd">        for a segment id based on which original mesh face</span>
<span class="sd">        the synapses map to</span>

<span class="sd">        Pseudocode: </span>
<span class="sd">        1) get synapses for the segment id</span>
<span class="sd">        Iterate through presyn and postsyn</span>
<span class="sd">            a. Find the errors because of distance</span>
<span class="sd">            b. Find the errors because of mesh cancellation</span>
<span class="sd">            c. Find the valid mesh (by set difference)</span>
<span class="sd">            store all error types in output dict</span>
<span class="sd">        2) Plot the synapses if requested</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">        mesh_label_dict = syu.fetch_synapse_dict_by_mesh_labels(</span>
<span class="sd">            segment_id=o_neuron.segment_id,</span>
<span class="sd">            mesh = nru.neuron_mesh_from_branches(o_neuron),</span>
<span class="sd">            original_mesh = du.fetch_segment_id_mesh(segment_id),</span>
<span class="sd">            validation=True,</span>
<span class="sd">            plot_synapses=True,</span>
<span class="sd">            verbose = True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">synapse_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">synapse_dict</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">segment_id_to_synapse_dict</span><span class="p">(</span>
                <span class="n">segment_id</span><span class="p">,</span>
                <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">mesh_label_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


        <span class="k">for</span> <span class="n">synapse_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presyn&quot;</span><span class="p">,</span><span class="s2">&quot;postsyn&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Working on </span><span class="si">{</span><span class="n">synapse_type</span><span class="si">}</span><span class="s2">--&quot;</span><span class="p">)</span>
            <span class="n">synapse_centers_scaled</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="s2">&quot;synapse_coordinates&quot;</span><span class="p">]</span>
            <span class="n">synapse_ids</span> <span class="o">=</span> <span class="n">synapse_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">][</span><span class="s2">&quot;synapse_ids&quot;</span><span class="p">]</span>

            <span class="n">distance_errored_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
            <span class="n">mesh_errored_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
            <span class="n">valid_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>

            <span class="n">local_label_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synapse_centers_scaled</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">original_mesh_method</span><span class="p">:</span>

                    <span class="n">distance_errored_syn_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">valid_coordiantes_mapped_to_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
                                            <span class="n">coordinates</span><span class="o">=</span><span class="n">synapse_centers_scaled</span><span class="p">,</span>
                                            <span class="n">mapping_threshold</span> <span class="o">=</span> <span class="n">mapping_threshold</span><span class="p">,</span>
                                            <span class="n">return_idx</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">return_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">valid_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_centers_scaled</span><span class="p">)),</span><span class="n">distance_errored_syn_idx</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Pseudocode:</span>

<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using original_mesh_method&quot;</span><span class="p">)</span>
                        
                    <span class="k">if</span> <span class="n">original_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">vdi</span><span class="o">.</span><span class="n">fetch_segment_id_mesh</span><span class="p">(</span><span class="n">segment_id</span><span class="p">)</span>
                    <span class="n">distance_errored_syn_idx</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">valid_coordiantes_mapped_to_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">original_mesh</span><span class="p">,</span>
                                            <span class="n">coordinates</span><span class="o">=</span><span class="n">synapse_centers_scaled</span><span class="p">,</span>
                                            <span class="n">mapping_threshold</span> <span class="o">=</span> <span class="n">mapping_threshold</span><span class="p">,</span>
                                            <span class="n">return_idx</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">return_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                    <span class="n">mesh_errored_syn_idx_pre</span> <span class="o">=</span> <span class="n">tu</span><span class="o">.</span><span class="n">valid_coordiantes_mapped_to_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
                                                                            <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
                                                                            <span class="n">original_mesh_kdtree</span><span class="o">=</span><span class="n">original_mesh_kd</span><span class="p">,</span>
                                            <span class="n">coordinates</span><span class="o">=</span><span class="n">synapse_centers_scaled</span><span class="p">,</span>
                                            <span class="n">mapping_threshold</span> <span class="o">=</span> <span class="n">mapping_threshold</span><span class="p">,</span>
                                            <span class="n">return_idx</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">return_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">mesh_errored_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">mesh_errored_syn_idx_pre</span><span class="p">,</span><span class="n">distance_errored_syn_idx</span><span class="p">)</span>


                    <span class="n">total_error_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">distance_errored_syn_idx</span><span class="p">,</span><span class="n">mesh_errored_syn_idx</span><span class="p">])</span>
                    <span class="n">valid_syn_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">synapse_centers_scaled</span><span class="p">)),</span><span class="n">total_error_syn_idx</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of distance_errored_syn_idx = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">distance_errored_syn_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of mesh_errored_syn_idx = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_errored_syn_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# of valid_syn_idx = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_syn_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">local_label_dict</span><span class="p">[</span><span class="s2">&quot;distance_errored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synapse_ids</span><span class="p">[</span><span class="n">distance_errored_syn_idx</span><span class="p">]</span>
            <span class="n">local_label_dict</span><span class="p">[</span><span class="s2">&quot;mesh_errored&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synapse_ids</span><span class="p">[</span><span class="n">mesh_errored_syn_idx</span><span class="p">]</span>
            <span class="n">local_label_dict</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synapse_ids</span><span class="p">[</span><span class="n">valid_syn_idx</span><span class="p">]</span>

            <span class="n">mesh_label_dict</span><span class="p">[</span><span class="n">synapse_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_label_dict</span>

        <span class="k">if</span> <span class="n">plot_synapses</span><span class="p">:</span>
            <span class="n">output_syn_dict</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapse_dict_mesh_labels_to_synapse_coordinate_dict</span><span class="p">(</span><span class="n">synapse_mesh_labels_dict</span><span class="o">=</span><span class="n">mesh_label_dict</span><span class="p">,</span>
                                                        <span class="n">synapse_dict</span><span class="o">=</span><span class="n">synapse_dict</span><span class="p">)</span>
            <span class="n">syu</span><span class="o">.</span><span class="n">plot_valid_error_synpases</span><span class="p">(</span><span class="n">neuron_obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">synapse_dict</span><span class="o">=</span><span class="n">output_syn_dict</span><span class="p">,</span>
                                    <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span>
                                    <span class="n">original_mesh</span> <span class="o">=</span> <span class="n">original_mesh</span><span class="p">,</span>
                                    <span class="n">keyword_to_plot</span><span class="o">=</span><span class="n">plot_synapses_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mesh_label_dict</span></div>

<div class="viewcode-block" id="synapse_df_abridged"><a class="viewcode-back" href="../../neurd.html#neurd.synapse_utils.synapse_df_abridged">[docs]</a><span class="k">def</span> <span class="nf">synapse_df_abridged</span><span class="p">(</span>
    <span class="n">neuron_obj</span><span class="p">,</span>
    <span class="p">):</span>

    <span class="n">syn_df</span> <span class="o">=</span> <span class="n">syu</span><span class="o">.</span><span class="n">synapses_df</span><span class="p">(</span><span class="n">syu</span><span class="o">.</span><span class="n">synapses_valid</span><span class="p">(</span><span class="n">neuron_obj</span><span class="p">))</span>
    <span class="n">syn_df_new</span> <span class="o">=</span> <span class="n">syn_df</span><span class="p">[[</span><span class="s2">&quot;syn_id&quot;</span><span class="p">,</span><span class="s2">&quot;syn_type&quot;</span><span class="p">,</span><span class="s2">&quot;coordinate&quot;</span><span class="p">,</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span><span class="s2">&quot;compartment&quot;</span><span class="p">,</span><span class="s2">&quot;limb_idx&quot;</span><span class="p">,</span><span class="s2">&quot;branch_idx&quot;</span><span class="p">,</span><span class="s2">&quot;soma_distance&quot;</span><span class="p">]]</span>
    <span class="n">syn_df_new</span><span class="p">[[</span><span class="s2">&quot;synapse_x_nm&quot;</span><span class="p">,</span><span class="s2">&quot;synapse_y_nm&quot;</span><span class="p">,</span><span class="s2">&quot;synapse_z_nm&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">syn_df_new</span><span class="p">[</span><span class="s2">&quot;coordinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">syn_df_new</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span>
        <span class="n">syn_df_new</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">syn_type</span> <span class="o">=</span> <span class="s2">&quot;prepost&quot;</span><span class="p">,</span>
            <span class="n">syn_id</span> <span class="o">=</span> <span class="s2">&quot;synapse_id&quot;</span><span class="p">,</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;synapse_size&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">syn_df_new</span></div>

<span class="c1"># ------------- Setting up parameters -----------</span>

<span class="c1"># -- default</span>
<span class="n">attributes_dict_default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">voxel_to_nm_scaling</span> <span class="o">=</span> <span class="n">mvu</span><span class="o">.</span><span class="n">voxel_to_nm_scaling</span><span class="p">,</span>
    <span class="n">vdi</span> <span class="o">=</span> <span class="n">mvu</span><span class="o">.</span><span class="n">data_interface</span>
<span class="p">)</span>    
<span class="n">global_parameters_dict_default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1">#max_ais_distance_from_soma = 50_000</span>
<span class="p">)</span>

<span class="c1"># -- microns</span>
<span class="n">global_parameters_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">attributes_dict_microns</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#-- h01--</span>
<span class="n">attributes_dict_h01</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">voxel_to_nm_scaling</span> <span class="o">=</span> <span class="n">hvu</span><span class="o">.</span><span class="n">voxel_to_nm_scaling</span><span class="p">,</span>
    <span class="n">vdi</span> <span class="o">=</span> <span class="n">hvu</span><span class="o">.</span><span class="n">data_interface</span>
<span class="p">)</span>
<span class="n">global_parameters_dict_h01</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
       
<span class="c1"># data_type = &quot;default&quot;</span>
<span class="c1"># algorithms = None</span>
<span class="c1"># modules_to_set = [syu]</span>

<span class="c1"># def set_global_parameters_and_attributes_by_data_type(data_type,</span>
<span class="c1">#                                                      algorithms_list = None,</span>
<span class="c1">#                                                       modules = None,</span>
<span class="c1">#                                                      set_default_first = True,</span>
<span class="c1">#                                                       verbose=False):</span>
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     modu.set_global_parameters_and_attributes_by_data_type(modules,data_type,</span>
<span class="c1">#                                                           algorithms=algorithms_list,</span>
<span class="c1">#                                                           set_default_first = set_default_first,</span>
<span class="c1">#                                                           verbose = verbose)</span>
    
<span class="c1"># set_global_parameters_and_attributes_by_data_type(data_type,</span>
<span class="c1">#                                                    algorithms)</span>

<span class="c1"># def output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#     modules = None,</span>
<span class="c1">#     algorithms = None,</span>
<span class="c1">#     verbose = True,</span>
<span class="c1">#     lowercase = True,</span>
<span class="c1">#     output_types = (&quot;global_parameters&quot;),</span>
<span class="c1">#     include_default = True,</span>
<span class="c1">#     algorithms_only = False,</span>
<span class="c1">#     **kwargs):</span>
    
<span class="c1">#     if modules is None:</span>
<span class="c1">#         modules = modules_to_set</span>
    
<span class="c1">#     return modu.output_global_parameters_and_attributes_from_current_data_type(</span>
<span class="c1">#         modules,</span>
<span class="c1">#         algorithms = algorithms,</span>
<span class="c1">#         verbose = verbose,</span>
<span class="c1">#         lowercase = lowercase,</span>
<span class="c1">#         output_types = output_types,</span>
<span class="c1">#         include_default = include_default,</span>
<span class="c1">#         algorithms_only = algorithms_only,</span>
<span class="c1">#         **kwargs,</span>
<span class="c1">#         )</span>


<span class="c1">#--- from neurd_packages ---</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">apical_utils</span> <span class="k">as</span> <span class="n">apu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">axon_utils</span> <span class="k">as</span> <span class="n">au</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">branch_attr_utils</span> <span class="k">as</span> <span class="n">bau</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">concept_network_utils</span> <span class="k">as</span> <span class="n">cnu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">h01_volume_utils</span> <span class="k">as</span> <span class="n">hvu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">microns_volume_utils</span> <span class="k">as</span> <span class="n">mvu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_searching</span> <span class="k">as</span> <span class="n">ns</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_statistics</span> <span class="k">as</span> <span class="n">nst</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_utils</span> <span class="k">as</span> <span class="n">nru</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">neuron_visualizations</span> <span class="k">as</span> <span class="n">nviz</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">proofreading_utils</span> <span class="k">as</span> <span class="n">pru</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">spine_utils</span> <span class="k">as</span> <span class="n">spu</span>

<span class="n">presyns_on_dendrite_query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;(label==&#39;limb_branch&#39;) and ((compartment==&#39;dendrite&#39;) or &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; (compartment in </span><span class="si">{</span><span class="n">apu</span><span class="o">.</span><span class="n">dendrite_compartment_labels</span><span class="p">()</span><span class="si">}</span><span class="s2">)) and (syn_type==&#39;presyn&#39;)&quot;</span><span class="p">)</span>

<span class="c1">#--- from mesh_tools ---</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="n">skeleton_utils</span> <span class="k">as</span> <span class="n">sk</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="n">trimesh_utils</span> <span class="k">as</span> <span class="n">tu</span>

<span class="c1">#--- from python_tools ---</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">general_utils</span> <span class="k">as</span> <span class="n">gu</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">modu</span> 
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">numpy_dep</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">numpy_utils</span> <span class="k">as</span> <span class="n">nu</span>
<span class="kn">from</span> <span class="nn">python_tools</span> <span class="kn">import</span> <span class="n">pandas_utils</span> <span class="k">as</span> <span class="n">pu</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">synapse_utils</span> <span class="k">as</span> <span class="n">syu</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Brendan Celii.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>